function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function resetBmap(e){var t=e.ecc._model,a=null;t.eachComponent("bmap",function(e){null==a&&(a=e.__bmap)}),a&&setTimeout(function(){a.setZoom(4)},500)}function threshold(e,t){var a=[],r=[];if(!_.isUndefined(e.targetData)){for(var n=function(t){for(var n={silent:!0,data:[]},i=0;i<e.targetData[t].cols.length;i++){var s={show:!1,top:10,right:10,pieces:[],orient:"horizontal",padding:35,left:"15"};if(!_.isUndefined(e.targetData[t].cols[i].thresholds))for(var l in e.targetData[t].cols[i].thresholds)for(var c=0;c<e.targetData[t].cols[i].thresholds[l].length;c++){var d={gt:e.targetData[t].cols[i].thresholds[l][c].t_min_values,lte:e.targetData[t].cols[i].thresholds[l][c].t_max_values,color:e.targetData[t].cols[i].thresholds[l][c].t_color,label:e.targetData[t].cols[i].thresholds[l][c].t_key},u={yAxis:e.targetData[t].cols[i].thresholds[l][c].t_min_values,itemStyle:{normal:{label:{show:!0,position:"start",formatter:e.targetData[t].cols[i].thresholds[l][c].t_key}}}},f={yAxis:e.targetData[t].cols[i].thresholds[l][c].t_max_values,itemStyle:{normal:{label:{show:!0,position:"start",formatter:e.targetData[t].cols[i].thresholds[l][c].t_key}}}};s.pieces.push(d),s.show=!0,n.data.push(u),n.data.push(f)}r.push(s)}a.push(n),o=_.filter(e.series,function(e){return e.yAxisIndex==t});for(var p=0;p<o.length;p++)o[p].markLine=a[t]},i=0;i<e.targetData.length;i++){var o;n(i)}if("scatter"==e.series[0].type){var s=r[0];r=[];for(var l=0;l<e.series.length;l++){for(var c=0;c<s.pieces.length;c++)if(s.pieces[c].gt){var d={silent:!0,data:[]},u={yAxis:s.pieces[c].gt,itemStyle:{normal:{label:{show:!0,position:"start",formatter:s.label}}}},f={yAxis:s.pieces[c].lte,itemStyle:{normal:{label:{show:!0,position:"start",formatter:s.label}}}};d.data.push(u,f),e.series[c].markLine=d}r.push(angular.copy(s))}for(var p=0;p<e.series.length;p++)!_.isUndefined(e.color)&&p<5?(r[p].outOfRange.color=e.color[p],r[p].color.push(e.color[p])):(r[p].outOfRange.color=t.color[p],r[p].color.push(t.color[p])),r[p].dimension=1,r[p].seriesIndex=p,r[p].show=!1,r[p].top=15*p;s.dimension=1,r=s}else if("pie"==e.series[0].type){var g=r[0];r=[];for(var m=0;m<e.series.length;m++){g.outOfRange={color:[]},g.color=[];for(var h=0;h<e.series[m].data.length;h++)!_.isUndefined(e.color)&&m<5?(g.outOfRange.color=e.color[m],g.color.push(e.color[m])):(g.outOfRange.color.push(t.color[h]),g.color.push(t.color[h]));r.push(g)}}else if(r.length===e.series.length)for(var v=0;v<r.length;v++)r[v].seriesIndex=v,r[v].top=3*v+"%",r[v].outOfRange={color:[]},r[v].color=[],!_.isUndefined(e.color)&&v<5?(r[v].outOfRange.color=e.color[v],r[v].color.push(e.color[v])):(r[v].outOfRange.color=t.color[v],r[v].color.push(t.color[v]));e.visualMap=r}return e}function theme(e,t){return e}function transForEXCEL(e){var t=[],a={};for(var r in e.columnList)a[r]=e.columnList[r].name;for(var r in e.data){var n={};for(var i in e.data[r])n[a[i]]=e.data[r][i];t.push(n)}return t}function randomStr(){return Math.random().toString(36).substring(2)}function render(e,t){var a=/(\\)?\{([^\{\}\\]+)(\\)?\}/g;return e.replace(a,function(e,a,r,n){if(a||n)return e.replace("\\","");for(var i,o,s,l=r.replace(/\s/g,"").split("."),c=t,i=0,o=l.length;i<o;++i)if(s=l[i],c=c[s],void 0===c||null===c)return"{"+r+"}";return c})}function dataStructure(e){var t=e?e.toString():"",a=/^\d+(\.\d+)?$/.test(t),r=a?t.split(".")[0].length:0,n=a&&t.indexOf(".")!=-1?t.split(".")[1].length:0;return{isNumber:a,intBit:r,floatBit:n}}function dataFormat(e){var t=dataStructure(e);return t.isNumber?numbro(e).format("0.[0000]"):e}function verifyAggExpRegx(exp){var result={isValid:!1,msg:""},exp=exp.replace(/\s/g,"").replace(/(sum|avg|count|max|min)\([\u4e00-\u9fa5_a-zA-Z0-9]+\)/g,"1");try{eval(exp)}catch(e){return result.msg=e.message,result}return result.isValid=!0,result.msg="ok!",result}function cboardTranslate(path){for(var keys=path.split("."),exp="CB_I18N",i=0;i<keys.length;i++)exp+="['"+keys[i]+"']";var result=eval(exp);return result?result:path}function groupSort(e,t,a){var r=[],n=t.prevOptions,i=e.chartConfig.keys.length,o=e.chartConfig.groups.length,s=e.data,l=[];for(var c in t.drill.config)l.push(t.drill.config[c]);if(_.isUndefined(n))r=getSortingData(s,i,o,e,a,t);else{var d=[],u=n.prevData,f=n.keys;f.length!==i&&"up"!==a&&(i=f.length);var p=getSortingData(s,i,o,e,a,t);0===u.length&&(u=p),_.each(u,function(e){_.each(p,function(t){"down"===a||_.isUndefined(a)?t.indexOf(e)>-1&&d.push(t):e.indexOf(t)>-1&&d.push(t)})}),_.each(p,function(e){d.indexOf(e)===-1&&d.push(e)}),d.length>0&&(r=_.uniq(d))}return r}function getSortingData(e,t,a,r,n,i){var o=[],s=void 0,l=r.chartConfig.keys.length;_.map(e[a],function(e,t){_.isUndefined(s)&&e.sort&&"sort"!==e.sort&&(s=e.sort)});var c=0,d=1;("up"===n||"up"!==n&&"down"!==n)&&(c=1,d=2);for(var u=a+1;u<e.length;u++){for(var f="",p=0;p<t-c;p++)(_.isNaN(Number(e[u][p].data))||""===e[u][p].data)&&(f+=""===e[u][p].data?"_":e[u][p].data,p!==t-d&&(f+="-"));o.indexOf(f)===-1&&o.push(f)}var g="";return o="function"==typeof g.localeCompare?o.sort(function(e,t){return!_.isUndefined(s)&&1===l||!_.isUndefined(i.prevOptions)?0:e.localeCompare(t,"zh")}):o.sort()}function sortByPrev(e,t,a){function r(e){var t=parseFloat(e);return t=_.isNaN(t)||_.isUndefined(t)||_.isNull(t)||t===1/0?-(1/0):t}var n=[],i={},o=t.prevOptions.prevData,s=e.chartConfig.keys.length,l=e.chartConfig.groups.length,c=e.data,d=void 0,u=void 0,f=0,p=1;_.map(c[l],function(e,t){_.isUndefined(d)&&e.sort&&(d=e.sort,u=t)}),_.isUndefined(t.prevOptions.keys)||"up"===a||(s=t.prevOptions.keys.length),("up"===a||"up"!==a&&"down"!==a)&&(f=1,p=2);for(var g=l+1;g<c.length;g++){for(var m="",h=0;h<s-f;h++)(_.isNaN(Number(c[g][h].data))||""===c[g][h].data)&&(m+=""===c[g][h].data?"_":c[g][h].data,h!==s-p&&(m+="-"));i[m]?i[m].push(c[g]):i[m]=[c[g]]}_.each(o,function(e){_.isUndefined(u)||_.isUndefined(i[e])||i[e].sort(function(e,t){return"asc"===d?r(e[u].data)-r(t[u].data):"desc"===d?r(t[u].data)-r(e[u].data):0}),_.isUndefined(i[e])||(n=n.concat(i[e]))});for(var v=[],y=0;y<l+1;y++)v.push(c[y]);return n=v.concat(n)}function htmlRender(e,t){for(var a=e.chartConfig.values[0].cols,r=e.chartConfig.keys,n=e.chartConfig.groups,i=e.originalData.columnList,o=e.originalData.data,s=getIndex(r,i),l=getIndex(n,i),c=[],d=0;d<o.length;d++)c.push(o[d][l.index]);c=_.uniq(c);for(var u="<thead>",f="<tr><th>"+s.name+" \\ "+l.name+"</th>",p="<tr><th></th>",g=0;g<c.length;g++){f+='<th colspan="'+a.length+'" data-type="group" data-name="'+c[g]+'">'+c[g]+"</th>";for(var m=0;m<a.length;m++)p+='<th data-type="value">'+a[m].alias+"</th>"}return f+="</tr>",p+="</tr>",u+=f+p+"</thead>"}function getIndex(e,t){if(_.isUndefined(e[0]))return!1;if(_.isUndefined(e[0].drillDown))return _.find(t,function(t){return e[0].col===t.name});for(var a=0;a<e[0].drillDown.length;a++){var r=_.find(t,function(t){return e[0].drillDown[a].col===t.name});if(r)return r}}function theadRender(e){var t=e.chartConfig.values[0].cols,a=e.chartConfig.keys[0].drillDown,r=e.chartConfig.drillTier.keyTier,n="<thead><tr>";return _.each(a,function(e,t){if(t>r)return!1;var i=e.col;e.alias&&(i=e.alias),n+='<th data-field="'+e.col+'" data-key="'+e.col+'" class="drillDown_th">'+i,t==r&&t+1<a.length?n+='<a data-index="'+t+'" data-key="'+e.col+'" style="float: right;" data-type="drillDown"><i class="glyphicon glyphicon-plus"></i></a>':t<r&&t+1<a.length&&(n+='<a data-index="'+t+'" data-key="'+e.col+'" style="float: right;" data-type="drillUp"><i class="fa fa-minus"></i></a>'),n+="</th>"}),_.each(t,function(e){var t=e.col;e.alias&&(t=e.alias),n+='<th data-field="'+e.col+'">'+t+"</th>"}),n+="</tr></thead>"}function selectorRender(keys,groupSelects,columnList,EventService,options){var key=keys[0],target=keys[0].colNoDot?keys[0].colNoDot:keys[0].col,$target=$("#select_"+target),eventName=keys[0].eventName,targetEventName=eventName?eventName:target;$target.addClass("select_"+targetEventName);var option="";if(_.each(options.firstSelects,function(e){option+='<option value="'+e+'">'+e+"</option>"}),$target.children().length&&$target.empty(),$target.append(option),$target.multipleSelect({single:key.isSingle,filter:options.chartConfig.isFilter,selectAllText:"全部",onClick:function(e){if(e.checked)key.isSingle?window.$$dlut_param[$target.attr("data-eventName")]=e.value:window.$$dlut_param[$target.attr("data-eventName")].indexOf(e.value)===-1&&("-1"===window.$$dlut_param[$target.attr("data-eventName")]&&(window.$$dlut_param[$target.attr("data-eventName")]=[]),window.$$dlut_param[$target.attr("data-eventName")].push(e.value));else if(key.isSingle)window.$$dlut_param[$target.attr("data-eventName")]="";else{var t=$target.multipleSelect("getSelects");0===t.length&&(t="-1"),window.$$dlut_param[$target.attr("data-eventName")]=t}},onCheckAll:function(){var e=options.firstSelects.length,t=$target.multipleSelect("getSelects").length;e===t?window.$$dlut_param[$target.attr("data-eventName")]=[]:window.$$dlut_param[$target.attr("data-eventName")]=$target.multipleSelect("getSelects")},onUncheckAll:function(){window.$$dlut_param[$target.attr("data-eventName")]="-1"},onClose:function onClose(){try{EventService.trigger("$change",{event:key.eventName,col:key.col?key.col:key.column}),eval(key.change)}catch(e){console.log("CBoardSelectorRender.js 执行eval错误",key.change,key.col,e)}}}),key.isSingle){if(!options.chartConfig.init){var selected=options.firstSelects[0];!_.isUndefined(options.chartConfig.initSelected)&&options.chartConfig.initSelected.length>0&&(selected=options.chartConfig.initSelected),selected||(selected=-1),$target.multipleSelect("setSelects",[selected]),window.$$dlut_param[$target.attr("data-eventname")]=selected}options.chartConfig.temporaryParam&&($target.multipleSelect("setSelects",[options.chartConfig.temporaryParam]),window.$$dlut_param[$target.attr("data-eventName")]=options.chartConfig.temporaryParam),delete options.chartConfig.temporaryParam,$target&&EventService.trigger("$ready",{wName:options.wName})}else options.chartConfig.init||($target.multipleSelect("checkAll"),window.$$dlut_param[$target.attr("data-eventName")]="all"),options.chartConfig.temporaryParam&&("all"===options.chartConfig.temporaryParam?($target.multipleSelect("checkAll"),window.$$dlut_param[$target.attr("data-eventName")]="all"):("string"==typeof options.chartConfig.temporaryParam&&(options.chartConfig.temporaryParam=[options.chartConfig.temporaryParam]),$target.multipleSelect("setSelects",options.chartConfig.temporaryParam),window.$$dlut_param[$target.attr("data-eventName")]=options.chartConfig.temporaryParam)),delete options.chartConfig.temporaryParam,$target&&EventService.trigger("$ready",{wName:options.wName})}function getLocalData(e){var t=void 0,a=e.treeGrid.data;if(e.chartConfig&&e.chartConfig.option&&e.chartConfig.option.code){t=e.chartConfig.option.code;try{var r=angular.copy(window.$$dlut_param);a=new Function("data,option,param","return ("+t+")(data,option,param)")(e.treeGrid.data,e,r)}catch(n){console.error("option自定义计算错误",e,n)}}return a}function hierarchyColumn(e,t){"undefined"==typeof t&&(t=":");for(var a=e.columns,r={},n=0;n<a.length;n++){var i=a[n];if(i.colArr=i.text.split(t),i.colArr.length>1){i.text=i.colArr[i.colArr.length-1];for(var o=i.colArr.length-2;o>=0;o--){for(var s=[],l=0;l<=o;l++)s.push(i.colArr[l]);var c=s.join(t);"undefined"==typeof i.columngroup&&(i.columngroup=c),"undefined"==typeof r[c]&&(r[c]={text:i.colArr[o],align:"center",name:c},o>0&&(s.pop(),r[c].parentgroup=s.join(t)))}}}var d=[];for(var u in r)d.push(r[u]);return d.length>0&&(e.columnGroups=d),e}function getRootPath(){var e=window.document.location.href,t=window.document.location.pathname,a=e.indexOf(t),r=e.substring(0,a),n=t.substring(0,t.substr(1).indexOf("/")+1);return r+n}function convertCityData(e){for(var t=e.data,a=e.keys,r=[],n=0;n<t.length;n++)for(var i=t[n],o=0;o<i.length;o++){var s=city[a[o][0]],l=CBoardEChartRenderEventInfo(e,void 0,o);if(0===n){var c={name:a[o][0],value:s&&2===s.length?s.concat(t[n][o]):[null,null],eventInfo:l};r.push(c)}else r[o]&&r[o].value&&(r[o].value=r[o].value.concat(t[n][o]))}return r}function convertProvinceData(e){for(var t=[],a=0;a<e.length;a++){var r=province[e[a][0]];r&&t.push({name:e[a][0],value:e[a][1]})}return t}function convertZoneData(e){for(var t=e.data,a=e.keys,r=[],n=0;n<t.length;n++)for(var i=t[n],o=0;o<i.length;o++){var s=a[o][0],l=[];if(s&&0===n){var c=CBoardEChartRenderEventInfo(e,void 0,o),d={name:s,value:l.concat(t[n][o]),eventInfo:c};r.push(d)}else r[o]&&r[o].value&&(r[o].value=r[o].value.concat(t[n][o]))}return r}function jstree_GetWholeTree(e){return $("#"+e).jstree(!0)}function jstree_GetSelectedNodes(e){return jstree_GetWholeTree(e).get_selected(!0)}function jstree_CvtVPath2TreeData(e){var t=1,a=[];a.push({id:"root",parent:"#",text:"Root",state:{opened:!0}});for(var r=0;r<e.length;r++){var n=[];e[r].categoryName?(n=e[r].categoryName.split("/"),n.push(e[r].name)):n.push(e[r].name);for(var i="root",o=0;o<n.length;o++){for(var s=!1,l=n[o],c=0;c<a.length;c++)if(a[c].text==l&&a[c].parent==i&&"parent"==a[c].id.substring(0,6)){s=!0;break}s?i=a[c].id:(o==n.length-1?a.push({id:e[r].id.toString(),parent:i,text:l,icon:"glyphicon glyphicon-file"}):a.push({id:"parent"+t,parent:i,text:l}),i="parent"+t,t++)}}return a}function jstree_CheckTreeNode(e,t,a){var r=jstree_GetSelectedNodes(t);return void 0!==r&&(0==r.length?(a("Please, select one widget first!","modal-warning","sm"),!1):!("undefined"!=typeof r[0].children&&r[0].children.length>0)||(a("Can't "+e+" a folder!","modal-warning","sm"),!1))}function jstree_ReloadTree(e,t,a){jstree_GetWholeTree(e).settings.core.data=t,jstree_GetWholeTree(e).refresh()}function jstree_baseTreeEventsObj(e){var t={ready:function(){e.ngTimeout(function(){e.ngScope.ignoreChanges=!1})},activate_node:function(t,a){var r=jstree_GetWholeTree(e.treeID),n=r.get_selected(!0)[0];n.children.length>0&&(r.deselect_node(n),r.toggle_node(n))},dblclick:function(){var t=jstree_GetSelectedNodes(e.treeID);0!=t.length&&e.ngScope.editNode()},move_node:function(t,a){var r=function(t,a){var r=!0,n=_.find(e.ngScope[e.listName],function(e){return e.id==t});if(n.categoryName=a,e.categoryList){var i=_.find(e.ngScope.$parent[e.categoryList],function(e){return e.name==a});i&&(r=!1,n.categoryId=i.id)}r?e.ngHttp.post(e.updateUrl,{categoryName:a,id:t,name:n.name}).success(function(t){"1"==t.status||e.ModalUtils.alert(t.msg,"modal-warning","lg")}):e.ngHttp.post(e.updateUrl,{json:angular.toJson(n)}).success(function(t){"1"==t.status||e.ModalUtils.alert(t.msg,"modal-warning","lg")})},n=function c(e,t){var a=e.children;if(0==a.length)r(e.id,t);else for(var n=""==t?e.text:t+"/"+e.text,o=0;o<a.length;o++){var s=i.get_node(a[o]);c(s,n)}},i=jstree_GetWholeTree(e.treeID),o=a.node,s=a.parent,l=i.get_path(s,"/").substring(5);n(o,l)}};return e.ngScope.clickNode&&(t.waitClick=!1,t.click=function(a){e.ngTimeout?t.waitClick?(t.waitClick=!1,e.ngTimeout.cancel(t.timer)):(t.waitClick=!0,t.timer=e.ngTimeout(function(){t.waitClick=!1;var a=jstree_GetSelectedNodes(e.treeID)[0];e.ngScope.clickNode(a)},200),e.ngScope.$on("$stateChangeStart",function(){e.ngTimeout.cancel(t.timer)})):e.ngScope.clickNode(selectedNodes)}),t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};$(function(){window.dlut||(window.dlut={}),dlut.utils={GetQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?unescape(a[2]):null},convertMoney:function(e,t){e=parseFloat(e),"亿"==t?e=1e8*e:"万"==t&&(e=1e4*e);var a="";if(e>=1e8){var r=(e/1e8).toString(),n=r.substring(0,r.indexOf(".")).length-2;if(r.toString().indexOf(".")>-1&&n<=0){var i=r.substring(r.indexOf(".")+1,r.toString().indexOf(".")+3);a="00"==i?r.substring(0,r.indexOf("."))+"亿":r.substring(0,r.indexOf(".")+3)+"亿"}else a=r.indexOf(".")==-1?r+"亿":r.substring(0,r.indexOf("."))+"亿"}else if(e>1e4){var r=(e/1e4).toString(),n=r.substring(0,r.indexOf(".")).length-2;if(r.toString().indexOf(".")>-1&&n<=0){var i=r.substring(r.indexOf(".")+1,r.toString().indexOf(".")+3);a="00"==i?r.substring(0,r.indexOf("."))+"万":r.substring(0,r.indexOf(".")+3)+"万"}else a=r.indexOf(".")==-1?r+"万":r.substring(0,r.indexOf("."))+"万"}else if(e.toString().indexOf(".")==-1)a=e.toString()+"元";else{var r=e.toString();a=r.substring(0,r.indexOf(".")+3)+"元"}return a}},dlut.PostMan={listen:function(e,t,a){this._callbacks||(this._callbacks={});return a||(a=this(this._callbacks[e]||(this._callbacks[e]=[])).push({callback:t,context:a})),this},speak:function(){var e,t,a,r,n=Array.prototype.slice.call(arguments,0),i=n.shift();if(!(t=this._callbacks))return this;if(!(e=this._callbacks[i]))return this;for(a=0,r=e.length;a<r;a++)e[a].callback.apply(e[a].context,n);return this},socket:null,lastLetter:{},init:function(e){io&&e&&e.office?(this.socket=io.connect(e.office,{"reconnection limit":1}),this.socket.on("connect_error",function(e){this.io.disconnect()}),this.socket.on("letter",$.proxy(function(e){this.speak&&this.speak(e.title,e),this.lastLetter=e},this))):console.error("dlut","PostMan init must has io,option,option.office 3 parms")},post:function(e,t,a){a=$.extend(a,{addressee:e,title:t}),this.socket&&"page"!=a.addressee&&this.socket.emit("letter",a),"page"!=a.addressee&&"all"!=a.addressee||this.speak&&this.speak(a.title,a)},whenReceive:function(e,t,a){this.listen(e,t,a)},postlastLetter:function(){this.lastLetter.title&&this.post("page",this.lastLetter.title,this.lastLetter)}},dlut.html={color:{red:function(e){return'<a class="alert_text_red">'+e+"</a>"},yellow:function(e){return'<a class="alert_text_yellow">'+e+"</a>"},green:function(e){return'<a class="alert_text_green">'+e+"</a>"}},getColorClass:function(e,t,a){var r="alert_text_yellow";return"green"===a?r="alert_text_green":"yellow"===a?r="alert_text_yellow":"red"===a?r="alert_text_red":e>t?r="alert_text_green":e<t&&(r="alert_text_red"),r},arrow:function e(t,a,r){if("-"===t)return"-";"undefined"==typeof a&&(a=0);var n=dlut.html.getColorClass(t,a,r),e="fa-arrow-up";return(n="red")&&(e="fa-arrow-down"),"<a>"+t+'<i class="fa '+e+" "+n+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},arrowPercent:function(e,t,a,r){if("-"===e)return"-";"undefined"==typeof t&&(t=0);var n=dlut.html.getColorClass(e,t,a),e=dlut.math.toPercent(e,r);if("-"===e)return"-";var i="fa-arrow-up";return"alert_text_red"===n?i="fa-arrow-down":"alert_text_yellow"===n&&(i=""),"<a>"+e+'<i class="fa '+i+" "+n+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},bubble:function(e,t,a){if("-"===e)return"-";"undefined"==typeof t&&(t=0);var r=dlut.html.getColorClass(e,t,a);return"<a>"+e+'<i class="fa fa-adjust fa-rotate-270 '+r+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},bubblePercent:function(e,t,a){if("-"===e)return"<a>-</a>";"undefined"==typeof t&&(t=0);var r=dlut.html.getColorClass(e,t,a),e=dlut.math.toPercent(e);return"-"===e?"<a>-</a>":_.isNaN(e)||"NaN"===e.toString()?"<a>-</a>":"<a>"+e+'<i class="fa fa-adjust fa-rotate-270 '+r+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},square:function(e,t,a){if("-"===e)return"-";"undefined"==typeof t&&(t=0);var r=dlut.html.getColorClass(e,t,a);return"<a>"+e+'<i class="fa fa-square '+r+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},squarePercent:function(e,t,a){if("-"===e)return"-";"undefined"==typeof t&&(t=0);var r=dlut.html.getColorClass(e,t,a),e=dlut.math.toPercent(e);return"-"===e?"-":_.isNaN(e)||"NaN"===e.toString()?"<a>-</a>":"<a>"+e+'<i class="fa fa-square '+r+'" aria-hidden="true" style="margin-left: 5px"></i></a>'},bar:{percentBar:function(e,t,a,r,n){_.isUndefined(a)&&(a=!0),"undefined"==typeof t&&(t=70),_.isUndefined(n)&&(n="#47b9ff");var i="";if(i+='<label class="percentBar" style="width:'+(_.isNaN(dlut.math.toDecimal(e))?0:dlut.math.toDecimal(e)*t)+"%; background-color: "+n+';">',i+='<span class="percentBar-label" style="color: black">',"int"===a)i+=dlut.math.toDecimal(e,0);else{var o=2;_.isUndefined(r)||(o=r),i+=a?dlut.math.toPercent(e,o):dlut.math.toDecimal(e,o)}return i+="</span></label>"},doublePercentBar:function(e,t,a,r){_.isUndefined(r)&&(r=2),e=parseFloat(e);var n=Math.abs(a)>t?Math.abs(a):t,i="";return i+='<div class="double-percent-bar">',i+='<div class="flex">',e<0&&(i+="<label>"+dlut.math.toPercent(e,r)+'<span style="width:'+parseInt(Math.abs(e)/n*80)+'%" class="red"></span></label>'),i+="</div>",i+='<div class="flex">',e>=0&&(i+='<label><span style="width:'+parseInt(e/n*80)+'%" class="green"></span>'+dlut.math.toPercent(e,r)+"</label>"),i+="</div>"}}},dlut.math={toInt:function(e){return"-"===e?"-":_.isNaN(e)||e===1/0||e===-(1/0)||_.isUndefined(e)||"undefined"===e?"-":Math.round(e)},toDecimal:function(e,t){if("-"===e)return"-";if(_.isNull(e)||_.isNaN(e)||e===1/0||e===-(1/0)||_.isUndefined(e)||"undefined"===e)return"-";if("undefined"==typeof t&&(t=2),0===t)return dlut.math.toInt(e);t<1&&(t=1),"string"==typeof e&&(e=parseFloat(e));var a=Math.pow(10,t),r=(Math.round(e*a)/a).toFixed(t);return r},toDecimalK:function(e,t){return dlut.math.formatThousand(dlut.math.toDecimal(e,t))},to2Decimal:function(e){if("-"===e)return"-";if("string"==typeof e&&(e=parseFloat(e)),_.isNaN(e)||e===1/0||e===-(1/0))return"-";var t=(Math.round(100*e)/100).toFixed(2);return t},to2DecimalK:function(e){return dlut.math.formatThousand(dlut.math.to2Decimal(e))},toPercent:function(e,t){if("-"===e)return"-";if(0===e.length||_.isNull(e)||_.isNaN(e)||e===1/0||e===-(1/0)||_.isUndefined(e)||"undefined"===e)return"-";"string"==typeof e&&(e=parseFloat(e));var a=2;return _.isUndefined(t)||(a=t),dlut.math.toDecimal(100*e,a)+"%"},toPercentK:function(e){return"-"===e?"-":_.isNaN(e)||e===1/0||e===-(1/0)||_.isUndefined(e)||"undefined"===e?"-":("string"==typeof e&&(e=parseFloat(e)),_.isNaN(e)||e===1/0||e===-(1/0)?"-":dlut.math.formatThousand(Math.round(1e4*e)/100)+"%")},toDate:function(e,t){if(!e)return"-";var a="年",r="月",n="日";if(t&&(a=r="/",n=""),"-"===e)return"-";if(_.isNaN(e)||e===1/0||e===-(1/0))return"-";var i="";if(e&&(e=e.toString()),4===e.length)i=e+a;else if(6===e.length){var o=e.slice(0,4),s=e.slice(4);i=o+a+s+r}else if(8===e.length){var o=e.slice(0,4),s=e.slice(4,6),l=e.slice(6,8);i=o+a+s+r+l+n}return i},convertNum:function(e){return"string"==typeof e?e=parseFloat(e):"number"==typeof e||alert("dlut.math.convertNum 参数类型错误"),e>0&&e>1e3&&e<1e6?e=dlut.math.to2Decimal(e/1e3)+"K":e>0&&e>1e6?e=dlut.math.to2Decimal(e/1e6)+"M":e<0&&e<-1e3&&e>-1e6?e=dlut.math.to2Decimal(e/1e3)+"K":e<0&&e<-1e6&&(e=dlut.math.to2Decimal(e/1e6)+"M"),e},formatThousand:function(e){return e+="",e.indexOf(".")||(e+="."),e.replace(/(\d)(?=(\d{3})+\.)/g,function(e,t){return t+","}).replace(/\.$/,"")},isNum:function(e){return"-"===e?"-":0===e.length||_.isNull(e)||_.isNaN(e)||e===1/0||e===-(1/0)||_.isUndefined(e)||"undefined"===e?"-":("string"==typeof e&&(e=parseFloat(e)),e)}},dlut.echart={yAxisAlign:function(e){for(var t in e)e[t].max=function(e){return Math.abs(e.max)>Math.abs(e.min)?(1.2*Math.abs(e.max)).toFixed(2):(1.2*Math.abs(e.min)).toFixed(2)},e[t].min=function(e){return Math.abs(e.max)>Math.abs(e.min)?(1.2*-Math.abs(e.max)).toFixed(2):(1.2*-Math.abs(e.min)).toFixed(2)}},labelFormatter:function labelFormatter(e){var value=e.value,result="",formatter=e.data.laberFormatter;if(!formatter)return value;try{return result=eval(formatter)}catch(e){console.error("label formatterError",value,formatter)}},xAxisBottom:function(e,t,a,r,n){for(var i=[],o=0;o<t.length;o++){var s=angular.copy(e.series[t[o]]);e.series[t[o]].stack=t[o]+1,s.stack=t[o]+1,s.isAssist=!0,s.name+=" ",s.itemStyle={normal:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"},emphasis:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"}},s.data=[];for(var l=0;l<e.series[t[o]].data.length;l++){var c={eventInfo:e.series[t[o]].data[l].eventInfo,value:0};s.data.push(c)}s.label={show:!0,position:"bottom",rotate:r?r:0,ignore:!0,color:"black",offset:n?n:[0,0],formatter:a},i.push(s)}var d=i.concat(e.series);e.series=d},customSort:function(e,t,a){_.isUndefined(a)&&(a=1),a-=1;var r=[];return _.each(e,function(e){var n={},i=[];_.each(e.data,function(e){n[e.eventInfo[a].value]=e});for(var o=0;o<t.length;o++)n[t[o]]&&(i.push(n[t[o]]),r.indexOf(t[o])===-1&&r.push(t[o]),delete n[t[o]]);for(var s in n)i.push(n[s]),r.indexOf(s)===-1&&r.push(s);e.data=i}),{axis:r,series:e}}},dlut.table={getIndex:function(e,t){var a=e.data;if(a.length>1)for(var r=a[0],n=0;n<r.length;n++)if(r[n].data===t)return n},getRankMap:function(e,t,a){"undefined"==typeof a&&(a="desc");for(var r=e.data,n={},i=[],o=1;o<r.length;o++){var s=parseFloat(r[o][t].data);i.push(s)}if(i&&i.sort){var l=function(e){return e};"desc"===a&&(l=function(e){return-e}),i=_.sortBy(i,l)}for(var o=0;o<=i.length;o++)n[i[o]]=o+1;return n},getTotal:function(e,t){var a=e.data,r=0;if(a.length>1)for(var n=1;n<a.length;n++)if(a[n][t]){var i=parseFloat(a[n][t].data);$.isNumeric(a[n][t].data)&&(r+=i)}return r},customSort:function(e,t,a,r){_.isUndefined(a)&&(a=1),_.isUndefined(r)&&(r=0),a-=1;for(var n=[],i={},o=1+r;o<e.length;o++)i[e[o][a].data]=e[o];for(var s=0;s<1+r;s++)n.push(e[s]);_.each(t,function(e){i[e]&&(n.push(i[e]),delete i[e])});for(var l in i)n.push(i[l]);return n}},dlut.selector={customSort:function(e,t){var a=[],r={};_.each(e,function(e){r[e]=e}),_.each(t,function(e){r[e]&&(a.push(e),delete r[e])});for(var n in r)a.push(r[n]);return a}},dlut.url={goTo:function(e,t,a){var r="";r=_.isUndefined(a)?window.location.origin+window.location.pathname+"?":window.location.origin+a+"?";var n=window.$$dlut_param,i=getQueryString("yili-token"),o=!1;if(i&&(o=!0,r+="yili-token="+i),t.length){var s=[],l=[];for(var c in n)s.push(c);_.each(s,function(e){_.each(t,function(t){e.indexOf(t)>-1&&l.push(e)})}),_.each(l,function(e,t){var a=angular.copy(n[e]);"object"===_typeof(n[e])&&_.isUndefined(n[e].length)&&(a="",_.each(n[e],function(e,t){a+=e,t<e.length-1&&(a+=",")})),r+=o&&0===t?"&"+e+"="+a:o||0!==t?"&"+e+"="+a:e+"="+a})}window.location.href=r+e}}});var updateEchartOptions=function(e,t){if(e){if(e.markPoint&&_.isArray(t.series)){for(var a=function(e,t){if(!_.isUndefined(e)&&_.isArray(t)){if("category"==t[e].type)return t[e].data}else if(_.isUndefined(e)&&_.isArray(t)){if("category"==t[e].type)return t[0].data}else if("category"==t.type)return t.data},r=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];_.isUndefined(r.value)?t.push(r):t.push(r.value)}return t},n=function(e,t,a,r){var n=[];if(_.isUndefined(e)){for(var i=0;i<t.length;i++)n.push({coord:[a[i],i,r.data[0].unit?r.data[0].unit:""]});r.markPoint={symbolRotate:-90,label:{normal:{textStyle:{fontSize:18},formatter:function(e){return e.data.coord[0]+e.data.coord[2]},offset:[5,2]}},itemStyle:{normal:{color:"transparent"}},data:n}}else{for(var i=0;i<e.length;i++)n.push({coord:[i,a[i],r.data[0].unit]});r.markPoint={label:{normal:{formatter:function(e){return e.data.coord[1]+e.data.coord[2]},textStyle:{fontSize:18}}},itemStyle:{normal:{color:"transparent"}},data:n}}},i=[],o=[],s=0;s<t.series.length;s++){var l,c,d=[],u=t.series[s];l=a(u.xAxisIndex,t.xAxis),c=a(u.yAxisIndex,t.yAxis),_.isUndefined(u.stack)?(d=r(u.data),n(l,c,d,u)):(i.push(u),o.push(u.stack))}if(i.length){var f=function(e){var n=a(e[0].xAxisIndex,t.xAxis),i=a(e[0].yAxisIndex,t.yAxis),o=r(e[0].data);if(e.length>1)for(var s=1;s<e.length;s++){n=a(e[s].xAxisIndex,t.xAxis),i=a(e[s].yAxisIndex,t.yAxis);var l=r(e[s].data);o=_.map(_.zip(o,l),function(e){return e[0]+e[1]})}return{x:n,y:i,sumData:o}},p=_.uniq(o);if(1==p.length){var g=f(i);n(g.x,g.y,g.sumData,i[0])}else{var m=_.groupBy(i,"stack");for(var h in m){var g=f(m[h]);n(g.x,g.y,g.sumData,m[h][0])}}}}t.grid=angular.copy(echartsBasicOption.grid),0==e.legendShow?(t.grid.top="5%",t.legend.show=!1):(void 0===t.legend?t.legend=angular.copy(echartsBasicOption.legend):null,e.legendX?t.legend.x=e.legendX:null,e.legendY?t.legend.y=e.legendY:null,e.legendOrient?t.legend.orient=e.legendOrient:null),void 0===t.grid?t.grid=angular.copy(echartsBasicOption.grid):null,1==e.gridCustom?(e.gridTop?t.grid.top=e.gridTop:null,e.gridBottom?t.grid.bottom=e.gridBottom:null,e.gridLeft?t.grid.left=e.gridLeft:null,e.gridRight?t.grid.right=e.gridRight:null):t.grid=angular.copy(echartsBasicOption.grid)}},echartsBasicOption={title:{},grid:{left:"50",right:"20",bottom:"15%",top:"15%",containLabel:!1},toolbox:{showTitle:!1,feature:{myTool1:{show:!0,title:"",icon:"path://M432.45,595.444c0,2.177-4.661,6.82-11.305,6.82c-6.475,0-11.306-4.567-11.306-6.82s4.852-6.812,11.306-6.812C427.841,588.632,432.452,593.191,432.45,595.444L432.45,595.444z M421.155,589.876c-3.009,0-5.448,2.495-5.448,5.572s2.439,5.572,5.448,5.572c3.01,0,5.449-2.495,5.449-5.572C426.604,592.371,424.165,589.876,421.155,589.876L421.155,589.876z M421.146,591.891c-1.916,0-3.47,1.589-3.47,3.549c0,1.959,1.554,3.548,3.47,3.548s3.469-1.589,3.469-3.548C424.614,593.479,423.062,591.891,421.146,591.891L421.146,591.891zM421.146,591.891",onclick:function(e,t){_.isUndefined(window.$$dlut_echart_timeout)||(window.$$dlut_echart_timeout=!0);var a=e.getOption(),r=a.wName;if($$dlut_renders[r]){for(var n=0;n<a.series.length;n++)if(a.series[n].label||(a.series[n].label={}),a.series[n].labelLine||(a.series[n].labelLine={}),a.series[n].label.ignore);else{_.isUndefined(a.series[n].label.position)&&(a.series[n].label.position="top"),a.series[n].emphasis||(a.series[n].emphasis={},a.series[n].emphasis.label={},a.series[n].emphasis.labelLine={}),a.series[n].emphasis.label||(a.series[n].emphasis.label={}),a.series[n].emphasis.labelLine||(a.series[n].emphasis.labelLine={});var i=!a.series[n].label.show;a.series[n].label.show=i,a.series[n].labelLine.show=i,a.series[n].emphasis.label.show=i,a.series[n].emphasis.labelLine.show=i}echarts.init(t.getDom()).setOption(a)}}},myExcelDownload:{show:!1,title:"",icon:"path://M102.745,48.964h-2.449V37.146c0-0.074-0.012-0.148-0.021-0.223c-0.004-0.469-0.154-0.93-0.475-1.295L80.133,13.163  c-0.006-0.006-0.012-0.008-0.016-0.014c-0.117-0.131-0.254-0.24-0.398-0.334c-0.043-0.029-0.086-0.053-0.131-0.078  c-0.125-0.068-0.258-0.125-0.395-0.166c-0.037-0.01-0.07-0.025-0.107-0.035c-0.148-0.035-0.303-0.057-0.459-0.057H30.295  c-2.207,0-4,1.795-4,4v32.484h-2.449c-3.157,0-5.717,2.559-5.717,5.717v29.73c0,3.156,2.56,5.717,5.717,5.717h2.449v20.352  c0,2.205,1.793,4,4,4h66c2.205,0,4-1.795,4-4V90.128h2.449c3.157,0,5.717-2.561,5.717-5.717v-29.73  C108.461,51.522,105.902,48.964,102.745,48.964z M30.295,16.479h46.332v20.465c0,1.105,0.896,2,2,2h17.668v10.02h-66V16.479z   M75.177,78.098v5.801H56.093V53.35h6.937v24.748H75.177z M26.045,83.898l8.839-15.455L26.362,53.35h7.932l2.674,5.574  c0.907,1.857,1.587,3.355,2.313,5.076h0.089c0.727-1.949,1.315-3.309,2.085-5.076l2.584-5.574h7.887l-8.613,14.912l9.067,15.637  h-7.978l-2.765-5.529c-1.132-2.131-1.858-3.717-2.719-5.484h-0.091c-0.635,1.768-1.404,3.354-2.356,5.484l-2.539,5.529H26.045z   M96.295,109.396h-66V90.128h66V109.396z M86.733,84.354c-3.489,0-6.935-0.908-8.656-1.859l1.404-5.711  c1.859,0.951,4.715,1.904,7.661,1.904c3.174,0,4.85-1.314,4.85-3.309c0-1.904-1.45-2.992-5.122-4.307  c-5.076-1.768-8.386-4.578-8.386-9.021c0-5.213,4.352-9.201,11.561-9.201c3.443,0,5.982,0.727,7.795,1.541l-1.541,5.576  c-1.224-0.59-3.4-1.451-6.391-1.451s-4.441,1.359-4.441,2.947c0,1.949,1.721,2.811,5.665,4.307c5.393,1.994,7.932,4.803,7.932,9.109  C99.063,80.002,95.12,84.354,86.733,84.354z",onclick:function(e,t){_.isUndefined(window.$$dlut_echart_timeout)||(window.$$dlut_echart_timeout=!0);var a=$(t.getDom()).attr("name"),r=transForEXCEL(window.$$EXCEL[a]),n=XLSX.utils.json_to_sheet(r),i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,n,"sheet1"),XLSX.writeFile(i,a+".xlsx")}}}},tooltip:{trigger:"axis",confine:!0},legend:{x:"left",itemWidth:15,itemHeight:10}},CBoardEChartRender=function(e,t,a,r){this.container=e;var n=this.container.attr("name");this.ecc=echarts.init(e.get(0),this.theme),window.$$dlut_renders||(window.$$dlut_renders={}),
"undefined"==typeof n&&t&&"undefined"!=typeof t.wName&&(n=t.wName),window.$$dlut_renders[n]=this,this.isDeppSpec=a,this.basicOption=echartsBasicOption,t&&(t.wName=n),this.wName=n,this.options=t,this.themeFunList=r};CBoardEChartRender.prototype.theme="theme-fin1",CBoardEChartRender.prototype.chart=function(e,t,a){var r=this,n=1==this.isDeppSpec?r.options:$.extend(!0,{},r.basicOption,r.options);return void 0!=n.visualMap&&$(this.jqContainer).css({height:"500px",width:"100%"}),n.legend.data&&n.legend.data.length>35&&(n.grid.top="5%",n.legend.show=!1),t&&(n.animation=!1),r.ecc.setOption(n),n.wName=r.wName,r.options=n,r.changeSize(r.ecc),r.container.resize(function(e){r.ecc.resize(),r.changeSize(r.ecc)}),e&&(r.ecc.group=e,echarts.connect(e)),t&&setTimeout(function(){r.container.css("background","#fff"),html2canvas(r.container[0],{onrendered:function(e){t.data=e.toDataURL("image/jpeg"),t.type="jpg"}})},1e3),a.trigger("$ready",{wName:r.wName}),function(e){e=$.extend(!0,{},r.basicOption,e),r.options=e,e.wName=r.wName,r.ecc.setOption(e,!0),a.trigger("$ready",{wName:r.wName})}},CBoardEChartRender.prototype.changeSize=function(e){var t=e.getOption(),a=t.series[0]?t.series[0].type:null;if("pie"==a){for(var r=t.series.length,n=(e.getWidth()/(r+1+8*r),0);n<r;n++)t.series[n].xRadius?t.series[n].radius=[t.series[n].xRadius[0],t.series[n].xRadius[1]]:t.series[n].radius=[0,"75%"];e.setOption(t)}};var CBoardEChartRenderEventInfo=function(e,t,a){if(0==e.length)return[];var r=e.chartConfig,n=e.keys,i=e.originalData.data,o=e.originalData.columnList,s=e.chartConfig.drillTier,l=[];if(void 0!=a&&void 0!=r.keys)for(var c=0;c<r.keys.length;c++)r.keys[c].drillDown&&n[a]?l.push({col:r.keys[c].drillDown[s.keyTier].col,alias:r.keys[c].drillDown[s.keyTier].alias,value:n[a][c]}):n[a]&&l.push({col:r.keys[c].col,alias:r.keys[c].alias,value:n[a][c]});if(void 0!=t&&void 0!=r.groups)for(var c=0;c<r.groups.length;c++)r.groups[c].drillDown&&e.series[t]?l.push({col:r.groups[c].drillDown[s.groupTier].col,alias:r.groups[c].drillDown[s.groupTier].alias,value:n[a][c]}):e.series[t]&&l.push({col:r.groups[c].col,alias:r.groups[c].alias,value:e.series[t][c]});if(void 0!=t&&void 0!=r.events&&l.length>0)for(var d=l[0],c=0;c<r.events.length;c++){for(var u=r.events[c].col,f=0,p=0,g=0;g<o.length;g++)if(o[g].name==u){f=g;break}for(var g=0;g<o.length;g++)if(o[g].name==d.col){p=g;break}for(var g=0;g<i.length;g++){var m=i[g];if(m[p]==d.value){l.push({col:r.events[c].col,alias:r.events[c].alias,value:m[f]});break}}}return l};String.prototype.render=function(e){return render(this,e)};var CBoardKpiRender=function(e,t){this.container=e,this.options=t};CBoardKpiRender.prototype.html=function(e){var t=this,a=""+t.template,r=a.render(t.options);return e&&setTimeout(function(){t.container.css("background","#fff"),html2canvas(t.container,{onrendered:function(t){e.data=t.toDataURL("image/jpeg"),e.type="jpg"}})},1e3),r},CBoardKpiRender.prototype.realTimeTicket=function(){var e=this;return function(t){$(e.container).find("h3").html(t.kpiValue)}},CBoardKpiRender.prototype["do"]=function(){var e=this;$(e.container).html(e.rendered())},CBoardKpiRender.prototype.template="<div class='small-box kpi {align}'>         <div class='kpiOut'>           <div class='inner'>                    <h3 class='{style}'>{kpiValue}<span class='unit'>{unit}</span></h3>                    <p class='{style}'>{kpiName}</p>                </div>                <div class='icon'>                    <i class='{icon} {style}'></i>                </div>             </div>        </div>";var CBoardTableRender=function(e,t,a){this.container=e,this.options=t,this.tall,this.drill=a;var r=this;$(this.container).resize(function(e){r.resize(e.target)})};CBoardTableRender.prototype.resize=function(e){var t=$(e).find(".table_wrapper"),a=$(e).parents(".box"),r=a.height()-a.children(".box-header").height();0===r?r=500:r,$(e).find(".tableView").css("max-height",r+"px"),$(e).css("height",r),t.css("width","auto"),t.width()<$(e).width()&&t.css("width","100%")},CBoardTableRender.prototype["do"]=function(e,t,a,r){this.tall=e,this.type=r,e=_.isUndefined(e)?500:e;var n=this,i=function(e,t,r){(_.isUndefined(n.options.chartConfig.option.groupSort)||_.isNull(n.options.chartConfig.option.groupSort)||n.options.chartConfig.option.groupSort)&&!n.options.chartConfig.option.stopMerge&&(n.prevOptions.keys=n.options.chartConfig.keys),n.options=e,n.drill.config=t,n["do"](n.tall,null,a,r)};this.options.chartConfig.crossTable={},this.options.chartConfig.crossTable.drill=this.drill,this.options.chartConfig.crossTable.render=i,(_.isUndefined(this.options.chartConfig.option.groupSort)||_.isNull(this.options.chartConfig.option.groupSort)||this.options.chartConfig.option.groupSort)&&!this.options.chartConfig.option.stopMerge&&(_.isUndefined(this.prevOptions)?this.prevOptions={prevData:groupSort(this.options,this,r)}:this.prevOptions.prevData=groupSort(this.options,this,r),this.options.data=sortByPrev(this.options,this,r));var o=void 0;if(this.options.chartConfig&&this.options.chartConfig.option&&this.options.chartConfig.option.optionCode){o=n.options.chartConfig.option.optionCode;try{var s=angular.copy(window.$$dlut_param);n.options=new Function("option,param","return ("+o+")(option,param)")(n.options,s)}catch(l){console.error("option自定义计算错误",n.options,l)}}var c={tall:e,chartConfig:this.options.chartConfig,data:this.options.data,container:this.container,drill:this.drill,oData:this.options.originalData,render:i,wName:this.options.wName,EventService:a};return crossTable.table(c),$(this.container).css({height:e+"px"}),this.resize(this.container),t&&(t.data=this.options.data,t.type="table"),i};var CBoardMapRender=function(e,t,a){this.options=t,this.tall,this.jqContainer=e,this.drill=a;var r=this;$(e).html("<div class='map_wrapper'></div>"),$(".map_wrapper").resize(function(){r["do"](r.tall)})};CBoardMapRender.prototype["do"]=function(e,t){this.tall=e,this.container=this.jqContainer,e=_.isUndefined(e)?500:e;var a={height:e-20,chartConfig:this.options.chartConfig,data:this.options.data,container:this.container,drill:this.drill};threeLevelMap.map(a),$(this.jqContainer).css({height:e+40+"px",width:"100%"}),$(this.container).css({height:e+"px",width:"100%"});var r=this;return t&&setTimeout(function(){html2canvas(r.container[0],{onrendered:function(e){t.data=e.toDataURL("image/jpeg"),t.type="jpg"}})},1e3),function(e){r.options=e,r["do"](r.tall)}};var CBoardFlexRender=function(e,t){this.container=e,this.options=t};CBoardFlexRender.prototype.html=function(e){var t=this.options,a=template.compile(t.template),r=a({list:t.data});return r},CBoardFlexRender.prototype.initialize=function(e,t,a,r){var n=this;return this.uuid=r,this.draw(e),function(e){n.draw(e)}},CBoardFlexRender.prototype.draw=function(e){this.options=e;var t=this.html();this.container.prop("id","flex_"+this.uuid),this.container.html(t)};var CBoardFlex2Render=function(e,t){this.container=e,this.options=t};CBoardFlex2Render.prototype.html=function(persist,scope,$compile){var option=this.options,render=$compile(option.template);scope.list=option.data,scope.params=$$dlut_param;var $scope=scope;if(option.code)try{var code=eval(option.code);if("undefined"!=typeof code)for(var key in code)$scope[key]=code[key]}catch(error){console.log("flex error",error)}var html=render(scope);return html},CBoardFlex2Render.prototype.initialize=function(e,t,a,r,n,i){var o=this;return this.uuid=r,this.scope=a,this.$compile=n,a.EventService=t,this.scope.$$apply=a.$apply,a.click=function(e,r){t.trigger("CE:click",{widget:a.widget,param:{data:{eventInfo:[{col:e,value:r}]}}}),t.trigger("CE:drillDown",{widget:a.widget,param:{data:{eventInfo:[{col:e,value:r}]}}})},a.clickMore=function(e){for(var r=[],n=0;n<e.length;n++)r.push({col:e[n].col,value:e[n].value});t.trigger("CE:click",{widget:a.widget,param:{data:{eventInfo:r}}})},a.gotoScreen=function(e,a){if("undefined"==typeof a&&(a={}),"undefined"!=typeof e){var r=[];for(var n in a){var i=a[n];r.push({column:n,type:"=",values:"string"==typeof i?[i]:i})}t.trigger("WS:screenSkip",{target:e,param:r},"all")}},a.filter=function(e){"undefined"==typeof e&&(e={});var a=[];for(var r in e){var n=e[r];a.push({column:r,type:"=",values:"string"==typeof n?[n]:n})}t.trigger("CE:filter",a)},this.draw(e,i),function(e){o.draw(e,i)}},CBoardFlex2Render.prototype.draw=function(e,t){this.scope.flex2_destroy&&this.scope.flex2_destroy.apply(this.scope),this.options=e;var a=this.html(void 0,this.scope,this.$compile,t);this.container.prop("id","flex_"+this.uuid),this.container.html(a),this.scope.flex2_created&&this.scope.flex2_created.apply(this.scope)};var CBoardDataLineTableRender=function(e,t){this.container=e,this.options=t};CBoardDataLineTableRender.prototype.html=function(e,t,a){var r="<table id = "+a+" class='display table-bordered table-inverse' width='100%'></table>";return r},CBoardDataLineTableRender.prototype.initialize=function(e,t,a,r,n){for(var i=[],o=[],s=0;s<e.chartConfig.keys.length;s++){var l=e.chartConfig.keys[s];1!=l.hide?i.push(l):o.push(l.col)}if(o.length>0&&(e.chartConfig.keys=i,e.data.length>0)){for(var c=[],s=0;s<e.data.length;s++){for(var d=[],u=0;u<e.data[s].length;u++){var f=!1;if(e.data[s][u]&&e.data[s][u].column_header_header)for(var p=0;p<o.length;p++)if(e.data[s][u].data==o[p]){f=!0;break}f||"undefined"==typeof e.data[s][u]||d.push(e.data[s][u])}c.push(d)}e.data=c}for(var g=$("#"+n),m=[],h=[],s=0;s<e.chartConfig.keys.length;s++){var v=e.chartConfig.keys[s].alias?e.chartConfig.keys[s].alias:e.chartConfig.keys[s].col;m.push(v)}if(!_.isUndefined(e.seriesConfig))for(var y in e.seriesConfig)m.push(y);for(var s=0;s<m.length;s++)h.push({title:m[s]});var w={sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配的结果",sInfo:"显示第 _START_ 至 _END_ 项结果,共 _TOTAL_ 项",sInfoEmpty:"显示第0至0项结果,共0项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:"以升序排列此列",sSortDescending:"以降序排列此列"}},b="<'dt-toolbar'<'col-xs-12 col-sm-6'f><'col-sm-6 col-xs-6 hidden-xs'C>r>t",C=10;e.chartConfig.option.size&&(C=e.chartConfig.option.size);var I=[];if(e.chartConfig.option.colWidth){I=e.chartConfig.option.colWidth.split(",");for(var s=0;s<h.length;s++)I[s]&&(h[s].sWidth=I[s])}var x=e.dataList.length>C;e.chartConfig.option.showPage&&(x=e.chartConfig.option.showPage),x&&(b+="<'dt-toolbar-footer'<'col-sm-5 col-xs-12 hidden-xs'i><'col-sm-7 col-xs-12'p>>");var N={data:e.dataList,columns:h,language:w,autoWidth:!0,sDom:b,ordering:!0,bFilter:!1,lengthMenu:[C],paging:x,bLengthChange:x,columnDefs:colunmsRender(e)};a&&(N.scrollY=0),g.DataTable(N);var T=g.DataTable(),D=this;return $("#"+n+" tbody").on("click","tr",function(){var e=T.row(this).data(),a=[];if(m.length==e.length)for(var r=0;r<m.length;r++)a.push({col:m[r],value:e[r]});var n={data:{eventInfo:a},name:""};t.trigger("CE:click",{widget:D.widget,param:n}),t.trigger("CE:drillDown",{widget:D.widget,param:n})}),$("#"+n+" tbody").on("resize",function(e){}),function(e){var t=g.dataTable();t&&(t.api().clear(),t.api().rows.add(e.dataList),t.api().draw())}},CBoardDataLineTableRender.prototype.setWidget=function(e){this.widget=e};var colunmsRender=function(e){for(var t=e.chartConfig.keys,a=[],r=function(r){var n={targets:r,render:null,className:"dataTable-"+t[r].align,orderable:!0};if(!_.isUndefined(t[r].dataStyle))switch(t[r].dataStyle.type){case"bar":var i=_.max(e.dataList,function(e){if(parseInt(e[r])){var t=parseInt(e[r]);return t}});n.render=function(e,t,a,n){if(!parseInt(e))return e;var o='<div class="progress" style="margin-bottom: 0px"><div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:'+toPercent(e/i[r])+'">'+e+"</div> </div>";return o};break;case"percent":n.render=function(e,a,n,i){if(!parseInt(e))return e;var o='<a style="color: red;">'+e+"</a>";return toPoint(e)>t[r].dataStyle.num&&(o='<a style="color: green">'+e+"</a>"),o};break;case"updown":n.render=function(e,t,a,r){if(!parseInt(e))return e;var n="<a>"+e+'<i class="fa fa-arrow-up" aria-hidden="true" style="color: green; margin-left: 5px"></i></a>';return parseInt(e)<0&&(n="<a>"+e+'<i class="fa fa-arrow-down" aria-hidden="true" style="color: red; margin-left: 5px"></i></a>'),n}}a.push(n)},n=0;n<t.length;n++)r(n);return a},toPercent=function(e){var t=Number(100*e).toFixed(1);return t+="%"},toPoint=function(e){var t=e.replace("%","");return t=parseInt(t/100)},CBoardGanttRender=function(e,t){this.container=e,this.options=t};CBoardGanttRender.prototype.html=function(e,t,a){var r="<div class='row'><div class='col-sm-12'><div class='pull-right ganttBtnGroup'><button onClick='ganttFun.zoomToFit()' class='btn btn-success'><i class='fa-search-minus fa'></i>自动缩放</button><button onClick='ganttFun.setScaleConfig(\"day\")' class='btn btn-default'>天</button><button onClick='ganttFun.setScaleConfig(\"week\")' class='btn btn-default'>周</button><button onClick='ganttFun.setScaleConfig(\"month\")' class='btn btn-default'>月</button><button onClick='ganttFun.setScaleConfig(\"year\")' class='btn btn-default'>年</button></div></div></div><div id = "+a+" style='width:100%; height:100%;' class='gantt'></div>";return r},CBoardGanttRender.prototype.initialize=function(e,t,a,r,n){var i=e.newList,o={data:[],links:[]},s=["id","text","duration","progress","open","parent","state"];if(i&&_.isArray(i))for(var l=0;l<i.length;l++){var c={};c.start_date=i[l].start_date.split("-").reverse().join("-");for(var d in s){var u=s[d];c[u]=i[l][u]}c.duration=parseFloat(c.duration),c.progress=parseFloat(c.progress),"-"!=c.parent&&""!=c.parent||(c.parent=void 0),o.data.push(c)}gantt.config.subscales=[{unit:"month",step:1,date:"%Y年%M"}],gantt.templates.task_class=function(e,t,a){return 1==a.progress?"gantt_project":""},gantt.templates.task_text=function(e,t,a){var r=100*a.progress;return 100==r?a.text+"(已完成)":a.text+"("+r+"%)"},gantt.config.date_scale="%d日",gantt.config.readonly=!0,gantt.config.drag_links=!1,gantt.config.drag_move=!1,gantt.templates.tooltip_text=function(e,t,a){return"<b>项目名称:</b> "+a.text+"<br/><b>开始时间:</b> "+gantt.templates.tooltip_date_format(e)+"<br/><b>结束时间:</b> "+gantt.templates.tooltip_date_format(t)+"<br/><b>说明:</b>"+a.state},gantt.config.grid_width=500,gantt.config.scale_height=100,gantt.config.columns=[{name:"text",label:"项目名称",tree:!0,width:"200",align:"center"},{name:"start_date",label:"开始时间",width:"130",align:"center"},{name:"duration",label:"持续时间",width:"130",align:"center"},{name:"add"}],gantt.config.grid_resize=!0,_.isUndefined(window.ganttFun)&&(window.ganttFun={scaleConfigs:[{unit:"minute",step:1,scale_unit:"hour",date_scale:"%H",subscales:[{unit:"minute",step:1,date:"%H:%i"}]},{unit:"hour",step:1,scale_unit:"day",date_scale:"%M %j",subscales:[{unit:"hour",step:1,date:"%H:%i"}]},{unit:"day",step:1,scale_unit:"month",date_scale:"%F",subscales:[{unit:"day",step:1,date:"%j"}]},{unit:"week",step:1,scale_unit:"month",date_scale:"%F",subscales:[{unit:"week",step:1,template:function(e){var t=gantt.date.date_to_str("%M%d日"),a=gantt.date.add(gantt.date.add(e,1,"week"),-1,"day");return t(e)+" - "+t(a)}}]},{unit:"month",step:1,scale_unit:"year",date_scale:"%Y",subscales:[{unit:"month",step:1,date:"%M"}]},{unit:"month",step:3,scale_unit:"year",date_scale:"%Y",subscales:[{unit:"month",step:3,template:function(e){var t=gantt.date.date_to_str("%M"),a=gantt.date.add(gantt.date.add(e,3,"month"),-1,"day");return t(e)+" - "+t(a)}}]},{unit:"year",step:1,scale_unit:"year",date_scale:"%Y",subscales:[{unit:"year",step:5,template:function(e){var t=gantt.date.date_to_str("%Y"),a=gantt.date.add(gantt.date.add(e,5,"year"),-1,"day");return t(e)+" - "+t(a)}}]},{unit:"year",step:10,scale_unit:"year",template:function(e){var t=gantt.date.date_to_str("%Y"),a=gantt.date.add(gantt.date.add(e,10,"year"),-1,"day");return t(e)+" - "+t(a)},subscales:[{unit:"year",step:100,template:function(e){var t=gantt.date.date_to_str("%Y"),a=gantt.date.add(gantt.date.add(e,100,"year"),-1,"day");return t(e)+" - "+t(a)}}]}],getUnitsBetween:function(e,t,a,r){for(var n=new Date(e),i=new Date(t),o=0;n.valueOf()<i.valueOf();)o++,n=gantt.date.add(n,r,a);return o},zoomToFit:function(){for(var e=gantt.getSubtaskDates(),t=gantt.$task.offsetWidth,a=0;a<ganttFun.scaleConfigs.length;a++){var r=this.getUnitsBetween(e.start_date,e.end_date,ganttFun.scaleConfigs[a].unit,ganttFun.scaleConfigs[a].step);if((r+2)*gantt.config.min_column_width<=t)break}a==ganttFun.scaleConfigs.length&&a--,ganttFun.applyConfig(ganttFun.scaleConfigs[a],e),gantt.render()},applyConfig:function(e,t){gantt.config.scale_unit=e.scale_unit,e.date_scale?(gantt.config.date_scale=e.date_scale,gantt.templates.date_scale=null):gantt.templates.date_scale=e.template,gantt.config.step=e.step,gantt.config.subscales=e.subscales,t?(gantt.config.start_date=gantt.date.add(t.start_date,-1,e.unit),gantt.config.end_date=gantt.date.add(gantt.date[e.unit+"_start"](t.end_date),2,e.unit)):gantt.config.start_date=gantt.config.end_date=null},setScaleConfig:function(e){switch(e){case"day":gantt.config.scale_unit="day",gantt.config.step=1,gantt.config.date_scale="%M%d日",gantt.config.subscales=[],gantt.config.scale_height=27,gantt.templates.date_scale=null;break;case"week":var t=function(e){var t=gantt.date.date_to_str("%M%d日"),a=gantt.date.add(gantt.date.add(e,1,"week"),-1,"day");return t(e)+" - "+t(a)};gantt.config.scale_unit="week",gantt.config.step=1,gantt.templates.date_scale=t,gantt.config.subscales=[{unit:"day",step:1,date:"%D"}],gantt.config.scale_height=50;break;case"month":gantt.config.scale_unit="month",gantt.config.date_scale="%Y%F",gantt.config.subscales=[{unit:"day",step:1,date:"%j(%D)"}],gantt.config.scale_height=50,gantt.templates.date_scale=null;break;case"year":gantt.config.scale_unit="year",gantt.config.step=1,gantt.config.date_scale="%Y",gantt.config.min_column_width=50,gantt.config.scale_height=90,gantt.templates.date_scale=null,gantt.config.subscales=[{unit:"month",step:1,date:"%M"}]}gantt.render()}}),gantt.init(n),gantt.parse(o),gantt.addMarker({start_date:new Date,css:"today",text:"今天"}),window.ganttFun.zoomToFit(),this.newData=o;var f=this;return gantt.attachEvent("onTaskClick",function(a,r){var n=null;if(f.newData&&f.newData.data)for(var i=0;i<f.newData.data.length;i++)if(f.newData.data[i].id==a){n=f.newData.data[i];break}var o=[];e.chartConfig.keys[0].col&&e.chartConfig.keys[4].col&&o.push({col:e.chartConfig.keys[0].col,value:a},{col:e.chartConfig.keys[4].col,value:n.text});var s={data:{eventInfo:o},name:""};return t.trigger("CE:click",{widget:f.widget,param:s}),t.trigger("CE:drillDown",{widget:f.widget,param:s}),gantt.render(),!0}),$("#"+n).on("resize",function(e){gantt.render()}),gantt.render(),function(e){var t=e.newList,a={data:[],links:[]},r=["id","text","duration","progress","open","parent","state"];if(t&&_.isArray(t))for(var n=0;n<t.length;n++){var i={};i.start_date=t[n].start_date.split("-").reverse().join("-");for(var o in r){var s=r[o];i[s]=t[n][s]}i.duration=parseFloat(i.duration),i.progress=parseFloat(i.progress),"-"!=i.parent&&""!=i.parent||(i.parent=void 0),a.data.push(i)}this.newData=a,gantt.clearAll(),gantt.parse(a),gantt.render()}},CBoardGanttRender.prototype.setWidget=function(e){this.widget=e};var CBoardDataTableRender=function(e,t){this.container=e,this.options=t,this.chartType="crossTable"};CBoardDataTableRender.prototype.html=function(e,t){var a="<table id = "+e+" class='display table-bordered table-inverse' width='100%'>"+htmlRender(this.options,e)+"</table>";return a},CBoardDataTableRender.prototype.initialize=function(e,t,a,r){for(var n=[],i=[],o=0;o<e.chartConfig.keys.length;o++){var s=e.chartConfig.keys[o];1!=s.hide?n.push(s):i.push(s.col)}if(i.length>0&&(e.chartConfig.keys=n,e.data.length>0)){for(var l=[],o=0;o<e.data.length;o++){for(var c=[],d=0;d<e.data[o].length;d++){var u=!1;if(e.data[o][d]&&e.data[o][d].column_header_header)for(var f=0;f<i.length;f++)if(e.data[o][d].data==i[f]){u=!0;break}u||"undefined"==typeof e.data[o][d]||c.push(e.data[o][d])}l.push(c)}e.data=l}var p=$("#"+a),g={sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配的结果",sInfo:"显示第 _START_ 至 _END_ 项结果,共 _TOTAL_ 项",sInfoEmpty:"显示第0至0项结果,共0项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:"以升序排列此列",sSortDescending:"以降序排列此列"}},m="<'dt-toolbar'<'col-xs-12 col-sm-6'f><'col-sm-6 col-xs-6 hidden-xs'C>r>t",h=10;e.chartConfig.option.size&&(h=e.chartConfig.option.size);var v=[];e.chartConfig.option.colWidth&&(v=e.chartConfig.option.colWidth.split(","));var y=e.dataList.length>h;e.chartConfig.option.showPage&&(y=e.chartConfig.option.showPage),y&&(m+="<'dt-toolbar-footer'<'col-sm-5 col-xs-12 hidden-xs'i><'col-sm-7 col-xs-12'p>>");var _={data:e.dataList,language:g,autoWidth:!0,sDom:m,ordering:!1,bFilter:!1,lengthMenu:[h],paging:y,bLengthChange:y,headerCallback:function(e,t,a,r,n){},columnDefs:[{data:void 0,defaultContent:"-",targets:"_all",createdCell:function(e,t,a,r,n){0==n&&($(e).attr("data-type","key"),$(e).attr("data-name",t))}}]};t&&(_.scrollY=0),p.DataTable(_);var w=(p.DataTable(),this);return this.table=a,$("#"+a+" tbody").on("resize",function(e){}),function(e){var t=$("#"+w.table),a=t.dataTable();a&&(a.api().destroy(),t.empty(),t.html(htmlRender(e,w.table)),_.data=e.dataList,_.aaData=e.dataList,t.DataTable(_))}},CBoardDataTableRender.prototype.setWidget=function(e){this.widget=e};var CBoardCrossGreatRender=function(e,t){this.container=e,this.options=t,this.chartType="crossGreatTable"};CBoardCrossGreatRender.prototype.html=function(e,t){var a='<table id = "'+e+'" class="display table-bordered table-inverse bootstrap_table" width="100%">';return a+=theadRender(t),a+="</table>"},CBoardCrossGreatRender.prototype.initialize=function(e,t,a,r){var n=$("#"+a);return n.bootstrapTable({data:e.tableData}),function(e){n.bootstrapTable("destroy"),n.empty(),n.html(theadRender(e)),n.bootstrapTable({data:e.tableData})}},CBoardCrossGreatRender.prototype.setWidget=function(e){this.widget=e};var CBoardSelectorRender=function(e,t){this.container=e,this.options=t,this.chartType="selector"};CBoardSelectorRender.prototype.html=function(e){var t=e.chartConfig.keys,a='<div id="multipleSelectContainer" class="flex-row">';return _.each(t,function(e,t){var r=e.showName?e.showName:e.col?e.col:e.column,n=e.eventName?e.eventName:"event";e.colNoDot=e.col?e.col.replace(".","__"):e.column.replace(".","__"),a+='<div class="flex1"><h5>'+r+'</h5><div><select id="select_'+e.colNoDot+'" class="selector_multiple_simple dSelect ',e.isSingle&&(a+="isSingle "),a+='" multiple data-eventName="'+n+'" data-key="'+e.col+'" data-index="'+t+'" style="width: 100%"></select></div></div>'}),a+="</div>"},CBoardSelectorRender.prototype.initialize=function(e,t,a){var r=e.chartConfig.keys,n=e.groupSelects,i=e.originalData.columnList;return selectorRender(r,n,i,a,e),function(e,t,r,n){var i=e.chartConfig.keys,o=e.groupSelects,s=e.originalData.columnList;selectorRender(i,o,s,a,e)}};var CBoardTreeGridRender=function(e,t){this.container=e,this.options=t,this.chartType="treeGrid"};CBoardTreeGridRender.prototype.html=function(e,t){var a='<div id="'+t+'" style="width: 100%;height: 100%" class="treegrid"></div>';return a},CBoardTreeGridRender.prototype.setWidget=function(e){this.widget=e},CBoardTreeGridRender.prototype.initialize=function(e,t){var a=this,r=$("#"+t),n=e.chartConfig.keys[0],i=e.chartConfig.keys[0].drillDown,o=e.chartConfig.option,s=o.root?o.root:n.col,l=o.drillDownNum;a.treeGrid=r,a.width=0,a.height=0,(_.isUndefined(l)||l<0)&&(l=0),r.jqxTreeGrid(hierarchyColumn({width:r.parents(".box-content").width(),height:r.parents(".box-content").height(),sortable:o.isSort,pageable:o.isPageable,pageSizeMode:"root",pagerMode:"advanced",pageSize:o.pageSize?parseInt(o.pageSize):10,pageSizeOptions:["10","20","50"],virtualModeCreateRecords:function(t,n){var i={},c=[],d=0,u=angular.copy(e.chartConfig.keys).splice(1,parseInt(l));if(a.done=n,t){var f=function g(e){return d++,c.unshift(e[s]),e.parent&&g(e.parent),c};_.each(u,function(e){i[e.col]=t[e.col]});var p=f(t);r.trigger("expand",{record:t,option:o,tier:{list:p,tier:d},filters:i})}},virtualModeRecordCreating:function(e){e.level===i.length-1&&(e.leaf=!0)},columns:e.treeGrid.columns}));var c=getLocalData(e),d={dataType:"json",dataFields:e.treeGrid.fields,hierarchy:{keyDataField:{name:o.root},parentDataField:{name:o.parent}},id:"tree_item_id",localData:c},u=new $.jqx.dataAdapter(d);return u.dataBind(),a.done(u.records),function(e){var t=getLocalData(e),n={dataType:"json",dataFields:e.treeGrid.fields,hierarchy:{keyDataField:{name:o.root},parentDataField:{name:o.parent}},id:"tree_item_id",localData:t},i=new $.jqx.dataAdapter(n);i.dataBind(),a.done||r.jqxTreeGrid("clear"),a.done(i.records)}},function(exports){"use strict";var discovery=angular.module("discovery",["splitter","gridster","ui.router","angular-md5","dndLists","treeControl","ui.bootstrap","ngSanitize","ui.select","pascalprecht.translate","ui.ace","ngJsTree","daterangepicker","angular-cron-jobs","rzModule","uuid4","ngFileUpload","ngSanitize","ui.select","moment-picker"]);exports.H={PAGE:function(e){return"src/app/pages/"+e+".tpl.html"},CMPT:function(e){return"src/app/components/"+e+".tpl.html"},URL:function(e){return _.mapObject(e,function(e){return baseUrl+e})}},discovery.service("exports",function(){return{controller:function controller($scope,option){if(option){if(option.data)for(var name in option.data)$scope[name]=option.data[name];if(option.service)for(var _name in option.service)$scope[_name]=option.service[_name];if(option.methods)for(var _name2 in option.methods)$scope[_name2]=option.methods[_name2].bind($scope);if(option.utils)for(var _name3 in option.utils)$scope[_name3]=option.utils[_name3].bind(void 0);if(option.watch)for(var _name4 in option.watch){var fun=option.watch[_name4],target=void 0;try{target=eval("$scope."+_name4)}catch(err){}"undefined"!=typeof target&&("object"===("undefined"==typeof target?"undefined":_typeof(target))?$scope.$watchCollection(_name4,fun.bind($scope)):$scope.$watch(_name4,fun.bind($scope)))}var eventsDestroyList=[];if(option.events)for(var _name5 in option.events)eventsDestroyList.push($scope.$on(_name5,option.events[_name5].bind($scope)));option.created&&option.created.bind($scope)(),option.destroyed&&$scope.$on("$destroy",function(){option.destroyed.bind($scope)();for(var e=0;e<eventsDestroyList.length;e++)eventsDestroyList[e]()})}},service:function e(t){var e={};if(t.data)for(var a in t.data){var r=t.data[a];"function"==typeof r?e[a]=t.data[a].bind(e):e[a]=t.data[a]}if(t.actions)for(var n in t.actions){var i=t.actions[n];if("function"==typeof i)e[n]=i;else if("object"===("undefined"==typeof i?"undefined":_typeof(i)))for(var o in i)e[o]=i[o]}if(t.utils)for(var s in t.utils)e[s]=t.utils[s].bind(void 0);if(t.cached)for(var l in t.cached)e[l]=_.memoize(t.cached[l],function(){for(var e="",t=0;t<arguments.length;t++)e+="_"+arguments[t];return console.log("get Memoize",e),e}),e[l].clear=function(){console.log("clear Memoize");for(var e="",t=0;t<arguments.length;t++)e+="_"+arguments[t];delete this.cache[e]}.bind(e[l]),e[l].clearAll=function(){this.cache={}}.bind(e[l]);return t.created&&t.created.apply(e),e}}}),exports.discovery=discovery}(window),basePathUrl=getRootPath()+"/","http://localhost:4000/"!==basePathUrl&&(baseUrl=basePathUrl,socketUrl=basePathUrl),angular.module("discovery").constant("globalConfig",{api:{socket:socketUrl,baseUrl:baseUrl}}),angular.module("discovery").config(["$stateProvider",function(e){"ngInject";e.state("dashboard",{url:"/dashboard","abstract":!0,template:"<div ui-view></div>"}).state("mine",{url:"/mine","abstract":!0,template:"<div ui-view></div>"}).state("mine.view",{url:"/{id}",params:{id:null},templateUrl:"src/view/dashboard/view.html",controller:"dashboardViewCtrl"}).state("dashboard.category",{url:"/{category}",params:{category:null},"abstract":!0,template:"<div ui-view></div>"}).state("dashboard.category.view",{url:"/{id}",params:{id:null},templateUrl:"src/view/dashboard/view.html",controller:"dashboardViewCtrl"}).state("config",{url:"/config","abstract":!0,template:"<div ui-view></div>"}).state("config.board",{url:"/board",templateUrl:"src/view/config/board.html",controller:"boardCtrl"}).state("config.widget",{url:"/widget",params:{id:null},templateUrl:"src/view/config/widget.html",controller:"widgetCtrl"}).state("config.datasource",{url:"/datasource",templateUrl:"src/view/config/datasource.html",controller:"datasourceCtrl"}).state("config.category",{url:"/category",templateUrl:"src/view/config/category.html",controller:"categoryCtrl"}).state("config.dataset",{url:"/dataset",templateUrl:"src/view/config/dataset.html",controller:"datasetCtrl"}).state("config.model",{url:"/buildModel/{dataSourceId}",params:{dataSourceId:null,curDatasetId:null},templateUrl:"src/view/config/buildModel.html",controller:"buildModelCtrl"}).state("config.job",{url:"/job",templateUrl:"src/view/config/job.html",controller:"jobCtrl"}).state("config.role",{url:"/role",templateUrl:"src/view/config/shareResource.html",controller:"shareResCtrl"}).state("admin",{url:"/admin","abstract":!0,template:"<div ui-view></div>"}).state("admin.user",{url:"/user",templateUrl:"src/view/admin/user.html",controller:"userAdminCtrl"}).state("nv",{url:"/nv","abstract":!0,replace:!0,template:"<div ui-view></div>"}).state("nv.screen_menu",{url:"/screen/menu",templateUrl:"src/view/nv/screen/screen_menu.html",controller:"NvScreenMenuCtrl"}).state("nv.statistics",{url:"/statistics",templateUrl:"src/view/nv/statistics/index.html",controller:"NvStatisticsCtrl"}).state("nv.typeControl",{url:"/typeControl",templateUrl:"src/view/nv/typeControl/index.html",controller:"NvTypeControlCtrl"}).state("nv.datasource",{url:"/datasource",templateUrl:"src/view/nv/datasource/index.html",controller:"NvDataSourceCtrl"}).state("nv.explore_item",{url:"/explore/:id",templateUrl:"src/view/nv/explore/edit.html",controller:"nvExploreEditCtrl"}).state("nv.explore_create",{url:"/explore/create/new",templateUrl:"src/view/nv/explore/edit.html",controller:"nvExploreEditCtrl",params:{create:!0}}).state("nv.explore_create_by",{url:"/explore/create/by/:cube_id",templateUrl:"src/view/nv/explore/edit.html",controller:"nvExploreEditCtrl",params:{create:!0}}).state("nv.explore",{url:"/explore",templateUrl:"src/view/nv/explore/list.html",controller:"nvExploreListCtrl"}).state("home",{url:"",templateUrl:"src/view/nv/home/index.html",controller:"nvHomeCtrl"}).state("nv.knowledgegraph",{url:"/knowledge",templateUrl:"src/view/nv/knowledgeGraph/index.html",controller:function(){var e=document.getElementById("kg");e.setAttribute("src",ZSTP_URL)}}).state("nv.homepage",{url:"/home",templateUrl:"src/view/nv/home/index.html",controller:"nvHomeCtrl"}).state("nv.cube",{url:"/cube",templateUrl:"src/view/nv/cube/index.html",controller:"nvCubeCtrl"}).state("nv.cube_item",{url:"/cube/:id",templateUrl:"src/view/nv/cube/index.html",controller:"nvCubeCtrl"}).state("nv.cube_view",{url:"/cube_view",templateUrl:"src/view/nv/cube/index.html",controller:"nvCubeCtrl",params:{onlyView:!0}}).state("nv.neo_vis",{url:"/neo_vis",templateUrl:"src/view/nv/neo/index.html"}).state("nv.dashboard_panel",{url:"/dashboard_panel",controller:"nvDashboardPanelCtrl",templateUrl:"src/view/nv/dashboard/index.html"}).state("nv.mind",{url:"/mind/:id",controller:"nvJsMindCtrl",templateUrl:"src/view/nv/mind/index.html"}).state("nv.mind_list",{url:"/mind",controller:"nvJsMindListCtrl",templateUrl:"src/view/nv/mind/list.html"}).state("nv.dashboard",{url:"/dashboard/{category}",params:{category:null},"abstract":!0,template:"<div ui-view></div>"}).state("nv.dashboard.view",{url:"/{id}",params:{id:null,param:[],history:[],screenHistory:[],role:!1},templateUrl:"src/view/nv/dashboard/view.html",controller:"NvDashboardViewCtrl"
}).state("nv.dashboard.role_view",{url:"/{id}/{role}",params:{id:null,param:[],history:[],screenHistory:[],role:!1},templateUrl:"src/view/nv/dashboard/view.html",controller:"NvDashboardViewCtrl"}).state("nv.excel",{"abstract":!0,template:"<div ui-view></div>"}).state("nv.excel.upload",{url:"/excel/upload",templateUrl:"src/view/nv/excel/upload.html",controller:function(){}}).state("nv.share",{url:"/share",templateUrl:"src/view/nv/share/index.html",controller:"nvShareCtrl"}).state("docs",{"abstract":!0,template:"<div ui-view></div>"}).state("docs.analyse",{url:"/nv/docs/analyse",templateUrl:"src/view/nv/docs/analyse.html",controller:"NvDocsAnalyse"}).state("docs.result",{url:"/nv/docs/result/{widgetList}",params:{widgetList:null},templateUrl:"src/view/nv/docs/related/dataset.html",controller:"NvDocsWidgetCtrl"}).state("docs.related",{"abstract":!0,template:"<div ui-view></div>"}).state("docs.related.widget",{url:"/nv/docs/related/widget/{widgetId}",params:{widgetId:null},templateUrl:"src/view/nv/docs/related/widget.html",controller:"NvDocsRelatedWidgetCtrl"}).state("docs.related.dataset",{url:"/nv/docs/related/dataset/{datasetId}",params:{datasetId:null},templateUrl:"src/view/nv/docs/related/dataset.html",controller:"NvDocsWidgetCtrl"}).state("render",{url:"/render/:wid",params:{wid:null},templateUrl:"src/view/render/index.html",controller:"renderCtrl"}).state("chart",{url:"/chart/:wid",params:{wid:null},templateUrl:"src/view/nv/onlyChart/index.html",controller:"chartCtrl"})}]),angular.module("discovery").factory("sessionHelper",["$rootScope","$q",function(e,t){var a={responseError:function(a){return 2==a.data.status&&e.alert&&e.alert(a.data.msg),t.reject(a)}};return a}]),angular.module("discovery").factory("baseUrlHelper",["$q","globalConfig",function(e,t){var a={request:function(a){return 0!==a.url.indexOf("http")&&a.url.indexOf(".do")!==-1&&(a.url=t.api.baseUrl+a.url),a||e.when(a)}};return a}]),angular.module("discovery").config(["$httpProvider",function(e){"ngInject";e.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded",e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest=[function(e){var t=function a(e){var t,r,n,i,o,s,l,c="";for(t in e)if(r=e[t],r instanceof Array)for(var l=0;l<r.length;++l)o=r[l],n=t+"["+l+"]",s={},s[n]=o,c+=a(s)+"&";else if(r instanceof Object)for(i in r)o=r[i],n=t+"["+i+"]",s={},s[n]=o,c+=a(s)+"&";else void 0!==r&&null!==r&&(c+=encodeURIComponent(t)+"="+encodeURIComponent(r)+"&");return c.length?c.substr(0,c.length-1):c};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e}],e.interceptors.push("baseUrlHelper"),e.interceptors.push("sessionHelper")}]),angular.module("discovery").config(["$translateProvider","$translatePartialLoaderProvider",function(e,t){"ngInject";e.translations("cn",CB_I18N),e.preferredLanguage(settings.preferredLanguage)}]),angular.module("discovery").filter("trustAsResourceUrl",["$sce",function(e){"ngInject";return function(t){return e.trustAsResourceUrl(t)}}]),discovery.controller("discoveryCtrl",["$rootScope","$scope","$location","$http","$q","$filter","$uibModal","ModalUtils","menuDataService",function(e,t,a,r,n,i,o,s,l){"ngInject";var c=i("translate");e.alert=function(e){s.alert(e)};var d=function(){r.get("commons/getMenuList.do").success(function(e){t.menuList=e})},u=function(){r.get("dashboard/getCategoryList.do").success(function(e){t.categoryList=e})},f=function(){r.get("dashboard/getBoardList.do").success(function(e){t.boardList=e})};t.$on("boardChange",function(){f()}),t.$on("categoryChange",function(){u()}),t.isShowMenu=function(e){return!_.isUndefined(_.find(t.menuList,function(t){return t.menuCode==e}))},window.isPreview||(r.get("commons/getUserDetail.do").success(function(e){t.user=e;var a="imgs/user-male-circle-blue-128.png";t.user.avatar=a}),d(),u(),f()),t.changePwd=function(){o.open({templateUrl:"src/view/cboard/changePwd.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"sm",controller:["$scope","$uibModalInstance",function(e,t){e.close=function(){t.close()},e.ok=function(){r.post("commons/changePwd.do",{curPwd:e.curPwd,newPwd:e.newPwd,cfmPwd:e.cfmPwd}).success(function(e){"1"==e.status?(s.alert(c("COMMON.SUCCESS"),"modal-success","sm"),t.close()):s.alert(e.msg,"modal-warning","lg")})}}]})}}]),discovery.controller("menuItemCtrl",["$scope","$http","menuDataService",function(e,t,a){"ngInject";e.tree={name:"first",type:"first",id:"tree",children:[]},e.noFolder=new Array;var r=function(){t.get("dashboard/getBoardList.do").success(function(t){for(var r in t)a.buildTree(t[r],e.tree.children,e.noFolder)})};r()}]),function(){"use strict";function e(e,t,a,r){a.controller(e,{watch:_defineProperty({},"sql",function(){e.id&&e.sql&&t.get("dashboard/getTableListByDatasourceIdSql.do?datasourceId="+e.id+"&page="+e.page+"&step="+e.pageSize+"&sql="+e.sql).success(function(t){e.column=t.column,e.data=t.data,e.pageCount=t.pageCount,e.page=t.page})}),data:{pageSize:10,column:[],data:[],pageCount:null,page:1},created:function(){},methods:{pageChanged:function(a){e.page=a,t.get("dashboard/getTableListByDatasourceIdSql.do?datasourceId="+e.id+"&page="+e.page+"&step="+e.pageSize+"&sql="+e.sql).success(function(t){e.column=t.column,e.data=t.data,e.pageCount=t.pageCount,e.page=t.page})}},destroyed:function(){}})}e.$inject=["$scope","$http","exports","$attrs"],angular.module("discovery").directive("tableCtrl",function(){return{restrict:"EAC",replace:!0,transclude:!0,scope:{id:"@",sql:"@"},templateUrl:"src/common/table.tpl.html",controller:e}})}(),discovery.controller("dashboardViewCtrl",["$timeout","$rootScope","$scope","$state","$stateParams","$http","ModalUtils","chartService","$interval","$uibModal","dataService","$q",function(e,t,a,r,n,i,o,s,l,c,d,u){"ngInject";i.get("admin/isAdmin.do").success(function(e){a.isAdmin=e}),a.loading=!0,a.paramInit=0,i.get("dashboard/getDatasetList.do").success(function(e){a.datasetList=e,a.realtimeDataset={},a.datasetMeta={},a.intervals=[],a.datasetFilters={},a.widgetFilters={},a.load(!1)}),a.timelineColor=["bg-light-blue","bg-red","bg-aqua","bg-green","bg-yellow","bg-gray","bg-navy","bg-teal","bg-purple","bg-orange","bg-maroon","bg-black"];var f=function(){a.timeline=[];var e=void 0;_.each(a.board.layout.rows,function(t,r){return 0==r?void(a.timelineFilter=t):(t.show=!1,"parent"==t.node&&(e&&a.timeline.push(e),e=[],t.show=!0),void e.push(t))}),a.timeline.push(e)};a.openCloseParentNode=function(e){var t=_.find(e,function(e){return"parent"!=e.node&&e.show});t?_.each(e,function(e){"parent"!=e.node&&(e.show=!1,_.each(e.widgets,function(e){e.show=!1}))}):_.each(e,function(e){"parent"!=e.node&&(e.show=!0,_.each(e.widgets,function(e){e.show=!0}))})},a.openCloseNode=function(e){e.show?(e.show=!1,_.each(e.widgets,function(e){e.show=!1})):(e.show=!0,_.each(e.widgets,function(e){e.show=!0}))},i.post("admin/isConfig.do",{type:"widget"}).success(function(e){a.widgetCfg=e});var p=function(e,t){e.render=function(a,r,n){s.render(a,v(e.widget).data,r,n,t).then(function(t){e.realTimeTicket=t,e.loading=!1}),e.realTimeOption={optionFilter:r,scope:n}},e.modalRender=function(t,a,r){e.modalRealTimeTicket=s.render(t,v(e.widget).data,a,r),e.modalRealTimeOption={optionFilter:a,scope:r}}};t.$on("$stateChangeSuccess",function(e,t,r,n){"dashboardViewCtrl"==n.controller&&_.each(a.intervals,function(e){l.cancel(e)})}),a["export"]=function(){a.exportStatus||(a.exportStatus=!0,i({url:"dashboard/exportBoard.do?id="+n.id,method:"POST",headers:{"Content-type":"application/json"},responseType:"arraybuffer"}).success(function(e){var t=new Blob([e],{type:"application/vnd.ms-excel"}),r=URL.createObjectURL(t),n=$("<a><span class='forExcel'>下载excel</span></a>").attr("href",r);n.attr("download",a.board.name),$("body").append(n),$(".forExcel").click(),n.remove(),a.exportStatus=!1}).error(function(e,t,r,n){a.exportStatus=!1}))};var g,m=function(){_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){e.refresh&&e.refresh()})}),y()},h=function(e){y(),_.each(a.board.layout.rows,function(t){_.each(t.widgets,function(r){if(_.isUndefined(r.hasRole)||r.hasRole){p(r,e),r.loading=!0,"timeline"==a.board.layout.type?t.show&&(r.show=!0):r.show=!0;var n=r.widget.data,i=_.find(a.datasetList,function(e){return e.id==n.datasetId});i&&i.data.interval&&i.data.interval>0&&(a.intervalGroup[n.datasetId]||(a.intervalGroup[n.datasetId]=[],a.intervals.push(l(function(){m(),_.each(a.intervalGroup[n.datasetId],function(e){e()})},1e3*i.data.interval))),a.intervalGroup[n.datasetId].push(function(){try{r.show&&(s.realTimeRender(r.realTimeTicket,v(r.widget).data),r.modalRealTimeTicket&&s.realTimeRender(r.modalRealTimeTicket,v(r.widget).data,r.modalRealTimeOption.optionFilter,null))}catch(e){console.error(e)}}))}})})};a.load=function(e){a.paramInit=0,a.loading=!0,_.each(a.intervals,function(e){l.cancel(e)}),a.intervals=[],a.board&&_.each(a.board.layout.rows,function(e){_.each(e.widgets,function(e){e.show=!1})}),i.get("dashboard/getBoardData.do?id="+n.id).success(function(t){a.intervalGroup={},a.loading=!1,a.board=t,_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){e.paramType||(e.paramType="default")})}),g&&g(e),_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){a.paramInit++})}),"timeline"==a.board.layout.type&&f(),0==a.paramInit&&h(e),g=a.$on("paramInitFinish",function(t,r){a.paramInit--,0==a.paramInit&&h(e)})})};var v=function(e){return e.data.config.boardFilters=[],_.isUndefined(e.data.datasetId)?e.data.config.boardFilters=a.widgetFilters[e.id]:e.data.config.boardFilters=a.datasetFilters[e.data.datasetId],e},y=function(){a.widgetFilters=[],a.datasetFilters=[],_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){e.values.length<=0||_.each(e.col,function(t){var r={col:t.column,type:e.type,values:e.values};_.isUndefined(t.datasetId)?(a.widgetFilters[t.widgetId]||(a.widgetFilters[t.widgetId]=[]),a.widgetFilters[t.widgetId].push(r)):(a.datasetFilters[t.datasetId]||(a.datasetFilters[t.datasetId]=[]),a.datasetFilters[t.datasetId].push(r))})})})};a.applyParamFilter=function(){y(),_.each(a.board.layout.rows,function(e){_.each(e.widgets,function(e){try{s.realTimeRender(e.realTimeTicket,v(e.widget).data)}catch(t){console.error(t)}})}),w()},a.paramToString=function(e){return _.filter(_.map(e.params,function(e){return e.title}),function(e){return e&&e.length>0}).join("; ")},a.modalChart=function(e){c.open({templateUrl:"src/view/util/modal/chart.html",windowTemplateUrl:"src/view/util/modal/window.html",windowClass:"modal-fit",backdrop:!1,controller:["$scope","$uibModalInstance","chartService",function(t,a,r){t.widget=e,t.close=function(){a.close(),delete e.modalRealTimeTicket,delete e.modalRealTimeOption},t.render1=function(){e.modalRender($("#modal_chart"),function(e){e.toolbox={feature:{dataView:{show:!0,readOnly:!0},magicType:{type:["line","bar","stack","tiled"]},dataZoom:{show:!0},restore:{show:!0}}}},null)}}]})},a.modalTable=function(e){c.open({templateUrl:"src/view/util/modal/chart.html",windowTemplateUrl:"src/view/util/modal/window.html",windowClass:"modal-fit",backdrop:!1,controller:["$scope","$uibModalInstance","chartService",function(t,a,r){t.widget=e,t.close=function(){a.close()},t.render1=function(){e.modalRender($("#modal_chart"),null,null)}}]})},a.config=function(e){r.go("config.widget",{id:e.widget.id})},a.reload=function(t){t.show=!1,t.render=function(e,a,r){s.render(e,t.widget.data,a,r,!0).then(function(e){t.realTimeTicket=e,t.loading=!1}),t.realTimeOption={optionFilter:a,scope:r}},e(function(){t.loading=!0,t.show=!0})},i.get("dashboard/getBoardParam.do?boardId="+n.id).success(function(e){e?a.boardParams=JSON.parse(e.config):a.boardParams=[]}),a.newBoardParam=function(e){if(""!=e){var t={};_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){"slider"!=e.paramType&&(t[e.name]={type:e.type,values:e.values})})}),a.boardParams.unshift({name:e,params:t}),i.post("dashboard/saveBoardParam.do",{boardId:n.id,config:angular.toJson(a.boardParams)}).success(function(e){})}},a.deleteBoardParam=function(e){a.boardParams.splice(e,1),i.post("dashboard/saveBoardParam.do",{boardId:n.id,config:angular.toJson(a.boardParams)}).success(function(e){})},a.applyBoardParam=function(e){for(var t in e)_.each(a.board.layout.rows,function(a){_.each(a.params,function(a){a.name==t&&(a.type=e[t].type,a.values=e[t].values)})});a.applyParamFilter()};var w=function(){_.each(a.board.layout.rows,function(e){_.each(e.params,function(e){if("slider"!=e.paramType){var t;switch(e.type){case"=":case"≠":t=e.name+" "+e.type+" ("+e.values+")";break;case">":case"<":case"≥":case"≤":t=e.name+" "+e.type+" "+e.values;break;case"(a,b]":case"[a,b)":case"(a,b)":case"[a,b]":var a=e.type.split("a")[0],r=e.type.split("b")[1];t=e.name+" between "+a+e.values[0]+","+e.values[1]+r}e.title=e.values.length>0?t:void 0}})})}}]),discovery.controller("widgetCtrl",["$scope","$stateParams","$http","$uibModal","dataService","ModalUtils","updateService","$filter","chartService","$timeout",function(e,t,a,r,n,i,o,s,l,c){"ngInject";var d=s("translate"),u="dashboard/updateWidget.do";e.chart_types=[{name:d("CONFIG.WIDGET.CITYMAP"),value:"cityMap","class":"cCityMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.CITYMAP"),value:"zoneMap","class":"cZoneMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.CHORD"),value:"chord","class":"cChord",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.LINE_BAR"),value:"line","class":"cLine",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.LINE_BAR2"),value:"line2","class":"cLine",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.LINE_BAR3"),value:"line3","class":"cLine",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.SCATTER"),value:"scatter","class":"cScatter",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.SCATTER2"),value:"scatter2","class":"cScatter2",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.PIE"),value:"pie","class":"cPie",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.KPI"),value:"kpi","class":"cKpi",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.FUNNEL"),value:"funnel","class":"cFunnel",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.SANKEY"),value:"sankey","class":"cSankey",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.RADAR"),value:"radar","class":"cRadar",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.MAP"),value:"map","class":"cMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:d("CONFIG.WIDGET.GAUGE"),value:"gauge","class":"cGauge",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.WORD_CLOUD"),value:"wordCloud","class":"cWordCloud",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.TREE_MAP"),value:"treeMap","class":"cTreeMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.AREA_MAP"),value:"areaMap","class":"cAreaMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.HEAT_MAP_CALENDER"),value:"heatMapCalendar","class":"cHeatMapCalendar",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.HEAT_MAP_TABLE"),value:"heatMapTable","class":"cHeatMapTable",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.MARK_LINE_MAP"),value:"markLineMap","class":"cMarkLineMap",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:d("CONFIG.WIDGET.LIQUID_FILL"),value:"liquidFill","class":"cLiquidFill",row:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:d("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:d("CONFIG.WIDGET.TIPS_DIM_NUM_1")}],e.chart_types_status={line:!0,line2:!0,line3:!0,pie:!0,kpi:!0,table:!0,funnel:!0,sankey:!0,radar:!0,map:!0,scatter:!0,scatter2:!0,gauge:!0,wordCloud:!0,treeMap:!0,areaMap:!0,heatMapCalendar:!0,heatMapTable:!0,markLineMap:!0,liquidFill:!0,chord:!0,cityMap:!0,zoneMap:!0},e.value_series_types=[{name:d("CONFIG.WIDGET.LINE"),value:"line"},{name:d("CONFIG.WIDGET.BAR"),value:"bar"},{name:d("CONFIG.WIDGET.STACKED_BAR"),value:"stackbar"},{name:d("CONFIG.WIDGET.PERCENT_BAR"),value:"percentbar"},{name:d("CONFIG.WIDGET.ONE_LINE_BAR"),value:"oneLineBar"},{name:d("CONFIG.WIDGET.WATER_FALL"),value:"waterFall"}],e.value_aggregate_types=[{name:"sum",value:"sum"},{name:"count",value:"count"},{name:"avg",value:"avg"},{name:"max",value:"max"},{name:"min",value:"min"},{name:"distinct",value:"distinct"}],e.kpi_styles=[{name:d("CONFIG.WIDGET.AQUA"),value:"bg-aqua"},{name:d("CONFIG.WIDGET.RED"),value:"bg-red"},{name:d("CONFIG.WIDGET.GREEN"),value:"bg-green"},{name:d("CONFIG.WIDGET.YELLOW"),value:"bg-yellow"}],$.getJSON("plugins/FineMap/mapdata/citycode.json",function(t){e.provinces=t.provinces}),e.treemap_styles=[{name:d("CONFIG.WIDGET.RANDOM"),value:"random"},{name:d("CONFIG.WIDGET.MULTI"),value:"multi"},{name:d("CONFIG.WIDGET.BLUE"),value:"blue"},{name:d("CONFIG.WIDGET.RED"),value:"red"},{name:d("CONFIG.WIDGET.GREEN"),value:"green"},{name:d("CONFIG.WIDGET.YELLOW"),value:"yellow"},{name:d("CONFIG.WIDGET.PURPLE"),value:"purple"}],e.heatmap_styles=[{name:d("CONFIG.WIDGET.BLUE"),value:"blue"},{name:d("CONFIG.WIDGET.RED"),value:"red"},{name:d("CONFIG.WIDGET.GREEN"),value:"green"},{name:d("CONFIG.WIDGET.YELLOW"),value:"yellow"},{name:d("CONFIG.WIDGET.PURPLE"),value:"purple"}],e.heatmap_date_format=[{name:"yyyy-MM-dd",value:"yyyy-MM-dd"},{name:"yyyy/MM/dd",value:"yyyy/MM/dd"},{name:"yyyyMMdd",value:"yyyyMMdd"}],e.liquid_fill_style=[{name:d("CONFIG.WIDGET.CIRCLE"),value:"circle"},{name:d("CONFIG.WIDGET.PIN"),value:"pin"},{name:d("CONFIG.WIDGET.RECT"),value:"rect"},{name:d("CONFIG.WIDGET.ARROW"),value:"arrow"},{name:d("CONFIG.WIDGET.TRIANGLE"),value:"triangle"},{name:d("CONFIG.WIDGET.ROUND_RECT"),value:"roundRect"},{name:d("CONFIG.WIDGET.SQUARE"),value:"square"},{name:d("CONFIG.WIDGET.DIAMOND"),value:"diamond"}],e.configRule={chord:{keys:-1,groups:0,filters:-1,values:2},line:{keys:2,groups:-1,filters:-1,values:2},line2:{keys:2,groups:-1,filters:-1,values:2},line3:{keys:2,groups:-1,filters:-1,values:2},pie:{keys:2,groups:-1,filters:-1,values:2},kpi:{keys:0,groups:0,filters:-1,values:1},table:{keys:-1,groups:-1,filters:-1,values:-1},funnel:{keys:-1,groups:0,filters:-1,values:2},sankey:{keys:2,groups:2,filters:-1,values:1},radar:{keys:2,groups:-1,filters:-1,values:2},map:{keys:2,groups:-1,filters:-1,values:2},scatter:{keys:2,groups:-1,filters:-1,values:2},scatter2:{keys:2,groups:-1,filters:-1,values:2},gauge:{keys:0,groups:0,filters:-1,values:1},wordCloud:{keys:2,groups:0,filters:-1,values:1},treeMap:{keys:2,groups:0,filters:-1,values:1},areaMap:{keys:2,groups:-1,filters:-1,values:1},heatMapCalendar:{keys:1,groups:0,filters:-1,values:1},heatMapTable:{keys:-1,groups:-1,filters:-1,values:1},markLineMap:{keys:2,groups:2,filters:-1,values:1},liquidFill:{keys:0,groups:0,filters:-1,values:1}},e.loading=!1,e.toChartDisabled=!0,e.optFlag="",e.alerts=[],e.treeData=[];var f=[],p="widgetTreeID";e.datasource,e.widgetName,e.widgetCategory,e.widgetId,e.curWidget={},e.previewDivWidth=12,e.expressions=[],e.customDs=!1,e.loadFromCache=!0,e.filterSelect={},e.verify={widgetName:!0},e.params=[];var g=function(t){a.get("dashboard/getDatasetList.do").success(function(a){e.datasetList=a,t&&t()})};g(),a.get("dashboard/getDatasourceList.do").success(function(a){e.datasourceList=a,h(),m(function(){t.id&&e.editWgt(_.find(e.widgetList,function(e){return e.id==t.id}))})}),e.datasetGroup=function(e){return e.categoryName};var m=function(t){a.get("dashboard/getWidgetList.do").success(function(a){e.widgetList=a,t&&t(),e.searchNode()})},h=function(){a.get("dashboard/getWidgetCategoryList.do").success(function(t){e.categoryList=t,$("#widgetName").autocomplete({source:e.categoryList})})};e.editExp=function(t){var a,n=S(e.schema),o=e.value_aggregate_types,s=e.curWidget,l={expression:""};t?(l.expression=t.exp,l.alias=t.alias,a=function(e){t.exp=e.expression,t.alias=e.alias}):a=function(t){e.curWidget.expressions.push({type:"exp",exp:t.expression,alias:t.alias})},r.open({templateUrl:"src/view/config/modal/exp.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=l,e.curWidget=s,e.selects=n,e.aggregate=o,e.alerts=[],e.close=function(){t.close()},e.expAceOpt=expEditorOptions(n,o),e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.verify=function(){e.alerts=[];var t=verifyAggExpRegx(e.data.expression);e.alerts=[{msg:t.isValid?d("COMMON.SUCCESS"):t.msg,type:t.isValid?"success":"danger"}]},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void i.alert(d("CONFIG.WIDGET.ALIAS")+d("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.loadData=function(){e.toChartDisabled=!1,e.newConfig(),e.filterSelect={},g(function(){e.curWidget.expressions=[],y(),e.curWidget.filterGroups=[],v(),D()}),N()},e.newWgt=function(){e.curWidget={},e.curWidget.config={},e.curWidget.config.option={},e.curWidget.expressions=[],e.curWidget.filterGroups=[],e.curWidget.query={},e.datasource=null,e.widgetName=null,e.widgetCategory=null,e.widgetId=null,e.optFlag="new",e.customDs=!1,e.schema=null,b()};var v=function(){if(!e.customDs){var t=_.find(e.datasetList,function(t){return t.id==e.curWidget.datasetId}).data.filters;t&&_.each(t,function(t){e.curWidget.filterGroups.push(t)})}};e.isDsExpression=function(t){if(e.customDs)return!1;var a=_.find(e.datasetList,function(t){return t.id==e.curWidget.datasetId}).data.expressions,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)},e.isDsFilter=function(t){if(e.customDs)return!1;var a=_.find(e.datasetList,function(t){return t.id==e.curWidget.datasetId}).data.filters,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)};var y=function(){if(!e.customDs){var t=_.find(e.datasetList,function(t){return t.id==e.curWidget.datasetId}).data.expressions;t&&_.each(t,function(t){e.curWidget.expressions.push(t)})}},w=function(){e.$watch("curWidget.config.keys",x,!0),e.$watch("curWidget.config.groups",x,!0),e.$watch("curWidget.config.values",x,!0),e.$watch("curWidget.config.filters",x,!0),b()},b=function(){e.$watch("widgetName",C,!0),e.$watch("curWidget.datasetId",C,!0)},C=function(){e.alerts=[],e.verify={widgetName:!0}},I=function(){if(e.alerts=[],e.verify={widgetName:!0},!e.widgetName)return e.alerts=[{msg:d("CONFIG.WIDGET.WIDGET_NAME")+d("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={widgetName:!1},$("#widgetName").focus(),!1;if(0==e.customDs&&void 0==e.curWidget.datasetId)return e.alerts=[{msg:d("CONFIG.WIDGET.DATASET")+d("COMMON.NOT_EMPTY"),type:"danger"}],!1;if(1==e.customDs)for(var t=0;t<e.params.length;t++){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?d(s[0]):r,e.alerts=[{msg:"["+s+"]"+d("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0},x=function(){for(var t in e.chart_types_status){var a=e.configRule[t],r=e.curWidget.config,n=[];if(_.each(r.values,function(e){n=n.concat(e.cols)}),0==_.size(r.keys)&&0==_.size(r.groups)&&0==_.size(n))o=!1;else for(var i in a){var o=!0;if(2==a[i]?o="values"==i?_.size(n)>=1:_.size(r[i])>=1:a[i]!=-1&&(o="values"==i?_.size(n)==a[i]:_.size(r[i])==a[i]),!o){e.chart_types_status[t]=o;break}}e.chart_types_status[t]=o}};e.changeChart=function(t){if(e.chart_types_status[t]){var a=angular.copy(e.curWidget.config);switch(e.curWidget.config={},e.curWidget.config.option={},e.curWidget.config.chart_type=t,N(),e.curWidget.config.selects=a.selects,e.curWidget.config.keys=a.keys,e.curWidget.config.groups=a.groups,e.curWidget.config.values=[],e.curWidget.config.filters=a.filters,e.curWidget.config.chart_type){case"line":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"line2":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"line3":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"kpi":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="bg-aqua"});break;case"scatter":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<3;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"scatter2":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});break;case"gauge":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.styles=[{proportion:"0.2",color:"#228b22"},{proportion:"0.8",color:"#48b"},{proportion:"1",color:"#ff4500"}];break;case"areaMap":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="bg-aqua"});break;case"heatMapCalendar":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.dateFormat="yyyy-MM-dd",e.style="blue"});break;case"heatMapTable":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="blue"});break;case"liquidFill":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.animation="static",_.each(e.curWidget.config.values,function(e){e.style="circle"});break;case"markLineMap":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="bg-aqua"});break;default:e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})})}_.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){delete e.formatter})}),e.preview()}},e.newConfig=function(){switch(e.curWidget.config={},e.curWidget.config.option={},e.curWidget.config.chart_type="table",N(),e.curWidget.config.chart_type){case"line":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"line2":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"line3":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"pie":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"kpi":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"bg-aqua"}],e.curWidget.config.filters=new Array;break;case"table":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"funnel":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"sankey":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"radar":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"map":e.curWidget.config.selects=angular.copy(e.columns),
e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"gauge":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array,e.curWidget.config.styles=[{proportion:"0.2",color:"#228b22"},{proportion:"0.8",color:"#48b"},{proportion:"1",color:"#ff4500"}];break;case"areaMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"heatMapCalendar":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],dateFormat:"yyyy-MM-dd",style:"blue"}];break;case"heatMapTable":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"blue"}],e.curWidget.config.filters=new Array;break;case"markLineMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"liquidFill":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"circle"}],e.curWidget.config.filters=new Array,e.curWidget.config.animation="static"}w()};var N=function(){$("#preview_widget").html(""),$("#viewQuery_widget").html(""),e.viewQueryMoal=!1};e.previewQuery=function(){$("#viewQuery_widget").html(""),c(function(){angular.element("#viewQuery_widget_tab").trigger("click")}),e.loadingPre=!0,n.viewQuery({config:e.curWidget.config,datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId},function(t){var a=t.trim().replace(/\n/g,"<br/>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");$("#viewQuery_widget").html("<div class='alert alert-info' role='alert' style='text-align: left;'><p style='color: black'>"+a+"</p></div>"),e.loadingPre=!1,e.viewQueryMoal=!0})},e.preview=function(){$("#preview_widget").html(""),c(function(){angular.element("#preview_widget_tab").trigger("click")}),e.loadingPre=!0,$("#preview_widget").html("<div id='preview' style='min-height: 300px; user-select: text;'></div>"),l.render($("#preview"),{config:e.curWidget.config,datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId},function(t){switch(e.curWidget.config.chart_type){case"line":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"line2":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"line3":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"pie":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"kpi":e.previewDivWidth=6;break;case"table":e.previewDivWidth=12;break;case"funnel":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"sankey":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"map":e.previewDivWidth=12;break;case"areaMap":e.previewDivWidth=12;break;case"markLineMap":e.previewDivWidth=12}e.loadingPre=!1},null,!e.loadFromCache)},e.add_value=function(){e.curWidget.config.values.push({name:"",series_type:"line",type:"value",cols:[]})},e.add_style=function(){e.curWidget.config.styles.push({proportion:"",color:""})};e.saveWgt=function(){if(I()){var t={};return t.name=e.widgetName.slice(e.widgetName.lastIndexOf("/")+1).trim(),t.categoryName=e.widgetName.substring(0,e.widgetName.lastIndexOf("/")).trim(),""==t.categoryName&&(t.categoryName=d("COMMON.DEFAULT_CATEGORY")),t.data={},t.data.config=e.curWidget.config,e.customDs?(t.data.query=e.curWidget.query,t.data.datasource=e.datasource.id):t.data.datasetId=e.curWidget.datasetId,t.data.expressions=_.filter(e.curWidget.expressions,function(t){return!e.isDsExpression(t)}),t.data.filterGroups=_.filter(e.curWidget.filterGroups,function(t){return!e.isDsFilter(t)}),e.alerts=[],e.verify={widgetName:!0},null==t.name||""==t.name?(e.alerts=[{msg:d("CONFIG.WIDGET.WIDGET_NAME")+d("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={widgetName:!1},void $("#widgetName").focus()):void 0==t.data.datasetId&&0==e.customDs?void(e.alerts=[{msg:d("CONFIG.WIDGET.DATASET")+d("COMMON.NOT_EMPTY"),type:"danger"}]):void("new"==e.optFlag?a.post("dashboard/saveNewWidget.do",{json:angular.toJson(t)}).success(function(t){"1"==t.status?(m(),h(),i.alert(d("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]}):"edit"==e.optFlag&&(t.id=e.widgetId,a.post(u,{json:angular.toJson(t)}).success(function(t){"1"==t.status?(m(),h(),i.alert(d("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})))}},e.editWgt=function(t){a.post("dashboard/checkWidget.do",{id:t.id}).success(function(a){if("1"==a.status)T(t),1==e.customDs&&e.doConfigParams();else{var r=t.data.datasetId?"CONFIG.WIDGET.DATASET":"CONFIG.WIDGET.DATA_SOURCE";i.alert(d("ADMIN.CONTACT_ADMIN")+"："+d(r)+"/"+a.msg,"modal-danger","lg")}})},e.editCurWgt=function(){var t=_.find(e.widgetList,function(t){return t.id==e.widgetId});t&&e.editWgt(t)};var T=function(t){N(),c(function(){O(t.id)},500),O(t.id),$("#preview_widget").html(""),e.curWidget=angular.copy(t.data),e.curWidget.expressions||(e.curWidget.expressions=[]),e.curWidget.filterGroups||(e.curWidget.filterGroups=[]),o.updateConfig(e.curWidget.config),e.datasource=_.find(e.datasourceList,function(e){return e.id==t.data.datasource}),e.widgetName=angular.copy(t.categoryName+"/"+t.name),e.widgetId=t.id,e.optFlag="edit",e.customDs=_.isUndefined(e.curWidget.datasetId),g(function(){y(),v(),D(),n.linkDataset(e.curWidget.datasetId,e.curWidget.config)}),w()};e.doCancel=function(){"new"==e.optFlag?(e.newConfig(),e.filterSelect={},N()):e.editCurWgt()},e.filterDimension=function(t){if("level"==t.type)return!0;var a=_.find(e.curWidget.config.keys,function(e){return e.col==t.column}),r=_.find(e.curWidget.config.groups,function(e){return e.col==t.column});return!(a||r)},e.filterExpressions=function(t){var a=!1;return _.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){"exp"==e.type&&t.id==e.id&&t.alias==e.alias&&(a=!0)})}),!a},e.filterFilterGroup=function(t){var a=!1;return _.each(e.curWidget.config.filters,function(e){e.group&&t.id==e.id&&t.group==e.group&&(a=!0)}),!a};var D=function(){var t=!1;e.customDs||(e.dataset=_.find(e.datasetList,function(t){return t.id==e.curWidget.datasetId}),e.dataset.data.schema&&(e.dataset.data.schema.measure.length>0||e.dataset.data.schema.dimension.length>0)&&(t=!0)),t?(e.schema=e.dataset.data.schema,e.alerts=[]):(e.loading=!0,n.getColumns({datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId,reload:!e.loadFromCache,callback:function(t){e.loading=!1,e.alerts=[],"1"==t.msg?(e.schema={selects:[]},_.each(t.columns,function(t){e.schema.selects.push({column:t})})):e.alerts=[{msg:t.msg,type:"danger"}]}}))};e.deleteWgt=function(t){i.confirm(d("COMMON.CONFIRM_DELETE"),"modal-info","lg",function(){a.post("dashboard/deleteWidget.do",{id:t.id}).success(function(t){"1"==t.status?m():i.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})})},e.copyWgt=function(t){var r=angular.copy(t);r.name=r.name+"_copy",a.post("dashboard/saveNewWidget.do",{json:angular.toJson(r)}).success(function(t){"1"==t.status?(m(),i.alert(d("COMMON.SUCCESS"),"modal-success","sm")):i.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})},e.getQueryView=function(){if(e.datasource&&e.datasource.name)return"dashboard/getConfigView.do?type="+e.datasource.type},e.getChartView=function(){if(e.curWidget.config&&e.curWidget.config.chart_type)return"src/view/config/chart/"+e.curWidget.config.chart_type+".html"},e.getOptionsView=function(){var t="src/view/config/chart/options/";if(e.curWidget.config&&e.curWidget.config.chart_type)return t+e.curWidget.config.chart_type+".html"},e.deleteValue=function(t){_.each(t,function(t){"exp"==t.type?e.expressions.push(t):e.curWidget.config.selects.push(t.col)})},e.dndTransfer={toCol:function(e,t,a,r){"key"==r||"group"==r||"filter"==r?e[t]={col:a.col,aggregate_type:"sum"}:"select"!=r&&"measure"!=r||(e[t]={col:a.column,aggregate_type:"sum"})},toSelect:function(e,t,a,r){"col"==r?e[t]=a.col:"key"!=r&&"group"!=r&&"filter"!=r||(e[t]=a.col)},toKeysGroups:function(e,t,a,r){"col"==r?e[t]={col:a.col,type:"eq",values:[],sort:"asc"}:"dimension"!=r&&"select"!=r||(e[t]={alias:a.alias,col:a.column,level:a.level,type:"eq",values:[],sort:"asc"},"dimension"==r&&(e[t].id=a.id))},attachLevel:function(e,t){return e.level=t.alias,e}},e.selectsByFilter=[],e.selects=[],e.editFilter=function(t,a){r.open({templateUrl:"src/view/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){var e=t[a];return e.col?("eq"==e.type?e.type="=":"ne"==e.type&&(e.type="≠"),angular.copy(e)):{col:e,type:"=",values:[]}},filter:function(){return!0},getSelects:function(){return function(r,i,o){var s=void 0;if(r){s=angular.copy(e.curWidget.config);var l=_.findKey(e.curWidget.config,function(e){return e==t});s[l].splice(a,1)}n.getDimensionValues(e.datasource?e.datasource.id:null,e.curWidget.query,e.customDs?void 0:e.curWidget.datasetId,i,s,function(e){o(e)})}},ok:function(){return function(e){t[a]=e}}},controller:"paramSelector"})},e.editVFilter=function(e){r.open({templateUrl:"src/view/config/modal/vfilter.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(t,a){t.type=["=","≠",">","<","≥","≤","(a,b]","[a,b)","(a,b)","[a,b]"],t.f_type=e.f_type?e.f_type:">",t.f_values=e.f_values?e.f_values:[],t.f_top=e.f_top?e.f_top:"",t.close=function(){a.close()},t.ok=function(){e.f_type=t.f_type,e.f_values=t.f_values,e.f_top=t.f_top,a.close()}}]})};var S=function(e){if(e.selects)return angular.copy(e.selects);var t=[];return t=t.concat(e.measure),_.each(e.dimension,function(e){"level"==e.type?_.each(e.columns,function(e){t.push(e)}):t.push(e)}),angular.copy(t)};e.editFilterGroup=function(t){var a=S(e.schema);r.open({templateUrl:"src/view/config/modal/filterGroup.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,scope:e,controller:["$scope","$uibModalInstance",function(e,i){t?e.data=angular.copy(t):e.data={group:"",filters:[]},e.selects=a,e.close=function(){i.close()},e.addColumn=function(t){e.data.filters.push({col:t,type:"=",values:[]})},e.ok=function(){t?(t.group=e.data.group,t.filters=e.data.filters):e.curWidget.filterGroups.push(e.data),i.close()},e.editFilter=function(t){r.open({templateUrl:"src/view/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return angular.copy(t)},filter:function(){return!1},getSelects:function(){return function(t,a,r){n.getDimensionValues(e.datasource?e.datasource.id:null,e.curWidget.query,e.curWidget.datasetId,a,void 0,function(e){r(e)})}},ok:function(){return function(e){t.type=e.type,t.values=e.values}}},controller:"paramSelector"})}}]})},e.editSort=function(e){switch(e.sort){case"asc":e.sort="desc";break;case"desc":e.sort=void 0;break;default:e.sort="asc"}},e.cleanVSort=function(){_.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){e.sort=void 0})})},e.editAlign=function(e){switch(e.align){case void 0:e.align="left";break;case"left":e.align="right";break;default:e.align=void 0}},e.cleanRowSort=function(t){var a=t.sort;_.each(e.curWidget.config.keys,function(e){e.sort=void 0}),e.cleanVSort(),t.sort=a},e.showTooltip=function(e,t){if(!e.isDisabled){var a=$(t.currentTarget),r=a.find(".chart-tip");r.show()}},e.hideTooltip=function(e,t){if(!e.isDisabled){var a=$(t.currentTarget),r=a.find(".chart-tip");r.hide()}},e.treeConfig=jsTreeConfig1,$("#"+p).keyup(function(t){46==t.keyCode&&e.deleteNode()});var M=function(){var t=jstree_GetSelectedNodes(p)[0];return _.find(e.widgetList,function(e){return e.id==t.id})},k=function(e){return jstree_CheckTreeNode(e,p,i.alert)},O=function(t){e.ignoreChanges=!1;var a=jstree_GetWholeTree(p);a.deselect_all(),a.select_node(t)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyNode=function(){k("copy")&&e.copyWgt(M())},e.editNode=function(){k("edit")&&e.editWgt(M())},e.deleteNode=function(){k("delete")&&e.deleteWgt(M())},e.searchNode=function(){var t={wgtName:"",dsName:"",dsrName:""},a=e.widgetList.map(function(t){var a,r=_.find(e.datasetList,function(e){return e.id==t.data.datasetId}),n="";return r?a=_.find(e.datasourceList,function(e){return e.id==r.data.datasource}):t.data.datasource&&(a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource})),{id:t.id,name:t.name,categoryName:t.categoryName,datasetName:r?r.name:"",datasourceName:a?a.name:n}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.wgtName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var i=r[n].trim();"wg"==i.split(":")[0]&&(t.wgtName=i.split(":")[1]),"ds"==i.split(":")[0]&&(t.dsName=i.split(":")[1]),"dsr"==i.split(":")[0]&&(t.dsrName=i.split(":")[1])}f=jstree_CvtVPath2TreeData(s("filter")(a,{name:t.wgtName,datasetName:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(p,f)},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:c,treeID:p,listName:"widgetList",updateUrl:u});return t}(),e.doConfigParams=function(){a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=widget.html").then(function(t){e.params=t.data})},e.changeDs=function(){e.curWidget.query={},a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=widget.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}})},e.setCities=function(){var t=_.find(e.provinces,function(t){return t.code==e.curWidget.config.province.code});t&&t.cities?e.cities=t.cities:e.curWidget.config.city&&e.curWidget.config.city.code&&(e.curWidget.config.city.code="")},e.queryAceOpt=datasetEditorOptions()}]),discovery.controller("datasourceCtrl",["$scope","$http","ModalUtils","$uibModal","$filter","$q",function(e,t,a,r,n,o){"ngInject";var s=n("translate");e.optFlag="none",e.dsView="",e.curDatasource={},e.alerts=[],e.verify={dsName:!0,provider:!0},e.params=[];var l=function(){t.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t})};l(),t.get("dashboard/getProviderList.do").success(function(t){e.providerList=t}),e.newDs=function(){e.optFlag="new",e.curDatasource={config:{}},e.dsView=""},e.editDs=function(t){e.optFlag="edit",e.curDatasource=angular.copy(t),e.changeDsView(),e.doDatasourceParams()},e.deleteDs=function(r){var n=[],i=[],c=t.get("dashboard/getAllDatasetList.do").then(function(e){if(!e)return!1;for(var t=0;t<e.data.length;t++)e.data[t].data.datasource==r.id&&n.push(e.data[t].name)}),d=t.get("dashboard/getAllWidgetList.do").then(function(e){if(!e)return!1;for(var t=0;t<e.data.length;t++)e.data[t].data.datasource==r.id&&i.push(e.data[t].name)}),u=o.all([c,d]);u.then(function(){if(n.length>0||i.length>0){var o="   ";return n.length>0&&(o+="   "+s("CONFIG.DATASET.DATASET")+": ["+n.toString()+"]"),i.length>0&&(o+="   "+s("CONFIG.WIDGET.WIDGET")+": ["+i.toString()+"]"),a.alert(s("COMMON.NOT_ALLOWED_TO_DELETE_BECAUSE_BE_DEPENDENT")+o,"modal-warning","lg"),!1}a.confirm(s("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){t.post("dashboard/deleteDatasource.do",{id:r.id}).success(function(t){"1"==t.status?l():a.alert(t.msg,"modal-warning","lg"),e.optFlag="none"})})})},e.copyDs=function(r){var n=angular.copy(r);n.name=n.name+"_copy",t.post("dashboard/saveNewDatasource.do",{json:angular.toJson(n)}).success(function(t){"1"==t.status?(e.optFlag="none",l(),a.alert(s("COMMON.SUCCESS"),"modal-success","sm")):a.alert(t.msg,"modal-warning","lg")})},e.changeDsView=function(){e.dsView="dashboard/getDatasourceView.do?type="+e.curDatasource.type},e.doDatasourceParams=function(){t.get("dashboard/getDatasourceParams.do?type="+e.curDatasource.type).then(function(t){e.params=t.data})},e.changeDs=function(){e.changeDsView(),e.curDatasource.config={},t.get("dashboard/getDatasourceParams.do?type="+e.curDatasource.type).then(function(t){e.params=t.data;for(i in e.params){var a=e.params[i].name,r=e.params[i].value,n=e.params[i].checked,o=e.params[i].type;"checkbox"==o&&1==n&&(e.curDatasource.config[a]=!0),"number"!=o||""==r||isNaN(r)?""!=r&&(e.curDatasource.config[a]=r):e.curDatasource.config[a]=Number(r)}})};var c=function(){if(e.alerts=[],null==e.curDatasource.type)return e.alerts=[{msg:s("CONFIG.DATA_SOURCE.DATA_PROVIDER")+s("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={provider:!1},!1;if(!e.curDatasource.name)return e.alerts=[{msg:s("CONFIG.DATA_SOURCE.NAME")+s("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curDatasource.config[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,l=o.exec(r);return l=l&&l.length>0?s(l[0]):r,e.alerts=[{msg:"["+l+"]"+s("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0};e.saveNew=function(){c()&&t.post("dashboard/saveNewDatasource.do",{json:angular.toJson(e.curDatasource)}).success(function(t){"1"==t.status?(e.optFlag="none",l(),e.verify={dsName:!0,provider:!0},a.alert(s("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.saveEdit=function(){c()&&t.post("dashboard/updateDatasource.do",{json:angular.toJson(e.curDatasource)}).success(function(t){"1"==t.status?(e.optFlag="none",l(),e.verify={dsName:!0,provider:!0},a.alert(s("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.test=function(){var a=e.curDatasource;r.open({templateUrl:"src/view/config/modal/test.html",windowTemplateUrl:"src/view/util/modal/window.html",size:"lg",backdrop:!1,controller:["$scope","$uibModalInstance",function(e,r){e.datasource=a,e.alerts=[],e.close=function(){r.close()},e.curWidget={query:{}},t.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=test.html").then(function(t){e.params=t.data;for(i in e.params){var a=e.params[i].name,r=e.params[i].value,n=e.params[i].checked,o=e.params[i].type;"checkbox"==o&&1==n&&(e.curWidget.query[a]=!0),"number"!=o||""==r||isNaN(r)?""!=r&&(e.curWidget.query[a]=r):e.curWidget.query[a]=Number(r)}});var n=function(){for(i in e.params){var t=e.params[i].name,a=e.params[i].label,r=e.params[i].required,n=e.curWidget.query[t];if(1==r&&0!=n&&(void 0==n||""==n)){var o=/([\w_\s\.]+)/,l=o.exec(a);return l=l&&l.length>0?s(l[0]):a,e.alerts=[{msg:"["+l+"]"+s("COMMON.NOT_EMPTY"),type:"danger"}],!1}}return!0};e["do"]=function(){n()&&t.post("dashboard/test.do",{datasource:angular.toJson(e.datasource),query:angular.toJson(e.curWidget.query)}).success(function(t){"1"!=t.status?e.alerts=[{msg:t.msg,type:"danger"}]:e.alerts=[{msg:s("COMMON.SUCCESS"),type:"success"}]})}}]})}}]),discovery.controller("boardCtrl",["$rootScope","$scope","$http","ModalUtils","$filter","updateService","$uibModal","$timeout","dataService","$state","$window",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";function u(e){"1"==e.status?(h(),t.curBoard.id||(t.curBoard.id=e.id),t.optFlag="edit",r.alert(e.msg,"modal-success","sm"),b()):r.alert(e.msg,"modal-warning","sm")}var f=n("translate");t.optFlag="none",t.curBoard={layout:{rows:[]}},t.alerts=[],t.verify={boardName:!0},e.freeLayout=!1,t.treeData=[];var p="boardTreeID",g=[],m="dashboard/updateBoard.do",h=function(){a.get("dashboard/getBoardList.do").success(function(e){t.boardList=e,g=jstree_CvtVPath2TreeData(t.boardList.map(function(e){var t=null==e.categoryName?f("CONFIG.DASHBOARD.MY_DASHBOARD"):e.categoryName;return{id:e.id,name:e.name,categoryName:t}})),jstree_ReloadTree(p,g)})},v=function(){a.get("dashboard/getCategoryList.do").success(function(e){t.categoryList=[{id:null,name:f("CONFIG.DASHBOARD.MY_DASHBOARD")}],_.each(e,function(e){t.categoryList.push(e)})})},y=function(){a.get("dashboard/getDatasetList.do").then(function(e){return t.datasetList=e.data,a.get("dashboard/getWidgetList.do")}).then(function(e){t.widgetList=e.data,t.widgetList=t.widgetList.map(function(e){if(null!=e.data.datasetId){var a=_.find(t.datasetList,function(t){return t.id==e.data.datasetId});e.dataset=null==a?"Lost DataSet":a.name}else e.dataset="Query";return e})})},w=function(e){var a=[],r=[];_.each(t.curBoard.layout.rows,function(e){_.each(e.widgets,function(e){var n=_.find(t.widgetList,function(t){return t.id==e.widgetId});n.data.datasetId?a.push(n.data.datasetId):r.push(n)})}),a=_.union(a),t.boardDataset=[],_.each(a,function(a){e.i++,l.getColumns({datasource:null,query:null,datasetId:a,callback:function(r){if(t.alerts=[],"1"==r.msg){var n=_.find(t.datasetList,function(e){return e.id==a});void 0!=n&&t.boardDataset.push({name:n.name,columns:r.columns,datasetId:n.id}),e.i--}else t.alerts=[{msg:r.msg,type:"danger"}]}})}),_.each(r,function(a){e.i++,l.getColumns({datasource:a.data.datasource,query:a.data.query,datasetId:null,callback:function(r){"1"==r.msg?(t.boardDataset.push({name:a.name,columns:r.columns,widgetId:a.id}),e.i--):t.alerts=[{msg:r.msg,type:"danger"}]}})})},b=function(){t.verify={boardName:!0},t.$emit("boardChange")};h(),v(),y(),t.newOperate=function(){$("div.newBoard").toggleClass("hideOperate")},t.newGridLayout=function(){e.freeLayout=!1,t.optFlag="new",t.curBoard={layout:{rows:[]}},$("div.newBoard").addClass("hideOperate")},t.newTimelineLayout=function(){e.freeLayout=!1,t.optFlag="new",t.curBoard={layout:{type:"timeline",rows:[{height:"",params:[],type:"param"}]}},$("div.newBoard").addClass("hideOperate")},t.newFreeLayout=function(){e.freeLayout=!0,$("div.newBoard").addClass("hideOperate")},t.editBoard=function(e){var a=angular.copy(e);i.updateBoard(a),t.curBoard=a,t.optFlag="edit"},t.copyBoard=function(e){var t=angular.copy(e);t.name=t.name+"_copy",a.post("dashboard/saveNewBoard.do",{json:angular.toJson(t)}).success(u)},t.deleteBoard=function(e){r.confirm(f("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){a.post("dashboard/deleteBoard.do",{id:e.id}).success(function(e){"1"==e.status?(h(),b(),r.alert(e.msg,"modal-success","sm")):r.alert(e.msg,"modal-warning","lg"),"none"==t.optFlag})})},t.widgetGroup=function(e){return e.categoryName},t.addWidget=function(e){var a={};a.name=f("CONFIG.DASHBOARD.CHART_NAME"),a.width=12,a.widgetId=t.widgetList[0].id,e.widgets.push(a)},t.addRow=function(){t.curBoard.layout.rows.push({type:"widget",widgets:[]})},t.addNode=function(e){t.curBoard.layout.rows.push({node:e,type:"widget",widgets:[]})},t.addPramRow=function(){t.curBoard.layout.rows.unshift({type:"param",params:[]})};var C=function(){return t.alerts=[],!!t.curBoard.name||(t.alerts=[{msg:f("CONFIG.DASHBOARD.NAME")+f("COMMON.NOT_EMPTY"),type:"danger"}],t.verify={boardName:!1},$("#BoardName").focus(),!1)};t.checkBeforPreview=function(e){t.isPreview=!0,C()&&r.confirm(f("COMMON.CONFIRM_SAVE_BEFORE_PREVIEW"),"modal-warning","lg",function(){var a=d.open("","_blank");t.saveBoard().then(function(){e||(e=t.curBoard.id);var r=c.href("mine.view",{id:e});a.location.href=r})})},t.saveBoard=function(){if(C())return"new"==t.optFlag?a.post("dashboard/saveNewBoard.do",{json:angular.toJson(t.curBoard)}).success(u):"edit"==t.optFlag?a.post(m,{json:angular.toJson(t.curBoard)}).success(u):void 0},t.editParam=function(e,a){var n={i:0};w(n);var i,s,l=t;_.isUndefined(a)?(s={col:[]},i=function(t){e.params||(e.params=[]),e.params.push(t)}):(s=angular.copy(e.params[a]),i=function(t){e.params[a]=t}),o.open({templateUrl:"src/view/config/board/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.param_types=[{name:f("CONFIG.DASHBOARD.PARAM_TYPE_SELECTOR"),value:"selector"},{name:f("CONFIG.DASHBOARD.PARAM_TYPE_SLIDER"),value:"slider"}],e.status=n,e.param=s,e.param.paramType||(e.param.paramType="default"),e.boardDataset=l.boardDataset,e.add=function(t,a){var r=angular.copy(t);delete r.columns,r.column=a;for(var n=e.param.col,i=null,o=0;o<n.length;o++)n[o].column==r.column&&n[o].name==r.name?i=!0:null;i&&e.param.col!=[]?null:e.param.col.push(r)},e.close=function(){t.close()},e.deleteSelected=function(t){for(var a=e.param.col[t].column,r=$(".cube>span"),n=0;n<r.length;n++)$(r[n])[0].innerText==a&&$(r[n]).removeClass("itemSelected");e.param.col.splice(t,1)},e.ok=function(){e.param.name?(i(e.param),t.close()):r.alert(f("CONFIG.DASHBOARD.ENTER_PARAMETER_NAME"),"modal-warning","lg")},e.foldCube=function(t,a){var r="img"==a.target.localName?a.target.parentNode.parentNode:a.target.parentNode,n=r.getElementsByTagName("img");"cubeName ng-binding"==a.target.className||"img"==a.target.localName?"25px"==r.style.height||""==r.style.height?(r.style.height=25*(t.columns.length+1)+"px",n[0].style.webkitTransform="rotate(90deg)"):(r.style.height="25px",n[0].style.webkitTransform="rotate(0deg)"):"span"==$(a.target)[0].localName&&$(a.target).addClass("itemSelected"),e.param.col.map(function(e){for(var t=e.column,a=e.name,r=$(".cube>span"),n=0;n<r.length;n++){var i=r[n].parentNode.firstElementChild.innerText;$(r[n])[0].innerText==t&&a==i&&$(r[n]).addClass("itemSelected")}})}}]})},t.treeConfig=angular.copy(jsTreeConfig1),t.treeConfig.plugins=["types","unique","state","sort"],$("#"+p).keyup(function(e){46==e.keyCode&&t.deleteBoard(I())});var I=function(){var e=jstree_GetSelectedNodes(p)[0];return _.find(t.boardList,function(t){return t.id==e.id})},x=function(e){return jstree_CheckTreeNode(e,p,r.alert)};t.applyModelChanges=function(){return!t.ignoreChanges},t.copyNode=function(){x("copy")&&t.copyBoard(I())},t.editNode=function(){x("edit")&&t.editBoard(I())},t.deleteNode=function(){x("delete")&&t.deleteBoard(I())},t.treeEventsObj=function(){var e=jstree_baseTreeEventsObj({ngScope:t,ngHttp:a,ngTimeout:s,treeID:p,listName:"boardList"});return e}()}]),angular.module("treeControl",[]).constant("treeConfig",{templateUrl:null}).directive("treecontrol",["$compile",function(e){"ngInject";function t(e,t){return e?t?'class="'+e+'"':e:""}function a(e,t,a){e.hasOwnProperty(t)||(e[t]=a)}return{restrict:"EA",require:"treecontrol",transclude:!0,scope:{treeModel:"=",selectedNode:"=?",selectedNodes:"=?",expandedNodes:"=?",onSelection:"&",onNodeToggle:"&",options:"=?",orderBy:"@",reverseOrder:"@",filterExpression:"=?",filterComparator:"=?"},controller:["$scope","$templateCache","$interpolate","treeConfig",function(r,n,i,o){function s(e){return!e[r.options.nodeChildren]||0===e[r.options.nodeChildren].length}function l(e,t){if(angular.isArray(e)){t=t||[];for(var a=0;a<e.length;a++)t[a]=e[a]}else if(angular.isObject(e)){t=t||{};for(var r in e)!hasOwnProperty.call(e,r)||"$"===r.charAt(0)&&"$"===r.charAt(1)||(t[r]=e[r])}return t||e}function c(e,t){return void 0!==e&&void 0!==t&&(e=l(e),e[r.options.nodeChildren]=[],t=l(t),t[r.options.nodeChildren]=[],angular.equals(e,t))}function d(){return!0}function u(e){if(!r.options.multiSelection&&r.options.equality(e,r.selectedNode))return!0;if(r.options.multiSelection&&r.selectedNodes){for(var t=0;t<r.selectedNodes.length;t++)if(r.options.equality(e,r.selectedNodes[t]))return!0;return!1}}r.options=r.options||{},a(r.options,"multiSelection",!1),a(r.options,"nodeChildren","children"),a(r.options,"dirSelectable","true"),a(r.options,"injectClasses",{}),a(r.options.injectClasses,"ul",""),a(r.options.injectClasses,"li",""),a(r.options.injectClasses,"liSelected",""),a(r.options.injectClasses,"iExpanded",""),a(r.options.injectClasses,"iCollapsed",""),a(r.options.injectClasses,"iLeaf",""),a(r.options.injectClasses,"label",""),a(r.options.injectClasses,"labelSelected",""),a(r.options,"equality",c),a(r.options,"isLeaf",s),a(r.options,"allowDeselect",!0),a(r.options,"isSelectable",d),r.selectedNodes=r.selectedNodes||[],r.expandedNodes=r.expandedNodes||[],r.expandedNodesMap={};for(var f=0;f<r.expandedNodes.length;f++)r.expandedNodesMap[""+f]=r.expandedNodes[f];r.parentScopeOfTree=r.$parent,r.headClass=function(e){var a=t(r.options.injectClasses.liSelected,!1),n="";return a&&u(e)&&(n=" "+a),r.options.isLeaf(e)?"tree-leaf"+n:r.expandedNodesMap[this.$id]?"tree-expanded"+n:"tree-collapsed"+n},r.iBranchClass=function(){return t(r.expandedNodesMap[this.$id]?r.options.injectClasses.iExpanded:r.options.injectClasses.iCollapsed)},r.nodeExpanded=function(){return!!r.expandedNodesMap[this.$id]},r.selectNodeHead=function(e){var t=this,a=void 0===r.expandedNodesMap[t.$id];if(r.expandedNodesMap[t.$id]=a?t.node:void 0,a)r.expandedNodes.push(t.node);else{for(var n,i=0;i<r.expandedNodes.length&&!n;i++)r.options.equality(r.expandedNodes[i],t.node)&&(n=i);void 0!==n&&r.expandedNodes.splice(n,1)}if(r.onNodeToggle){var o=t.$parent.node===t.synteticRoot?null:t.$parent.node;r.onNodeToggle({node:t.node,$parentNode:o,$index:t.$index,$first:t.$first,$middle:t.$middle,$last:t.$last,$odd:t.$odd,$even:t.$even,expanded:a})}var t=this;if(r.options.isLeaf(e)||r.options.dirSelectable&&r.options.isSelectable(e)){if(r.options.isLeaf(e)&&!r.options.isSelectable(e))return;var s=!1;if(r.options.multiSelection){for(var l=-1,i=0;i<r.selectedNodes.length;i++)if(r.options.equality(e,r.selectedNodes[i])){l=i;break}l===-1?(r.selectedNodes.push(e),s=!0):r.selectedNodes.splice(l,1)}else r.options.equality(e,r.selectedNode)&&r.options.allowDeselect?r.selectedNode=void 0:(r.selectedNode=e,s=!0);if(r.onSelection){var o=t.$parent.node===t.synteticRoot?null:t.$parent.node;r.onSelection({node:e,selected:s,$parentNode:o,$index:t.$index,$first:t.$first,$middle:t.$middle,$last:t.$last,$odd:t.$odd,$even:t.$even})}}else this.selectNodeHead()},r.selectNodeLabel=function(e){},r.selectedClass=function(){var e=u(this.node),a=t(r.options.injectClasses.labelSelected,!1),n="";return a&&e&&(n=" "+a),e?"tree-selected"+n:""},r.unselectableClass=function(){var e=!r.options.isSelectable(this.node),a=t(r.options.injectClasses.labelUnselectable,!1);return e?"tree-unselectable "+a:""},r.isReverse=function(){return!("false"===r.reverseOrder||"False"===r.reverseOrder||""===r.reverseOrder||r.reverseOrder===!1)},r.orderByFunc=function(){return"'"+r.orderBy+"'"};var p,g={orderBy:r.orderBy?" | orderBy:orderByFunc():isReverse()":"",ulClass:t(r.options.injectClasses.ul,!0),nodeChildren:r.options.nodeChildren,liClass:t(r.options.injectClasses.li,!0),iLeafClass:t(r.options.injectClasses.iLeaf,!1),labelClass:t(r.options.injectClasses.label,!1)},m=r.options.templateUrl||o.templateUrl;m&&(p=n.get(m)),p||(p='<ul {{options.ulClass}} ><li ng-repeat="node in node.{{options.nodeChildren}} | filter:filterExpression:filterComparator {{options.orderBy}}"  ng-class="headClass(node)" {{options.liClass}}set-node-to-data><i class="tree-branch-head" ng-class="iBranchClass()" ng-click="selectNodeHead(node)"></i><i class="tree-leaf-head {{options.iLeafClass}}" ng-if="node.name"></i><div class="tree-label {{options.labelClass}}" ng-click="selectNodeHead(node)" ng-class="[selectedClass(), unselectableClass()]" tree-transclude></div><treeitem ng-if="nodeExpanded()"></treeitem></li></ul>'),this.template=e(i(p)({options:g}))}],compile:function(e,t,a){return function(e,t,r,n){e.$watch("treeModel",function(t){if(angular.isArray(t)){if(angular.isDefined(e.node)&&angular.equals(e.node[e.options.nodeChildren],t))return;e.node={},e.synteticRoot=e.node,e.node[e.options.nodeChildren]=t}else{if(angular.equals(e.node,t))return;e.node=t}}),e.$watchCollection("expandedNodes",function(a,r){var n=0,i={},o=t.find("li"),s=[];angular.forEach(o,function(e){var t=angular.element(e),a={$id:t.data("scope-id"),node:t.data("node")};s.push(a)}),angular.forEach(a,function(t){for(var a=!1,r=0;r<s.length&&!a;r++){
var o=s[r];e.options.equality(t,o.node)&&(i[o.$id]=o.node,a=!0)}a||(i[n++]=t)}),e.expandedNodesMap=i}),n.template(e,function(e){t.html("").append(e)}),e.$treeTransclude=a}}}}]).directive("setNodeToData",["$parse",function(e){"ngInject";return{restrict:"A",link:function(e,t,a){t.data("node",e.node),t.data("scope-id",e.$id),t.off("dnd_start.vakata.jstree"),t.off("dnd_move.vakata.jstree"),t.off("dnd_scroll.vakata.jstree"),t.off("dnd_stop.vakata.jstree"),t.on("dragstart",".tree-label span",function(e){t.data("node").folder===!1&&(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("Text",JSON.stringify(t.data("node"))))})}}}]).directive("treeitem",function(){"ngInject";return{restrict:"E",require:"^treecontrol",link:function(e,t,a,r){r.template(e,function(e){t.html("").append(e)})}}}).directive("treeTransclude",function(){"ngInject";return{link:function(e,t,a,r){if(e.options.isLeaf(e.node)||angular.forEach(e.expandedNodesMap,function(t,a){e.options.equality(t,e.node)&&(e.expandedNodesMap[e.$id]=e.node,e.expandedNodesMap[a]=void 0)}),!e.options.multiSelection&&e.options.equality(e.node,e.selectedNode))e.selectedNode=e.node;else if(e.options.multiSelection){for(var n=[],i=0;i<e.selectedNodes.length;i++)e.options.equality(e.node,e.selectedNodes[i])&&n.push(e.node);e.selectedNodes=n}e.transcludeScope=e.parentScopeOfTree.$new(),e.transcludeScope.node=e.node,e.transcludeScope.$parentNode=e.$parent.node===e.synteticRoot?null:e.$parent.node,e.transcludeScope.$index=e.$index,e.transcludeScope.$first=e.$first,e.transcludeScope.$middle=e.$middle,e.transcludeScope.$last=e.$last,e.transcludeScope.$odd=e.$odd,e.transcludeScope.$even=e.$even,e.$on("$destroy",function(){e.transcludeScope.$destroy()}),e.$treeTransclude(e.transcludeScope,function(e){t.empty(),t.append(e)})}}}),discovery.controller("categoryCtrl",["$scope","$http","ModalUtils","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.optFlag="none",e.categoryList={},e.alerts=[],e.verify={categoryName:!0};var i=function(){t.get("dashboard/getCategoryList.do").success(function(t){e.categoryList=t})},o=function(){e.verify={categoryName:!0},e.$emit("categoryChange")};i(),e.newBordCategory=function(){e.optFlag="new",e.curCategory={}},e.editBordCategory=function(t){e.optFlag="edit",e.curCategory=angular.copy(t)},e.deleteBordCategory=function(r){a.confirm(n("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){t.post("dashboard/deleteCategory.do",{id:r.id}).success(function(){e.optFlag="none",i(),o()})})};var s=function(){return e.alerts=[],!!e.curCategory.name||(e.alerts=[{msg:n("CONFIG.CATEGORY.NAME")+n("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={categoryName:!1},$("#CategoryName").focus(),!1)};e.save=function(){s()&&("new"==e.optFlag?t.post("dashboard/saveNewCategory.do",{json:angular.toJson(e.curCategory)}).success(function(t){"1"==t.status?(e.optFlag="none",i(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm"),o()):e.alerts=[{msg:t.msg,type:"danger"}]}):t.post("dashboard/updateCategory.do",{json:angular.toJson(e.curCategory)}).success(function(t){"1"==t.status?(e.optFlag="none",i(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm"),o()):e.alerts=[{msg:t.msg,type:"danger"}]}))}}]),discovery.controller("datasetCtrl",["$scope","$http","dataService","$uibModal","ModalUtils","$filter","chartService","$timeout","uuid4",function(e,t,a,r,n,i,o,s,l){"ngInject";var c=i("translate");e.optFlag="none",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},e.alerts=[],e.verify={dsName:!0},e.loadFromCache=!0,e.queryAceOpt=cbAcebaseOption,e.hierarchy=c("CONFIG.DATASET.HIERARCHY"),e.uuid4=l,e.params=[];var d="dataSetTreeID",u=[],f="dashboard/updateDataset.do",p={};e.toTrash=function(e,t){var a=e[t];"column"==a.type&&(p[a.column]||(p[a.column]=[]),p[a.column].push(a)),e.splice(t,1)},e.dndTransfer={dimension:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})},measure:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})}},t.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t});var g=function(){t.get("dashboard/getDatasetList.do").success(function(t){e.datasetList=t,e.searchNode()})},m=function(){t.get("dashboard/getDatasetCategoryList.do").success(function(t){e.categoryList=t,$("#DatasetName").autocomplete({source:e.categoryList})})};m(),g(),e.newDs=function(){e.optFlag="new",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},w()},e.editDs=function(a){t.post("dashboard/checkDatasource.do",{id:a.data.datasource}).success(function(t){"1"==t.status?(h(a),e.doConfigParams()):n.alert(c("ADMIN.CONTACT_ADMIN")+"：Datasource/"+t.msg,"modal-danger","lg")})};var h=function(t){e.optFlag="edit",e.curDataset=angular.copy(t),e.curDataset.name=e.curDataset.categoryName+"/"+e.curDataset.name,e.curDataset.data.expressions||(e.curDataset.data.expressions=[]),e.curDataset.data.filters||(e.curDataset.data.filters=[]),e.curDataset.data.schema||(e.curDataset.data.schema={dimension:[],measure:[]}),e.datasource=_.find(e.datasourceList,function(t){return t.id==e.curDataset.data.datasource}),e.curWidget.query=e.curDataset.data.query,e.loadData()};e.checkExist=function(t){var a=_.find(e.curDataset.data.schema.measure,function(e){return e.column==t});return!_.isUndefined(a)||(a=_.find(e.curDataset.data.schema.dimension,function(e){if("level"==e.type){var a=_.find(e.columns,function(e){return e.column==t});return!_.isUndefined(a)}return e.column==t}),!_.isUndefined(a))},e.deleteDs=function(a){t.get("dashboard/getAllWidgetList.do").then(function(r){if(!r)return!1;for(var i=[],o=0;o<r.data.length;o++)r.data[o].data.datasetId==a.id&&i.push(r.data[o].name);if(i.length>0){var s=c("CONFIG.WIDGET.WIDGET")+":["+i.toString()+"]";return n.alert(c("COMMON.NOT_ALLOWED_TO_DELETE_BECAUSE_BE_DEPENDENT")+s,"modal-warning","lg"),!1}n.confirm(c("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){t.post("dashboard/deleteDataset.do",{id:a.id}).success(function(t){"1"==t.status?g():n.alert(t.msg,"modal-warning","lg"),e.optFlag="none"})})})},e.copyDs=function(a){var r=angular.copy(a);r.name=r.name+"_copy",t.post("dashboard/saveNewDataset.do",{json:angular.toJson(r)}).success(function(t){"1"==t.status?(e.optFlag="none",g(),n.alert(c("COMMON.SUCCESS"),"modal-success","sm")):n.alert(t.msg,"modal-warning","lg")})};var v=function(){if(e.alerts=[],!e.curDataset.name)return e.alerts=[{msg:c("CONFIG.DATASET.NAME")+c("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?c(s[0]):r,e.alerts=[{msg:"["+s+"]"+c("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0};e.save=function(){if(e.datasource?e.curDataset.data.datasource=e.datasource.id:null,e.curDataset.data.query=e.curWidget.query,v()){var a=angular.copy(e.curDataset),r=a.name.lastIndexOf("/");a.categoryName=e.curDataset.name.substring(0,r).trim(),a.name=e.curDataset.name.slice(r+1).trim(),""==a.categoryName&&(a.categoryName=c("COMMON.DEFAULT_CATEGORY")),"new"==e.optFlag?t.post("dashboard/saveNewDataset.do",{json:angular.toJson(a)}).success(function(t){"1"==t.status?(m(),g(),e.verify={dsName:!0},n.alert(c("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]}):t.post(f,{json:angular.toJson(a)}).success(function(t){"1"==t.status?(e.optFlag="edit",m(),g(),e.verify={dsName:!0},n.alert(c("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})}},e.editFilterGroup=function(t){var n=y(e.curDataset.data.schema);r.open({templateUrl:"src/view/config/modal/filterGroup.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,scope:e,controller:["$scope","$uibModalInstance",function(e,i){t?e.data=angular.copy(t):e.data={group:"",filters:[],id:l.generate()},e.selects=n,e.close=function(){i.close()},e.addColumn=function(t){e.data.filters.push({col:t,type:"=",values:[]})},e.ok=function(){t?(t.group=e.data.group,t.filters=e.data.filters):(null==e.$parent.curDataset.data.filters&&(e.$parent.curDataset.data.filters=[]),e.$parent.curDataset.data.filters.push(e.data)),i.close()},e.editFilter=function(t){r.open({templateUrl:"src/view/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return angular.copy(t)},filter:function(){return!1},getSelects:function(){return function(t,r,n){a.getDimensionValues(e.datasource.id,e.curWidget.query,void 0,r,void 0,function(e){n(e)})}},ok:function(){return function(e){t.type=e.type,t.values=e.values}}},controller:"paramSelector"})}}]})},e.deleteFilterGroup=function(t){n.confirm(c("COMMON.FILTER_GROUP")+": ["+e.curDataset.data.filters[t].group+"], "+c("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.filters.splice(t,1)})};var y=function(e){if(e.selects)return angular.copy(e.selects);var t=[];return t=t.concat(e.measure),_.each(e.dimension,function(e){"level"==e.type?_.each(e.columns,function(e){t.push(e)}):t.push(e)}),angular.copy(t)};e.editExp=function(t){var a,i=y(e.curDataset.data.schema),o=[{name:"sum",value:"sum"},{name:"count",value:"count"},{name:"avg",value:"avg"},{name:"max",value:"max"},{name:"min",value:"min"}],s={expression:""};t?(s.expression=t.exp,s.alias=t.alias,a=function(e){t.exp=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.expressions.push({type:"exp",exp:s.expression,alias:s.alias,id:l.generate()})},r.open({templateUrl:"src/view/config/modal/exp.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=s,e.selects=i,e.aggregate=o,e.alerts=[],e.expAceOpt=expEditorOptions(i,o),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.verify=function(){e.alerts=[];var t=verifyAggExpRegx(e.data.expression);e.alerts=[{msg:t.isValid?c("COMMON.SUCCESS"):t.msg,type:t.isValid?"success":"danger"}]},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void n.alert(c("CONFIG.WIDGET.ALIAS")+c("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.deleteExp=function(t){n.confirm(c("CONFIG.COMMON.CUSTOM_EXPRESSION")+": ["+e.curDataset.data.expressions[t].alias+"], "+c("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.expressions.splice(t,1)})},e.createNode=function(e){if(p[e.column]){var t=p[e.column].pop();if(t)return t}return e.id=l.generate(),e},e.measureToDimension=function(t,a){e.curDataset.data.schema.measure.splice(t,1),e.curDataset.data.schema.dimension.push(a)},e.toDimension=function(t){e.curDataset.data.schema.dimension.push(e.createNode(t))},e.custom=function(t){var a=e.selects,n=e.datasource;r.open({templateUrl:"src/view/config/modal/custom.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,r){e.c=t,e.ok=function(){r.close()},e.customAceOpt=schemaCustomOpt(a,n.type)}]})},e.loadData=function(){w(),e.loading=!0,a.getColumns({datasource:e.datasource.id,query:e.curWidget.query,datasetId:null,reload:!e.loadFromCache,callback:function(t){e.loading=!1,e.toChartDisabled=!1,"1"==t.msg?(e.alerts=[],e.selects=t.columns):e.alerts=[{msg:t.msg,type:"danger"}];var a={chart_type:"table",filters:[],groups:[],keys:[],selects:[],values:[{cols:[]}]};_.each(e.selects,function(e){a.keys.push({col:e,type:"eq",values:[]})})}})};var w=function(){$("#dataset_preview").html("")};e.treeConfig=jsTreeConfig1,$("#"+d).keyup(function(t){46==t.keyCode&&e.deleteNode()});var b=function(){var t=jstree_GetSelectedNodes(d)[0];return _.find(e.datasetList,function(e){return e.id==t.id})},C=function(e){return jstree_CheckTreeNode(e,d,n.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyNode=function(){C("copy")&&e.copyDs(b())},e.editNode=function(){C("edit")&&e.editDs(b())},e.deleteNode=function(){C("delete")&&e.deleteDs(b())},e.searchNode=function(){var t={dsName:"",dsrName:""},a=e.datasetList.map(function(t){var a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.dsName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var o=r[n].trim();"ds"==o.split(":")[0]&&(t.dsName=o.split(":")[1]),"dsr"==o.split(":")[0]&&(t.dsrName=o.split(":")[1])}u=jstree_CvtVPath2TreeData(i("filter")(a,{name:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(d,u)},e.treeEventsObj=function(){var a=jstree_baseTreeEventsObj({ngScope:e,ngHttp:t,ngTimeout:s,treeID:d,listName:"datasetList",updateUrl:f});return a}(),e.doConfigParams=function(){t.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data})},e.changeDs=function(){e.curWidget.query={},t.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}})},e.queryAceOpt=datasetEditorOptions()}]),discovery.controller("buildModelCtrl",["$scope","$state","$http","$stateParams","dataService","$uibModal","ModalUtils","$filter","chartService","$timeout","uuid4",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";var u=s("translate");e.optFlag="new",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},e.alerts=[],e.verify={dsName:!0},e.loadFromCache=!0,e.queryAceOpt=cbAcebaseOption,e.hierarchy=u("CONFIG.DATASET.HIERARCHY"),e.uuid4=d,e.params=[],e.colSearch={row:[]};var f="dataSetTreeID",p="dashboard/updateDataset.do",g={};e.tableList=null,e.dataList=[],e.testList=[],e.tableRelation=[],e.lastTable="",e.id=e.$resolve.$stateParams.dataSourceId,e.$watch("curDataset.data",function(t){var a={};a=e.curDataset.data.schema},!0),e.checkDimension=function(t){var r={columns:[],filters:[],events:[],rows:[],values:[{column:t,aggType:"sum"}]},n={};"undefined"==typeof n.param&&(n.param={}),n.param.cols="",r.rows.forEach(function(e){n.param.cols+="'"+e.columnName+"',"}),r.columns.forEach(function(e){n.param.cols+="'"+e.columnName+"',"}),n.param.pg_grpcols=n.param.cols=n.param.cols.slice(0,n.param.cols.length-1),a.post("/dashboard/getAggregateData.do",{query:angular.toJson(n),datasetId:e.curDataset.id,reload:!1,cfg:JSON.stringify(r)}).success(function(e){e.data&&o.alert("可用,总数:"+JSON.stringify(e.data),"modal-warning","sm")})},e.loadAggregateData=function(){for(var t={columns:[],filters:[],events:[],rows:[],values:[]},r=e.curDataset.data.schema,n=0;n<r.dimension.length;n++){var i=r.dimension[n];t.rows.push({columnName:i.column,filterType:"eq",values:[],id:i.id})}for(var n=0;n<r.measure.length;n++){var o=r.measure[n];t.rows.push({columnName:o.column,filterType:"eq",values:[],id:o.id})}var s={};"undefined"==typeof s.param&&(s.param={}),s.param.cols="",t.rows.forEach(function(e){s.param.cols+="'"+e.columnName+"',"}),t.columns.forEach(function(e){s.param.cols+="'"+e.columnName+"',"}),s.param.pg_grpcols=s.param.cols=s.param.cols.slice(0,s.param.cols.length-1),a.post("/dashboard/getAggregateData.do",{query:angular.toJson(s),datasetId:e.curDataset.id,reload:!1,cfg:JSON.stringify(t)}).success(function(t){e.aggregateData=t})},e.editDemand=function(){var t=i.open({animation:!0,templateUrl:"src/view/config/modal/demand.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.close=function(){t.close()},e.ok=function(){return e.name?void t.close({name:e.name,explaination:e.explaination}):void o.alert(u("CONFIG.DATASET.NAME")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]});t.result.then(function(t){a.post("dashboard/saveNewDemand.do",{name:t.name,explaination:t.explaination,datasetId:e.curDataset.id}).success(function(e){"1"==e.status?(o.alert(u("COMMON.SUCCESS"),"modal-success","sm"),b()):o.alert(e.msg,"modal-warning","lg")})})},e.onlyView=function(){return!_.isUndefined(r.onlyView)&&r.onlyView},e.toTrash=function(e,t){var a=e[t];"column"==a.type&&(g[a.column]||(g[a.column]=[]),g[a.column].push(a)),e.splice(t,1)},e.dndTransfer={dimension:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})},measure:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})}},a.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t,e.datasourceShowList=_.filter(t,function(e){return 0==e.isVersion})});var m=function(){a.get("dashboard/getDatasetList.do").success(function(t){if(e.datasetList=t,e.searchNode(),_.isUndefined(r.id)){if(e.insertId)e.editDs(_.find(e.datasetList,function(t){return t.id==e.insertId})),e.insertId=null;else if(e.datasetList.length>0&&_.isUndefined(e.curDataset.id)&&r.curDatasetId){var a=_.findIndex(e.datasetList,function(e){return e.id===r.curDatasetId});e.editDs(e.datasetList[a]),e.dataList=e.datasetList[a].data.dataList,e.tableRelation=e.datasetList[a].data.tableRelation}}else e.editDs(_.find(e.datasetList,function(e){return e.id==r.id}))})};m(),e.dimMapList=[];var h=function(t){a.post("dataRelated/getDimMapList.do",{datasetId:t}).success(function(t){for(var a={},r=0;r<t.length;r++){var n=t[r];a[n.col]=n}e.dimMapList=a})};e.openWidget=function(e){window.open("#/nv/explore/"+e,"widget")},e.editDs=function(t){a.post("dashboard/checkDatasource.do",{id:t.data.datasource}).success(function(r){a.get("dashboard/getWidgetListByDatasetId.do?datasetId="+t.id).success(function(t){e.widgetList=t}),"1"==r.status?(v(t),e.doConfigParams()):o.alert(u("ADMIN.CONTACT_ADMIN")+"：Datasource/"+r.msg,"modal-danger","lg")})};var v=function(t){e.optFlag="edit",e.curDataset=angular.copy(t),e.curDataset.name=e.curDataset.categoryName+"/"+e.curDataset.name,e.curDataset.data.expressions||(e.curDataset.data.expressions=[]),e.curDataset.data.filters||(e.curDataset.data.filters=[]),e.curDataset.data.schema||(e.curDataset.data.schema={dimension:[],measure:[]}),e.datasource=_.find(e.datasourceList,function(t){return t.id==e.curDataset.data.datasource}),e.curWidget.query=e.curDataset.data.query,e.loadData()};e.checkExist=function(t){var a=_.find(e.curDataset.data.schema.measure,function(e){return e.column==t});return!_.isUndefined(a)||(a=_.find(e.curDataset.data.schema.dimension,function(e){if("level"==e.type){var a=_.find(e.columns,function(e){return e.column==t});return!_.isUndefined(a)}return e.column==t}),!_.isUndefined(a))},e.deleteDs=function(t){a.get("dashboard/getAllWidgetList.do").then(function(r){if(!r)return!1;for(var n=[],i=0;i<r.data.length;i++)r.data[i].data.datasetId==t.id&&n.push(r.data[i].name);if(n.length>0){var s=u("CONFIG.WIDGET.WIDGET")+":["+n.toString()+"]";return o.alert(u("COMMON.NOT_ALLOWED_TO_DELETE_BECAUSE_BE_DEPENDENT")+s,"modal-warning","lg"),!1}o.confirm(u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){a.post("dashboard/deleteDataset.do",{id:t.id}).success(function(t){"1"==t.status||o.alert(t.msg,"modal-warning","lg"),e.optFlag="none"})})})},e.copyDs=function(t){var r=angular.copy(t);r.name=r.name+"_copy",a.post("dashboard/saveNewDataset.do",{json:angular.toJson(r)}).success(function(t){"1"==t.status?(e.optFlag="none",o.alert(u("COMMON.SUCCESS"),"modal-success","sm")):o.alert(t.msg,"modal-warning","lg")})};var y=function(){if(e.alerts=[],!e.curDataset.name)return e.alerts=[{msg:u("CONFIG.DATASET.NAME")+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?u(s[0]):r,e.alerts=[{msg:"["+s+"]"+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0};e.save=function(){if(e.datasource?e.curDataset.data.datasource=e.datasource.id:null,e.curDataset.data.query=e.curWidget.query,y()){var r=angular.copy(e.curDataset),n=r.name.lastIndexOf("/");if(r.categoryName=e.curDataset.name.substring(0,n).trim(),r.name=e.curDataset.name.slice(n+1).trim(),""==r.categoryName&&(r.categoryName=u("COMMON.DEFAULT_CATEGORY")),r.loadFromCache=e.loadFromCache,r.data.datasource=e.id,r.data.query={},r.data.query.sql="select ",e.dataList[0]){for(var i in e.dataList[0].columns)r.data.query.sql+=e.dataList[0].tableName+"."+e.dataList[0].columns[i].title+" as "+e.dataList[0].columns[i].value+",";for(var s="",l=0;l<e.tableRelation.length;l++){for(var c=0;c<e.tableRelation[l].currentColumns.length;c++)r.data.query.sql+=e.tableRelation[l].table.current+"."+e.tableRelation[l].currentColumns[c]+" as "+e.tableRelation[l].table.current+"__"+e.tableRelation[l].currentColumns[c]+",";s+=" "+e.tableRelation[l].table.relation+" "+e.tableRelation[l].table.current+" on ";for(var d=0;d<e.tableRelation[l].columns.length;d++)s+=e.tableRelation[l].columns[d].current+e.tableRelation[l].columns[d].relation+e.tableRelation[l].columns[d].target+" and ";s=s.slice(0,s.length-4)}r.data.query.sql=r.data.query.sql.slice(0,r.data.query.sql.length-1),r.data.query.sql+=" from "+e.dataList[0].tableName+s,r.data.dataList=e.dataList,r.data.tableRelation=e.tableRelation}"new"==e.optFlag?a.post("dashboard/saveNewDataset.do",{json:angular.toJson(r)}).success(function(a){"1"==a.status?(a.id&&(e.insertId=a.id),e.verify={dsName:!0},t.go("nv.cube_item",{id:a.uuid}),o.alert(u("COMMON.SUCCESS"),"modal-success","sm")):a.uuid?t.go("nv.cube_item",{id:a.uuid}):e.alerts=[{msg:a.msg,type:"danger"}]}):a.post(p,{json:angular.toJson(r)}).success(function(a){"1"==a.status?(e.optFlag="edit",e.verify={dsName:!0},t.go("nv.cube_item",{id:a.uuid}),o.alert(u("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:a.msg,type:"danger"}]})}},e.editFilterGroup=function(t){var a=w(e.curDataset.data.schema);i.open({templateUrl:"src/view/config/modal/filterGroup.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,scope:e,controller:["$scope","$uibModalInstance",function(e,r){t?e.data=angular.copy(t):e.data={group:"",filters:[],id:d.generate()},e.selects=a,e.close=function(){r.close()},e.addColumn=function(t){e.data.filters.push({col:t,type:"=",values:[]})},e.ok=function(){t?(t.group=e.data.group,t.filters=e.data.filters):(null==e.$parent.curDataset.data.filters&&(e.$parent.curDataset.data.filters=[]),e.$parent.curDataset.data.filters.push(e.data)),r.close()},e.editFilter=function(t){i.open({templateUrl:"src/view/nv/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return angular.copy(t)},filter:function(){return!1},getSelects:function(){return function(t,a,r){n.getDimensionValues(e.datasource.id,e.curWidget.query,void 0,a,void 0,function(e){r(e)})}},ok:function(){return function(e){t.type=e.type,t.values=e.values}}},controller:"paramSelector"})}}]})},e.deleteFilterGroup=function(t){o.confirm(u("COMMON.FILTER_GROUP")+": ["+e.curDataset.data.filters[t].group+"], "+u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.filters.splice(t,1)})};var w=function(e){if(e.selects)return angular.copy(e.selects);var t=[];return t=t.concat(e.measure),_.each(e.dimension,function(e){"level"==e.type?_.each(e.columns,function(e){t.push(e)}):t.push(e)}),angular.copy(t)};e.editExp=function(t){var a,r=w(e.curDataset.data.schema),n=[{name:"sum",value:"sum"},{name:"count",value:"count"},{name:"avg",value:"avg"},{name:"max",value:"max"},{name:"min",value:"min"}],s={expression:""};t?(s.expression=t.exp,s.alias=t.alias,a=function(e){t.exp=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.expressions.push({type:"exp",exp:s.expression,alias:s.alias,id:d.generate()})},i.open({templateUrl:"src/view/config/modal/exp.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=s,e.selects=r,e.aggregate=n,e.alerts=[],e.expAceOpt=expEditorOptions(r,n),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.verify=function(){e.alerts=[];var t=verifyAggExpRegx(e.data.expression);e.alerts=[{msg:t.isValid?u("COMMON.SUCCESS"):t.msg,type:t.isValid?"success":"danger"}]},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.deleteExp=function(t){o.confirm(u("CONFIG.COMMON.CUSTOM_EXPRESSION")+": ["+e.curDataset.data.expressions[t].alias+"], "+u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.expressions.splice(t,1)})},e.editMea=function(t){var a,r=w(e.curDataset.data.schema),n=[{name:"+",value:"+"},{name:"-",value:"-"},{name:"*",value:"*"},{name:"/",value:"/"}],s={expression:""};t?(s.expression=t.column,s.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.schema.measure.push({type:"column",column:s.expression,alias:s.alias,id:d.generate()})},i.open({templateUrl:"src/view/config/modal/measure.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=s,e.selects=r,e.aggregate=n,e.alerts=[],e.expAceOpt=expEditorOptions(r,n),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.editDim=function(t){var a,r=w(e.curDataset.data.schema),n={expression:""};t?(n.expression=t.column,n.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.schema.dimension.push({type:"column",column:n.expression,alias:n.alias,id:d.generate()})},i.open({templateUrl:"src/view/config/modal/dimension.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=n,e.selects=r,e.alerts=[],e.expAceOpt=expEditorOptions(r,""),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.createNode=function(e){if(g[e.column]){var t=g[e.column].pop();if(t)return t}return e.id=d.generate(),e},e.measureToDimension=function(t,a){e.curDataset.data.schema.measure.splice(t,1),e.curDataset.data.schema.dimension.push(a)},e.toDimension=function(t){e.curDataset.data.schema.dimension.push(e.createNode(t))},e.custom=function(t){e.selects,e.datasource;i.open({templateUrl:"src/view/config/modal/custom.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"sm",controller:["$scope","$uibModalInstance",function(e,a){e.c=t,e.ok=function(){a.close()}}]})};var b=function(){if(e.curDataset.id)return a.get("dashboard/getDatesetDemandList.do?datasetId="+e.curDataset.id).success(function(t){h(e.curDataset.id),e.demandList=t})};e.loadData=function(){C(),e.loading=!0,n.getColumns({datasource:e.datasource.id,query:e.curWidget.query,datasetId:null,reload:!e.loadFromCache,callback:function(t){e.loading=!1,e.toChartDisabled=!1,"1"==t.msg?(e.alerts=[],e.selects=t.columns):e.alerts=[{msg:t.msg,type:"danger"}];var a={chart_type:"table",filters:[],groups:[],keys:[],selects:[],values:[{cols:[]}]};_.each(e.selects,function(e){a.keys.push({col:e,type:"eq",values:[]})})}}),b()},e.updateStatus=function(e,t){a.post("dashboard/updateStatus.do",{id:e,status:t}).success(function(e){"1"==e.status?(b(),o.alert(e.msg,"modal-success","sm")):o.alert(e.msg,"modal-warning","lg")})};var C=function(){$("#dataset_preview").html("")};e.treeConfig=jsTreeConfig1,$("#"+f).keyup(function(t){46==t.keyCode&&e.deleteNode()});var I=function(){var t=jstree_GetSelectedNodes(f)[0];return _.find(e.datasetList,function(e){return e.id==t.id})},x=function(e){return jstree_CheckTreeNode(e,f,o.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyNode=function(){x("copy")&&e.copyDs(I())},e.editNode=function(){x("edit")&&e.editDs(I())},e.deleteNode=function(){x("delete")&&e.deleteDs(I())},e.searchNode=function(){var t={dsName:"",dsrName:""};e.datasetList.map(function(t){var a=_.find(e.datasourceList,function(e){var a=t.data;if(a)return e.id==a.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.dsName=e.keywords;else for(var a=e.keywords.split(" "),r=0;r<a.length;r++){var n=a[r].trim();"ds"==n.split(":")[0]&&(t.dsName=n.split(":")[1]),"dsr"==n.split(":")[0]&&(t.dsrName=n.split(":")[1])}},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:c,treeID:f,listName:"datasetList",updateUrl:p});return t}(),e.doConfigParams=function(){a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data})},e.changeDs=function(){e.curWidget.query={},a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}})},e.queryAceOpt=datasetEditorOptions(),e.setDataRelated=function(t,a,r){var n=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"setDataRelated.html",size:"md",controller:"SetDataRelatedCtrl",resolve:{column:function(){return t.column},id:function(){return t.id},datasetId:function(){return a},commonId:function(){return r?r.commonId:null}}});n.result.then(function(t){h(e.curDataset.id)},function(){})},e.openDbReletionModal=function(t){var r=e;i.open({templateUrl:"src/view/config/modal/dbRelation.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:["$scope","$uibModalInstance","$stateParams",function(e,n,i){e.relationOptions=[">","=","<"],e.currentTable={tableName:t,columns:[]},e.selectedTable=r.dataList,
e.radioModel="left join",e.targetTable={tableName:"",columns:[]},e.relationList=[];var o={sql:"select * from "+t};a.post("dashboard/getColumns.do",{datasourceId:r.id,query:JSON.stringify(o),reload:!1}).success(function(t){t.columns&&(e.currentTable.columns=t.columns)}),e.add=function(){if(e.targetTable.tableName){var t={current:e.currentTable.columns[0]?e.currentTable.columns[0]:"",relation:"=",target:""};e.relationList.push(t)}},e.close=function(){n.close()},e.ok=function(){var t={table:{current:e.currentTable.tableName,relation:e.radioModel,target:e.targetTable.tableName},columns:[],currentColumns:e.currentTable.columns};for(var a in e.relationList){var i={current:e.currentTable.tableName+"."+e.relationList[a].current,relation:e.relationList[a].relation,target:e.targetTable.tableName+"."+e.relationList[a].target};t.columns.push(i)}r.tableRelation.push(t),n.close()},e.selectTable=function(){e.relationList=[];var t={sql:"select * from "+e.targetTable.tableName};a.post("dashboard/getColumns.do",{datasourceId:r.id,query:JSON.stringify(t),reload:!1}).success(function(t){t.columns&&(e.targetTable.columns=t.columns)})}}]})},e.openAddTableModal=function(){i.open({templateUrl:"src/view/config/modal/selectTable.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:["$scope","$uibModalInstance","$stateParams",function(e,t,r){e.tableList=[],e.currentTable=null,e.searchStr="",e.dataSourceId=r.dataSourceId,e.selectTable=function(t,a){e.currentTable=a;var r=t.target,n=window.$;n(".data-active").removeClass("data-active"),r.classList.add("data-active")},e.close=function(){t.close()},e.ok=function(){t.close(e.currentTable)};var n=e;a.post("dashboard/getTableListByDatasourceId.do",{id:n.dataSourceId}).success(function(e){n.tableList=e})}]}).result.then(function(t){if(t){0!==e.dataList.length&&e.openDbReletionModal(t),e.lastTable=t;var r={tableName:t,columns:[]},n=e,i={sql:"select * from "+t};a.post("dashboard/getColumns.do",{datasourceId:n.id,query:JSON.stringify(i),reload:!1}).success(function(a){if(a.columns){var n=[];for(var i in a.columns){var o={title:a.columns[i],value:t+"__"+a.columns[i]};n.push(o)}r.columns=n,e.dataList.push(r)}})}},function(e){console.log(e)})}}]).controller("SetDataRelatedCtrl",["commonId","datasetId","column","id","$scope","$rootScope","$http","$uibModalInstance","ModalUtils","$filter","$location",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";n.activeCommonId=e;var u=function(){o.get("dataRelated/getDataRelatedList.do").success(function(e){n.dataRelatedList=e})};u(),n.changeDataRelated=function(e){n.activeCommonId!=e?n.activeCommonId=e:n.activeCommonId=""},n.ok=function(){o.post("dataRelated/saveDataRelated.do",{datasetId:t,commonId:n.activeCommonId,col:a,colId:r}).success(function(e){s.close(n.activeCommonId)})},n.cancel=function(){s.dismiss("cancel")}}]),discovery.controller("userAdminCtrl",["$scope","$http","ModalUtils","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.optFlag,e.curUser,e.filterByRole=!1,e.userKeyword="",e.tab="menu",t.get("admin/isAdmin.do").success(function(t){e.isAdmin=t});var i=function(){t.get("admin/getUserList.do").success(function(t){e.userList=t})};i();var o=function(){t.get("admin/getRoleList.do").success(function(t){e.roleList=t})};o();var s=function(){t.get("admin/getUserRoleList.do").success(function(t){e.userRoleList=t})};s(),e.tree={menu:{},board:{},datasource:{},dataset:{},widget:{},job:{},brain:{}},e.tree.menu.resList=[{id:"Menu",text:n("ADMIN.MENU"),parent:"#",state:{disabled:!0}}],e.tree.board.resList=[{id:"Dashboard",text:n("ADMIN.BOARD"),parent:"#",state:{disabled:!0}}],e.tree.datasource.resList=[{id:"Datasource",text:n("ADMIN.DATASOURCE"),parent:"#",state:{disabled:!0}}],e.tree.dataset.resList=[{id:"Dataset",text:n("ADMIN.DATASET"),parent:"#",state:{disabled:!0}}],e.tree.widget.resList=[{id:"Widget",text:n("ADMIN.WIDGET"),parent:"#",state:{disabled:!0}}],e.tree.job.resList=[{id:"Job",text:n("ADMIN.JOB"),parent:"#",state:{disabled:!0}}],e.tree.brain.resList=[{id:"Brain",text:n("ADMIN.BRAIN_MAP"),parent:"#",state:{disabled:!0}}];var l=function(){return t.get("admin/getBoardList.do").success(function(t){_.each(h(t,"Dashboard","board","fa fa-puzzle-piece"),function(t){e.tree.board.resList.push(t)})})},c=function(){return t.get("admin/getMenuList.do").success(function(t){e.menuList=t,_.each(t,function(t){e.tree.menu.resList.push({id:"menu_"+t.menuId,text:n(t.menuName),parent:t.parentId==-1?"Menu":"menu_"+t.parentId,resId:t.menuId,type:"menu",icon:"fa fa-cog"})})})},d=function(){return t.get("admin/getDatasourceList.do").success(function(t){_.each(h(t,"Datasource","datasource","fa fa-database"),function(t){e.tree.datasource.resList.push(t)})})},u=function(){return t.get("admin/getDatasetList.do").success(function(t){_.each(h(t,"Dataset","dataset","fa fa-table"),function(t){e.tree.dataset.resList.push(t)})})},f=function(){return t.get("admin/getWidgetList.do").success(function(t){_.each(h(t,"Widget","widget","fa fa-line-chart"),function(t){e.tree.widget.resList.push(t)})})},p=function(){return t.get("admin/getJobList.do").success(function(t){_.each(h(t,"Job","job","fa fa-clock-o"),function(t){e.tree.job.resList.push(t)})})},g=function(){return t.get("mindmap/getMindmapList.do").success(function(t){_.each(h(t,"Brain","brain","fa fa-clock-o"),function(t){e.tree.brain.resList.push(t)})})},m=function(e,t){var a=["R"];return e&&a.push("U"),t&&a.push("D")," ("+a.join(",")+")"},h=function(e,t,a,r){for(var n=1,i=[],o=0;o<e.length;o++){var s=[];e[o].categoryName?(s=e[o].categoryName.split("/"),s.push(e[o].name)):s.push(e[o].name);for(var l=t,c=0;c<s.length;c++){for(var d=!1,u=s[c],f=0;f<i.length;f++)if(i[f].text==u&&i[f].parent==l&&"parent"==i[f].id.substring(0,6)){d=!0;break}d?l=i[f].id:(c==s.length-1?i.push({id:a+"_"+e[o].id.toString(),parent:l,text:u,resId:e[o].id,type:a,icon:r,name:u}):i.push({id:"parent_"+a+"_"+n,parent:l,text:u}),l="parent_"+a+"_"+n,n++)}}return i},v=function(e){function t(t){return function(a){e.original[t]=void 0!=e.original[t]&&!e.original[t],_.each(e.children_d,function(r){var n=$(a.reference).jstree(!0),i=n.get_node(r);0==i.children.length&&(i.original[t]=e.original[t],n.rename_node(i,i.original.name+m(i.original[t],i.original["delete"])))})}}return _.isUndefined(e.original.resId)?"#"!=e.parent?{edit:{label:function(){return n("ADMIN.TOGGLE_UPDATE")},action:t("update")},"delete":{label:function(){return n("ADMIN.TOGGLE_DELETE")},action:t("delete")}}:void 0:{edit:{label:function(){return e.original.edit?"√ Update":"× Update"},action:function(t){e.original.edit=!e.original.edit,$(t.reference).jstree(!0).rename_node(e,e.original.name+m(e.original.edit,e.original["delete"]))}},"delete":{label:function(){return e.original["delete"]?"√ Delete":"× Delete"},action:function(t){e.original["delete"]=!e.original["delete"],$(t.reference).jstree(!0).rename_node(e,e.original.name+m(e.original.edit,e.original["delete"]))}}}},y=(function(){l().then(function(){return c()}).then(function(){return d()}).then(function(){return u()}).then(function(){return f()}).then(function(){return p()}).then(function(){return g()}).then(function(){var t={core:{multiple:!0,animation:!0,error:function(e){},check_callback:!0,worker:!0},checkbox:{three_state:!0},contextmenu:{items:v,select_node:!1},version:1,plugins:["types","checkbox","unique","contextmenu"]},a=angular.copy(t);a.checkbox.three_state=!1,delete a.contextmenu,a.plugins=["types","checkbox","unique"],e.treeConfig=t,e.treeMenuConfig=a})}(),function(){t.get("admin/getRoleResList.do").success(function(t){e.roleResList=t})});y(),e.onRoleFilter=function(t){e.roleFilter=_.map(_.filter(e.userRoleList,function(e){return e.roleId==t.roleId}),function(e){return e.userId})},e.searchUserByRole=function(t){return!e.filterByRole||!_.isUndefined(_.find(e.roleFilter,function(e){return e==t.userId}))},e.searchUserByName=function(t){return""===e.userKeyword||void 0===e.userKeyword||!e.filterByRole&&(t.loginName+t.userName).toLowerCase().indexOf(e.userKeyword)!=-1},e.changeRoleSelect=function(){if(e.selectUser&&1==e.selectUser.length){var t=_.filter(e.userRoleList,function(t){return t.userId==e.selectUser[0].userId});e.selectRole=_.filter(e.roleList,function(e){return _.find(t,function(t){return t.roleId==e.roleId})}),e.changeResSelect()}},e.newUser=function(){e.optFlag="newUser",e.curUser={}},e.editUser=function(t){e.optFlag="editUser",e.curUser=angular.copy(t)},e.newRole=function(){e.optFlag="newRole",e.curRole={}},e.editRole=function(t){e.optFlag="editRole",e.curRole=angular.copy(t)},e.saveUser=function(){"newUser"==e.optFlag?t.post("admin/saveNewUser.do",{user:angular.toJson(e.curUser)}).success(function(t){"1"==t?(e.optFlag="none",i(),e.verify={dsName:!0},a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]}):t.post("admin/updateUser.do",{user:angular.toJson(e.curUser)}).success(function(t){"1"==t?(e.optFlag="none",i(),e.verify={dsName:!0},a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.saveRole=function(){"newRole"==e.optFlag?t.post("admin/saveRole.do",{role:angular.toJson(e.curRole)}).success(function(t){"1"==t?(e.optFlag="none",o(),e.verify={dsName:!0},a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]}):t.post("admin/updateRole.do",{role:angular.toJson(e.curRole)}).success(function(t){"1"==t?(e.optFlag="none",o(),e.verify={dsName:!0},a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.grantRole=function(){var r=_.map(e.selectUser,function(e){return e.userId}),i=_.map(e.selectRole,function(e){return e.roleId});t.post("admin/updateUserRole.do",{userIdArr:angular.toJson(r),roleIdArr:angular.toJson(i)}).success(function(t){"1"==t?(e.selectUser=null,e.selectRole=null,s(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.revokeRole=function(){var r=_.map(e.selectUser,function(e){return e.userId}),i=_.map(e.selectRole,function(e){return e.roleId});t.post("admin/deleteUserRole.do",{userIdArr:angular.toJson(r),roleIdArr:angular.toJson(i)}).success(function(t){"1"==t?(e.selectUser=null,e.selectRole=null,s(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.changeResSelect=function(){w(e.tree.menu),w(e.tree.board),w(e.tree.dataset),w(e.tree.datasource),w(e.tree.job),w(e.tree.widget),w(e.tree.brain)};var w=function(t){if(e.optFlag="selectRes",t.treeInstance.jstree(!0).open_all(),e.selectRole){var a=_.filter(e.roleResList,function(t){return!_.isUndefined(_.find(e.selectRole,function(e){return t.roleId==e.roleId}))});t.treeInstance.jstree(!0).uncheck_all(),_.each(t.resList,function(e){var r=_.find(a,function(t){return t.resId==e.resId&&t.resType==e.type}),n=t.treeInstance.jstree(!0).get_node(e);_.isUndefined(r)?e.name&&(n.original.edit=!0,n.original["delete"]=!0):(t.treeInstance.jstree(!0).check_node(e),e.name&&(n.original.edit=r.edit,n.original["delete"]=r["delete"])),e.name&&t.treeInstance.jstree(!0).rename_node(e,e.name+m(n.original.edit,n.original["delete"]))})}};e.grantRes=function(){var r=_.map(e.selectRole,function(e){return e.roleId}),i=[];for(var o in e.tree)_.each(_.filter(e.tree[o].treeInstance.jstree(!0).get_checked(!0),function(e){return!_.isUndefined(e.original.resId)}),function(e){i.push({resId:e.original.resId,resType:e.original.type,edit:e.original.edit,"delete":e.original["delete"]})});t.post("admin/updateRoleRes.do",{roleIdArr:angular.toJson(r),resIdArr:angular.toJson(i)}).success(function(t){"1"==t?(e.selectRole=null,e.selectRes=null,y(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.deleteRole=function(){a.confirm(n("COMMON.CONFIRM_DELETE"),"modal-info","lg",function(){t.post("admin/deleteRole.do",{roleId:e.selectRole[0].roleId}).success(function(t){"1"==t?(e.selectRole=null,e.selectRes=null,o(),y(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})})}}]),discovery.controller("jobCtrl",["$scope","$rootScope","$http","dataService","$uibModal","ModalUtils","$filter","$interval",function(e,t,a,r,n,i,o,s){"ngInject";var l=o("translate");e.jobTypes=[{name:"Send Mail",type:"mail"}],e.interval=s(function(){a.get("dashboard/getJobList.do").success(function(t){_.each(e.jobList,function(e){var a=_.find(t,function(t){return e.id==t.id});e.jobStatus=a.jobStatus,e.execLog=a.execLog})})},5e3),t.$on("$stateChangeSuccess",function(t,a,r,n){"jobCtrl"==n.controller&&s.cancel(e.interval)}),e.loadJobList=function(){a.get("dashboard/getJobList.do").success(function(t){e.jobList=t})},e.loadJobList(),e.getName=function(t){return _.find(e.jobTypes,function(e){return e.type==t}).name},e.getTime=function(e){return e?moment(Number(e)).format("YYYY-MM-DD HH:mm:ss"):"N/A"},e.getDateRange=function(e){return e?moment(e.startDate).format("YYYY-MM-DD")+" ~ "+moment(e.endDate).format("YYYY-MM-DD"):"N/A"},e.getStatus=function(e){if(null==e)return"N/A";switch(e){case 0:return"CONFIG.JOB.FAIL";case 1:return"CONFIG.JOB.FINISH";case 2:return"CONFIG.JOB.PROCESSING"}},e.showLog=function(e){i.alert(e.execLog?e.execLog:"N/A",null,"lg")},e.runJob=function(t){a.post("dashboard/execJob.do",{id:t.id}).success(function(a){"1"==a.status?t.jobStatus=2:e.alerts=[{msg:a.msg,type:"danger"}]})},e.editJob=function(t){n.open({templateUrl:"src/view/config/modal/job/edit.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:["$scope","$uibModalInstance",function(e,r){e.cronConfig={quartz:!0,allowMultiple:!0,options:{allowYear:!1}},e.dateRangeCfg={locale:{format:"YYYY-MM-DD"}},t?(e.job=angular.copy(t),e.job.daterange.startDate=moment(e.job.daterange.startDate),e.job.daterange.endDate=moment(e.job.daterange.endDate)):e.job={daterange:{startDate:null,endDate:null},jobType:"mail"},e.close=function(){r.close()},e.ok=function(){t?a.post("dashboard/updateJob.do",{json:angular.toJson(e.job)}).success(function(t){"1"==t.status?(i.alert(l("COMMON.SUCCESS"),"modal-success","sm"),e.$parent.loadJobList(),r.close()):i.alert(t.msg,"modal-warning","lg")}):a.post("dashboard/saveJob.do",{json:angular.toJson(e.job)}).success(function(t){"1"==t.status&&(i.alert(l("COMMON.SUCCESS"),"modal-success","sm"),e.$parent.loadJobList(),r.close())})},e.config=function(){n.open({templateUrl:"src/view/config/modal/job/"+e.job.jobType+".html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:e.job.jobType+"JobCtrl"})}}]})},e.deleteJob=function(t){i.confirm(l("COMMON.CONFIRM_DELETE"),"modal-info","lg",function(){a.post("dashboard/deleteJob.do",{id:t.id}).success(function(t){"1"==t.status?e.loadJobList():i.alert(t.msg,"modal-warning","lg")})})}}]),discovery.controller("mailJobCtrl",["$scope","$uibModalInstance","$http","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.boardType=[{name:"Xls",type:"xls"},{name:"Image",type:"img"},{name:"Both",type:"xls,img"}];(function(){e.$parent.job.config?e.config=angular.copy(e.$parent.job.config):e.config={boards:[]}})(),function(){a.get("dashboard/getBoardList.do").success(function(t){e.boardList=t})}();e.addBoard=function(){e.config.boards.push({id:e.boardList[0].id,type:"img"})},e.boardGroup=function(e){return e.categoryName?e.categoryName:n("CONFIG.DASHBOARD.MY_DASHBOARD")},e.close=function(){t.close()},e.ok=function(){e.$parent.job.config=e.config,t.close()}}]),discovery.controller("shareResCtrl",["$scope","$http","ModalUtils","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.curUser,e.userKeyword="";var i=function(){t.get("admin/getRoleListAll.do").success(function(t){e.roleList=t})};i(),e.resList=[{id:"Dashboard",text:n("ADMIN.BOARD"),parent:"#",state:{disabled:!0}},{id:"Dataset",text:n("ADMIN.DATASET"),parent:"#",state:{disabled:!0}},{id:"Widget",text:n("ADMIN.WIDGET"),parent:"#",state:{disabled:!0}}];var o=function(){return t.get("admin/getBoardListUser.do").success(function(t){_.each(c(t,"Dashboard","board","fa fa-puzzle-piece"),function(t){e.resList.push(t)})})},s=function(){return t.get("admin/getDatasetListUser.do").success(function(t){_.each(c(t,"Dataset","dataset","fa fa-table"),function(t){e.resList.push(t)})})},l=function(){return t.get("admin/getWidgetListUser.do").success(function(t){_.each(c(t,"Widget","widget","fa fa-line-chart"),function(t){e.resList.push(t)})})},c=function(e,t,a,r){for(var n=1,i=[],o=0;o<e.length;o++){var s=[];e[o].categoryName?(s=e[o].categoryName.split("/"),s.push(e[o].name)):s.push(e[o].name);for(var l=t,c=0;c<s.length;c++){for(var d=!1,u=s[c],f=0;f<i.length;f++)if(i[f].text==u&&i[f].parent==l&&"parent"==i[f].id.substring(0,6)){d=!0;break}d?l=i[f].id:(c==s.length-1?i.push({id:a+"_"+e[o].id.toString(),parent:l,text:u,resId:e[o].id,type:a,icon:r,name:u}):i.push({id:"parent_"+a+"_"+n,parent:l,text:u,state:{disabled:!0}}),l="parent_"+a+"_"+n,n++)}}return i},d=(function(){o().then(function(){return s()}).then(function(){return l()}).then(function(){e.treeConfig={core:{multiple:!0,animation:!0,error:function(e){},check_callback:!0,worker:!0},checkbox:{three_state:!1},version:1,plugins:["types","unique"]},_.delay(function(){e.treeInstance.jstree(!0).open_all()},500)})}(),function(){t.get("admin/getRoleResList.do").success(function(t){e.roleResList=t})});d(),e.grantRes=function(){var r=_.map(e.selectRole,function(e){return e.roleId}),i=_.map(_.filter(e.treeInstance.jstree(!0).get_selected(!0),function(e){return!_.isUndefined(e.original.resId)}),function(e){return{resId:e.original.resId,resType:e.original.type}});t.post("admin/updateRoleResUser.do",{roleIdArr:angular.toJson(r),resIdArr:angular.toJson(i)}).success(function(t){"1"==t?(e.selectRole=null,e.selectRes=null,d(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.changed=function(t,a,r){var t=a.node.original,n=_.map(_.filter(e.roleResList,function(e){return e.resType==t.type&&e.resId==t.resId}),function(e){return e.roleId});e.selectRole=_.filter(e.roleList,function(e){return _.find(n,function(t){return e.roleId==t})})}}]),discovery.controller("paramSelector",["$scope","$uibModalInstance","dataService","param","filter","getSelects","ok",function(e,t,a,r,n,i,o){"ngInject";e.type=["=","≠",">","<","≥","≤","(a,b]","[a,b)","(a,b)","[a,b]"],e.param=r,e.operate={},e.filter=n,e.byFilter={a:!1},e.loadSelect=!0,e.paramInput="",e.addInputParam=function(){var t=$.trim(e.paramInput);if(""!=t){for(var a=!1,r=0;r<e.param.values.length;r++)if(e.param.values[r]==t){a=!0;break}a||e.param.values.push(e.paramInput)}},e.getSelects=function(){e.loading=!0,i(e.byFilter.a,e.param.col,function(t){e.selects=t,e.loading=!1})};var s=function(){var t=["=","≠"],a=[">","<","≥","≤"],r=["(a,b]","[a,b)","(a,b)","[a,b]"];e.operate.equal=$.inArray(e.param.type,t)>-1,e.operate.openInterval=$.inArray(e.param.type,a)>-1,e.operate.closeInterval=$.inArray(e.param.type,r)>-1};s(),e.dbclickPush=function(t){e.operate.equal&&e.param.values.push(t),e.operate.openInterval&&(e.param.values[0]=t),e.operate.closeInterval&&(void 0==e.param.values[0]||""==e.param.values[0]?e.param.values[0]=t:e.param.values[1]=t)},e.deleteValues=function(t){e.operate.equal&&(e.param.values=_.difference(e.param.values,t))},e.pushValues=function(t){e.operate.openInterval&&t.splice(1,t.length-1),e.operate.closeInterval&&t.splice(2,t.length-2),_.each(t,function(t){e.param.values.push(t)})},e.selected=function(t){return _.indexOf(e.param.values,t)==-1},e.filterType=function(){e.param.values=[],s()},e.close=function(){t.close()},e.ok=function(){t.close(),o(e.param)}}]),discovery.controller("permissionSettingCtrl",["$scope","$timeout","$uibModalInstance","$http","$filter","config",function(e,t,a,r,n,i){"ngInject";n("translate");e.existRoleList=[],e.roleList=[],e.checkA=function(e){e.read=e.admin,e.update=e.admin,e["delete"]=e.admin},e.checkD=function(e){e["delete"]?e.read=!0:e.update||(e.read=!1),e["delete"]||e.update||e.read||(e.admin=!1)},e.checkU=function(e){e.update?e.read=!0:e["delete"]||(e.read=!1),e["delete"]||e.update||e.read||(e.admin=!1)},e.checkR=function(e){e.read||(e.update=!1,e["delete"]=!1,e.admin=!1)},r.get("admin/isAdmin.do").success(function(t){e.isAdmin=t});var o=function(){r.get("admin/getRoleResById.do?resId="+i.id+"&resType="+i.type).success(function(t){e.existRoleList=t,l()})};o();var s=function(){r.get("admin/getRoleListAll.do").success(function(t){e.roleList=t,l()})};s();var l=function(){_.each(e.roleList,function(t){var a=_.find(e.existRoleList,function(e){return e.roleId==t.roleId});a||(t.permission=null,e.existRoleList.push(t))}),c()},c=function(){_.each(e.existRoleList,function(e){switch(e.permission){case"00":e.read=!0,e.update=!1,e["delete"]=!1,e.admin=!1;break;case"01":e.read=!0,e.update=!1,e["delete"]=!0,e.admin=!1;break;case"10":e.read=!0,e.update=!0,e["delete"]=!1,e.admin=!1;break;case"11":e.read=!0,e.update=!0,e["delete"]=!0,e.admin=!0;break;default:e.read=!1,e.update=!1,e["delete"]=!1,e.admin=!1}})},d=function(){return _.each(e.existRoleList,function(e){e.read&&e.update&&e["delete"]?e.permission="11":e.read&&e.update&&!e["delete"]?e.permission="10":e.read&&!e.update&&e["delete"]?e.permission="01":!e.read||e.update||e["delete"]?delete e.permission:e.permission="00",e.resType=i.type,e.resId=i.id}),e.existRoleList};e.ok=function(){r.post("admin/updateRoleResById.do",{permissionSetting:angular.toJson(d())}).success(function(t){"1"==t?a.close():e.alerts=[{msg:t.msg,type:"error"}]})},e.cancel=function(){a.dismiss("cancel")},e.close=function(){a.dismiss("cancel")}}]),discovery.service("dashboardService",["$http",function(e){"ngInject";this.boardData,this.saveWidget=function(e,t,a){var r={name:e,width:12,datasource:t,config:angular.copy(a)};if(this.boardData)this.boardData.rows.push({widgets:[r]}),this.saveThis();else{var n=this;this.get(function(e){e.rows.push({widgets:[r]}),n.saveThis()})}},this.saveThis=function(){e.post("dashboard/saveData.do",{json:angular.toJson(this.boardData)}).success(function(){})},this.save=function(t){e.post("dashboard/saveData.do",{json:angular.toJson(t)}).success(function(){})},this.get=function(t){var a=this;e.get("dashboard/getData.do").success(function(e){e||(e={rows:[]}),a.boardData=e,t(a.boardData)})}}]),discovery.service("dataService",["$http","$q","updateService","ComputedValueService","BoardParamService",function($http,$q,updateService,ComputedValueService,BoardParamService){"ngInject";function parserExp(e){var t=e,a=[],r=[];t=t.trim().replace(/[\n|\r|\r\n]/g,""),_.each(t.match(/".*?"/g),function(e){t=t.replace(e,"_#"+a.length),a.push(e)});var n=[];return _.each(t.match(/(sum|avg|count|max|min|distinct)\("?.*?"?\)/g),function(e){var i=e.substring(0,e.indexOf("(")),o=e.substring(e.indexOf("(")+1,e.indexOf(")"));o.match("_#")&&(o=a[o.replace("_#","")].replace(/\"/g,"")),t=t.replace(e,"groupData[_names["+n.length+"]]['"+i+"'][key]"),n.push(o),r.push({name:o,aggregate:i})}),{evalExp:t,aggs:r,names:n}}var dataSetMap={},tableDrill={},getDatasetList=function(e){var t=$q.defer(),a=dataSetMap[e];return _.isUndefined(a)?$http.get("dashboard/getDatasetById.do?id="+e).success(function(a){dataSetMap[e]=a[0],t.resolve(a[0])}):t.resolve(a),t.promise};this.getDatasetList=function(e){var t=$q.defer(),a="";_.each(e,function(e){dataSetMap[e],a+="id="+e+"&"});a.substring(0,a.length-1);return $.ajax({type:"POST",url:baseUrl+"dashboard/getDatasetByIdList.do",traditional:!0,data:{id:e,token:getQueryString("yili-token")},dataType:"json",async:!1}).success(function(e){_.each(e,function(e){_.isUndefined(dataSetMap[e.id])&&(dataSetMap[e.id]=e)}),t.resolve()}),t.promise},this.linkDataset=function(e,t){return linkDataset(e,t)};var linkDataset=function(e,t){if(_.isUndefined(e)||_.isUndefined(t)){var a=$q.defer();return a.resolve(),a.promise}return getDatasetList(e).then(function(e){var a=$q.defer();_.each(t.filters,function(t){if(t.group){var a=_.find(e.data.filters,function(e){return e.id==t.id});a&&(t.filters=a.filters,t.group=a.group)}}),_.each(t.values,function(t){_.each(t.cols,function(t){if("exp"==t.type){var a=_.find(e.data.expressions,function(e){return t.id==e.id});a&&(t.exp=a.exp,t.alias=a.alias)}})});var r=function(t){if(t.id){var a,r;_.each(e.data.schema.dimension,function(e){"level"==e.type?_.each(e.columns,function(n){n.id==t.id&&(r=n,a=e)}):t.id==e.id&&(r=e)}),r&&r.alias&&(t.alias=r.alias,a&&(t.level=a.alias))}};return _.each(t.keys,r),_.each(t.groups,r),a.resolve(e.data?e.data.schema:null),a.promise})},getDimensionConfig=function getDimensionConfig(array,schema){var result=[];return array&&_.each(array,function(e){if("computedDimension"==e.type){var setResult=function(e,t){(e.dependOn.indexOf(t.alias)>-1||e.dependOn.indexOf(t.column)>-1||e.formula2.indexOf(t.alias)>-1||e.formula2.indexOf(t.column)>-1)&&result.push({columnName:t.column,filterType:t.filterType?t.filterType:"eq",values:[],id:t.id,style:t.style?t.style:"string"})};_.each(schema.dimension,function(t){_.isArray(t.columns)?_.each(t.columns,function(t){setResult(e,t)}):setResult(e,t)})}else _.isUndefined(e.group)?result.push({columnName:e.col,filterType:e.type,values:e.values,id:e.id,style:e.style?e.style:"string"}):_.each(e.filters,function(f){var hasValue=!1;if(f.isExp&&f.exp){var reg=/\[&[^\]]+/g,argsList=f.exp.match(reg),allArgsHad=!0,exp=f.exp;if(argsList)for(var i=0;i<argsList.length;i++){var argName=argsList[i].substr(2),argValue=BoardParamService.get(argName);if("undefined"==typeof argValue){allArgsHad=!1;break}exp=exp.replace("[&"+argName+"]","("+argValue+")")}try{var expResult=eval(exp);hasValue=!0,result.push({columnName:f.col,filterType:f.type,values:[expResult],style:f.style?f.style:"string"})}catch(e){console.error("dataService:function-getDimensionConfig,row-111,eval(exp)执行错误",e)}}hasValue||result.push({columnName:f.col,filterType:f.type,values:f.values})})}),result};this.getDimensionValues=function(e,t,a,r,n,i){n=angular.copy(n),linkDataset(a,n).then(function(o){var s=void 0;n&&(s={rows:[],columns:[],filters:[]},s.rows=getDimensionConfig(n.keys,o),s.columns=getDimensionConfig(n.groups,o),s.filters=getDimensionConfig(n.filters,o)),$http.post("dashboard/getDimensionValues.do",{datasourceId:e,query:angular.toJson(t),datasetId:a,colmunName:r,cfg:angular.toJson(s)}).success(function(e){i(e)})})},this.getDataSeries=function(e,t,a,r,n,i,o){t.loadingCircle=!0,r=angular.copy(r),updateService.updateConfig(r),linkDataset(a,r).then(function(s){var l=ComputedValueService.precomputation(r,s);r.computedValue=l.values,r.computedKey=l.keys,r.computedGroup=l.groups,_.isUndefined(t.query)&&(t.query={}),o&&(t.query.param={},_.each(BoardParamService.getAll(),function(e,a){var r=_.find(t.paramList,function(e){return e.column==a});if(r)if("multiple"===r.selector){var n="'"+[e[0]].join("','")+"'";t.query.param[a]=n}else t.query.param[a]=e[0]}));var c=function(e,t){function a(e,t){var a=[];return _.each(e,function(e,r){r<=t&&a.push({columnName:e.col,filterType:e.type,values:e.values,id:e.id})}),a}var r={},n=e.keys,i=e.groups,o=[],s=e.drillTier;return r.rows=[],r.columns=[],_.each(n,function(e){if(_.isUndefined(e.drillDown))"computedDimension"==e.type?(_.each(t.dimension,function(t){(e.dependOn.indexOf(t.alias)>-1||e.dependOn.indexOf(t.column)>-1||e.formula2.indexOf(t.alias)>-1||e.formula2.indexOf(t.column)>-1)&&r.rows.push({columnName:t.column,filterType:t.filterType?t.filterType:"eq",values:[],id:t.id})}),r.rows=_.uniq(r.rows)):r.rows.push({columnName:e.col,filterType:e.type,values:e.values,id:e.id});else{var n=[];s.keyTier>0&&!s.isGreat&&_.each(e.drillDown.slice(0,s.keyTier),function(e,t){n.push({columnName:e.col,filterType:"=",values:s.filters.key[t]})}),o=o.concat(n),s.isGreat?r.rows=r.rows.concat(a(e.drillDown,s.keyTier)):r.rows.push({columnName:e.drillDown[s.keyTier].col,filterType:e.drillDown[s.keyTier].type,values:e.drillDown[s.keyTier].values,id:e.drillDown[s.keyTier].id})}}),_.each(i,function(e){if(_.isUndefined(e.drillDown))"computedDimension"==e.type?(_.each(t.dimension,function(t){(e.dependOn.indexOf(t.alias)>-1||e.dependOn.indexOf(t.column)>-1||e.formula2.indexOf(t.alias)>-1||e.formula2.indexOf(t.column)>-1)&&r.columns.push({columnName:t.column,filterType:t.filterType?t.filterType:"eq",values:[],id:t.id})}),r.columns=_.uniq(r.columns)):r.columns.push({columnName:e.col,filterType:e.type,values:e.values,id:e.id});else{var a=[];s.groupTier>0&&!s.isGreat&&_.each(e.drillDown.slice(0,s.groupTier),function(e,t){a.push({columnName:e.col,filterType:"=",values:s.filters.group[t]})}),o=o.concat(a),r.columns.push({columnName:e.drillDown[s.groupTier].col,filterType:e.drillDown[s.groupTier].type,values:e.drillDown[s.groupTier].values,id:e.drillDown[s.groupTier].id})}}),e.chart_type&&_.each(s.treeGridFilters,function(e,t){o.push({columnName:t,filterType:"=",values:e,style:"string"})}),r.filters=o,r},d=function(e){var t=e.rows,a=e.columns,r={},n=[];return _.each(t,function(e,t){r[e.columnName]=!0}),_.each(a,function(e,t){r[e.columnName]===!0&&n.push(t)}),_.each(n,function(e){a.splice(e,1)}),e},u=getDataSeries(r),f={rows:[],columns:[],filters:[]};if(f.rows=getDimensionConfig(r.keys,s),f.columns=getDimensionConfig(r.groups,s),f.filters=getDimensionConfig(r.filters,s),f.events=getDimensionConfig(r.events,s),f.filters=f.filters.concat(getDimensionConfig(r.boardFilters,s)),f.values=_.map(u,function(e){return{column:e.name,aggType:e.aggregate}}),0!=f.rows.length||0!=f.columns.length||0!=f.filters.length||0!=f.events.length||0!=f.filters.length||0!=f.values.length){var p=c(r,s);p.rows.length&&(f.rows=p.rows),p.columns.length&&(f.columns=p.columns),p.filters.length&&(f.filters=f.filters.concat(p.filters)),f=d(f);var g=t.query?t.query:{};"undefined"==typeof g.param&&(g.param={});var m=BoardParamService.getAll(),h={};for(var v in m){var y=m[v];_.isArray(y)&&0===y.length&&(y="'all'"),"all"===y?y="'all'":_.isArray(y)&&(y="'"+y.join("','")+"'"),h[v]=y}g.param=h,g.param.cols=[];var w={};f.rows.forEach(function(e){w[e.columnName]=!0}),f.columns.forEach(function(e){w[e.columnName]=!0});for(var v in w)g.param.cols.push(v);for(var b in f.filters)f.filters[b].style||(f.filters[b].style="string");for(var b in f.rows)f.rows[b].style||(f.rows[b].style="string");var C=[];if(f.rows)for(var b=0;b<f.rows.length;b++)if(f.rows[b].values&&f.rows[b].values.length>0){var I=f.rows[b].values;"string"==typeof I&&(I=[I]),C.push({name:f.rows[b].columnName,type:"=",value:I})}if(f.filters)for(var b=0;b<f.filters.length;b++){var x=f.filters[b],I=x.values;"string"==typeof I&&(I=[I]),C.push({name:x.columnName,type:x.filterType,value:I})}for(var b=0;b<C.length;b++)for(var N=0;N<C[b].value.length;N++)"string"==typeof C[b].value[N]&&(C[b].value[N]="'"+C[b].value[N]+"'");g.param.func_whrcols=C;try{r.option&&r.option.advancedOption&&$.extend(g,JSON.parse(r.option.advancedOption))}catch(T){console.error("advancedOption error",r.option.advancedOption)}g.param.func_grpcols=g.param.cols;for(var D in g.param)"-1"!==g.param[D]&&g.param[D]!==-1||(g.param[D]=void 0);$http.post("dashboard/getAggregateData.do",{datasourceId:e,query:angular.toJson(g),datasetId:a,cfg:angular.toJson(f),reload:i,cache:t.config.redis,token:getQueryString("yili-token")}).success(function(e){var i=ComputedValueService.replaceDisplay(e,r),o=castRawData2Series(i,r,t.wName);o.chartConfig=r,o.wName=t.wName,window.$$EXCEL||(window.$$EXCEL={}),_.isUndefined(a)?n(o):getDrillConfig(a,r).then(function(e){o.drill={config:e},tableDrill[t.wName]=o,n(o)}),t.loadingCircle=!1})}})},this.getDrillPath=function(e,t){var a=$q.defer();return getDatasetList(e).then(function(e){var r,n=[];_.each(e.data.schema.dimension,function(e){"level"==e.type&&_.each(e.columns,function(a){a.id==t&&(n=e.columns,r=e)})}),n=_.map(n,function(e){return{id:e.id,alias:e.alias,col:e.column,level:r.alias,type:"=",values:[],sort:"sort"}}),a.resolve(n)}),a.promise};var getDrillConfig=function(e,t){var a=$q.defer();return getDatasetList(e).then(function(e){var r={};if(!e.data.schema||0==e.data.schema.dimension.length)return a.resolve(r),
a.promise;var n=function(t){_.each(t,function(a,n){var i,o,s,l;if(_.find(e.data.schema.dimension,function(e){if("level"==e.type)return _.find(e.columns,function(t,r){if(t.id==a.id)return i=e,o=r,s=e.id,l=e.columns,!0})}),i){var c=!1;n>0&&o>0&&(c=t[n-1].id==i.columns[o-1].id);var d=n>0,u=!1;n<t.length-1&&o<i.columns.length-1&&(u=t[n+1].id==i.columns[o+1].id);var f=o==i.columns.length-1,p=0,g=_.find(t,function(e,t){if(o<i.columns.length-1&&i.columns[o+1].id==e.id)return p=t,!0}),m=!g||p==n+1,h=o>0&&n>0&&c&&(n==t.length-1||!u)&&d,v=(u||!f)&&m;r[a.id]={up:h,down:v,dimensionId:s,length:l,index:o}}})};n(t.keys),n(t.groups),a.resolve(r)}),a.promise};this.viewQuery=function(e,t){e.config=angular.copy(e.config),updateService.updateConfig(e.config),linkDataset(e.datasetId,e.config).then(function(a){var r=getDataSeries(e.config),n={rows:[],columns:[],filters:[]};n.rows=getDimensionConfig(e.config.keys,a),n.columns=getDimensionConfig(e.config.groups,a),n.filters=getDimensionConfig(e.config.filters,a),n.filters=n.filters.concat(getDimensionConfig(e.config.boardFilters,a)),n.values=_.map(r,function(e){return{column:e.name,aggType:e.aggregate}}),$http.post("dashboard/viewAggDataQuery.do",{datasourceId:e.datasource,query:angular.toJson(e.query),datasetId:e.datasetId,cfg:angular.toJson(n)}).success(function(e){t(e[0])})})},this.getColumns=function(e){e.query=angular.copy(e.query),"undefined"==typeof e.query&&(e.query={}),e.query.param={},e.paramList&&e.paramList.paramList&&_.isArray(e.paramList.paramList)&&_.each(e.paramList.paramList,function(t){"multiple"==t.selector?e.query.param[t.column]="1":e.query.param[t.column]="1"}),$http.post("dashboard/getColumns.do",{datasourceId:e.datasource,query:e.query?angular.toJson(e.query):null,datasetId:e.datasetId,reload:e.reload}).success(function(t){e.callback(t)})},this.getColumnsByDatasetConfig=function(e){$http.get("dashboard/getDatasetById.do?id="+e.datasetId).success(function(t){e.callback(t[0])})};var getDataSeries=function(e){var t=[];return _.each(e.values,function(e){_.each(e.cols,function(e){var a=configToDataSeries(e);_.each(a,function(e){_.find(t,function(t){return JSON.stringify(t)==JSON.stringify(e)})||t.push(e)})})}),t},configToDataSeries=function(e){switch(e.type){case"exp":return getExpSeries(e.exp);case"computed":return getComputedSeries(e);default:return[{name:e.col||e.column,aggregate:e.aggregate_type||null}]}},getComputedSeries=function(e){var t=[];return _.each(e.dependOn,function(e){t.push({name:e.column,aggregate:e.aggType||"sum"})}),t},getExpSeries=function(e){return parserExp(e).aggs},filter=function(e,t){switch(e.f_type){case"=":case"eq":for(var a=0;a<e.f_values.length;a++)if(t==e.f_values[a])return!0;return 0==e.f_values.length;case"≠":case"ne":for(var a=0;a<e.f_values.length;a++)if(t==e.f_values[a])return!1;return!0;case">":var r=e.f_values[0],n=toNumber(t,r);return!(!_.isUndefined(r)&&n[0]<=n[1]);case"<":var r=e.f_values[0],n=toNumber(t,r);return!(!_.isUndefined(r)&&n[0]>=n[1]);case"≥":var r=e.f_values[0],n=toNumber(t,r);return!(!_.isUndefined(r)&&n[0]<n[1]);case"≤":var r=e.f_values[0],n=toNumber(t,r);return!(!_.isUndefined(r)&&n[0]>n[1]);case"(a,b]":var i=e.f_values[0],o=e.f_values[1],n=toNumber(t,i,o);return!(!_.isUndefined(i)&&!_.isUndefined(o)&&(n[0]<=n[1]||n[0]>n[2]));case"[a,b)":var i=e.f_values[0],o=e.f_values[1],n=toNumber(t,i,o);return!(!_.isUndefined(i)&&!_.isUndefined(o)&&(n[0]<n[1]||n[0]>=n[2]));case"(a,b)":var i=e.f_values[0],o=e.f_values[1],n=toNumber(t,i,o);return!(!_.isUndefined(i)&&!_.isUndefined(o)&&(n[0]<=n[1]||n[0]>=n[2]));case"[a,b]":var i=e.f_values[0],o=e.f_values[1],n=toNumber(t,i,o);return!(!_.isUndefined(i)&&!_.isUndefined(o)&&(n[0]<n[1]||n[0]>n[2]));default:return!0}},toNumber=function(){for(var e=_.isArray(arguments[0])?arguments[0]:arguments,t=[],a=0;a<e.length;a++){var r=Number(e[a]);if(isNaN(r))return e;t.push(r)}return t};this.toNumber=toNumber;var castRawData2Series=function(e,t,a){for(var r=new Array,n=new Array,i={},o={},s={},l=function(e,t){var a=new Array;if(t)for(var r=0;r<t.length;r++){var n=_.find(e,function(e){return e.name==t[r]});a.push(n.index)}return a},c=l(e.columnList,_.map(t.keys,function(e){return e.drillDown?e.drillDown[t.drillTier.keyTier].col:e.col||e.column})),d=_.map(t.keys,function(e){return e.sort}),u=l(e.columnList,_.map(t.groups,function(e){return e.drillDown?e.drillDown[t.drillTier.groupTier].col:e.col||e.column})),f=_.map(t.groups,function(e){return e.drillDown?e.drillDown[t.drillTier.groupTier].sort:e.sort}),p=_.filter(e.columnList,function(e){return e.aggType}),g=0;g<e.data.length;g++){var m=getRowElements(e.data[g],c),h=m.join("-");_.isUndefined(i[h])&&(r.push(m),i[h]=!0);var v=getRowElements(e.data[g],u),y=v.join("-");_.isUndefined(o[y])&&(n.push(v),o[y]=!0),_.each(p,function(t){_.isUndefined(s[y])&&(s[y]={}),_.isUndefined(s[y][t.name])&&(s[y][t.name]={}),_.isUndefined(s[y][t.name][t.aggType])&&(s[y][t.name][t.aggType]={}),"string"!=t.aggType?s[y][t.name][t.aggType][h]=parseFloat(e.data[g][t.index]):s[y][t.name][t.aggType][h]=e.data[g][t.index]})}var w=function(e){return function(t,a){for(var r=0,n=0;n<t.length;n++)if(e[n]){if(t[n]!=a[n]){var i=toNumber(t[n],a[n]);r=i[0]>i[1]?1:-1,"desc"==e[n]&&(r*=-1);break}r=0}return r}};r.sort(w(d)),n.sort(w(f));var b=new Array,C={},I=new Array,x=void 0,N=[];if(_.each(n,function(e){_.each(t.values,function(t){_.each(t.cols,function(t){_.isUndefined(x)&&t.sort&&(x=t.sort,castSeriesData(t,e.join("-"),r,s,function(e,t){N[t]={v:e,i:t}}))})})}),!_.isUndefined(x)){N.sort(function(e,t){if(e.v==t.v)return 0;var a=toNumber(e.v,t.v);return(_.isNaN(a[0])||_.isUndefined(a[0])||_.isNull(a[0])||a[0]===1/0||a[0]===-(1/0))&&(a[0]=-(1/0)),(_.isNaN(a[1])||_.isUndefined(a[1])||_.isNull(a[1])||a[1]===1/0||a[1]===-(1/0))&&(a[1]=-(1/0)),"asc"==x?a[0]-a[1]:a[1]-a[0]});var T=angular.copy(r);_.each(N,function(e,t){r[t]=T[e.i]})}_.each(n,function(e){_.each(t.values,function(t,a){_.each(t.cols,function(n){var i=n.alias?n.alias:n.col,o=i;if(e&&e.length>0){var l=[].concat(e);l.push(i),o=l.join("-"),b.push(l)}else b.push([i]);C[o]={type:t.series_type,valueAxisIndex:a,formatter:n.formatter,dataStyle:n.dataStyle?n.dataStyle:null},castSeriesData(n,e.join("-"),r,s,function(e,t){I[b.length-1]||(I[b.length-1]=new Array),I[b.length-1][t]=e})})})});for(var g=0;g<r.length;g++){var D=0,S=!0;_.each(n,function(e){_.each(t.values,function(e){_.each(e.cols,function(e){S&&(e.f_top&&e.f_top<=g&&(S=!1),filter(e,I[D][g])||(S=!1),S&&(I[D][g]=dataFormat(I[D][g])),D++)})})}),S||(r.splice(g,1),_.each(I,function(e){e.splice(g,1)}),g--)}var M=[];_.each(t.keys,function(e,t){1==e.hide&&M.push(t)}),M=M.reverse();for(var g=0;g<r.length;g++)for(var k=0;k<M.length;k++)r[g].splice(M[k],1);return{originalData:e,keys:r,series:b,data:I,seriesConfig:C}},castSeriesData=function(e,t,a,r,n){switch(e.type){case"exp":for(var i=compileExp(e.exp),o=0;o<a.length;o++)n(i(r[t],a[o].join("-")),o);break;case"computed":for(var o=0;o<a.length;o++)n(r[t][e.col||e.column][e.aggregate_type][a[o].join("-")],o);break;default:for(var o=0;o<a.length;o++)n(r[t][e.col][e.aggregate_type][a[o].join("-")],o)}},compileExp=function compileExp(exp){var parseredExp=parserExp(exp);return function(groupData,key){var _names=parseredExp.names;return eval(parseredExp.evalExp)}},aggregate=function(e,t){if(!e)return e;switch(t){case"sum":return aggregate_sum(e);case"count":return aggregate_count(e);case"avg":return aggregate_avg(e);case"max":return _.max(e,function(e){return parseFloat(e)});case"min":return _.min(e,function(e){return parseFloat(e)})}},aggregate_sum=function(e){for(var t=0,a=0;a<e.length;a++){var r=parseFloat(e[a]);r&&(t+=r)}return t},aggregate_count=function(e){return e.length},aggregate_avg=function(e){for(var t=0,a=0,r=0;r<e.length;r++){var n=parseFloat(e[r]);n&&(t+=n,a++)}return 0==a?0:t/a},getHeaderIndex=function(e,t){var a=new Array;if(t)for(var r=0;r<t.length;r++){var n=_.indexOf(e[0],t[r]);a.push(n)}return a},getRowElements=function(e,t){for(var a=new Array,r=0;r<t.length;r++){var n=e[t[r]];a.push(n)}return a};this.getTableDataDrillByWidget=function(){return tableDrill},this.getDatasetListMap=function(){return dataSetMap}}]),discovery.directive("dashboardWidget",["$compile","$templateCache","dataService","chartService",function(e,t,a,r){"ngInject";var n=function(a,r,n){var i=t.get("echartContent");a.myheight=a.row.height?a.row.height-44:300;var o=e(i);r.append(o(a));var s=$(r).find(".box-body");a.widget.render(s,null,a)},i=function(a,r,n){var i=t.get("chartContent");a.myheight=a.row.height?a.row.height-44:300;var o=e(i);r.append(o(a));var s=$(r).find(".box-body");a.widget.render(s,null,a)},o=function(a,r,n){var i=t.get("kpiContent"),o=e(i)(a);r.append(o);var s=$(r).find(".kpi-body");a.widget.render(s,null,a)},s=function(a,r,n){var i=t.get("selectorContent"),o=e(i)(a);r.append(o);var s=$(r).find(".box-body");a.widget.render(s,null,a)},l=function(a,r,n){var i=t.get("chartContent");a.myheight=a.row.height?a.row.height-44:500;var o=e(i)(a);r.append(o);var s=$(r).find(".box-body");a.widget.render(s,null,a)};return{restrict:"E",scope:!0,compile:function(e,t){return{pre:function(e,t,a){},post:function(e,t,a){switch(e.widget.widget.data.config.chart_type){case"line":n(e,t,a);break;case"line2":n(e,t,a);break;case"line3":n(e,t,a);break;case"pie":n(e,t,a);break;case"kpi":o(e,t,a);break;case"table":l(e,t,a);break;case"crossTable":l(e,t,a);break;case"treeGrid":l(e,t,a);break;case"crossGreatTable":l(e,t,a);break;case"selector":s(e,t,a);break;case"funnel":n(e,t,a);break;case"sankey":n(e,t,a);break;case"chord":n(e,t,a);break;case"radar":n(e,t,a);break;case"map":i(e,t,a);break;case"scatter":n(e,t,a);break;case"gauge":n(e,t,a);break;case"wordCloud":n(e,t,a);break;case"treeMap":n(e,t,a);break;case"areaMap":n(e,t,a);break;case"heatMapCalendar":n(e,t,a);break;case"heatMapTable":n(e,t,a);break;case"markLineMap":n(e,t,a);break;case"liquidFill":n(e,t,a)}}}}}}]),discovery.filter("hasBoards",function(){"ngInject";return function(e,t){if(void 0==t)return t;var a=t.map(function(e){return e.categoryId}),r=_.filter(e,function(e){return _.contains(a,e.id)});return r}}),discovery.filter("hasCategoryId",function(){"ngInject";return function(e){var t=[];if(!_.isUndefined(e))for(var a=0;a<e.length;a++)null==e[a].categoryId&&t.push(e[a]);return t}});var CBoardD3Render=function(e,t,a,r){this.container=e,this.options=t,this.service=a,this.uuid=r;var n=this;$(this.container).resize(function(e){n.resize(e.target)})};CBoardD3Render.prototype.resize=function(e){this.service.redraw($(e),this)},CBoardD3Render.prototype.chart=function(e,t){return this.service.draw(this.container,this.options,this),function(e,t){}},discovery.service("BoardParamService",["$http",function(e){"ngInject";window.$$dlut_param={},this.get=function(e,t){return"function"==typeof t&&t(window.$$dlut_param[e]),window.$$dlut_param[e]},this.set=function(e,t){_.isUndefined(window.$$dlut_param[e])&&(window.$$dlut_param[e]={}),window.$$dlut_param[e]=t},this.getAll=function(){return window.$$dlut_param},this.remove=function(e){delete window.$$dlut_param[e]},this.clear=function(){window.$$dlut_param={}}}]),discovery.service("ComputedValueService",["$q","BoardParamService",function($q,BoardParamService){"ngInject";function schemaComputedRender(computed,scomputed){var regCalc=/\[&[^\]]+\]/g,regFormula=/\[\$[^\]]+\]/g,preCalc=computed.preCalc,formula=computed.formula;if(preCalc){var regCalcArr=preCalc.match(regCalc);_.each(regCalcArr,function(e){var t=BoardParamService.get(e.substring(2,e.length-1));preCalc=preCalc.replace(e,'"'+t+'"')});try{computed.formula2=eval(preCalc)}catch(e){console.log("预处理公式错误:ComputedValueService:function-this.precomputation,row-8,eval(preCalc)执行错误",preCalc,computed.column,e)}}else computed.formula&&""!==computed.formula&&(computed.formula2=computed.formula);formula=computed.formula2?computed.formula2:"";var n=0,isWhile=!0;do{var regFormulaArr=formula.match(regFormula);regFormulaArr&&(isWhile=!1),_.each(regFormulaArr,function(e){var t=_.find(scomputed,function(t){return t.column==e.substring(2,e.length-1)});formula=formula.replace(e,t.formula2)}),computed.formula2=formula,n++}while(n<100&&isWhile)}function computedKeys(e,t){var a=/\[#[^\]^&^$]+/g;_.each(e,function(e){if(t.col==e.column||t.column==e.column){var r=e.formula2.match(a);t.dependOn=[],t.formula2=e.formula2,_.each(r,function(e){var a=e.substring(2),r=a.split(":"),n=null;if(r.length>1)n=r[1];else{if(1!==r.length)return;n=r[0]}n&&!_.find(t.dependOn,function(e){return e.column==n})&&t.dependOn.push({column:n})})}})}function computedValues(e,t,a){var r=/\[#[^\]^&^$]+/g,n=/(TOTAL|RANK|RUNNING_SUM|MAX|MIN)\([^\(^)]+/g;_.each(e,function(e){if(t.col==e.column||t.column==e.column){var i=e.formula2.match(r),o=e.formula2.match(n);if(t.aggregate_type="sum",t.aggType=e.aggType,t.dependOn=[],t.dependOnFun={},t.formula2=e.formula2,_.each(i,function(e){var a=e.substring(2),r=a.split(":"),n=null,i=null;if(r.length>1)n=r[1],i=r[0];else{if(1!==r.length)return;n=r[0],i="sum"}n&&i&&!_.find(t.dependOn,function(e){return e.column==n})&&t.dependOn.push({column:n,aggType:i})}),_.isArray(o))for(var s=0;s<o.length;s++){var l=o[s].replace(/[\'\"]/g,""),c=l.match(/[^(^,]+/g);"undefined"==typeof c[2]&&(c[2]="sum"),_.isUndefined(_.find(t.dependOn,function(e){return e.column==c[1]}))&&t.dependOn.push({column:c[1],aggType:c[2]}),a&&a.dependOnFun&&("undefined"==typeof a.dependOnFun[c[0]]&&(a.dependOnFun[c[0]]=[]),a.dependOnFun[c[0]].push({fun:c[0],column:c[1],aggType:c[2],extend:c[3]}))}}})}function displayComputedKeys(e,t,a,r,n){_.each(e,function(a){_.each(t,function(t,r){var n=_.find(a.dependOn,function(e){return e.column==t.name});n&&(_.find(e,function(e){return n==e.col||n==e.column})?t["delete"]=!1:t["delete"]=!0)})}),_.each(e,function(e){_.isUndefined(e.formula2)||(_.each(a,function(t){var a=0,i=!0,o=e.formula2;do{var s=o.match(n);s||(i=!1),_.each(s,function(e){var a=e.substring(2,e.length-1);_.isUndefined(r[a])||(o=o.replace(e,t[r[a]]))}),e.formula3=o,a++}while(a<100&&i);try{t.push(e.formula3)}catch(l){console.log("ComputedValueService:function-displayComputedValues,row-197,eval(c.formula3)执行错误",e.formula3,e.column,l)}}),a.length>0&&t.push({index:a[0].length-1,aggType:null,name:e.col||e.column}))})}function displayComputedValues(computedValues,columns,oData,columnIndexMap,reg){for(var i=0;i<computedValues.length;i++)for(var cv=computedValues[i],j=0;j<cv.cols.length;j++){var c=cv.cols[j];if(c.aggregate_type=c.aggType?c.aggType:c.aggregate_type,_.each(columns,function(e,t){var a=_.find(c.dependOn,function(t){return t.column==e.name});a&&(_.find(cv.cols,function(e){return a==e.col||a==e.column})?e["delete"]=!1:e["delete"]=!0)}),!_.isUndefined(c.formula2)){for(var k=0;k<oData.length;k++){var data=oData[k],n=0,isWhile=!0,cFormula2=c.formula2;do{var regValues=cFormula2.match(reg);regValues||(isWhile=!1),_.each(regValues,function(e){var t=e.substring(2,e.length-1);columnIndexMap[t]&&(cFormula2=cFormula2.replace(e,data[columnIndexMap[t]]))}),c.formula3=cFormula2,n++}while(n<100&&isWhile);try{colData=data,c.formula3=eval(c.formula3),data.push(c.formula3)}catch(e){console.log("ComputedValueService:function-displayComputedValues,row-197,eval(c.formula3)执行错误",c.formula3,c.column,e)}}oData.length>0&&columns.push({index:oData[0].length-1,aggType:c.aggType,name:c.col||c.column})}}}function TOTAL(e,t){try{"undefined"==typeof t&&(t="sum");var a=this.funCacheMap.indexMap[t+":"+e];return this.funCacheMap.TOTAL[a]}catch(r){return console.error("TOTAL ERROR"),0}}function MAX(e,t){try{"undefined"==typeof t&&(t="sum");var a=this.funCacheMap.indexMap[t+":"+e];return this.funCacheMap.MAX[a]}catch(r){return console.error("MAX ERROR"),0}}function MIN(e,t){try{"undefined"==typeof t&&(t="sum");var a=this.funCacheMap.indexMap[t+":"+e];return this.funCacheMap.MIN[a]}catch(r){return console.error("MIN ERROR"),0}}function RANK(e,t,a){try{"undefined"==typeof t&&(t="sum"),"undefined"==typeof a&&(a="desc");var r=this.funCacheMap.indexMap[t+":"+e];return this.funCacheMap.RANK[a+r][parseFloat(this.colData[r])]}catch(n){return console.error("RANK ERROR"),0}}function RUNNING_SUM(e,t){try{"undefined"==typeof t&&(t="sum");var a=this.funCacheMap.indexMap[t+":"+e];return this.funCacheMap.RUNNING_SUM[a]+=parseFloat(colData[a]),this.funCacheMap.RUNNING_SUM[a]}catch(r){return console.error("RUNNING_SUM ERROR"),0}}this.precomputation=function(e,t){var a=e.values,r=e.keys,n=e.groups;if(_.isUndefined(t.computed)&&_.isUndefined(t.computedDimension))return!1;var i=!1,o=!1,s=!1;return _.each(a,function(e){_.each(e.cols,function(e){_.find(t.computed,function(t){return t.column==e.column||t.column==e.col})&&(e.isComputed=!0,i=!0)})}),_.each(r,function(e){_.find(t.computedDimension,function(t){return t.column==e.column||t.column==e.col})&&(e.isComputed=!0,o=!0)}),_.each(n,function(e){_.find(t.computedDimension,function(t){return t.column==e.column||t.column==e.col})&&(e.isComputed=!0,s=!0)}),!!(i||o||s)&&(_.each(t.computedDimension,function(e){schemaComputedRender(e,t.computedDimension)}),_.each(t.computed,function(e){schemaComputedRender(e,t.computed)}),_.each(r,function(e){e.isComputed&&computedKeys(t.computedDimension,e)}),_.each(n,function(e){e.isComputed&&computedKeys(t.computedDimension,e)}),e.dependOnFun={},_.each(a,function(a){_.each(a.cols,function(a){a.isComputed&&computedValues(t.computed,a,e)})}),e)},this.replaceDisplay=function(e,t){for(var a=e.columnList,r=e.data,n={},i=t.computedValue,o=t.computedKey,s=t.computedGroup,l=0;l<a.length;l++){var c=a[l],d=c.aggType?c.aggType+":":"";n[d+c.name]=c.index,"sum:"===d&&(n[c.name]=c.index)}if(t.option&&t.option.total&&r.length>0){for(var u=(r[0],[]),f=0,l=0;l<a.length;l++)if(null!==a[l].aggType){for(var p=0,g=0;g<r.length;g++){var m=parseFloat(r[g][l]);_.isNaN(m)||(p+=m)}u.push(p)}else f=l,u.push("");u[f]="总计",r.push(u)}if(funCacheMap={TOTAL:{},RUNNING_SUM:{},RANK:{},MAX:{},MIN:{},indexMap:n},t.dependOnFun){var p=t.dependOnFun.TOTAL;if(p&&p.length>0)for(var l=0;l<p.length;l++){for(var h=p[l],v=n[h.aggType+":"+h.column],y=0,g=0;g<r.length;g++){var m=parseFloat(r[g][v]);m&&(y+=m)}funCacheMap.TOTAL[v]=y}var w=t.dependOnFun.MAX;if(w&&w.length>0)for(var l=0;l<w.length;l++){for(var h=w[l],v=n[h.aggType+":"+h.column],b=0,g=0;g<r.length;g++){var C=parseFloat(r[g][v]);C>b&&(b=C)}funCacheMap.MAX[v]=b}var I=t.dependOnFun.MIN;if(I&&I.length>0)for(var l=0;l<I.length;l++){for(var h=I[l],v=n[h.aggType+":"+h.column],x=1/0,g=0;g<r.length;g++){var C=parseFloat(r[g][v]);C<x&&(x=C)}funCacheMap.MIN[v]=x}var N=t.dependOnFun.RUNNING_SUM;if(N&&N.length>0)for(var l=0;l<N.length;l++){var h=N[l],v=n[h.aggType+":"+h.column];funCacheMap.RUNNING_SUM[v]=0}var T=t.dependOnFun.RANK;if(T&&T.length>0)for(var l=0;l<T.length;l++){for(var h=T[l],v=n[h.aggType+":"+h.column],D=h.extend?h.extend:"desc",S=[],g=0;g<r.length;g++)S.push(parseFloat(r[g][v]));var M=function(e,t){return e<t};"asc"===D&&(M=function(e,t){return e>t}),S=S.sort(M);for(var k={},g=S.length-1;g>=0;g--)k[parseFloat(S[g])]=g+1;funCacheMap.RANK[D+v]=k}}var O=/\[[^\]^&^$]+\]/g;return _.isArray(i)&&displayComputedValues(i,a,r,n,O),_.isArray(o)&&displayComputedKeys(o,a,r,n,O),_.isArray(s)&&displayComputedKeys(s,a,r,n,O),colData=void 0,funCacheMap=void 0,{columnList:a,data:r}}}]),discovery.service("menuDataService",function(){"ngInject";this.handlePath=function(e){var t=e.split("/"),a="";for(var r in t)r>0&&r!==JSON.stringify(t.length-1)?a=a+t[r]+"/":r===JSON.stringify(t.length-1)&&(a+=t[r]);return a},this.buildTree=function(e,t,a){if(e){if(null==e.categoryName){var r={};return r.name=e.name,r.type="file",r.id=e.id,r.children=[],void a.push(r)}if(e.categoryName.indexOf("/")!==-1){if(0===t.length){var n={};return n.name=e.categoryName.split("/")[0],n.type="folder",n.id=e.id,n.children=[],t.push(n),e.categoryName=this.handlePath(e.categoryName),void this.buildTree(e,t[t.length-1].children,a)}for(j in t){if(e.categoryName.split("/")[0]===t[j].name)return e.categoryName=this.handlePath(e.categoryName),void this.buildTree(e,t[j].children,a);if(j===JSON.stringify(t.length-1)){var n={};return n.name=e.categoryName.split("/")[0],n.type="folder",n.id=e.id,n.children=[],t.push(n),e.categoryName=this.handlePath(e.categoryName),void this.buildTree(e,t[t.length-1].children,a)}}}else{var n={};if(0===t.length){n.name=e.categoryName,n.type="folder",n.id=e.id,n.children=[];var i={};return i.name=e.name,i.type="file",i.id=e.id,i.children=[],n.children.push(i),void t.push(n)}for(var o in t){if(e.categoryName===t[o].name)return n.name=e.name,n.type="file",n.id=e.id,n.children=[],void t[o].children.push(n);if(o===JSON.stringify(t.length-1)){n.name=e.categoryName,n.type="folder",n.id=e.id,n.children=[];var i={};return i.name=e.name,i.type="file",i.id=e.id,i.children=[],n.children.push(i),void t.push(n)}}}}}});var chartDataProcess=function(e,t,a,r,n,i,o){var s=t,l=[],c=[],d=e.keys.length,u=s[0]?s[0].length:0,f=e.values[0].cols;Array.matrix=function(e,t,a){for(var r=[],n=0;n<e;++n){for(var i=[],o=0;o<t;++o)i[o]=a;r[n]=i}return r};for(var p=Array.matrix(s.length,u,0),g=0;g<u;g++)for(var m=0;m<s.length;m++)p[m][g]={property:"column_key",data:s[m][g]};for(var h=0;h<a.length;h++)for(var v=a[h].join("-"),y=n[v].formatter,w=n[v].dataStyle,b=0;b<t.length;b++)if(_.isUndefined(r[h][b]))p[b][h+d]={property:"data",data:"",showType:w?w.type:null,showNum:w?w.num:null};else{var C=r[h][b];p[b][h+d]={property:"data",data:y?numbro(C).format(y):C,raw:C,showType:w?w.type:null,showNum:w?w.num:null}}for(var I=Array.matrix(e.groups.length+1,a.length,0),x=0;x<a.length;x++)for(var v=a[x].join("-"),y=n[v].formatter,w=n[v].dataStyle,N=0;N<a[x].length;N++)I[N][x]={property:"header_key",data:a[x][N],sort:f[x]?f[x].sort:"sort",width:f[x]?f[x].width:null,showType:w?w.type:null,showNum:w?w.num:null};for(var T=0;T<d;T++)l.push({property:"header_key",column_header_header:!0,data:e.keys[T].alias?e.keys[T].alias:e.keys[T].col,width:e.keys[T].width,id:e.keys[T].id}),c.push({property:"header_empty",data:null});for(var b=0;b<I.length;b++)b==I.length-1?I[b]=l.concat(I[b]):I[b]=c.concat(I[b]);var D=I.concat(p),S={chartConfig:e,data:D,originalData:i,wName:o};return p=null,I=null,S};discovery.service("chartFunnelService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,e.chartConfig.option.tooltip),o=e.chartConfig.keys;for(var s in o)i[o[s].col]?i[o[s].col].col||(i[o[s].col].col=o[s].col):i[o[s].col]={col:o[s].col,isShow:!0,formatter:""};var l=e.chartConfig.option.tooltipTarget?e.chartConfig.option.tooltipTarget:{};for(var c in e.chartConfig.values){var d=e.chartConfig.values[c].cols;for(var u in d)l[d[u].col]?l[d[u].col].col||(l[d[u].col].col=d[u].col):l[d[u].col]={col:d[u].col,isShow:!0,formatter:""}}for(var f=_.map(a,function(e){return e.join("-")}),p=_.map(r,function(e){return e.join("-")}),g=[],m=100/(9*f.length+1),h=[],v=0;v<f.length;v++){var y={name:f[v],type:"funnel",left:m+v*m*9+"%",width:8*m+"%",maxSize:"100%",minSize:"10%",label:{normal:{formatter:function(e){return e.value+"\n"+e.data.percent+"%"},show:!0,position:"inside"}},data:[]};h.push({textAlign:"center",textStyle:{fontSize:12,fontWeight:"normal"},text:f[v],left:5*m+9*v*m+"%",top:"90%"});for(var w=_.max(n,function(e){return Number(e[v])})[v],b=0;b<p.length;b++){var C=CBoardEChartRenderEventInfo(e,v,b);y.data.push({eventInfo:C,name:p[b],value:n[b][v],percent:(n[b][v]/w*100).toFixed(2)})}g.push(y)}var I={title:h,legend:{data:p},tooltip:{trigger:"item",formatter:function(e){return e.seriesName+" <br/>"+e.name+" : "+e.value+"<br>"+e.data.percent+"%"}},toolbox:!1,series:g};return updateEchartOptions(t.option,I),I}}]),discovery.service("chartKpiService",["dataService","$compile","$filter",function(e,t,a){"ngInject";var r=a("translate");this.render=function(e,a,r,n){var i=new CBoardKpiRender(e,a),o=i.html(n);return r?e.append(t(o)(r)):e.html(o),i.realTimeTicket()},this.parseOption=function(e){var t={},a=e.chartConfig,n=(e.keys,e.series,e.data);e.seriesConfig;if(t.kpiValue=n.length>0?n[0][0]:"0",a.values[0].format&&(t.kpiValue=numbro(t.kpiValue).format(a.values[0].format)),t.kpiName=a.values[0].name,t.style=a.values[0].style,t.edit=r("COMMON.EDIT"),t.refresh=r("COMMON.REFRESH"),t.icon=a.values[0].icon,a.values[0].cols[0].unit)if("元"==a.values[0].cols[0].unit||"万"==a.values[0].cols[0].unit||"亿"==a.values[0].cols[0].unit){if(n.length>0){var i=dlut.utils.convertMoney(t.kpiValue,a.values[0].cols[0].unit);t.kpiValue=i.substr(0,i.length-1),t.unit=i.substr(i.length-1,i.length)}}else t.unit=a.values[0].cols[0].unit;else t.unit="";return t.align=a.values[0].align?a.values[0].align:"textLeft",t}}]),discovery.service("chartLineMapService",["$filter","EventService","uuid4",function(e,t,a){"ngInject";this.instance=null,this.render=function(e,a,r,n,i,o){return this.instance=new CBoardEChartRender(e,a,(void 0),o),this.instance.chart(null,n,t)},this.parseOption=function(e){for(var t=e.chartConfig,a=e.keys,r=(e.series,e.data,e.seriesConfig,new Array,_.map(a,function(e){return e.join("-")}),["startLongitude","startLatitude","startLabel","startMeans","startType","pointId"]),n=["endLongitude","endLatitude","endLabel","endMeans","endType","lineMeans","lineType"],i=["startValue","endValue","lineValue"],o=t.keys,s=t.groups,l=t.values,c=e.originalData.data,d=[],u=0;u<c.length;u++){for(var f={},p=c[u],g=0,m=0;m<s.length;m++)f[n[m]]=p[g],g++;for(var h=0;h<o.length;h++)f[r[h]]=p[g],g++;for(var v=0;v<l.length;v++)f[i[v]]=p[g],g++;d.push(f)}for(var y=["#ffad3d","#00ac57","#d3133e","#2489b0","#5bc0de","#c2ced1","rgba(255, 26, 0, 0.5)","rgba(36, 128, 0, 0.6)"],w=[],b=[],C={"default":{color:y[5],width:1,opacity:.6,curveness:.2},"试验":{color:y[0],width:1,opacity:.6,curveness:.2},"任务":{color:y[1],width:1,opacity:.6,curveness:.2},"事件":{color:y[2],width:1,opacity:.6,curveness:.2},"国际大事":{color:y[3],width:1,opacity:.6,curveness:.2},"装备调配":{color:y[4],width:1,opacity:.6,curveness:.2},red:{color:"red",width:1,opacity:.6,curveness:.2},green:{color:"#1ed107",width:1,opacity:.6,curveness:.2}},I={"default":{color:y[5],width:1,opacity:.6,curveness:.2},"试验":{color:y[0],width:1,opacity:.6,curveness:.2},"任务":{color:y[1],width:1,opacity:.6,curveness:.2},"事件":{color:y[2],width:1,opacity:.6,curveness:.2},"国际大事":{color:y[3],width:1,opacity:.6,curveness:.2},"装备调配":{color:y[4],width:1,opacity:.6,curveness:.2}},u=0;u<d.length;u++){var v=d[u];"-"!=v.endMeans&&""!=v.endMeans&&(b.push({lineStyle:{normal:C["-"!=v.lineType?v.lineType:"default"]},fromName:v.startMeans,toName:v.endMeans?v.endMeans:"-",coords:[[v.startLongitude,v.startLatitude],[v.endLongitude?v.endLongitude:"-",v.endLatitude?v.endLatitude:"-"]]}),w.push({lineStyle:{normal:I["-"!=v.lineType?v.lineType:"default"]},fromName:v.startMeans,toName:v.endMeans?v.endMeans:"-",coords:[[v.startLongitude,v.startLatitude],[v.endLongitude?v.endLongitude:"-",v.endLatitude?v.endLatitude:"-"]]}))}var x=function(){var e=[],t={"default":{symbol:null},"试验":{itemStyle:{normal:{color:y[0]}}},"低完好率":{itemStyle:{normal:{color:y[5]}}},"高完好率":{itemStyle:{normal:{color:y[6]}}},"任务":{itemStyle:{normal:{color:y[1]}}},"事件":{itemStyle:{normal:{color:y[2]}}},"国际大事":{itemStyle:{normal:{color:y[3]}}},"装备调配":{itemStyle:{normal:{color:y[4]}}},red:{symbol:"image://theme/theme_Beili01/images/red.png",symbolSize:20,label:{normal:{textStyle:{color:"red"}}}},green:{symbol:"image://theme/theme_Beili01/images/green.png",symbolSize:10,label:{normal:{textStyle:{color:"#1ed107"}}}},yellow:{symbol:"image://theme/theme_Beili01/images/yellow.png",symbolSize:15,label:{normal:{textStyle:{color:"yellow"}}}}},a=_.groupBy(d,"startType"),n={red:"告警",green:"良好",yellow:"关注"};for(var i in a){for(var s={type:"effectScatter",coordinateSystem:"geo",zlevel:2,label:{normal:{show:!0,position:"right",formatter:function(e){var t="";return"-"!==e.data.value[3]&&e.data.value[3]&&(t=e.data.value[3]),t},textStyle:{fontSize:18}}},symbolSize:15},l=[],c=0;c<a[i].length;c++){for(var u=a[i][c],f=[],p=0;p<r.length;p++){var g=r[p],m=o[p];m&&f.push({col:m.col,alias:m.alias,value:u[g]})}l.push($.extend({eventInfo:f,name:u.startMeans?u.startMeans:"-",value:[u.startLongitude,u.startLatitude,parseInt(u.startValue),u.startLabel]},t["-"!=i?i:"default"]))}s.data=l,s.name=n["-"!=i?i:"default"],"red"!=i&&(s.rippleEffect={scale:0}),e.push(s)}return e},N=function(){for(var e=[],t=[],a=0;a<t.length;a++)e.push({type:"lines",coordinateSystem:"geo",data:[{coords:t[a]}],polyline:!0,lineStyle:{normal:{color:"white",opacity:1,width:3}}});return e},T="path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z",D=[{type:"lines",zlevel:1,effect:{show:!0,period:6,trailLength:.7,color:"#fff",symbolSize:3},data:w},{type:"lines",symbol:["none","arrow"],symbolSize:10,effect:{show:!0,period:6,trailLength:0,symbol:T,symbolSize:30},data:b}];D=D.concat(D,x(),N());var S=t.option;if(S){var M,k;S.ctgLabelInterval?M=S.ctgLabelInterval:"auto",S.ctgLabelRotate?k=S.ctgLabelRotate:0}var O="data:image/png;base64,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",W=new Image;
W.src=O;var E={backgroundColor:"rgba(0,0,0,0)",legend:{show:!0,orient:"vertical",top:"top",left:"left",data:[{name:"告警",icon:"image://theme/theme_Beili01/images/red.png"},{name:"关注",icon:"image://theme/theme_Beili01/images/yellow.png"},{name:"良好",icon:"image://theme/theme_Beili01/images/green.png"}],itemWidth:20,itemHeight:20},tooltip:{trigger:"item",formatter:function(e){if("effectScatter"==e.seriesType){var t="";return t+=e.data.name+"<br>经度："+e.data.value[0]+"<br>纬度："+e.data.value[1]}if("lines"==e.seriesType){var t="";return e.data.fromName&&e.data.toName&&(t+=e.data.fromName+"->"+e.data.toName),t}},extraCssText:"text-align: left"},geo:{map:"china",label:{emphasis:{show:!1}},roam:!0,itemStyle:{normal:{areaColor:"#06535f",borderColor:"#e0ffff",borderWidth:1},emphasis:{areaColor:"#2a333d"}}},series:D};return updateEchartOptions(S,E),E}}]),discovery.service("chartLineService",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){for(var i=0;i<data.data.length;i++)for(var itemData=data.data[i],_j4=0;_j4<itemData.length;_j4++)(_.isNaN(itemData[_j4])||itemData[_j4]===1/0)&&(itemData[_j4]="-");var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,tooltip={},Levi=data.chartConfig.option.tooltip?data.chartConfig.option.tooltip:{},keys=data.chartConfig.keys;for(var _i12 in keys)_.isUndefined(Levi)||(Levi[keys[_i12].col]?(tooltip[keys[_i12].col]=Levi[keys[_i12].col],Levi[keys[_i12].col].col||(tooltip[keys[_i12].col].col=keys[_i12].col)):tooltip[keys[_i12].col]={col:keys[_i12].col,isShow:!0,formatter:""});for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j5=0;_j5<data.chartConfig.values.length;_j5++)for(var _k=0;_k<data.chartConfig.values[_j5].cols.length;_k++)targetValue[data.chartConfig.values[_j5].cols[_k].alias]={col:data.chartConfig.values[_j5].cols[_k].alias};if(!_.isUndefined(Target))for(var _i13 in targetValue)tooltipTarget[_i13]=Target[_i13],Target[_i13]?tooltipTarget[_i13]={col:Target[_i13].col?Target[_i13].col:_i13,isShow:!Target[_i13]||Target[_i13].isShow,formatter:Target[_i13]&&Target[_i13].formatter?Target[_i13].formatter:""}:tooltipTarget[_i13]={col:_i13,isShow:!Target[_i13]||Target[_i13].isShow,formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i14=0;_i14<targetGroups.length;_i14++)Groups[targetGroups[_i14].col]?(tooltipGroups[targetGroups[_i14].col]=Groups[targetGroups[_i14].col],Groups[targetGroups[_i14].col].col||(tooltipGroups[targetGroups[_i14].col].col=targetGroups[_i14].col)):tooltipGroups[targetGroups[_i14].col]={col:targetGroups[_i14].col,isShow:!0,formatter:""};for(var series_data=new Array,string_keys=_.map(casted_keys,function(e){return e.join("-")}),tunningOpt=chartConfig.option,sum_data=[],j=0;aggregate_data[0]&&j<aggregate_data[0].length;j++){for(var sum=0,i=0;i<aggregate_data.length;i++)sum+=aggregate_data[i][j]?Number(aggregate_data[i][j]):0,aggregate_data[i][j]=aggregate_data[i][j]?Number(aggregate_data[i][j]):0;sum_data[j]=sum}for(var unitList=[],i=0;i<chartConfig.values.length;i++)for(var unit=chartConfig.values[i].unit?chartConfig.values[i].unit:"",j=0;j<chartConfig.values[i].cols.length;j++)unitList.push(unit);for(var newunitList=[],length=data.series.length/unitList.length,i=0;i<length;i++)newunitList=newunitList.concat(unitList);for(var pubuArr=[],i=0;i<aggregate_data.length;i++){var joined_values=casted_values[i].join("-"),s=angular.copy(newValuesConfig[joined_values]);s.name=joined_values,s.data=aggregate_data[i],s.barMaxWidth=40,_.isUndefined(chartConfig.option.barWidth)||""==chartConfig.option.barWidth||(s.barWidth=chartConfig.option.barWidth),"stackbar"==s.type?(s.type="bar",s.stack=s.valueAxisIndex.toString()):"percentbar"==s.type?(s.data=_.map(aggregate_data[i],function(e,t){return[t,parseFloat((e/sum_data[t]*100).toFixed(2)),e]}),s.type="bar",s.stack=s.valueAxisIndex.toString()):"stackline"==s.type?(s.type="line",s.stack="normal",s.areaStyle={normal:{}}):"oneLineBar"==s.type?(s.type="custom",s.renderItem=renderAverageItem):"waterFall"==s.type&&(s.type="bar",s.waterFall=!0,s.stack=s.valueAxisIndex.toString()),"horizontal"==chartConfig.valueAxis?s.xAxisIndex=s.valueAxisIndex:s.yAxisIndex=s.valueAxisIndex;for(var newData=[],unit=newunitList[i],newUnit="",j=0;j<s.data.length;j++){var eventInfo=CBoardEChartRenderEventInfo(data,i,j),obj={eventInfo:eventInfo,value:s.data[j],unit:""==newUnit?unit:newUnit};newData.push(obj)}s.data=newData,s.waterFall?pubuArr.push(s):series_data.push(s)}if(pubuArr.length>0){var serie={name:"辅助isAssist",isAssist:!0,type:"bar",stack:"",itemStyle:{normal:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"},emphasis:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"}},data:[]},dataArr=[];for(var i in pubuArr){serie.stack=pubuArr[i].stack,serie.yAxisIndex=pubuArr[i].yAxisIndex;for(var j in pubuArr[i].data)void 0===dataArr[j]&&(dataArr[j]=pubuArr[i].data[j].value)}for(var i=0;i<dataArr.length;i++)0===i?serie.data[i]=0:(serie.data[i]=serie.data[i-1]+dataArr[i-1],dataArr[i]<0&&(serie.data[i]=serie.data[i-1]+dataArr[i]));for(var i=0;i<series_data.length;i++){var totalData={};series_data[i].data.length>0&&(totalData=angular.copy(series_data[i].data[0]),totalData.eventInfo[0].value="总计"),totalData.value=0;for(var j=0;j<series_data[i].data.length;j++)totalData.value+=series_data[i].data[j].value;series_data[i].data.push(totalData)}for(var i=0;i<pubuArr.length;i++){for(var total=0,j=0;j<pubuArr[i].data.length;j++)total+=pubuArr[i].data[j].value,pubuArr[i].data[j].value<0?(pubuArr[i].data[j].value=Math.abs(pubuArr[i].data[j].value),_.isUndefined(pubuArr[i].data[j].itemStyle)?pubuArr[i].data[j].itemStyle={color:"red"}:pubuArr[i].data[j].itemStyle.color="red"):pubuArr[i].data[j].isPositive=!0;pubuArr[i].data[pubuArr[i].data.length]=angular.copy(pubuArr[i].data[pubuArr[i].data.length-1]),pubuArr[i].data[pubuArr[i].data.length-1].value=total,pubuArr[i].data[pubuArr[i].data.length-1].eventInfo[0].value="总计",pubuArr[i].data[pubuArr[i].data.length-1].itemStyle?pubuArr[i].data[pubuArr[i].data.length-1].itemStyle.color="#59A14F":pubuArr[i].data[pubuArr[i].data.length-1].itemStyle={color:"#59A14F"},string_keys.push("总计")}series_data.push(serie),series_data=series_data.concat(pubuArr)}var position={};!_.isUndefined(chartConfig.option.label);var top_bottom={top:"top",bottom:"insideBottom"},left_right={top:"right",bottom:"insideLeft"},settingPosition=chartConfig.option.label?chartConfig.option.label.position:"top";if(position="horizontal"==chartConfig.valueAxis?{position:left_right[settingPosition]}:{position:top_bottom[settingPosition]},!_.isUndefined(chartConfig.option.label)&&!_.isUndefined(chartConfig.option.label.offset)){var offset=[0,0];_.isUndefined(chartConfig.option.label.offset.top)||(offset[1]=-chartConfig.option.label.offset.top),_.isUndefined(chartConfig.option.label.offset.bottom)||(offset[1]=Number(chartConfig.option.label.offset.bottom)),_.isUndefined(chartConfig.option.label.offset.left)||(offset[0]=-chartConfig.option.label.offset.left),_.isUndefined(chartConfig.option.label.offset.right)||(offset[0]=Number(chartConfig.option.label.offset.right)),position.offset=offset}for(var i=0;i<chartConfig.values.length;i++){for(var j=0;j<series_data.length;j++)for(var c=0;c<chartConfig.values[i].cols.length;c++)series_data[j].name==chartConfig.values[i].cols[c].alias&&("percentbar"==chartConfig.values[i].series_type?series_data[j].label={show:chartConfig.values[i].series_label,color:"#fff",formatter:function(e){return e.data.value+"%"},series_type:"percentbar"}:series_data[j].label={show:chartConfig.values[i].series_label,color:"auto",formatter:function(e){return(0==e.data.value?"":e.data.value)+e.data.unit}},series_data[j].label=$.extend({},series_data[j].label,position));!_.isUndefined(chartConfig.values[i].series_label)}var valueAxis=angular.copy(chartConfig.values);_.each(valueAxis,function(e,t){e.axisLabel={formatter:function(e){return numbro(e).format("0a.[0000]")}},e.splitLine={show:!1},e.nameGap=0,"percentbar"==e.series_type?(e.min=0,e.max=100):(e.min=e.min?e.min:null,e.max=e.max?e.max:null),t>0&&(e.splitLine=!1)});for(var i=0;i<valueAxis.length;i++)chartConfig.values[i].series_label&&("true"==chartConfig.values[i].series_logarithm?valueAxis[i]={type:"log"}:"false"==chartConfig.values[i].series_logarithm&&(valueAxis[i]={type:"value"}));var colorList=[],dataNameList=[],seriesNameList=[];if(chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&(colorList=chartConfig.option.itemStyle.color.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.dataName&&(dataNameList=chartConfig.option.itemStyle.dataName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.seriesName&&(seriesNameList=chartConfig.option.itemStyle.seriesName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&""!=chartConfig.option.itemStyle.color)for(var e=0;e<colorList.length;e++)if(chartConfig.option.itemStyle.dataName&&(_.isUndefined(chartConfig.option.itemStyle.seriesName)||""==chartConfig.option.itemStyle.seriesName)){for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}})}else if(chartConfig.option.itemStyle.dataName&&chartConfig.option.itemStyle.seriesName)for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)for(var k=0;k<series_data[i].data[j].eventInfo.length;k++)seriesNameList[e]==series_data[i].data[j].eventInfo[k].value&&(series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}}));if(tunningOpt){var labelInterval,labelRotate;tunningOpt.ctgLabelInterval?labelInterval=tunningOpt.ctgLabelInterval:"auto",tunningOpt.ctgLabelRotate?labelRotate=tunningOpt.ctgLabelRotate:0}var categoryAxis={type:"category",data:string_keys,nameGap:0,show:!0,splitLine:{show:!0},axisLabel:{show:!0,interval:labelInterval,rotate:labelRotate}},thresholdCode=data.chartConfig.thresholdCode,params=angular.copy(window.$$dlut_param);if(thresholdCode){var seriesIndexObj={};for(var _j6 in data.seriesConfig)seriesIndexObj[_j6]=data.seriesConfig[_j6].valueAxisIndex;var evalColor=function(e){for(var t in e)for(var a in e[t].data)try{e[t].data[a]=new Function("data,params,seriesIndex,dataIndex","return ("+thresholdCode+")(data,params,seriesIndex,dataIndex)")(e[t].data[a],params,t,a)}catch(r){console.error("data自定义计算公式错误",thresholdCode,params,e[t].data[a],t,a,r)}};evalColor(series_data)}if(data.chartConfig.markLineCode){var markLineCode=data.chartConfig.markLineCode;for(var _i16 in series_data)try{series_data[_i16]=new Function("serie,params,seriesIndex","return ("+markLineCode+")(serie,params,seriesIndex)")(series_data[_i16],params,_i16)}catch(e){console.error("series自定义计算错误",markLineCode,series_data[_i16],params,_i16,e)}}for(var tooltipFormatter=function tooltipFormatter(params){if("辅助isAssist"!==params.seriesName){var finalResult="",value="",info=params.data?params.data.eventInfo:"",param=BoardParamService.getAll();if(params.data&&params.data.tooltipCache)return params.data.tooltipCache;var tooltipIndex=-1,_loop3=function _loop3(_i17){if(void 0===_typeof(tooltip[_i17])||tooltip[_i17].isShow!==!1){tooltipIndex++;var index=_.findIndex(params.data.eventInfo,function(e){if(e.alias===_i17||e.col===_i17)return!0});if(index<0){value=params.data.eventInfo[tooltipIndex].value;var result=value;tooltip[_i17].formatter&&(result=eval(tooltip[_i17].formatter));var itemCol=params.data.eventInfo[tooltipIndex].col;params.data.eventInfo[tooltipIndex].alias&&(itemCol=params.data.eventInfo[tooltipIndex].alias),finalResult=finalResult+itemCol+": "+result+"<br/>"}else{value=params.data.eventInfo[index].value;var _result=value;tooltip[_i17].formatter&&(_result=eval(tooltip[_i17].formatter)),finalResult=finalResult+tooltip[_i17].col+": "+_result+"<br/>"}}};for(var _i17 in tooltip)_loop3(_i17);var _loop4=function _loop4(_i18){if(tooltipGroups[_i18].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i18});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltipGroups[_i18].formatter&&(result=eval(tooltipGroups[_i18].formatter)),finalResult=finalResult+tooltipGroups[_i18].col+": "+result+"<br/>"}};for(var _i18 in tooltipGroups){var _ret4=_loop4(_i18);if("object"===("undefined"==typeof _ret4?"undefined":_typeof(_ret4)))return _ret4.v}var targetIndex=-1,_loop5=function _loop5(_i19){if(tooltipTarget[_i19]&&tooltipTarget[_i19].isShow!==!1)for(m=0;m<data.chartConfig.values.length;m++)for(itemValue=data.chartConfig.values[m],n=0;n<itemValue.cols.length;n++)if(itemValue.cols[n].alias===_i19){if(targetIndex+=1,targetIndex<0)continue;if(value="waterFall"===itemValue.series_type&&params.dataIndex>=aggregate_data[targetIndex].length?params.data.value:aggregate_data[targetIndex][params.dataIndex],_.isUndefined(value))continue;if(aggregate_data.length>_.keys(tooltipTarget).length)if(params.seriesIndex%2===0)if(targetIndex%2===0)value=aggregate_data[params.seriesIndex][params.dataIndex];else{var dataIndex=params.seriesIndex+1;dataIndex<aggregate_data.length&&(value=aggregate_data[dataIndex][params.dataIndex])}else if(targetIndex%2===0){var _dataIndex=params.seriesIndex-1;_dataIndex>-1&&(value=aggregate_data[_dataIndex][params.dataIndex])}else value=aggregate_data[params.seriesIndex][params.dataIndex];var result=value;tooltipTarget[_i19].formatter&&(result=eval(tooltipTarget[_i19].formatter)),finalResult=finalResult+tooltipTarget[_i19].col+": "+result+"<br/>",!_.isUndefined(series_data[params.seriesIndex].yAxisIndex)&&!valueAxis[series_data[params.seriesIndex].yAxisIndex].axisLabel.isFormatter&&tooltipTarget[_i19].formatter&&valueAxis[series_data[params.seriesIndex].yAxisIndex].cols.length>0&&(valueAxis[series_data[params.seriesIndex].yAxisIndex].cols[0].col===_i19||valueAxis[series_data[params.seriesIndex].yAxisIndex].cols[0].alias===_i19)&&(valueAxis[series_data[params.seriesIndex].yAxisIndex].axisLabel.formatter=function(fValue,fIndex){var yLabel=tooltipTarget[_i19].formatter.replace("value","fValue"),labelResult=eval(yLabel);return labelResult},valueAxis[series_data[params.seriesIndex].yAxisIndex].axisLabel.isFormatter=!0)}};for(var _i19 in tooltipTarget){var m,itemValue,n;_loop5(_i19)}return params.data.tooltipCache=finalResult,finalResult}},i=0;i<series_data.length;i++){var name=series_data[i].name,formatterObj=tooltipTarget[name];if(formatterObj&&formatterObj.formatter){for(var j=0;j<series_data[i].data.length;j++)series_data[i].data[j].laberFormatter=formatterObj.formatter;series_data[i].label||(series_data[i].label={}),series_data[i].label&&series_data[i].label&&"percentbar"!==series_data[i].label.series_type&&(series_data[i].label.formatter=dlut.echart.labelFormatter)}for(var j=0;j<series_data[i].data.length;j++)series_data[i].isAssist||(series_data[i].data[j].tooltipCache=tooltipFormatter({data:series_data[i].data[j],dataIndex:j,seriesIndex:i}))}var echartOption={grid:angular.copy(echartsBasicOption.grid),legend:{data:_.map(casted_values,function(e){return e.join("-")})},tooltip:{trigger:"item",formatter:tooltipFormatter},xAxis:"horizontal"==chartConfig.valueAxis?valueAxis:categoryAxis,yAxis:"horizontal"==chartConfig.valueAxis?categoryAxis:valueAxis,targetData:chartConfig.values,series:series_data};if(_.isUndefined(tunningOpt.xAxisName)||(_.isArray(echartOption.xAxis)?echartOption.xAxis[0].name=tunningOpt.xAxisName:echartOption.xAxis.name=tunningOpt.xAxisName),_.isUndefined(tunningOpt.yAxisName)||(_.isArray(echartOption.yAxis)?echartOption.yAxis[0].name=tunningOpt.yAxisName:echartOption.yAxis.name=tunningOpt.yAxisName),_.isUndefined(tunningOpt.xAxisPosition)||(_.isArray(echartOption.xAxis)?echartOption.xAxis[0].position=tunningOpt.xAxisPosition:echartOption.xAxis.position=tunningOpt.xAxisPosition),echartOption.dataZoom=[],tunningOpt.dataZoom&&echartOption.dataZoom.push({type:"slider",xAxisIndex:[0],startValue:tunningOpt.dataZoomStart?parseInt(tunningOpt.dataZoomStart):0,endValue:tunningOpt.dataZoomEnd?parseInt(tunningOpt.dataZoomEnd):100}),tunningOpt.dataZoomY&&echartOption.dataZoom.push({type:"slider",yAxisIndex:[0],startValue:tunningOpt.dataZoomStartY?parseInt(tunningOpt.dataZoomStartY):0,endValue:tunningOpt.dataZoomEndY?parseInt(tunningOpt.dataZoomEndY):100}),"horizontal"===chartConfig.valueAxis&&(echartOption.grid.left="left",echartOption.grid.containLabel=!0,echartOption.grid.bottom="5%"),"vertical"===chartConfig.valueAxis&&chartConfig.values.length>1&&(echartOption.grid.right=40),data.chartConfig.optionCode){var optionCode=data.chartConfig.optionCode;try{var param=angular.copy(window.$$dlut_param);echartOption=new Function("option,param,config","return ("+optionCode+")(option,param,config)")(echartOption,param,chartConfig)}catch(e){console.error("option自定义计算错误",echartOption,e)}}return updateEchartOptions(tunningOpt,echartOption),echartOption}}]);var renderAverageItem=function(e,t){var a=(t.value(0),.85*t.size([0,0])[0]),r=t.coord([t.value(0),t.value(1)]);return{type:"group",children:[{type:"rect",shape:{x:r[0]-a/2,y:r[1],width:a/2,height:-20},style:t.style()},{type:"line",shape:{x1:r[0]-a/2,x2:r[0]+a/2,y1:r[1],y2:r[1]},style:t.style({fill:null,stroke:t.visual("color"),lineWidth:2,text:""})}]}};discovery.service("chartLine2Service",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,tooltip={},Levi=data.chartConfig.option.tooltip?data.chartConfig.option.tooltip:{},keys=data.chartConfig.keys;for(var _i20 in keys)_.isUndefined(Levi)||(Levi[keys[_i20].col]?(tooltip[keys[_i20].col]=Levi[keys[_i20].col],Levi[keys[_i20].col].col||(tooltip[keys[_i20].col].col=keys[_i20].col)):tooltip[keys[_i20].col]={col:keys[_i20].col,isShow:!0,formatter:""});for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j8=0;_j8<data.chartConfig.values.length;_j8++)for(var _k2=0;_k2<data.chartConfig.values[_j8].cols.length;_k2++)targetValue[data.chartConfig.values[_j8].cols[_k2].alias]={col:data.chartConfig.values[_j8].cols[_k2].alias};if(!_.isUndefined(Target))for(var _i21 in targetValue)tooltipTarget[_i21]=Target[_i21],Target[_i21]?tooltipTarget[_i21]={col:Target[_i21].col?Target[_i21].col:_i21,isShow:!Target[_i21]||Target[_i21].isShow,formatter:Target[_i21]&&Target[_i21].formatter?Target[_i21].formatter:""}:tooltipTarget[_i21]={col:_i21,isShow:!Target[_i21]||Target[_i21].isShow,formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i22=0;_i22<targetGroups.length;_i22++)Groups[targetGroups[_i22].col]?(tooltipGroups[targetGroups[_i22].col]=Groups[targetGroups[_i22].col],Groups[targetGroups[_i22].col].col||(tooltipGroups[targetGroups[_i22].col].col=targetGroups[_i22].col)):tooltipGroups[targetGroups[_i22].col]={col:targetGroups[_i22].col,isShow:!0,formatter:""};for(var series_data=new Array,string_keys=_.map(casted_keys,function(e){return e.join("-")}),tunningOpt=chartConfig.option,sum_data=[],j=0;aggregate_data[0]&&j<aggregate_data[0].length;j++){for(var sum=0,i=0;i<aggregate_data.length;i++)sum+=aggregate_data[i][j]?Number(aggregate_data[i][j]):0,aggregate_data[i][j]=aggregate_data[i][j]?Number(aggregate_data[i][j]):0;sum_data[j]=sum}for(var unitList=[],i=0;i<chartConfig.values.length;i++)for(var unit=chartConfig.values[i].unit?chartConfig.values[i].unit:"",j=0;j<chartConfig.values[i].cols.length;j++)unitList.push(unit);for(var newunitList=[],length=data.series.length/unitList.length,i=0;i<length;i++)newunitList=newunitList.concat(unitList);for(var i=0;i<aggregate_data.length;i++){var joined_values=casted_values[i].join("-"),s=angular.copy(newValuesConfig[joined_values]);s.name=joined_values,s.data=aggregate_data[i],s.barMaxWidth=40,_.isUndefined(chartConfig.option.barWidth)||""==chartConfig.option.barWidth||(s.barWidth=chartConfig.option.barWidth),"stackbar"==s.type?(s.type="bar",s.stack=s.valueAxisIndex.toString()):"percentbar"==s.type?(s.data=_.map(aggregate_data[i],function(e,t){return[t,parseFloat((e/sum_data[t]*100).toFixed(2)),e]}),s.type="bar",s.stack=s.valueAxisIndex.toString()):"stackline"==s.type&&(s.type="line",s.stack="normal",s.areaStyle={normal:{}}),"horizontal"==chartConfig.valueAxis?s.xAxisIndex=s.valueAxisIndex:s.yAxisIndex=s.valueAxisIndex;for(var newData=[],unit=newunitList[i],newUnit="",strData="",j=0;j<s.data.length;j++){"元"==unit||"万"==unit||"亿"==unit?(unit=dlut.utils.convertMoney(s.data[j],unit),newUnit=unit.substr(unit.length-1,unit.length),strData=unit.substr(0,unit.length-1)):"100%"==unit?(strData=Math.floor(100*s.data[j]),newUnit="%"):"100.00%"==unit?(strData=(100*s.data[j]).toFixed(2),newUnit="%"):"100.0%"==unit&&(strData=(100*s.data[j]).toFixed(1),newUnit="%");var eventInfo=CBoardEChartRenderEventInfo(data,i,j),obj={eventInfo:eventInfo,value:""==strData?s.data[j]:strData,unit:""==newUnit?unit:newUnit};newData.push(obj)}s.data=newData,series_data.push(s)}var position={};if(!_.isUndefined(chartConfig.option.label)){var top_bottom={top:"insideTop",bottom:"insideBottom"},left_right={top:"insideRight",bottom:"insideLeft"};if(_.isUndefined(chartConfig.option.label.position)||(position="horizontal"==chartConfig.valueAxis?{position:left_right[chartConfig.option.label.position]}:{position:top_bottom[chartConfig.option.label.position]}),!_.isUndefined(chartConfig.option.label.offset)){var offset=[0,0];_.isUndefined(chartConfig.option.label.offset.top)||(offset[1]=-chartConfig.option.label.offset.top),_.isUndefined(chartConfig.option.label.offset.bottom)||(offset[1]=Number(chartConfig.option.label.offset.bottom)),_.isUndefined(chartConfig.option.label.offset.left)||(offset[0]=-chartConfig.option.label.offset.left),_.isUndefined(chartConfig.option.label.offset.right)||(offset[0]=Number(chartConfig.option.label.offset.right)),position.offset=offset}}for(var i=0;i<chartConfig.values.length;i++)if(!_.isUndefined(chartConfig.values[i].series_label))for(var j=0;j<series_data.length;j++)if("true"===chartConfig.values[i].series_label)for(var c=0;c<chartConfig.values[i].cols.length;c++)series_data[j].name==chartConfig.values[i].cols[c].alias&&("percentbar"==chartConfig.values[i].series_type?series_data[j].label={normal:{show:!0,formatter:function(e){return(0==e.data.value[2]?"":e.data.value[2])+e.data.unit}}}:series_data[j].label={normal:{show:!0,formatter:function(e){return(0==e.data.value?"":e.data.value)+e.data.unit}}},series_data[j].label.normal=$.extend({},series_data[j].label.normal,position));else series_data[i].label={normal:{show:!1}};var valueAxis=angular.copy(chartConfig.values);_.each(valueAxis,function(e,t){e.axisLabel={formatter:function(e){return numbro(e).format("0a.[0000]")}},e.nameGap=0,"percentbar"==e.series_type?(e.min=0,e.max=100):(e.min=e.min?e.min:null,e.max=e.max?e.max:null),t>0&&(e.splitLine=!1)});for(var i=0;i<valueAxis.length;i++)chartConfig.values[i].series_label&&("true"==chartConfig.values[i].series_logarithm?valueAxis[i]={type:"log"}:"false"==chartConfig.values[i].series_logarithm&&(valueAxis[i]={type:"value"}));for(var axis,m=0;m<series_data.length;m++){var s_ml=series_data[m];if(axis!=s_ml.valueAxisIndex&&(axis=s_ml.valueAxisIndex,!_.isUndefined(chartConfig.values[axis].markLine))){var axis_ml_v={};_.isUndefined(s_ml.xAxisIndex)?axis_ml_v.yAxis=parseInt(chartConfig.values[axis].markLine):axis_ml_v.xAxis=parseInt(chartConfig.values[axis].markLine),s_ml.markLine={data:[axis_ml_v],label:{normal:{position:"middle"}},lineStyle:{color:"white"}}}}var colorList=[],dataNameList=[],seriesNameList=[];if(chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&(colorList=chartConfig.option.itemStyle.color.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.dataName&&(dataNameList=chartConfig.option.itemStyle.dataName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.seriesName&&(seriesNameList=chartConfig.option.itemStyle.seriesName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&""!=chartConfig.option.itemStyle.color)for(var e=0;e<colorList.length;e++)if(chartConfig.option.itemStyle.dataName&&(_.isUndefined(chartConfig.option.itemStyle.seriesName)||""==chartConfig.option.itemStyle.seriesName)){for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}})}else if(chartConfig.option.itemStyle.dataName&&chartConfig.option.itemStyle.seriesName)for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)for(var k=0;k<series_data[i].data[j].eventInfo.length;k++)seriesNameList[e]==series_data[i].data[j].eventInfo[k].value&&(series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}}));if(tunningOpt){var labelInterval,labelRotate;tunningOpt.ctgLabelInterval?labelInterval=tunningOpt.ctgLabelInterval:"auto",tunningOpt.ctgLabelRotate?labelRotate=tunningOpt.ctgLabelRotate:0}var categoryAxis={type:"category",data:string_keys,nameGap:0,axisLabel:{show:!0,interval:labelInterval,rotate:labelRotate}},thresholdCode=data.chartConfig.thresholdCode,params=angular.copy(window.$$dlut_param);if(thresholdCode){var seriesIndexObj={};for(var _j9 in data.seriesConfig)seriesIndexObj[_j9]=data.seriesConfig[_j9].valueAxisIndex;var evalColor=function(e){for(var t in e)for(var a in e[t].data)try{e[t].data[a]=new Function("data,params,seriesIndex,dataIndex","return ("+thresholdCode+")(data,params,seriesIndex,dataIndex)")(e[t].data[a],params,t,a)}catch(r){console.error("data自定义计算公式错误",thresholdCode,params,e[t].data[a],t,a,r)}};evalColor(series_data)}if(data.chartConfig.markLineCode){var markLineCode=data.chartConfig.markLineCode;for(var _i24 in series_data)try{series_data[_i24]=new Function("serie,params,seriesIndex","return ("+markLineCode+")(serie,params,seriesIndex)")(series_data[_i24],params,_i24)}catch(e){console.error("series自定义计算错误",markLineCode,series_data[_i24],params,_i24,e)}}var echartOption={grid:angular.copy(echartsBasicOption.grid),legend:{data:_.map(casted_values,function(e){return e.join("-")})},tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",param=BoardParamService.getAll(),value="",_loop6=function _loop6(_i25){if(void 0===_typeof(tooltip[_i25])||tooltip[_i25].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i25});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltip[_i25].formatter&&(result=eval(tooltip[_i25].formatter)),finalResult=finalResult+tooltip[_i25].col+": "+result+"<br/>"}};for(var _i25 in tooltip){var _ret6=_loop6(_i25);if("object"===("undefined"==typeof _ret6?"undefined":_typeof(_ret6)))return _ret6.v}var _loop7=function _loop7(_i26){if(tooltipGroups[_i26].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i26});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltipGroups[_i26].formatter&&(result=eval(tooltipGroups[_i26].formatter)),finalResult=finalResult+tooltipGroups[_i26].col+": "+result+"<br/>"}};for(var _i26 in tooltipGroups){var _ret7=_loop7(_i26);if("object"===("undefined"==typeof _ret7?"undefined":_typeof(_ret7)))return _ret7.v}var _loop8=function _loop8(_i27){if(tooltipTarget[_i27]&&tooltipTarget[_i27].isShow!==!1){var index=_.findIndex(data.chartConfig.values,function(e){return e.cols[0].alias===_i27});if(index<0)return{v:void 0};var dataIndex=_.findIndex(aggregate_data[params.seriesIndex],function(e){return e===params.value});if(dataIndex<0)return{v:void 0};value=aggregate_data[index][dataIndex];var result=value;tooltipTarget[_i27].formatter&&(result=eval(tooltipTarget[_i27].formatter)),finalResult=finalResult+tooltipTarget[_i27].col+": "+result+"<br/>"}};for(var _i27 in tooltipTarget){var _ret8=_loop8(_i27);if("object"===("undefined"==typeof _ret8?"undefined":_typeof(_ret8)))return _ret8.v}return finalResult}},xAxis:"horizontal"==chartConfig.valueAxis?valueAxis:categoryAxis,yAxis:"horizontal"==chartConfig.valueAxis?categoryAxis:valueAxis,targetData:chartConfig.values,series:series_data};return _.isUndefined(tunningOpt.xAxisName)||(_.isArray(echartOption.xAxis)?echartOption.xAxis[0].name=tunningOpt.xAxisName:echartOption.xAxis.name=tunningOpt.xAxisName),_.isUndefined(tunningOpt.yAxisName)||(_.isArray(echartOption.yAxis)?echartOption.yAxis[0].name=tunningOpt.yAxisName:echartOption.yAxis.name=tunningOpt.yAxisName),"horizontal"===chartConfig.valueAxis&&(echartOption.grid.left="left",echartOption.grid.containLabel=!0,echartOption.grid.bottom="5%"),"vertical"===chartConfig.valueAxis&&chartConfig.values.length>1&&(echartOption.grid.right=40),updateEchartOptions(tunningOpt,echartOption),echartOption}}]),discovery.service("chartLine3Service",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,tooltip={},Levi=data.chartConfig.option.tooltip?data.chartConfig.option.tooltip:{},keys=data.chartConfig.keys;for(var _i28 in keys)_.isUndefined(Levi)||(Levi[keys[_i28].col]?(tooltip[keys[_i28].col]=Levi[keys[_i28].col],Levi[keys[_i28].col].col||(tooltip[keys[_i28].col].col=keys[_i28].col)):tooltip[keys[_i28].col]={col:keys[_i28].col,isShow:!0,formatter:""});for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j11=0;_j11<data.chartConfig.values.length;_j11++)for(var _k3=0;_k3<data.chartConfig.values[_j11].cols.length;_k3++)targetValue[data.chartConfig.values[_j11].cols[_k3].alias]={col:data.chartConfig.values[_j11].cols[_k3].alias};if(!_.isUndefined(Target))for(var _i29 in targetValue)tooltipTarget[_i29]=Target[_i29],Target[_i29]?tooltipTarget[_i29]={col:Target[_i29].col?Target[_i29].col:_i29,isShow:!Target[_i29]||Target[_i29].isShow,formatter:Target[_i29]&&Target[_i29].formatter?Target[_i29].formatter:""}:tooltipTarget[_i29]={col:_i29,isShow:!Target[_i29]||Target[_i29].isShow,formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i30=0;_i30<targetGroups.length;_i30++)Groups[targetGroups[_i30].col]?(tooltipGroups[targetGroups[_i30].col]=Groups[targetGroups[_i30].col],Groups[targetGroups[_i30].col].col||(tooltipGroups[targetGroups[_i30].col].col=targetGroups[_i30].col)):tooltipGroups[targetGroups[_i30].col]={col:targetGroups[_i30].col,isShow:!0,formatter:""};for(var series_data=new Array,string_keys=_.map(casted_keys,function(e){return e.join("-")}),tunningOpt=chartConfig.option,sum_data=[],j=0;aggregate_data[0]&&j<aggregate_data[0].length;j++){for(var sum=0,i=0;i<aggregate_data.length;i++)sum+=aggregate_data[i][j]?Number(aggregate_data[i][j]):0,aggregate_data[i][j]=aggregate_data[i][j]?Number(aggregate_data[i][j]):0;
sum_data[j]=sum}for(var unitList=[],i=0;i<chartConfig.values.length;i++)for(var unit=chartConfig.values[i].unit?chartConfig.values[i].unit:"",j=0;j<chartConfig.values[i].cols.length;j++)unitList.push(unit);for(var newunitList=[],length=data.series.length/unitList.length,i=0;i<length;i++)newunitList=newunitList.concat(unitList);for(var i=0;i<aggregate_data.length;i++){var joined_values=casted_values[i].join("-"),s=angular.copy(newValuesConfig[joined_values]);s.name=joined_values,s.data=aggregate_data[i],s.barMaxWidth=40,_.isUndefined(chartConfig.option.barWidth)||""==chartConfig.option.barWidth||(s.barWidth=chartConfig.option.barWidth),"stackbar"==s.type?(s.type="bar",s.stack=s.valueAxisIndex.toString()):"percentbar"==s.type?(s.data=_.map(aggregate_data[i],function(e,t){return[t,parseFloat((e/sum_data[t]*100).toFixed(2)),e]}),s.type="bar",s.stack=s.valueAxisIndex.toString()):"stackline"==s.type&&(s.type="line",s.stack="normal",s.areaStyle={normal:{}}),"horizontal"==chartConfig.valueAxis?s.xAxisIndex=s.valueAxisIndex:s.yAxisIndex=s.valueAxisIndex;for(var newData=[],unit=newunitList[i],newUnit="",strData="",j=0;j<s.data.length;j++){"元"==unit||"万"==unit||"亿"==unit?(unit=dlut.utils.convertMoney(s.data[j],unit),newUnit=unit.substr(unit.length-1,unit.length),strData=unit.substr(0,unit.length-1)):"100%"==unit?(strData=Math.floor(100*s.data[j]),newUnit="%"):"100.00%"==unit?(strData=(100*s.data[j]).toFixed(2),newUnit="%"):"100.0%"==unit&&(strData=(100*s.data[j]).toFixed(1),newUnit="%");var eventInfo=CBoardEChartRenderEventInfo(data,i,j),obj={eventInfo:eventInfo,value:""==strData?s.data[j]:strData,unit:""==newUnit?unit:newUnit};newData.push(obj)}s.data=newData,series_data.push(s)}var position={};if(!_.isUndefined(chartConfig.option.label)){var top_bottom={top:"insideTop",bottom:"insideBottom"},left_right={top:"insideRight",bottom:"insideLeft"};if(_.isUndefined(chartConfig.option.label.position)||(position="horizontal"==chartConfig.valueAxis?{position:left_right[chartConfig.option.label.position]}:{position:top_bottom[chartConfig.option.label.position]}),!_.isUndefined(chartConfig.option.label.offset)){var offset=[0,0];_.isUndefined(chartConfig.option.label.offset.top)||(offset[1]=-chartConfig.option.label.offset.top),_.isUndefined(chartConfig.option.label.offset.bottom)||(offset[1]=Number(chartConfig.option.label.offset.bottom)),_.isUndefined(chartConfig.option.label.offset.left)||(offset[0]=-chartConfig.option.label.offset.left),_.isUndefined(chartConfig.option.label.offset.right)||(offset[0]=Number(chartConfig.option.label.offset.right)),position.offset=offset}}for(var i=0;i<chartConfig.values.length;i++)if(!_.isUndefined(chartConfig.values[i].series_label))for(var j=0;j<series_data.length;j++)if("true"===chartConfig.values[i].series_label)for(var c=0;c<chartConfig.values[i].cols.length;c++)series_data[j].name==chartConfig.values[i].cols[c].alias&&("percentbar"==chartConfig.values[i].series_type?series_data[j].label={normal:{show:!0,formatter:function(e){return(0==e.data.value[2]?"":e.data.value[2])+e.data.unit}}}:series_data[j].label={normal:{show:!0,formatter:function(e){return(0==e.data.value?"":e.data.value)+e.data.unit}}},series_data[j].label.normal=$.extend({},series_data[j].label.normal,position));else series_data[i].label={normal:{show:!1}};var valueAxis=angular.copy(chartConfig.values);_.each(valueAxis,function(e,t){e.axisLabel={formatter:function(e){return numbro(e).format("0a.[0000]")}},e.nameGap=0,"percentbar"==e.series_type?(e.min=0,e.max=100):(e.min=e.min?e.min:null,e.max=e.max?e.max:null),t>0&&(e.splitLine=!1)});for(var i=0;i<valueAxis.length;i++)chartConfig.values[i].series_label&&("true"==chartConfig.values[i].series_logarithm?valueAxis[i]={type:"log"}:"false"==chartConfig.values[i].series_logarithm&&(valueAxis[i]={type:"value"}));for(var axis,m=0;m<series_data.length;m++){var s_ml=series_data[m];if(axis!=s_ml.valueAxisIndex&&(axis=s_ml.valueAxisIndex,!_.isUndefined(chartConfig.values[axis].markLine))){var axis_ml_v={};_.isUndefined(s_ml.xAxisIndex)?axis_ml_v.yAxis=parseInt(chartConfig.values[axis].markLine):axis_ml_v.xAxis=parseInt(chartConfig.values[axis].markLine),s_ml.markLine={data:[axis_ml_v],label:{normal:{position:"middle"}},lineStyle:{color:"white"}}}}var colorList=[],dataNameList=[],seriesNameList=[];if(chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&(colorList=chartConfig.option.itemStyle.color.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.dataName&&(dataNameList=chartConfig.option.itemStyle.dataName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.seriesName&&(seriesNameList=chartConfig.option.itemStyle.seriesName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&""!=chartConfig.option.itemStyle.color)for(var e=0;e<colorList.length;e++)if(chartConfig.option.itemStyle.dataName&&(_.isUndefined(chartConfig.option.itemStyle.seriesName)||""==chartConfig.option.itemStyle.seriesName)){for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}})}else if(chartConfig.option.itemStyle.dataName&&chartConfig.option.itemStyle.seriesName)for(var i=0;i<series_data.length;i++)if(dataNameList[e]==series_data[i].name)for(var j=0;j<series_data[i].data.length;j++)for(var k=0;k<series_data[i].data[j].eventInfo.length;k++)seriesNameList[e]==series_data[i].data[j].eventInfo[k].value&&(series_data[i]=_.extend(series_data[i],{itemStyle:{normal:{color:colorList[e]}}}));if(tunningOpt){var labelInterval,labelRotate;tunningOpt.ctgLabelInterval?labelInterval=tunningOpt.ctgLabelInterval:"auto",tunningOpt.ctgLabelRotate?labelRotate=tunningOpt.ctgLabelRotate:0}var categoryAxis={type:"category",data:string_keys,nameGap:0,axisLabel:{show:!0,interval:labelInterval,rotate:labelRotate}},thresholdCode=data.chartConfig.thresholdCode,params=angular.copy(window.$$dlut_param);if(thresholdCode){var seriesIndexObj={};for(var _j12 in data.seriesConfig)seriesIndexObj[_j12]=data.seriesConfig[_j12].valueAxisIndex;var evalColor=function(e){for(var t in e)for(var a in e[t].data)try{e[t].data[a]=new Function("data,params,seriesIndex,dataIndex","return ("+thresholdCode+")(data,params,seriesIndex,dataIndex)")(e[t].data[a],params,t,a)}catch(r){console.error("data自定义计算公式错误",thresholdCode,params,e[t].data[a],t,a,r)}};evalColor(series_data)}if(data.chartConfig.markLineCode){var markLineCode=data.chartConfig.markLineCode;for(var _i32 in series_data)try{series_data[_i32]=new Function("serie,params,seriesIndex","return ("+markLineCode+")(serie,params,seriesIndex)")(series_data[_i32],params,_i32)}catch(e){console.error("series自定义计算错误",markLineCode,series_data[_i32],params,_i32,e)}}var echartOption={grid:angular.copy(echartsBasicOption.grid),legend:{data:_.map(casted_values,function(e){return e.join("-")})},tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",param=BoardParamService.getAll(),value="",_loop9=function _loop9(_i33){if(void 0===_typeof(tooltip[_i33])||tooltip[_i33].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i33});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltip[_i33].formatter&&(result=eval(tooltip[_i33].formatter)),finalResult=finalResult+tooltip[_i33].col+": "+result+"<br/>"}};for(var _i33 in tooltip){var _ret9=_loop9(_i33);if("object"===("undefined"==typeof _ret9?"undefined":_typeof(_ret9)))return _ret9.v}var _loop10=function _loop10(_i34){if(tooltipGroups[_i34].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i34});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltipGroups[_i34].formatter&&(result=eval(tooltipGroups[_i34].formatter)),finalResult=finalResult+tooltipGroups[_i34].col+": "+result+"<br/>"}};for(var _i34 in tooltipGroups){var _ret10=_loop10(_i34);if("object"===("undefined"==typeof _ret10?"undefined":_typeof(_ret10)))return _ret10.v}var _loop11=function _loop11(_i35){if(tooltipTarget[_i35]&&tooltipTarget[_i35].isShow!==!1){var index=_.findIndex(data.chartConfig.values,function(e){return e.cols[0].alias===_i35});if(index<0)return{v:void 0};var dataIndex=_.findIndex(aggregate_data[params.seriesIndex],function(e){return e===params.value});if(dataIndex<0)return{v:void 0};value=aggregate_data[index][dataIndex];var result=value;tooltipTarget[_i35].formatter&&(result=eval(tooltipTarget[_i35].formatter)),finalResult=finalResult+tooltipTarget[_i35].col+": "+result+"<br/>"}};for(var _i35 in tooltipTarget){var _ret11=_loop11(_i35);if("object"===("undefined"==typeof _ret11?"undefined":_typeof(_ret11)))return _ret11.v}return finalResult}},xAxis:"horizontal"==chartConfig.valueAxis?valueAxis:categoryAxis,yAxis:"horizontal"==chartConfig.valueAxis?categoryAxis:valueAxis,targetData:chartConfig.values,series:series_data};return _.isUndefined(tunningOpt.xAxisName)||(_.isArray(echartOption.xAxis)?echartOption.xAxis[0].name=tunningOpt.xAxisName:echartOption.xAxis.name=tunningOpt.xAxisName),_.isUndefined(tunningOpt.yAxisName)||(_.isArray(echartOption.yAxis)?echartOption.yAxis[0].name=tunningOpt.yAxisName:echartOption.yAxis.name=tunningOpt.yAxisName),"horizontal"===chartConfig.valueAxis&&(echartOption.grid.left="left",echartOption.grid.containLabel=!0,echartOption.grid.bottom="5%"),"vertical"===chartConfig.valueAxis&&chartConfig.values.length>1&&(echartOption.grid.right=40),updateEchartOptions(tunningOpt,echartOption),echartOption}}]),discovery.service("chartPieService",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,tooltip={},Levi=data.chartConfig.option.tooltip?data.chartConfig.option.tooltip:{},keys=data.chartConfig.keys;console.log("keys",keys),console.log("data",data);for(var _i36 in keys)_.isUndefined(Levi)||(Levi[keys[_i36].col]?(tooltip[keys[_i36].col]=Levi[keys[_i36].col],Levi[keys[_i36].col].col||(tooltip[keys[_i36].col].col=keys[_i36].col)):tooltip[keys[_i36].col]={col:keys[_i36].col,isShow:!0,formatter:""});for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j14=0;_j14<data.chartConfig.values.length;_j14++)for(var _k4=0;_k4<data.chartConfig.values[_j14].cols.length;_k4++)targetValue[data.chartConfig.values[_j14].cols[_k4].alias]={col:data.chartConfig.values[_j14].cols[_k4].alias};if(!_.isUndefined(Target))for(var _i37 in targetValue)tooltipTarget[_i37]=Target[_i37],Target[_i37]?tooltipTarget[_i37]={col:Target[_i37].col?Target[_i37].col:_i37,isShow:!Target[_i37]||Target[_i37].isShow,formatter:Target[_i37]&&Target[_i37].formatter?Target[_i37].formatter:""}:tooltipTarget[_i37]={col:_i37,isShow:!Target[_i37]||Target[_i37].isShow,formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i38=0;_i38<targetGroups.length;_i38++)Groups[targetGroups[_i38].col]?(tooltipGroups[targetGroups[_i38].col]=Groups[targetGroups[_i38].col],Groups[targetGroups[_i38].col].col||(tooltipGroups[targetGroups[_i38].col].col=targetGroups[_i38].col)):tooltipGroups[targetGroups[_i38].col]={col:targetGroups[_i38].col,isShow:!0,formatter:""};var series=new Array,string_keys=_.map(casted_keys,function(e){return e.join("-")}),string_value=_.map(casted_values,function(e){return e.join("-")}),b=100/(9*casted_values.length+1),titles=[],s={name:string_value[0],type:"pie",center:[chartConfig.centerX?chartConfig.centerX:"50%",chartConfig.centerY?chartConfig.centerY:"50%"],xRadius:[chartConfig.radiusX?chartConfig.radiusX:"0",chartConfig.radiusY?chartConfig.radiusY:"70%"],data:[],label:{},itemStyle:{normal:{label:{show:!0,formatter:"{b}: {d}%"}},labelLine:{show:!0}}};chartConfig&&chartConfig.roseType&&(s.roseType="area",s.itemStyle={normal:{shadowBlur:200,shadowColor:"rgba(0, 0, 0, 0.5)"}},s.animationType="scale",s.animationEasing="elasticOut",s.animationDelay=function(e){return 200*Math.random()});for(var i=0;i<aggregate_data.length;i++)for(var j=0;j<aggregate_data[i].length;j++)0===i?s.data[j]={eventInfo:CBoardEChartRenderEventInfo(data,i,j),name:string_keys[j]?string_keys[j]:"",value:[aggregate_data[i][j]]}:s.data[j].value=s.data[j].value.concat(aggregate_data[i][j]);series.push(s);for(var i=0;i<series.length;i++)_.isUndefined(chartConfig.series_label)||(chartConfig.series_label===!0?series[i].label={normal:{show:!0}}:series[i].label={normal:{show:!1}});var colorList=[],dataNameList=[],seriesNameList=[];if(chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&(colorList=chartConfig.option.itemStyle.color.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.dataName&&(dataNameList=chartConfig.option.itemStyle.dataName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.seriesName&&(seriesNameList=chartConfig.option.itemStyle.seriesName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&""!=chartConfig.option.itemStyle.color)for(var e=0;e<colorList.length;e++)if(chartConfig.option.itemStyle.dataName&&(_.isUndefined(chartConfig.option.itemStyle.seriesName)||""==chartConfig.option.itemStyle.seriesName)){for(var i=0;i<series.length;i++)if(dataNameList[e]==series[i].name)for(var j=0;j<series[i].data.length;j++)series[i].data[j]=_.extend(series[i].data[j],{itemStyle:{normal:{color:colorList[e]}}})}else if(chartConfig.option.itemStyle.dataName&&chartConfig.option.itemStyle.seriesName)for(var i=0;i<series.length;i++)if(dataNameList[e]==series[i].name)for(var j=0;j<series[i].data.length;j++)for(var k=0;k<series[i].data[j].eventInfo.length;k++)seriesNameList[e]==series[i].data[j].eventInfo[k].value&&(series[i].data[j]=_.extend(series[i].data[j],{itemStyle:{normal:{color:colorList[e]}}}));var echartOption={title:titles,legend:{orient:"vertical",left:"left",data:string_keys},tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",value="",_loop12=function _loop12(_i39){if(void 0===_typeof(tooltip[_i39])||tooltip[_i39].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===tooltip[_i39].col});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltip[_i39].formatter&&(result=eval(tooltip[_i39].formatter)),finalResult=finalResult+tooltip[_i39].col+": "+result+"<br/>"}};for(var _i39 in tooltip){var _ret12=_loop12(_i39);if("object"===("undefined"==typeof _ret12?"undefined":_typeof(_ret12)))return _ret12.v}var _loop13=function _loop13(_i40){if(tooltipGroups[_i40].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===tooltipGroups[_i40].col});if(index<0)return{v:void 0};value=params.data.eventInfo[index].value;var result=value;tooltipGroups[_i40].formatter&&(result=eval(tooltipGroups[_i40].formatter)),finalResult=finalResult+tooltipGroups[_i40].col+": "+result+"<br/>"}};for(var _i40 in tooltipGroups){var _ret13=_loop13(_i40);if("object"===("undefined"==typeof _ret13?"undefined":_typeof(_ret13)))return _ret13.v}var _loop14=function _loop14(_i41){if(tooltipTarget[_i41]&&tooltipTarget[_i41].isShow!==!1){var index=_.findIndex(data.chartConfig.values[0].cols,function(e){return e.alias===_i41});if(index<0)return"continue";var dataIndex=_.findIndex(aggregate_data[params.seriesIndex],function(e){return"object"===_typeof(params.value)?e===params.value[0]:e===params.value});if(dataIndex<0)return"continue";value=aggregate_data[index][dataIndex];var result=value;tooltipTarget[_i41].formatter&&(result=eval(tooltipTarget[_i41].formatter)),finalResult=finalResult+tooltipTarget[_i41].col+": "+result+"<br/>"}};for(var _i41 in tooltipTarget){var _ret14=_loop14(_i41)}return finalResult+="占比："+params.percent+"%"}},targetData:chartConfig.values,series:series};return updateEchartOptions(chartConfig.option,echartOption),echartOption}}]),discovery.service("chartPie2Service",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var chartConfig=data.chartConfig,casted_values=data.series,aggregate_data=data.data,legend=[],tooltip={},Levi=data.chartConfig.option.tooltip?data.chartConfig.option.tooltip:{},keys=data.chartConfig.keys;for(var _i42 in keys)_.isUndefined(Levi)||(Levi[keys[_i42].col]?(tooltip[keys[_i42].col]=Levi[keys[_i42].col],Levi[keys[_i42].col].col||(tooltip[keys[_i42].col].col=keys[_i42].col)):tooltip[keys[_i42].col]={col:keys[_i42].col,isShow:!0,formatter:""});for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j15=0;_j15<data.chartConfig.values.length;_j15++)for(var k=0;k<data.chartConfig.values[_j15].cols.length;k++)targetValue[data.chartConfig.values[_j15].cols[k].alias]={col:data.chartConfig.values[_j15].cols[k].alias};if(!_.isUndefined(Target))for(var _i43 in targetValue)tooltipTarget[_i43]=Target[_i43],Target[_i43]?tooltipTarget[_i43]={col:Target[_i43].col?Target[_i43].col:_i43,isShow:!Target[_i43]||Target[_i43].isShow,formatter:Target[_i43]&&Target[_i43].formatter?Target[_i43].formatter:""}:tooltipTarget[_i43]={col:_i43,isShow:!Target[_i43]||Target[_i43].isShow,formatter:Target[_i43]&&Target[_i43].formatter?Target[_i43].formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i44=0;_i44<targetGroups.length;_i44++)Groups[targetGroups[_i44].col]?(tooltipGroups[targetGroups[_i44].col]=Groups[targetGroups[_i44].col],Groups[targetGroups[_i44].col].col||(tooltipGroups[targetGroups[_i44].col].col=targetGroups[_i44].col)):tooltipGroups[targetGroups[_i44].col]={col:targetGroups[_i44].col,isShow:!0,formatter:""};var series=[],series_data=[];if(_.isArray(casted_values)&&casted_values.length)for(var i=0;i<casted_values.length;i++)legend.push(casted_values[i][0]),series_data.push({name:casted_values[i][0],value:aggregate_data[i][0]});series=[{type:"pie",center:[chartConfig.centerX?chartConfig.centerX:"50%",chartConfig.centerY?chartConfig.centerY:"50%"],xRadius:[chartConfig.radiusX?chartConfig.radiusX:"0",chartConfig.radiusY?chartConfig.radiusY:"75%"],data:series_data}];for(var i=0;i<series.length;i++)_.isUndefined(chartConfig.series_label)||(chartConfig.series_label===!0?series[i].label={normal:{show:!0}}:series[i].label={normal:{show:!1}});var colorList=[],dataNameList=[],seriesNameList=[];if(chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&(colorList=chartConfig.option.itemStyle.color.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.dataName&&(dataNameList=chartConfig.option.itemStyle.dataName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle.seriesName&&(seriesNameList=chartConfig.option.itemStyle.seriesName.split(",")),chartConfig.option.itemStyle&&chartConfig.option.itemStyle&&chartConfig.option.itemStyle.color&&""!=chartConfig.option.itemStyle.color)for(var e=0;e<colorList.length;e++)if(chartConfig.option.itemStyle.dataName&&(_.isUndefined(chartConfig.option.itemStyle.seriesName)||""==chartConfig.option.itemStyle.seriesName))for(var i=0;i<series.length;i++)for(var j=0;j<series[i].data.length;j++)dataNameList[e]==series[i].data[j].name&&(series[i].data[j]=_.extend(series[i].data[j],{itemStyle:{normal:{color:colorList[e]}}}));var echartOption={legend:{orient:"vertical",left:"left",data:legend},tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",value="",param=BoardParamService.getAll(),_loop15=function _loop15(_i45){if(tooltipTarget[_i45].isShow!==!1){var index=_.findIndex(data.chartConfig.values[0].cols,function(e){return e.alias===_i45});if(index<0)return{v:void 0};value=aggregate_data[index][0];var result=value;tooltipTarget[_i45].formatter&&(result=eval(tooltipTarget[_i45].formatter)),_i45===params.name&&(finalResult=finalResult+tooltipTarget[_i45].col+": "+result+"<br/>")}};for(var _i45 in tooltipTarget){var _ret15=_loop15(_i45);if("object"===("undefined"==typeof _ret15?"undefined":_typeof(_ret15)))return _ret15.v}return finalResult+="占比："+params.percent+"%"}},targetData:chartConfig.values,series:series};return updateEchartOptions(chartConfig.option,echartOption),echartOption}}]),discovery.service("chartFlexChartService",["EventService",function(EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data,scope){var chartConfig=data.chartConfig,newList=[];if(!_.isUndefined(data.chartConfig.option.flex)){for(var keyNameList=[],i=0;i<data.chartConfig.keys.length;i++)keyNameList.push(data.chartConfig.keys[i].col);for(var i=0;i<data.keys.length;i++){for(var obj={},j=0;j<keyNameList.length;j++)obj[keyNameList[j]]=data.keys[i][j];newList.push(obj)}for(var i=0;i<data.series.length;i++)for(var j=0;j<data.keys.length;j++){var valueName=data.series[i][0],valueData=data.data[i];newList[j][valueName]=valueData[j]}}var echartOption={};try{var draw,flexChart=eval(data.chartConfig.option.flex);_.isFunction(flexChart)&&(echartOption=flexChart(newList,data))}catch(e){console.error("chartFlexChartService:function-this.parseOption,row-11,eval(data.chartConfig.option.flex)执行错误",e)}return echartOption}}]),discovery.service("chartFlexD3ChartService",["uuid4",function(uuid4){"ngInject";this.instance=null,this.render=function(e,t,a,r,n){if(null==t)return void e.html('<div class="alert alert-danger" role="alert">No Data!</div>');var i;a?i=a.myheight:null;var o=uuid4.generate();return e.addClass("d3_"+o),new CBoardD3Render(e,t,this,o).chart(null,r)},this.initCanvas=function(e,t,a){var r="<div>hello world</div>";r='<div id="wrapper">\n\t\t<div id="info" style="opacity: 1;">\n\t\t\t\t<div><span id="name"></span><span id="segment">&nbsp;</span></div>\n\t\t\t\t<div><span id="emissions"></span><span id="percent"></span></div>\n\t\t<div id="tweet-box">\n\t\t\t<i id="close" class="icon-remove"></i>\n\t\t\t<div id="tweet-text"></div>\n\t\t</div>\t\t\n',e.html(r);var n=e.height(),i=e.width(),o=d3.select(".d3_"+a.uuid).append("svg").attr("width",i).attr("height",n).attr("left",200);return o},this.draw=function(container,data,render){render.option=data;var div=this.initCanvas(container,data,render),newList=[];if(!_.isUndefined(data.chartConfig.option.flex)){for(var keyNameList=[],i=0;i<data.chartConfig.keys.length;i++)keyNameList.push(data.chartConfig.keys[i].col);for(var i=0;i<data.keys.length;i++){for(var obj={},j=0;j<keyNameList.length;j++)obj[keyNameList[j]]=data.keys[i][j];newList.push(obj)}for(var i=0;i<data.series.length;i++)for(var j=0;j<data.keys.length;j++){var valueName=data.series[i][0],valueData=data.data[i];newList[j][valueName]=valueData[j]}}var echartOption={};try{var draw,flexD3Chart=eval(data.chartConfig.option.flex);_.isFunction(flexD3Chart)&&flexD3Chart(d3,div,newList,data)}catch(e){console.error("chartFlexD3ChartService:function-this.draw,row-39,eval(data.chartConfig.option.flex)执行错误",e)}},this.redraw=function(e,t){this.draw(e,t.option,t)},this.parseOption=function(e,t){return e}}]),discovery.service("chartSankeyService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,[]),o=_.map(a,function(e){var t=e.join("-");return _.find(i,function(e){return e.name==t})||i.push({name:t}),t});_.each(r,function(e){e.length>1&&e.splice(-1,1);var t=e.join("-");_.find(i,function(e){return e.name==t})||i.push({name:t})});for(var s=[],l=0;l<n.length;l++)for(var c=0;c<n[l].length;c++)if(!_.isUndefined(n[l][c])){var d=CBoardEChartRenderEventInfo(e,l,c);s.push({eventInfo:d,source:o[c],target:r[l].join("-"),value:n[l][c]})}var u={color:["#c23531","#2f4554","#61a0a8","#d48265","#91c7ae","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],tooltip:{trigger:"item",triggerOn:"mousemove"},toolbox:!1,series:[{type:"sankey",layout:"none",data:i,links:s,itemStyle:{normal:{borderWidth:1,borderColor:"#aaa"}},lineStyle:{normal:{color:"source",curveness:.5}},label:{normal:{color:"#fff"}}}]},f=t.option;return f&&0==f.legendShow&&(u.grid=echartsBasicOption.grid,u.grid.top="5%",u.legend.show=!1),u}}]),discovery.service("chartCircularService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,[]),o=_.map(a,function(e){var t=e.join("-");return _.find(i,function(e){return e.name==t})||i.push({name:t}),t});_.each(r,function(e){e.length>1&&e.splice(-1,1);var t=e.join("-");_.find(i,function(e){return e.name==t})||i.push({name:t})});for(var s=[],l=0;l<n.length;l++)for(var c=0;c<n[l].length;c++)if(!_.isUndefined(n[l][c])){var d=CBoardEChartRenderEventInfo(e,l,c);s.push({eventInfo:d,source:o[c],target:r[l].join("-"),value:n[l][c]})}var u={tooltip:{trigger:"item",triggerOn:"mousemove"},series:[{name:"Les Miserables",type:"graph",layout:"force",data:i,links:s,itemStyle:{normal:{borderWidth:1,borderColor:"#aaa"}},lineStyle:{normal:{color:"source",curveness:.5}}}]},f=t.option;return f&&0==f.legendShow&&(u.grid=echartsBasicOption.grid,u.grid.top="5%",u.legend.show=!1),u}}]),discovery.service("chartEchart3dMapService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,[]),o={},s=[],l=0,c=1;_.isUndefined(t.option.multiple)||(c=t.option.multiple);for(var d=0;d<a.length;d++)parseInt(n[0][d])>l&&(l=n[0][d]);if("scatter3D"==t.values[0].series_type)for(var d=0;d<a.length;d++){var u=$.extend([],a[d]);if(2==u.length)u.push(void 0,n[0][d]),i.push({eventInfo:CBoardEChartRenderEventInfo(e,void 0,d),value:u,symbolSize:n[0][d]/l*(100*c)});else if(3==u.length){var f=u.pop();u.push(void 0,n[0][d],f),i.push({eventInfo:CBoardEChartRenderEventInfo(e,void 0,d),value:u,symbolSize:n[0][d]/l*(100*c)})}}else if("bar3D"==t.values[0].series_type)for(var d=0;d<a.length;d++){var p=$.extend([],a[d]);if(2==p.length)p.push(n[0][d],n[0][d]),i.push({eventInfo:CBoardEChartRenderEventInfo(e,void 0,d),value:p,symbolSize:5});else if(3==p.length){var f=p.pop();p.push(n[0][d],n[0][d],f),i.push({eventInfo:CBoardEChartRenderEventInfo(e,void 0,d),value:p,symbolSize:5})}}_.each(t.values,function(e){var t={color:e.series_color,opacity:.5};"scatter3D"==e.series_type?(o={label:{show:!1},emphasis:{label:{show:!1}},type:e.series_type,coordinateSystem:"globe",blendMode:"lighter",itemStyle:t,data:i,distanceToGlobe:0,distanceToGeo3D:0},s.push(o)):"bar3D"==e.series_type&&(o={label:{show:!1},emphasis:{label:{show:!1}},type:e.series_type,coordinateSystem:"globe",blendMode:"lighter",itemStyle:t,data:i},s.push(o))});var g={tooltip:{trigger:"item",formatter:function(e){var t=("经度："+e.data.value[0]+"<br>纬度："+e.data.value[1],"");return 5==e.data.value.length?t=e.data.value[4]+"<br>"+r[0]+"："+e.data.value[3]:4==e.data.value.length&&(t=r[0]+"："+e.data.value[3]),t}},backgroundColor:null,viewControl:{targetCoord:[116.46,39.92]},globe:{baseTexture:"../imgs/base2.gif",displacementScale:.04,displacementQuality:"normal",shading:"realistic",environment:null,realisticMaterial:{roughness:.2,metalness:0},postEffect:{enable:!0,depthOfField:{enable:!1,focalDistance:150}},temporalSuperSampling:{enable:!0},light:{ambient:{intensity:0},main:{intensity:5,shadow:!0},ambientCubemap:{texture:"../imgs/echart3dMap.hdr",exposure:1,diffuseIntensity:.5,specularIntensity:2}},viewControl:{autoRotate:!1}},series:s},m=t.option;return m&&(void 0==m.autoRotate&&(m.autoRotate=!1),g.globe.viewControl.autoRotate=m.autoRotate,void 0!=m.dye&&(g.globe.shading=m.dye),1==m.height&&(g.globe.heightTexture=null),0==m.height&&(g.globe.heightTexture="../imgs/height.jpg"),0==m.legendShow&&(g.grid=echartsBasicOption.grid,g.grid.top="5%",g.legend.show=!1),void 0!=m.bgImg&&(g.globe.baseTexture=m.bgImg)),g}}]),discovery.service("chartEchart3dMapLineService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){for(var t=e.chartConfig,a=(e.keys,e.series,e.data,e.seriesConfig,["startLongitude","startLatitude","startLabel","startMeans","startType"]),r=["endLongitude","endLatitude","endLabel","endMeans","endType","lineMeans","lineType"],n=["startValue","endValue","lineValue"],i=t.keys,o=t.groups,s=t.values[0].cols,l=e.originalData.data,c=[],d=0;d<l.length;d++){for(var u={},f=l[d],p=0,g=0;g<o.length;g++)"-"!=f[p]&&(u[r[g]]=f[p]),p++;for(var m=0;m<i.length;m++)"-"!=f[p]&&(u[a[m]]=f[p]),p++;for(var h=0;h<s.length;h++)"-"!=f[p]&&(u[n[h]]=f[p]),p++;c.push(u)}var v=["#ffad3d","#00ac57","#d3133e","#2489b0","#5bc0de","#c2ced1"],y=[],w=void 0,b=void 0,C={"default":{color:v[5],opacity:1,width:3},"试验":{color:v[0],opacity:1,width:3},"任务":{color:v[1],opacity:1,width:3},"事件":{color:v[2],opacity:1,width:3},"国际大事":{color:v[3],opacity:1,width:3},"装备调配":{color:v[4],opacity:1,width:3}},I={"default":{color:v[5]},"试验":{color:v[0]},"任务":{color:v[1]},"事件":{color:v[2]},"国际大事":{color:v[3]},"装备调配":{color:v[4]},red:{color:"red"},green:{color:"green"}},x=_.groupBy(c,"lineMeans"),N=[];for(var h in x){for(var T=[],D=0;D<x[h].length;D++){var S=x[h][D];if(void 0!=S.endMeans&&""!=S.endMeans){var M=C[void 0!=S.lineType?S.lineType:"default"];""!=S.lineType&&void 0!=S.lineType&&(M.width=2),T.push({lineStyle:M,coords:[[S.startLongitude,S.startLatitude],[S.endLongitude?S.endLongitude:void 0,S.endLatitude?S.endLatitude:void 0]]})}}N.push({type:"lines3D",name:h,effect:{show:!0,period:6,trailWidth:3,trailLength:.15,trailOpacity:.7,trailColor:"#fff"},blendMode:"lighter",data:T})}for(var d=0;d<c.length;d++){var h=c[d];y.push({name:h.endMeans?h.endMeans:void 0,value:[h.endLongitude,h.endLatitude,b,parseInt(h.endValue),h.endLabel],itemStyle:I[void 0!=h.endType?h.endType:"default"]}),y.push({name:h.startMeans?h.startMeans:void 0,value:[h.startLongitude,h.startLatitude,w,parseInt(h.startValue),h.startLabel],itemStyle:I[void 0!=h.startType?h.startType:"default"]})}N.push({type:"scatter3D",coordinateSystem:"globe",label:{show:!0,position:"right",formatter:function(e){var t="";return void 0!==e.data.value[4]&&e.data.value[4]&&(t=e.data.value[4]),t}},emphasis:{label:{show:!1}},blendMode:"lighter",symbolSize:function(e){return e[3]?e[3]/8:20},data:y});var k={backgroundColor:null,tooltip:{show:!0,trigger:"item",formatter:function(e){return e.name},extraCssText:"text-align: left"},globe:{baseTexture:"../imgs/base.jpg",displacementScale:.04,displacementQuality:"low",heightTexture:"../imgs/height.jpg",environment:null,shading:"realistic",realisticMaterial:{roughness:.2,metalness:0},postEffect:{enable:!0,depthOfField:{enable:!1,focalDistance:150}},temporalSuperSampling:{enable:!0},light:{ambient:{intensity:.2},main:{intensity:2,shadow:!0},ambientCubemap:{texture:"../imgs/echart3dMap.hdr",exposure:1,diffuseIntensity:.5,specularIntensity:2}},viewControl:{autoRotate:!1,targetCoord:[116.46,39.92]}},series:N},O=t.option;return O&&(void 0==O.autoRotate&&(O.autoRotate=!1),
k.globe.viewControl.autoRotate=O.autoRotate,void 0!=O.dye&&(k.globe.shading=O.dye),1==O.height&&(k.globe.heightTexture=null),0==O.height&&(k.globe.heightTexture="../imgs/height.jpg"),0==O.legendShow&&(k.grid=echartsBasicOption.grid,k.grid.top="5%",k.legend.show=!1),void 0!=O.bgImg&&(k.globe.baseTexture=O.bgImg)),k}}]),discovery.service("chartEchart3dBarService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){for(var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,[]),o=0,s=_.map(a,function(e){return e.join("-")}),l=_.map(r,function(e){return e.join("-")}),c=0;c<s.length;c++)for(var d=0;d<l.length;d++){var u=[];u.push(c),u.push(d),void 0!=n[d][c]?(parseInt(n[d][c])>o&&(o=n[d][c]),u.push(parseInt(n[d][c]))):u.push(0),i.push(u)}var f={backgroundColor:"transparent",tooltip:{trigger:"item",formatter:function(e){var t=e.data.itemInfo.names,a=e.data.itemInfo.value,r=t.join("-")+":"+a;return r}},visualMap:{max:o,inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]}},xAxis3D:{type:"category",data:s,axisPointer:{lineStyle:{color:"#900"}}},yAxis3D:{type:"category",data:l,axisPointer:{lineStyle:{color:"#090"}}},zAxis3D:{type:"value",axisPointer:{lineStyle:{color:"#009"}}},grid3D:{boxWidth:250,boxDepth:90,viewControl:{},light:{main:{intensity:1.2,shadow:!0},ambient:{intensity:.3}}},series:[{type:"bar3D",data:i.map(function(e){return{itemInfo:{names:[s[e[0]],l[e[1]]],value:e[2]},value:[e[0],e[1],e[2]],label:{show:!1}}}),bevelSize:.2,bevelSmoothness:3,shading:"lambert",label:{textStyle:{fontSize:16,borderWidth:1}},itemStyle:{opacity:.9},emphasis:{label:{textStyle:{fontSize:20,color:"#900"}},itemStyle:{color:"#900"}}}]},p=t.option;return p&&0==p.legendShow&&(f.grid=echartsBasicOption.grid,f.grid.top="5%",f.legend.show=!1),f}}]),discovery.service("chartEchartCityMapService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.originalData.data,a="#e0ffff";e.chartConfig.option.maxColor&&(a=e.chartConfig.option.maxColor);var r="#006edd";e.chartConfig.option.minColor&&(r=e.chartConfig.option.minColor),e.chartConfig.option.minColor;var n=20;e.chartConfig.option.cityMaxRadius&&(n=e.chartConfig.option.cityMaxRadius);var i=10;e.chartConfig.option.cityMinRadus&&(i=e.chartConfig.option.cityMinRadus);var o=convertCityData(t),s=_.max(o,function(e){return e.value[2]}),l={tooltip:{trigger:"item"},visualMap:{min:0,max:1500,left:"left",top:"bottom",text:["High","Low"],seriesIndex:[1],inRange:{color:[r,a]},calculable:!0},geo:{map:"china",roam:!0,label:{normal:{show:!0,textStyle:{}}},itemStyle:{normal:{borderColor:"#D5D5D5",borderWidth:"1",areaColor:"#F5F5F5"},emphasis:{areaColor:null,shadowOffsetX:0,shadowOffsetY:0,shadowBlur:20,borderWidth:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}},series:[{type:"scatter",coordinateSystem:"geo",data:convertCityData(t),symbolSize:function(e,t){var a=parseInt(e[2])/parseInt(s.value[2])*n;return a<i?i:a},symbolRotate:35,itemStyle:{normal:{color:"#F06C00"}}},{name:"categoryA",type:"map",geoIndex:0,data:convertProvinceData(t),label:{normal:{formatter:"{b}",position:"right",show:!1},emphasis:{show:!0}}}]};return l}}]);var city={"海门":[121.15,31.89],"鄂尔多斯":[109.781327,39.608266],"招远":[120.38,37.35],"舟山":[122.207216,29.985295],"齐齐哈尔":[123.97,47.33],"盐城":[120.13,33.38],"赤峰":[118.87,42.28],"青岛":[120.33,36.07],"乳山":[121.52,36.89],"金昌":[102.188043,38.520089],"泉州":[118.58,24.93],"莱西":[120.53,36.86],"日照":[119.46,35.42],"胶南":[119.97,35.88],"南通":[121.05,32.08],"拉萨":[91.11,29.97],"云浮":[112.02,22.93],"梅州":[116.1,24.55],"文登":[122.05,37.2],"攀枝花":[101.718637,26.582347],"威海":[122.1,37.5],"承德":[117.93,40.97],"厦门":[118.1,24.46],"汕尾":[115.375279,22.786211],"潮州":[116.63,23.68],"丹东":[124.37,40.13],"太仓":[121.1,31.45],"曲靖":[103.79,25.51],"烟台":[121.39,37.52],"福州":[119.3,26.08],"瓦房店":[121.979603,39.627114],"即墨":[120.45,36.38],"抚顺":[123.97,41.97],"玉溪":[102.52,24.35],"张家口":[114.87,40.82],"阳泉":[113.57,37.85],"莱州":[119.942327,37.177017],"湖州":[120.1,30.86],"汕头":[116.69,23.39],"昆山":[120.95,31.39],"宁波":[121.56,29.86],"湛江":[110.359377,21.270708],"揭阳":[116.35,23.55],"荣成":[122.41,37.16],"连云港":[119.16,34.59],"葫芦岛":[120.836932,40.711052],"常熟":[120.74,31.64],"东莞":[113.75,23.04],"河源":[114.68,23.73],"淮安":[119.15,33.5],"泰州":[119.9,32.49],"南宁":[108.33,22.84],"营口":[122.18,40.65],"惠州":[114.4,23.09],"江阴":[120.26,31.91],"蓬莱":[120.75,37.8],"韶关":[113.62,24.84],"嘉峪关":[98.289152,39.77313],"延安":[109.47,36.6],"太原":[112.53,37.87],"清远":[113.01,23.7],"中山":[113.38,22.52],"昆明":[102.73,25.04],"寿光":[118.73,36.86],"盘锦":[122.070714,41.119997],"长治":[113.08,36.18],"珠海":[113.52,22.3],"宿迁":[118.3,33.96],"咸阳":[108.72,34.36],"铜川":[109.11,35.09],"平度":[119.97,36.77],"佛山":[113.11,23.05],"海口":[110.35,20.02],"江门":[113.06,22.61],"章丘":[117.53,36.72],"肇庆":[112.44,23.05],"大连":[121.62,38.92],"临汾":[111.5,36.08],"吴江":[120.63,31.16],"石嘴山":[106.39,39.04],"沈阳":[123.38,41.8],"茂名":[110.88,21.68],"嘉兴":[120.76,30.77],"长春":[125.35,43.88],"胶州":[120.03336,36.264622],"银川":[106.27,38.47],"张家港":[120.555821,31.875428],"三门峡":[111.19,34.76],"锦州":[121.15,41.13],"南昌":[115.89,28.68],"柳州":[109.4,24.33],"三亚":[109.511909,18.252847],"自贡":[104.778442,29.33903],"阳江":[111.95,21.85],"泸州":[105.39,28.91],"西宁":[101.74,36.56],"宜宾":[104.56,29.77],"呼和浩特":[111.65,40.82],"大同":[113.3,40.12],"镇江":[119.44,32.2],"桂林":[110.28,25.29],"张家界":[110.479191,29.117096],"宜兴":[119.82,31.36],"北海":[109.12,21.49],"西安":[108.95,34.27],"金坛":[119.56,31.74],"东营":[118.49,37.46],"遵义":[106.9,27.7],"绍兴":[120.58,30.01],"扬州":[119.42,32.39],"常州":[119.95,31.79],"潍坊":[119.1,36.62],"台州":[121.420757,28.656386],"南京":[118.78,32.04],"滨州":[118.03,37.36],"贵阳":[106.71,26.57],"本溪":[123.73,41.3],"克拉玛依":[84.77,45.59],"渭南":[109.5,34.52],"马鞍山":[118.48,31.56],"宝鸡":[107.15,34.38],"焦作":[113.21,35.24],"句容":[119.16,31.95],"徐州":[117.2,34.26],"衡水":[115.72,37.72],"绵阳":[104.73,31.48],"枣庄":[117.57,34.86],"杭州":[120.19,30.26],"淄博":[118.05,36.78],"鞍山":[122.85,41.12],"溧阳":[119.48,31.43],"库尔勒":[86.06,41.68],"安阳":[114.35,36.1],"开封":[114.35,34.79],"济南":[117,36.65],"德阳":[104.37,31.13],"温州":[120.65,28.01],"九江":[115.97,29.71],"邯郸":[114.47,36.6],"临安":[119.72,30.23],"兰州":[103.73,36.03],"沧州":[116.83,38.33],"临沂":[118.35,35.05],"南充":[106.110698,30.837793],"富阳":[119.95,30.07],"泰安":[117.13,36.18],"诸暨":[120.23,29.71],"郑州":[113.65,34.76],"聊城":[115.97,36.45],"芜湖":[118.38,31.33],"平顶山":[113.29,33.75],"邢台":[114.48,37.05],"德州":[116.29,37.45],"济宁":[116.59,35.38],"荆州":[112.239741,30.335165],"宜昌":[111.3,30.7],"义乌":[120.06,29.32],"丽水":[119.92,28.45],"洛阳":[112.44,34.7],"秦皇岛":[119.57,39.95],"株洲":[113.16,27.83],"莱芜":[117.67,36.19],"常德":[111.69,29.05],"湘潭":[112.91,27.87],"岳阳":[113.09,29.37],"长沙":[113,28.21],"衢州":[118.88,28.97],"廊坊":[116.7,39.53],"菏泽":[115.480656,35.23375],"冷饮华东大区":[121.638481,31.230895],"冷饮晋冀蒙大区":[111.660351,40.828319],"冷饮华北大区":[116.521695,39.958953],"冷饮上海直辖区域":[121.487899,31.249162],"冷饮蒙晋大区":[111.660351,40.828319],"冷饮京津大区":[116.521695,39.958953],"乌鲁木齐":[87.583,43.8],"金山工厂":[111.73,40.83],"天津工厂":[117.03,39.38],"密云工厂":[116.83,40.37],"呼市直营":[111.73,40.83],"河南工厂":[113.18,33.77],"肇东工厂":[127,46.63],"沈阳工厂":[123.38,41.8],"苏州工厂":[120.62,31.32],"成都工厂":[103.47,30.42],"衡阳分仓":[112.57,26.9],"青岛分仓":[120.38,36.07],"济南分仓":[116.98,36.67],"天津直营":[117.2005692,39.14493942],"天津分仓":[117.2005692,39.14493942],"上海直营":[121.458,31.222],"南京直营":[118.777,32.061],"天津（分）":[117.13,39.22],"杭州直营":[120.62,31.32],"合肥直营":[117.25,31.83],"西安直营":[108.93,34.27],"武汉直营":[114.31,30.52],"武汉（直）":[114.3,30.6],"深圳直营":[114.07,22.62],"惠州工厂":[114.4,23.09],"太原分仓":[112.53,37.87],"西安分仓":[108.93,34.27],"长沙分仓":[112.93,28.23],"武汉分仓":[114.3,30.6],"南昌分仓":[115.89,28.68],"昆明分仓":[102.73,25.04],"常德分仓":[111.69,29.05],"兰州分仓":[103.73,36.03],"吉安分仓":[114.97,27.12],"厦门分仓":[118.1,24.46],"柳州分仓":[109.4,24.33],"南平分仓":[118.16,26.65],"西南直采":[104.07,30.67],"黄冈工厂":[114.87,30.44],"广佛分仓":[113.27,23.13],"定州工厂":[114.98,36.67],"金川工厂":[111.73,40.83],"北京（东分）":[116.65,39.92],"北京分仓":[116.23,40.22],"北京南直营":[116.219,40.218],"北京北直营":[116.219,40.218],"呼市分仓":[111.652,40.81],"成都分仓":[104.15,30.83],"肇东分仓":[125.983,46.083],"郑州分仓":[113.648,34.757],"调拨库":[124.45,46.87],"新疆分仓":[87.583,43.8],"合肥分仓":[117.28,31.863],"重庆分仓":[106.254,29.29],"广州分仓":[113.35,23.12],"贵阳分仓":[106.716,26.583],"北京直营":[116.46,39.92],"合肥新鲜度项目试点库":[117.28,31.863],"海口分仓":[110.341,20.045],"呼市暂存库":[111.652,40.81],"巴盟分仓":[107.42,40.77],"定州分仓":[114.995,38.513],"辽宁分仓":[123.432,41.792],"乌鲁木齐分仓":[87.583,43.8],"拉萨分仓":[91.1,29.65],"福州分仓":[119.306,26.061],"徐州分仓":[117.157,34.18],"杭州分仓":[120.168,30.255],"北京北暂存库":[116.329,39.721],"北京南暂存库":[116.219,40.218],"天津暂存库":[117.201,39.1449],"上海暂存库":[121.458,31.222],"南充暂存库":[106.084,30.795],"黄冈伊利中心仓":[114.907,30.4461],"肇东暂存库":[125.983,46.083],"苏南暂存库":[121.27,31.38],"贵阳暂存库":[106.716,26.583],"郑州暂存库":[113.648,34.757],"乌鲁木齐成品暂存库":[87.583,43.8],"兰州成品暂存库":[103.792,36.056],"北京暂存库北库":[116.219,40.218],"南京暂存库":[118.777,32.061],"南昌暂存库":[115.883,28.683],"合肥成品暂存库":[117.28,31.863],"定州成品暂存库":[114.995,38.513],"巴彦淖尔成品暂存库":[107.42,40.77],"广东暂存库":[114.4,23.083],"广州暂存库":[113.131,23.026],"徐州暂存库":[117.157,34.18],"成都伊利暂存库":[104.066,30.666],"成都暂存库":[104.066,30.666],"液奶拉萨分仓":[91.1,29.65],"液奶昆明暂存库":[102.718,25.038],"液奶柳州暂存库":[109.169,21.668],"液奶重庆暂存库":[106.254,29.29],"漯河暂存库":[114.02,33.56],"潍坊暂存库":[119.1426,36.71611],"福州暂存库":[119.306,26.061],"晋中伊利暂存库":[112.7345,37.681],"晋南暂存库":[108.928,34.258],"杭州暂存库":[120.168,30.255],"武汉暂存库":[114.266,30.583],"沈阳暂存库":[123.432,41.792],"泰普克成品暂存库":[108.928,34.258],"济南暂存库":[116.997,36.668],"济源暂存库":[112.5873,35.0888],"液奶乌鲁木齐伊利":[87.583,43.8],"液奶兰州乳业":[103.792,36.056],"长沙暂存库":[112.966,28.2],"黄冈伊利暂存库":[114.9066,30.44611],"龙游暂存库":[118.8758,28.95691],"北京暂存库南库":[116.329,39.721],"海口仓":[110.341,20.045],"液奶南充暂存库":[106.084,30.795],"西藏":[91.17849,29.658434],"安徽":[117.233592,31.826705],"川南":[104.693255,28.81582],"湖北外埠":[114.311831,30.598426],"武汉":[114.311831,30.598426],"无锡":[120.313232,31.579529],"广州":[113.30765,23.120049],"闽北":[119.330221,26.047125],"鄂东":[114.311831,30.598426],"吉西":[122.260363,43.633756],"豫北区域":[114.3995,36.103636],"甘青藏":[103.823305,36.064226],"蒙西":[109.787493,39.61474],"苏中":[118.778074,32.057236],"金华":[119.652576,29.102899],"直营一区":[116.4,39.9],"陕南":[108.953098,34.2778],"郑州区域":[113.649644,34.75661],"北京北郊区域":[116.728229,40.154951],"上海经销区域":[121.53,31.22],"济南区域":[117.126488,36.65819],"吉林":[125.344899,43.998252],"湖南":[112.945393,28.234248],"广东":[113.270793,23.135303],"辽宁":[123.453552,41.798305],"广西":[108.372627,22.823604],"陕西":[108.953098,34.2778],"四川":[104.07214,30.578832],"成都":[104.07214,30.578832],"闽南":[118.103886,24.489231],"鄂西":[109.47,30.3],"牡丹江":[129.608035,44.588521],"贵州":[106.724173,26.541413],"呼包宁":[111.660351,40.828319],"豫西":[112.390753,34.671668],"鲁西区域":[117.126488,36.65819],"云南区域":[101.55,25.03],"川北":[104.124269,30.606302],"海南":[110.330802,20.022071],"重庆区域":[106.530635,29.544606],"石家庄":[114.522082,38.048958],"常德区域":[111.653718,29.012149],"赣南区域":[114.935909,25.845296],"上海特通组":[121.75,31.05],"巴氏奶哈尔滨":[126.541745,45.808985],"黑龙江":[126.792044,45.710449],"浙南":[120.565799,28.067865],"广州直营":[113.270793,23.135303],"浙江":[120.162142,30.278988],"苏州":[120.591427,31.307026],"广东外埠":[113.270793,23.135303],"四川外埠":[107.474504,31.214344],"辽西":[123.432791,41.808645],"吉东":[125.313642,43.898338],"浙西":[120.219375,30.259244],"苏中区域":[118.802962,32.064792],"鄂东区域":[114.87,30.45],"豫北":[113.708011,34.797406],"云贵区域":[107.5,26.7],"鲁西南":[116.600798,35.402122],"鲁南":[116.600798,35.402122],"北京南郊区域":[116.740079,39.809815],"北京市区经销区域":[116.521695,39.958953],"包头":[109.846755,40.663633],"江西":[115.864758,28.68833],"蒙晋":[113.138484,41.000889],"重庆":[106.558106,29.56911],"湘北":[113.021311,25.776709],"湘南":[112.945393,28.234248],"福建":[119.303339,26.080457],"河南区域":[113.631768,34.753427],"鄂西区域":[112.250093,32.229169],"赣北":[115.959851,29.667088],"北京":[116.521695,39.958953],"蒙银":[106.238976,38.492391],"保定":[115.49481,38.886565],"直营区域":[116.521695,39.958953],"天津直营区域":[117.207137,39.089475],"上海直营二区":[121.5,31.27],"巴氏奶大庆":[125.110456,46.594889],"信阳区域":[114.099264,32.153182],"苏南":[119.635313,31.26495],"新疆":[87.549219,43.898324],"呼市":[111.755186,40.848657],"云贵":[106.724173,26.541413],"哈尔滨":[126.657717,45.773225],"大庆":[125.02184,46.596709],"蒙东":[113.138484,41.000889],"浙东":[121.579006,29.885259],"直营二区":[117.2,39.12],"晋南":[111.474665,36.125937],"陕北":[109.483933,34.502358],"上海直营一区":[121.43,31.18],"深圳":[114.025974,22.546054],"上海":[121.480237,31.2363],"湖北区域":[114.311831,30.598426],"湖南区域":[112.945393,28.234248],"晋北":[113.306205,40.082539],"山西":[112.555135,37.876812],"鲁中":[119.142634,36.716115],"豫南":[113.941362,33.670704],"鲁中区域":[117.126488,36.65819],"鲁东区域":[120.388969,36.073179],"冀北":[114.892592,40.774341],"漯河区域":[114.046061,33.576279],"洛阳区域":[112.447525,34.657368],"济宁区域":[116.593803,35.420956],"甘青":[103.771994,35.992495],"桂琼":[108.372627,22.823604],"浙北":[120.088993,30.207036],"江苏":[118.802962,32.064792],"辽东":[121.593478,38.94871],"豫南区域":[114.028713,33.019078],"川北区域":[105.849862,32.441794],"川南区域":[103.760824,29.600958],"赣南":[114.94126,25.837178],"蒙中":[118.757106,42.268753],"冀南":[114.511441,36.631195],"湘北区域":[112.950575,27.835846],"宁夏":[106.206479,38.502621],"经销一区":[116.7,39.52],"合肥":[117.247835,31.912901],"皖北区域":[117.233592,31.826705],"赣北区域":[115.893528,28.689578],"巴氏奶牡丹江":[129.640285,44.558309],"新疆区域":[87.623193,43.831481],"市区经销区域":[116.521695,39.958953],"湖北":[114.311831,30.598426],"皖南":[117.233592,31.826705],"粤东":[114.065944,22.548554],"粤西":[110.931773,21.669043],"蒙宁":[106.238976,38.492391],"苏北":[117.188107,34.271553],"苏南区域":[119.635313,31.26495],"云南":[102.839607,24.886079],"江西区域":[115.864758,28.68833],"湘南区域":[112.950575,27.835846],"鲁东":[120.384428,36.105215],"天津":[117.207137,39.089475],"鲁西":[117.024967,36.682785],"皖北":[117.282699,31.866942],"贵州区域":[106.933648,27.731899],"经销二区":[116.521695,39.958953],"经销三区":[117.2,39.12],"经销四区":[118.2,39.63],"唐山":[118.183451,39.650531],"衡阳区域":[112.583819,26.898164],"长沙区域":[112.979353,28.213478],"青岛区域":[120.388969,36.073179],"山东":[117.024967,36.682785],"西北":[108.953098,34.2778],"京津":[116.395645,39.929986],"奶粉华中大区":[114.332868,30.656091],"奶粉闽赣大区":[119.27345,26.04769],"奶粉西南大区":[104.124269,30.606302],"奶粉华南大区":[113.234423,23.093666],"两湖":[114.3162,30.581084],"奶粉华东大区":[121.638481,31.230895],"晋冀蒙":[111.660351,40.828319],"酸奶西北大区":[108.953098,34.2778],"酸奶西南大区":[104.067923,30.679943],"酸奶华中大区":[114.3162,30.581084],"冷饮西北大区":[111.755869,40.84906],"冷饮西南大区":[104.073543,30.658068],"酸奶华南大区":[113.30765,23.120049],"冷饮华南大区":[113.266109,23.144061],"浙沪":[121.487899,31.249162],"冷饮鲁豫大区":[117.117993,36.660062],"冷饮华中大区":[114.305645,30.610203],"酸奶东北大区":[123.432791,41.808645],"闽赣":[119.330221,26.047125],"酸奶晋冀蒙大区":[111.660351,40.828319],"酸奶浙沪大区":[121.487899,31.249162],"酸奶京津大区":[116.521695,39.958953],"云贵广":[108.297234,22.806493],"奶粉西北大区":[108.953098,34.2778],"粤海":[113.30765,23.120049],"酸奶苏皖大区":[118.778074,32.057236],"酸奶鲁豫大区":[117.024967,36.682785],"冷饮浙沪大区":[121.479949,31.236197],"奶粉华北大区":[116.521695,39.958953],"奶粉苏皖大区":[118.765057,32.05724],"奶粉蒙晋大区":[111.660351,40.828319],"东北":[123.432791,41.808645],"奶粉东北大区":[123.453552,41.798305],"冷饮京津冀大区":[117.20459,39.094829],"冷饮东北大区":[123.432592,41.818304],"苏皖":[118.778074,32.057236],"冷饮苏皖大区":[117.233613,31.826381],"河南":[113.649644,34.75661],"奶粉鲁豫大区":[113.708011,34.797406],"销售部软冰业务":[118.864332,28.985379],"华东":[121.480237,31.2363],"华南":[113.270793,23.135303],"北部":[116.413624,39.910837],"华北":[117.126488,36.65819],"东南":[119.303339,26.080457],"西南":[104.07214,30.578832],"华中":[114.311831,30.598426]},province={"北京":!0,"天津":!0,"上海":!0,"重庆":!0,"河北":!0,"河南":!0,"云南":!0,"辽宁":!0,"黑龙江":!0,"湖南":!0,"安徽":!0,"山东":!0,"新疆":!0,"江苏":!0,"浙江":!0,"江西":!0,"湖北":!0,"广西":!0,"甘肃":!0,"山西":!0,"内蒙古":!0,"陕西":!0,"吉林":!0,"福建":!0,"贵州":!0,"广东":!0,"青海":!0,"西藏":!0,"四川":!0,"宁夏":!0,"海南":!0,"台湾":!0,"香港":!0,"澳门":!0};discovery.service("chartEchart3dAreaService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){for(var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=(e.seriesConfig,[]),o=0,s=_.map(a,function(e){return e.join("-")}),l=_.map(r,function(e){return e.join("-")}),c=0;c<s.length;c++)for(var d=0;d<l.length;d++){var u=[];u.push(d),u.push(c),void 0!=n[d][c]?(parseInt(n[d][c])>o&&(o=n[d][c]),u.push(parseInt(n[d][c]))):u.push(0),i.push(u)}var f={tooltip:{},backgroundColor:"#fff",visualMap:{show:!1,dimension:2,min:-1,max:o,inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]}},xAxis3D:{type:"category",data:l,axisPointer:{lineStyle:{color:"#900"}}},yAxis3D:{type:"category",data:s,axisPointer:{lineStyle:{color:"#090"}}},zAxis3D:{type:"value"},grid3D:{viewControl:{}},series:[{type:"surface",wireframe:{},data:i}]},p=t.option;return p&&0==p.legendShow&&(f.grid=echartsBasicOption.grid,f.grid.top="5%",f.legend.show=!1),f}}]),discovery.service("chartBarPolarStackService",["EventService",function(EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys;for(var _i46 in keys)Levi[keys[_i46].col]?(tooltip[keys[_i46].col]=Levi[keys[_i46].col],Levi[keys[_i46].col].col||(tooltip[keys[_i46].col].col=keys[_i46].col)):tooltip[keys[_i46].col]={col:keys[_i46].col,isShow:!0,formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget,targetValue={},_j16=0;_j16<data.chartConfig.values.length;_j16++)for(var k=0;k<data.chartConfig.values[_j16].cols.length;k++)targetValue[data.chartConfig.values[_j16].cols[k].alias]={col:data.chartConfig.values[_j16].cols[k].alias};for(var _i47 in targetValue)tooltipTarget[_i47]=Target[_i47],Target[_i47]&&Target[_i47].col||(tooltipTarget[_i47]={col:_i47,isShow:!Target[_i47]||Target[_i47].isShow,formatter:Target[_i47]?Target[_i47].formatter:""});for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i48=0;_i48<targetGroups.length;_i48++)Groups[targetGroups[_i48].col]?(tooltipGroups[targetGroups[_i48].col]=Groups[targetGroups[_i48].col],Groups[targetGroups[_i48].col].col||(tooltipGroups[targetGroups[_i48].col].col=targetGroups[_i48].col)):tooltipGroups[targetGroups[_i48].col]={col:targetGroups[_i48].col,isShow:!0,formatter:""};for(var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,series=new Array,string_keys=_.map(casted_keys,function(e){return e.join("-")}),string_value=_.map(casted_values,function(e){return e.join("-")}),titles=[],i=0;i<aggregate_data.length;i++){for(var s={type:"bar",coordinateSystem:"polar",stack:"a",name:string_value[i],data:[]},j=0;j<aggregate_data[i].length;j++){var eventInfo=CBoardEChartRenderEventInfo(data,i,j),dataItem={eventInfo:eventInfo,name:string_keys[j],value:_.isUndefined(aggregate_data[i][j])?0:aggregate_data[i][j]};chartConfig.config&&chartConfig.config.events.length>0,s.data.push(dataItem)}series.push(s)}var echartOption={tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",_loop16=function _loop16(_i49){if(tooltip[_i49].isShow!==!1){var index=_.findIndex(data.chartConfig.keys,function(e){return e.col===_i49});if(index<0)return{v:void 0};var _value="";if(tooltip[_i49].formatter&&tooltip[_i49].formatter.indexOf("{v}")!=-1){var _repResult="";"string"==typeof params.data.eventInfo[index].value&&(_repResult=tooltip[_i49].formatter.replace("{v}","'{v}'")),_repResult=_repResult.replace("{v}",params.data.eventInfo[index].value),_value=eval(_repResult)}else _value=params.data.eventInfo[index].value;finalResult=finalResult+tooltip[_i49].col+": "+_value+"<br/>"}};for(var _i49 in tooltip){var _ret16=_loop16(_i49);if("object"===("undefined"==typeof _ret16?"undefined":_typeof(_ret16)))return _ret16.v}for(var _i50 in tooltipGroups)if(void 0===_typeof(tooltipGroups[_i50])||tooltipGroups[_i50].isShow!==!1){var obj=_.where(params.data.eventInfo,{col:_i50});if(0===obj.length)return;var value="";if(tooltipGroups[_i50].formatter&&tooltipGroups[_i50].formatter.indexOf("{v}")!=-1){var repResult="";"string"==typeof obj[0].value&&(repResult=tooltipGroups[_i50].formatter.replace("{v}","'{v}'")),repResult=repResult.replace("{v}",obj[0].value),value=eval(repResult)}else value=obj[0].value;finalResult=finalResult+tooltipGroups[_i50].col+": "+value+"<br/>"}var _loop17=function _loop17(_i51){if(tooltipTarget[_i51].isShow!==!1){var index=_.findIndex(data.chartConfig.values[0].cols,function(e){return e.alias===_i51});if(index<0)return{v:void 0};var dataIndex=_.findIndex(aggregate_data[params.seriesIndex],function(e){return e===params.value});if(dataIndex<0)return{v:void 0};var _value2="";if(tooltipTarget[_i51].formatter&&tooltipTarget[_i51].formatter.indexOf("{v}")!=-1){var _repResult2="";_repResult2="string"==typeof params.value?tooltipTarget[_i51].formatter.replace("{v}","'{v}'"):tooltipTarget[_i51].formatter,_repResult2=_repResult2.replace("{v}",aggregate_data[index][dataIndex]),_value2=eval(_repResult2)}else _value2=aggregate_data[index][dataIndex];finalResult=finalResult+tooltipTarget[_i51].col+": "+_value2+"<br/>"}};for(var _i51 in tooltipTarget){var _ret17=_loop17(_i51);if("object"===("undefined"==typeof _ret17?"undefined":_typeof(_ret17)))return _ret17.v}return finalResult}},angleAxis:{},radiusAxis:{type:"category",data:string_keys,z:10},polar:{},series:series,legend:{show:!0,data:string_value}},tunningOpt=chartConfig.option;return tunningOpt&&0==tunningOpt.legendShow&&(echartOption.grid=echartsBasicOption.grid,echartOption.grid.top="5%",echartOption.legend.show=!1),echartOption}}]),discovery.service("chartPieProportionService",["dataService","EventService",function(e,t){"ngInject";this.instance=null,this.render=function(e,a,r,n,i,o){return this.instance=new CBoardEChartRender(e,a,(void 0),o),this.instance.chart(null,n,t)},this.parseOption=function(e){for(var t=e.chartConfig,a=(t.keys,e.keys),r=e.series,n=e.data,i=(e.seriesConfig,new Array),o=_.map(a,function(e){return e.join("-")}),s=(_.map(r,function(e){return e.join("-")}),100/(9*o.length+1)),l=[],c={normal:{label:{show:!1},labelLine:{show:!1},shadowBlur:40,shadowColor:"rgba(40, 40, 40, 0.5)"}},d={normal:{label:{show:!1},labelLine:{show:!1}},emphasis:{}},u=["#3dd4de","#b697cd","#a6f08f"],f=0;f<o.length;f++){var p={name:o[f],type:"pie",clockWise:!1,radius:[75,85],xRadius:[75,85],itemStyle:c,hoverAnimation:!1,center:[5*s+9*f*s+"%","50%"],data:[]};l.push({textStyle:{fontWeight:"normal",color:"#b697cd",fontSize:15},text:o[f],x:"center",y:"center",left:3*s+9*f*s+"%",top:"90%"});var g={name:o[f],value:_.isUndefined(n[0][f])?0:n[0][f],label:{normal:{formatter:"{d}%",position:"center",show:!0,textStyle:{fontSize:"25",fontWeight:"normal",color:u[f%u.length]}}},itemStyle:{normal:{color:u[f%u.length],shadowColor:u[f%u.length],shadowBlur:10},emphasis:{color:u[f%u.length]}}},m={value:_.isUndefined(n[1][f]-n[0][f])?0:n[1][f]-n[0][f],name:"invisible",itemStyle:d};t.config&&t.config.events.length>0,p.data.push(g),p.data.push(m),i.push(p)}var h={title:l,tooltip:{show:!1},toolbox:{show:!1},series:i};return updateEchartOptions(t.option,h),h}}]),discovery.service("chartRadarService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){for(var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=0;i<n.length;i++)for(var o=0;o<n[i].length;o++)_.isUndefined(n[i][o])&&(n[i][o]=0);var s,l=_.map(a,function(e){return e.join("-")}),c=_.map(r,function(e){return e.join("-")}),d=[],u=[];if(t.asRow){for(var i=0;i<l.length;i++){for(var f={value:[],name:l[i]},o=0;o<r.length;o++){f.value[o]=n[o][i];var p=Number(n[o][i]);(_.isUndefined(s)||p>s)&&(s=p)}var g=CBoardEChartRenderEventInfo(d,void 0,i);f.eventInfo=g,d.push(f)}for(var o=0;o<r.length;o++)u.push({name:r[o],max:1.05*s})}else{for(var i=0;i<c.length;i++){for(var f={value:[],name:c[i]},o=0;o<l.length;o++){f.value[o]=n[i][o];var p=Number(n[i][o]);(_.isUndefined(s)||p>s)&&(s=p)}for(var g=[],m=0;m<t.keys.length;m++)a[i]&&g.push({col:t.keys[m].col,alias:t.keys[m].alias,value:a[i][m]});f.eventInfo=g,d.push(f)}for(var o=0;o<l.length;o++)u.push({name:l[o],max:1.05*s})}var h={tooltip:{trigger:"item"},toolbox:!1,legend:{orient:"vertical",left:"left",data:t.asRow?l:c},radar:{name:{textStyle:{fontSize:18}},indicator:u},series:[{name:"radar",type:"radar",itemStyle:{emphasis:{areaStyle:{color:"rgba(0,250,0,0.3)"}}},data:d}]};return updateEchartOptions(t.option,h),h}}]),discovery.service("chartService",["$q","$interpolate","EventService","dataService","chartPieService","chartLineService","chartLine2Service","chartLine3Service","chartFunnelService","chartSankeyService","chartTableService","chartKpiService","chartRadarService","chartMapService","chartScatterService","chartScatter2Service","chartGaugeService","chartWordCloudService","chartEchart3dMapLineService","chartEchartCityMapService","chartEchart3dBarService","chartEchart3dAreaService","chartTreeMapService","chartAreaMapService","chartHeatMapCalendarService","chartHeatMapTableService","chartLiquidFillService","chartMarkLineMapService","chartBarPolarStackService","chartPieProportionService","chartCircularService","chartEchart3dMapService","chartCodeFlowerService","chartD3DemoService","chartFlexService","chartFlex2Service","chartBarLimitsService","chartDataLineTableService","chartGanttService","chartLineMapService","chartPie2Service","chartFlexChartService","chartRoseService","chartFlexD3ChartService","chartD3ChordService","chartCrossTableService","chartCrossTableGreatService","chartSelectorService","chartEchartBmapService","chartEchartZoneMapService","chartTreeGridService",function(e,t,a,r,n,i,o,s,l,c,d,u,f,p,g,m,h,v,y,w,b,C,I,x,N,T,D,S,M,k,O,W,E,L,G,A,F,R,U,j,P,B,z,V,q,J,Y,X,H,K,Z){"ngInject";this.render=function(t,n,i,o,s,l,c,d){var u=e.defer(),f=Q(n.config),p=ee(n.config);return r.getDataSeries(n.datasource,n,n.datasetId,p,function(e){n.noData=!1,0===e.originalData.data.length&&(n.noData=!0);try{var s=f.parseOption(e);i&&i(s),e.drill&&(e.drill.drillDown=function(e,t){r.getDrillPath(n.datasetId,e).then(function(s){var l=_.find(s,function(t){return t.id==e});a.trigger("$drillDown",{widget:o?o.widget:null,param:{data:{eventInfo:[{col:l.col?l.col:l.column}]}},type:"table"});var c=0;_.each(s,function(t,a){t.id==e&&(c=a)});var d=s[++c];_.find(n.config.keys,function(t,a){if(t.id==e)return t.type="=",t.values=[],_.find(n.config.keys,function(e){return e.id==d.id})||n.config.keys.splice(a+1,0,d),!0}),_.find(n.config.groups,function(t,a){if(t.id==e)return t.type="=",t.values=[],_.find(n.config.groups,function(e){return e.id==d.id})||n.config.groups.splice(a+1,0,d),!0}),r.getDataSeries(n.datasource,n,n.datasetId,n.config,function(e){var a=f.parseOption(e);i&&i(a),t(a,e.drill.config,"down")})})},e.drill.drillUp=function(e,t){var s,l,c,d=null,u=r.getDatasetListMap(),p=u[n.datasetId].data.schema.dimension,g=0,m=-1,h=0,v=[];_.find(p,function(t){if(m++,"level"===t.type){var a=_.find(t.columns,function(a,r){if(a.id===e)return c=t.id,v=t.columns,!0});return a}}),n.config.keys.length&&(_.each(n.config.keys,function(t,a){_.find(v,function(e){if(e.id===t.id)return!0})&&g++,t.id==e&&(s=a,d=n.config.keys[a-1].col?n.config.keys[a-1].col:n.config.keys[a-1].column)}),console.log("keyIndex",s),console.log("keySpliceLength",g),console.log("keyOtherLength",m),s&&(n.config.keys[s-1].values=[],n.config.keys.splice(s,g-s+m))),n.config.groups.length&&(_.each(n.config.groups,function(t,a){_.find(v,function(e){if(e.id===t.id)return!0})&&h++,t.id==e&&(l=a,d=n.config.groups[a-1].col?n.config.groups[a-1].col:n.config.groups[a-1].column)}),l&&(n.config.groups[l-1].values=[],n.config.groups.splice(l,h-l+m))),a.trigger("$drillUp",{widget:o?o.widget:null,param:{data:{eventInfo:[{col:d}]}},type:"table"}),r.getDataSeries(n.datasource,n,n.datasetId,n.config,function(e){var a=f.parseOption(e);i&&i(a),t(a,e.drill.config,"up")})})}catch(d){console.log("chartService function-this.render row-27",d)}finally{if(u.resolve(f.render(t,s,o,l,e.drill,c)),_.isUndefined(f.type)||"table"!=f.type||($(document).off("click",".self-table-sort").on("click",".self-table-sort",function(e){function t(e){switch(e){case"fa fa-sort":return"asc";case"fa fa-sort-asc":return"desc";case"fa fa-sort-desc":return null}}$.widgets.sort($(this).parents("table").attr("widget"),$.trim($(this).data("column")),t($(this).children().children().attr("class"))),$.widgets.reload([$(this).parents("table").attr("widget")])}),$(document).off("click",".self-table-tbody").on("click",".self-table-tbody",function(e){var t,r;"DIV"===e.target.tagName||"A"===e.target.tagName||"SPAN"===e.target.tagName?(t=$(e.target).parents("tr"),r=$(e.target).parents("td")):"TD"===e.target.tagName&&(t=$(e.target).parents("tr"),r=$(e.target));var n=$(this).data("eventData"),i=t.data("i"),o=r.data("j");n&&n[i]&&a.trigger("$click",{wName:t.parents("table").attr("widget"),param:{this_tr:t,this_td:r,td_index:o,data:{eventInfo:n[i]}},isActive:t.hasClass("highlight_tr"),type:"table"})})),!f.instance||_.isUndefined(f.instance)||_.isUndefined(f.instance.render)||"crossTable"!=f.instance.render.chartType||(document.oncontextmenu=function(){return!1},$(document).off("click","table th,td").on("click","table th,td",function(e){a.trigger("CE:drillDown",{widget:o?o.widget:null,param:{name:$(this).data("name"),drillType:$(this).data("type")?$(this).data("type"):""}})}),$(document).off("mousedown","table th,td").on("mousedown","table th,td",function(e){3==e.which&&a.trigger("CE:drillUp",{widget:o?o.widget:null,param:{name:$(this).data("name"),drillType:$(this).data("type")?$(this).data("type"):""}})})),!f.instance||_.isUndefined(f.instance)||_.isUndefined(f.instance.render)||"crossGreatTable"!=f.instance.render.chartType||$(document).off("click","table th a").on("click","table th a",function(e){a.trigger("CE:"+$(this).data("type"),{widget:o?o.widget:null,param:{index:$(this).data("index"),name:$(this).data("name"),drillType:"key",key:$(this).data("key")?$(this).data("key"):"",isGreat:!0}})}),f.instance&&f.instance.render&&o&&f.instance.render.setWidget(o.widget),f.instance&&f.instance.ecc){window.$$dlut_echart_timeout=!1,document.oncontextmenu=function(){return!1},f.instance.ecc.getZr().on("click",function(e){window.$$dlut_echart_timeout?window.$$dlut_echart_timeout=!1:(e.trigger="blank",a.trigger("CE:click",{widget:o.widget,param:e,type:"chart"}))});var p;f.instance.ecc.on("click",function(e){p=!0,window.$$dlut_echart_timeout=!0,setTimeout(function(){p&&(window.$$dlut_echart_timeout=!0,o&&a.trigger("CE:click",{widget:o.widget,param:e,type:"chart"}))},250)}),f.instance.ecc.on("dblclick",function(e){p=!1,window.$$dlut_echart_timeout=!0,"undefined"==typeof e.region&&a.trigger("CE:drillDown",{widget:o?o.widget:null,param:e,type:"chart"}),setTimeout(function(){p=!0},300)}),f.instance.ecc.on("mousedown",function(e,t){3==e.event.which&&a.trigger("CE:drillUp",{widget:o?o.widget:null,param:e,type:"chart"})})}!f.instance||_.isUndefined(f.instance)||_.isUndefined(f.instance.render)||"treeGrid"!=f.instance.render.chartType||f.instance.render.treeGrid.on("expand",function(e,t){t.name=t.record[t.option.root],a.trigger("CE:drillDown",{widget:o?o.widget:null,param:t,type:"treeGrid",tier:t.tier,filters:t.filters})})}},s,d),u.promise},this.realTimeRender=function(e,t,a,n,i){if(e){var o=Q(t.config);r.getDataSeries(t.datasource,t,t.datasetId,t.config,function(r){t.noData=!1,0===r.originalData.data.length&&(t.noData=!0);var n=o.parseOption(r);a&&a(n),e(n,r.drill?r.drill.config:null,t),i&&i(n,t,r)})}};var Q=function(e){
var t;switch(e.chart_type){case"cityMap":t=H;break;case"zoneMap":t=K;break;case"line":t=i;break;case"line2":t=o;break;case"line3":t=s;break;case"pie":t=n;break;case"kpi":t=u;break;case"table":t=d;break;case"crossTable":t=J;break;case"treeGrid":t=Z;break;case"crossGreatTable":t=Y;break;case"selector":t=X;break;case"funnel":t=l;break;case"sankey":t=c;break;case"circular":t=O;break;case"echart3dMap":t=W;break;case"echart3dMapLine":t=y;break;case"echart3dBar":t=b;break;case"echart3dArea":t=C;break;case"barPolarStack":t=M;break;case"pieProportion":t=k;break;case"radar":t=f;break;case"map":t=p;break;case"scatter":t=g;break;case"scatter2":t=m;break;case"gauge":t=h;break;case"wordCloud":t=v;break;case"treeMap":t=I;break;case"areaMap":t=x;break;case"heatMapCalendar":t=N;break;case"heatMapTable":t=T;break;case"markLineMap":t=S;break;case"liquidFill":t=D;break;case"d3Demo":t=L;break;case"codeFlower":t=E;break;case"flex":t=G;break;case"flex2":t=A;break;case"barLimits":t=F;break;case"lineMap":t=j;break;case"dataLineTable":t=R;break;case"gantt":t=U;break;case"pie2":t=P;break;case"flexChart":t=B;break;case"rose":t=z;break;case"flexD3Chart":t=V;break;case"chord":t=q}return t},ee=function(e){e=angular.copy(e);var t;switch(e.chart_type){case"xxxxxxx":var a=[e.groups[0]],r=[e.keys[0]];e.groups=a,e.keys=r,t=e;break;default:t=e}return t}}]),discovery.service("chartMapService",function(){"ngInject";this.render=function(e,t,a,r,n){if(null==t)return void e.html('<div class="alert alert-danger" role="alert">No Data!</div>');var i;return a?i=a.myheight:null,new CBoardMapRender(e,t,n)["do"](i,r)},this.parseOption=function(e){var t=chartDataProcess(e.chartConfig,e.keys,e.series,e.data,e.seriesConfig);return t}}),discovery.service("updateService",function(){"ngInject";this.updateConfig=function(e){var t=function(e){return _.isString(e)?{col:e,type:"eq",values:[]}:e};switch(e.keys=_.map(e.keys,t),e.groups=_.map(e.groups,t),e.filters||(e.filters=[]),e.events||(e.events=[]),e.chart_type){case"pie":e.groups||(e.groups=[]);break;case"line":e.valueAxis||(e.valueAxis="vertical")}},this.updateBoard=function(e){void 0!==e.layout&&_.each(e.layout.rows,function(e){e.type||(e.type="widget")})}}),discovery.service("chartRoseService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t={},a=e.chartConfig.option.tooltip,r=e.chartConfig.keys;for(var n in r)a[r[n].col]?(t[r[n].col]=a[r[n].col],a[r[n].col].col||(t[r[n].col].col=r[n].col)):t[r[n].col]={col:r[n].col,isShow:!0,formatter:""};for(var i={},o=e.chartConfig.option.tooltipTarget,s={},l=0;l<e.chartConfig.values.length;l++)for(var c=0;c<e.chartConfig.values[l].cols.length;c++)s[e.chartConfig.values[l].cols[c].col]={col:e.chartConfig.values[l].cols[c].col};for(var d in s)i[d]=o[d],o[d]&&o[d].col||(i[d]={col:d,isShow:!o[d]||o[d].isShow,formatter:""});for(var u={},f=e.chartConfig.option.tooltipGroups,p=e.chartConfig.groups,g=0;g<p.length;g++)f[p[g].col]?(u[p[g].col]=f[p[g].col],f[p[g].col].col||(u[p[g].col].col=p[g].col)):u[p[g].col]={col:p[g].col,isShow:!0,formatter:""};for(var m=e.chartConfig,h=e.keys,v=e.series,y=e.data,w=e.seriesConfig,b=new Array,C=_.map(h,function(e){return e.join("-")}),I=m.option,x=[],N=0;y[0]&&N<y[0].length;N++){for(var T=0,D=0;D<y.length;D++)T+=y[D][N]?Number(y[D][N]):0,y[D][N]=y[D][N]?Number(y[D][N]):0;x[N]=T}for(var S=[],D=0;D<m.values.length;D++)for(var M=m.values[D].unit?m.values[D].unit:"",N=0;N<m.values[D].cols.length;N++)S.push(M);for(var k=[],O=e.series.length/S.length,D=0;D<O;D++)k=k.concat(S);for(var D=0;D<y.length;D++){var W=v[D].join("-"),E=angular.copy(w[W]);E.name=W,E.data=y[D],E.barMaxWidth=40,_.isUndefined(m.option.barWidth)||""==m.option.barWidth||(E.barWidth=m.option.barWidth),E.type="bar",E.stack=E.valueAxisIndex.toString(),E.coordinateSystem="polar","horizontal"==m.valueAxis?E.xAxisIndex=E.valueAxisIndex:E.yAxisIndex=E.valueAxisIndex;for(var L=[],M=k[D],G="",$="",N=0;N<E.data.length;N++){"元"==M||"万"==M||"亿"==M?(M=dlut.utils.convertMoney(E.data[N],M),G=M.substr(M.length-1,M.length),$=M.substr(0,M.length-1)):"100%"==M?($=Math.floor(100*E.data[N]),G="%"):"100.00%"==M?($=(100*E.data[N]).toFixed(2),G="%"):"100.0%"==M&&($=(100*E.data[N]).toFixed(1),G="%");var A=CBoardEChartRenderEventInfo(e,D,N),F={eventInfo:A,value:""==$?E.data[N]:$,unit:""==G?M:G};L.push(F)}E.data=L,b.push(E)}var R={};if(!_.isUndefined(m.option.label)){var U={top:"insideTop",bottom:"insideBottom"},j={top:"insideRight",bottom:"insideLeft"};if(_.isUndefined(m.option.label.position)||(R="horizontal"==m.valueAxis?{position:j[m.option.label.position]}:{position:U[m.option.label.position]}),!_.isUndefined(m.option.label.offset)){var P=[0,0];_.isUndefined(m.option.label.offset.top)||(P[1]=-m.option.label.offset.top),_.isUndefined(m.option.label.offset.bottom)||(P[1]=Number(m.option.label.offset.bottom)),_.isUndefined(m.option.label.offset.left)||(P[0]=-m.option.label.offset.left),_.isUndefined(m.option.label.offset.right)||(P[0]=Number(m.option.label.offset.right)),R.offset=P}}var B=angular.copy(m.values);_.each(B,function(e,t){e.axisLabel={formatter:function(e){return numbro(e).format("0a.[0000]")}},e.nameGap=0,"percentbar"==e.series_type?(e.min=0,e.max=100):(e.min=e.min?e.min:null,e.max=e.max?e.max:null),t>0&&(e.splitLine=!1),e.scale=!0});for(var D=0;D<B.length;D++)m.values[D].series_label&&("true"==m.values[D].series_logarithm?B[D]={type:"log"}:"false"==m.values[D].series_logarithm&&(B[D]={type:"value"}));var z=[],V=[],q=[];if(m.option.itemStyle&&m.option.itemStyle.color&&(z=m.option.itemStyle.color.split(",")),m.option.itemStyle&&m.option.itemStyle.dataName&&(V=m.option.itemStyle.dataName.split(",")),m.option.itemStyle&&m.option.itemStyle.seriesName&&(q=m.option.itemStyle.seriesName.split(",")),m.option.itemStyle&&m.option.itemStyle&&m.option.itemStyle.color&&""!=m.option.itemStyle.color)for(var J=0;J<z.length;J++)if(m.option.itemStyle.dataName&&(_.isUndefined(m.option.itemStyle.seriesName)||""==m.option.itemStyle.seriesName)){for(var D=0;D<b.length;D++)if(V[J]==b[D].name)for(var N=0;N<b[D].data.length;N++)b[D].data[N]=_.extend(b[D].data[N],{itemStyle:{normal:{color:z[J]}}})}else if(m.option.itemStyle.dataName&&m.option.itemStyle.seriesName)for(var D=0;D<b.length;D++)if(V[J]==b[D].name)for(var N=0;N<b[D].data.length;N++)for(var Y=0;Y<b[D].data[N].eventInfo.length;Y++)q[J]==b[D].data[N].eventInfo[Y].value&&(b[D].data[N]=_.extend(b[D].data[N],{itemStyle:{normal:{color:z[J]}}}));var X={angleAxis:{type:"category",data:C,z:10},radiusAxis:{},polar:{},grid:angular.copy(echartsBasicOption.grid),legend:{data:_.map(v,function(e){return e.join("-")})},tooltip:{formatter:function(e){var t=e[0].name,a="";""!=e[0].name&&(a+=t+"</br>");for(var r=0;r<m.values.length;r++){if("percentbar"==m.values[r].series_type)for(var n=0;n<e.length;n++)a+=e[n].seriesName+" : "+e[n].data.value[2]+e[n].data.unit+"("+e[n].data.value[1]+"%)</br>";else for(var r=0;r<e.length;r++)a+='<span style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:'+e[r].color+'"></span>',a+=e[r].seriesName+" : "+e[r].value+(e[r].data.unit?e[r].data.unit:""),a+="<br>";return a}}},series:b};return updateEchartOptions(I,X),X}}]),discovery.service("chartD3ChordService",["uuid4",function(e){"ngInject";this.render=function(t,a,r,n,i){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var o;r?o=r.myheight:null;var s=e.generate();return t.addClass("d3_"+s),new CBoardD3Render(t,a,this,s).chart(null,n)},this.parseOption=function(e){var t=e.keys,a=e.series,r=e.data,n=[],i=_.map(t,function(e){var t=e.join("-");return _.find(n,function(e){return e.name==t})||n.push({name:t}),t});_.each(a,function(e){e.length>1&&e.splice(-1,1);var t=e.join("-");_.find(n,function(e){return e.name==t})||n.push({name:t})});for(var o=[],s=0;s<r.length;s++)for(var l=0;l<r[s].length;l++)if(!_.isUndefined(r[s][l])){var c=CBoardEChartRenderEventInfo(e,s,l);o.push({eventInfo:c,source:i[l],target:a[s].join("-"),value:r[s][l]})}var d={};for(var u in n)d[n[u].name]=u;matrix=[];for(var f in n){var p=createArrayWith(n.length,0);for(var g in o)if(n[f].name===o[g].source){var m=d[o[g].target];p[m]=parseInt(o[g].value)}matrix.push(p)}var h={matrix:matrix,node:n};return h},this.initCanvas=function(e,t,a){html="<div>hello world</div>",html='<div id="wrapper">\n\t\t<div id="info" style="opacity: 1;">\n\t\t\t\t<div><span id="name"></span><span id="segment">&nbsp;</span></div>\n\t\t\t\t<div><span id="emissions"></span><span id="percent"></span></div>\n\t\t<div id="tweet-box">\n\t\t\t<i id="close" class="icon-remove"></i>\n\t\t\t<div id="tweet-text"></div>\n\t\t</div>\t\t\n',e.html(html);var r=e.height(),n=e.width(),i=d3.select(".d3_"+a.uuid).append("svg:svg").attr("width",n).attr("height",r);return i},this.draw=function(e,t,a){a.option=t;var r=this.initCanvas(e,t,a),n=t.matrix,i=e.width(),o=e.height(),s=.5*Math.min(i,o)-60;innerRadius=s-10;var l=d3.layout.chord().padding(.05).sortSubgroups(d3.descending).matrix(n),c=d3.scale.ordinal().domain(d3.range(4)).range(["#000000","#FFDD89","#957244","#F26223"]),d=r.append("svg:svg").attr("width",i).attr("height",o).append("svg:g").attr("transform","translate("+i/2+","+o/2+")"),u=d.append("svg:g").selectAll("g").data(l.groups).enter().append("svg:g");u.append("path").data(l.groups).style("fill",function(e){return c(e.index)}).style("stroke",function(e){return c(e.index)}).attr("d",d3.svg.arc().innerRadius(innerRadius).outerRadius(s)).on("mouseover",fade(.1,d)).on("mouseout",fade(1,d)),u.append("text").each(function(e,a){e.angle=(e.startAngle+e.endAngle)/2,e.name=t.node[e.index].name}).attr("dy",".35em").attr("transform",function(e){return"rotate("+180*e.angle/Math.PI+")translate(0,"+-1*(s+50)+")"+(e.angle>3*Math.PI/4&&e.angle<5*Math.PI/4?"rotate(180)":"")}).text(function(e){return e.name});var f=d.append("svg:g").selectAll("g").data(l.groups).enter().append("svg:g").selectAll("g").data(groupTicks).enter().append("svg:g").attr("transform",function(e){return"rotate("+(180*e.angle/Math.PI-90)+")translate("+s+",0)"});f.append("svg:line").attr("x1",1).attr("y1",0).attr("x2",5).attr("y2",0).style("stroke","#000"),f.append("svg:text").attr("x",8).attr("dy",".35em").attr("text-anchor",function(e){return e.angle>Math.PI?"end":null}).attr("transform",function(e){return e.angle>Math.PI?"rotate(180)translate(-16)":null}).text(function(e){return e.label}),d.append("svg:g").attr("class","chord").selectAll("path").data(l.chords).enter().append("svg:path").style("fill",function(e){return c(e.target.index)}).attr("d",d3.svg.chord().radius(innerRadius)).style("opacity",1).on("mouseover",function(e){return tooltip.text(t.node[e.source.index].name+"--"+t.node[e.target.index].name+":"+e.source.value),tooltip.style("visibility","visible")}).on("mousemove",function(e){return tooltip.text(t.node[e.source.index].name+"--"+t.node[e.target.index].name+":"+e.source.value),tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return tooltip.style("visibility","hidden")})},this.redraw=function(e,t){this.draw(e,t.option,t)}}]);var fade=function(e,t,a){return function(a,r){t.selectAll("g.chord path").filter(function(e){return e.source.index!=r&&e.target.index!=r}).transition().style("opacity",e)}},groupTicks=function(e){var t=(e.endAngle-e.startAngle)/e.value,a=20,r=5;return e.value>500?a=50:e.value>1e3&&(a=100),d3.range(0,e.value,a).map(function(a,n){return{angle:a*t+e.startAngle,label:n%r?null:a}})},createArrayWith=function(e,t){return Array.apply(null,new Array(e)).map(function(){return t})};discovery.service("chartTableService",["EventService",function(e){"ngInject";this.render=function(t,a,r,n,i){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var o;return r?o=r.myheight:null,this.type="table",new CBoardTableRender(t,a,i)["do"](o,n,e)},this.parseOption=function(e){var t=chartDataProcess(e.chartConfig,e.keys,e.series,e.data,e.seriesConfig,e.originalData,e.wName);return t}}]),discovery.service("chartScatterService",["dataService","BoardParamService","EventService",function(dataService,BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys;for(var _i57 in keys)Levi[keys[_i57].col]?(tooltip[keys[_i57].col]=Levi[keys[_i57].col],Levi[keys[_i57].col].col||(tooltip[keys[_i57].col].col=keys[_i57].col)):tooltip[keys[_i57].col]={col:keys[_i57].col,isShow:!0,formatter:keys[_i57]&&keys[_i57].formatter?keys[_i57].formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget,targetValue={},_j19=0;_j19<data.chartConfig.values.length;_j19++)for(var k=0;k<data.chartConfig.values[_j19].cols.length;k++)targetValue[data.chartConfig.values[_j19].cols[k].alias]={col:data.chartConfig.values[_j19].cols[k].alias};for(var _i58 in targetValue)tooltipTarget[_i58]=Target[_i58],Target[_i58]&&Target[_i58].col||(tooltipTarget[_i58]={col:_i58,isShow:!Target[_i58]||Target[_i58].isShow,formatter:Target[_i58]&&Target[_i58].formatter?Target[_i58].formatter:""});for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i59=0;_i59<targetGroups.length;_i59++)Groups[targetGroups[_i59].col]?(tooltipGroups[targetGroups[_i59].col]=Groups[targetGroups[_i59].col],Groups[targetGroups[_i59].col].col||(tooltipGroups[targetGroups[_i59].col].col=targetGroups[_i59].col)):tooltipGroups[targetGroups[_i59].col]={col:targetGroups[_i59].col,isShow:!0,formatter:targetGroups[_i59]&&targetGroups[_i59].formatter?targetGroups[_i59].formatter:""};for(var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,tunningOpt=chartConfig.option,data_copy=data,string_keys=_.map(casted_keys,function(e){return e.join("-")}),series=[],valueName=[],i=0;i<casted_values.length;i++){var joined_values=casted_values[i].join("-"),valueAxisIndex=newValuesConfig[joined_values].valueAxisIndex,name=casted_values[i].slice(0,-1).join("-"),s=_.find(series,function(e){return e.name==name});s||(s={name:name},series.push(s)),0==valueAxisIndex&&(s.yIdx=i),1==valueAxisIndex&&(s.sizeIdx=i),2==valueAxisIndex&&(s.colorIdx=i),valueName[valueAxisIndex]=casted_values[i][casted_values[i].length-1]}var data=_.unzip(aggregate_data);_.each(series,function(e,t){e.data=_.map(data,function(a,r){var n=CBoardEChartRenderEventInfo(data_copy,t,r);return[string_keys[r],a[e.yIdx],a[e.sizeIdx]?a[e.sizeIdx]:1,a[e.colorIdx]?a[e.colorIdx]:1,n]}),e.sizeMax=_.max(e.data,function(e){return Number(e[2])})[2],e.sizeMin=_.min(e.data,function(e){return Number(e[2])})[2],e.colorMax=_.max(e.data,function(e){return Number(e[3])})[3],e.colorMin=_.min(e.data,function(e){return Number(e[3])})[3]});var sizeMax=_.max(series,function(e){return Number(e.sizeMax)}).sizeMax,sizeMin=_.min(series,function(e){return Number(e.sizeMin)}).sizeMin,colorMax=_.max(series,function(e){return Number(e.colorMax)}).colorMax,colorMin=_.max(series,function(e){return Number(e.colorMin)}).colorMin;if(tunningOpt){var labelInterval,labelRotate;tunningOpt.ctgLabelInterval?labelInterval=tunningOpt.ctgLabelInterval:"auto",tunningOpt.ctgLabelRotate?labelRotate=tunningOpt.ctgLabelRotate:0}var echartOption={legend:{data:_.map(series,function(e){return e.name})},tooltip:{trigger:"item",formatter:function formatter(params){var param=BoardParamService.getAll(),value="",finalResult="",_loop18=function _loop18(_i60){if(void 0===_typeof(tooltip[_i60])||tooltip[_i60].isShow!==!1){var index=_.findIndex(params.data[params.data.length-1],function(e){return e.col===_i60});if(index<0)return{v:void 0};value=params.data[params.data.length-1][index].value;var _result3=value;tooltip[_i60].formatter&&(_result3=eval(tooltip[_i60].formatter)),finalResult=finalResult+tooltip[_i60].col+": "+_result3+"<br/>"}};for(var _i60 in tooltip){var _ret18=_loop18(_i60);if("object"===("undefined"==typeof _ret18?"undefined":_typeof(_ret18)))return _ret18.v}for(var _i61 in tooltipGroups)if(void 0===_typeof(tooltipGroups[_i61])||tooltipGroups[_i61].isShow!==!1){var obj=_.where(params.value[params.value.length-1],{col:_i61});if(0===obj.length)return;value=obj[0].value;var result=value;tooltipGroups[_i61].formatter&&(result=eval(tooltipGroups[_i61].formatter)),finalResult=finalResult+tooltipGroups[_i61].col+": "+result+"<br/>"}for(var _i62 in tooltipTarget)if(void 0===_typeof(tooltipTarget[_i62])||tooltipTarget[_i62].isShow!==!1){for(var arr=[],_j20=0;_j20<data.length;_j20++)arr.push(_.difference(data[_j20],[void 0,"undefined"]));var targetArray=_.keys(tooltipTarget);value=arr[params.dataIndex][_.indexOf(targetArray,_i62)];var _result2=value;tooltipTarget[_i62].formatter&&(_result2=eval(tooltipTarget[_i62].formatter)),finalResult=finalResult+tooltipTarget[_i62].col+": "+_result2+"<br/>"}return finalResult}},xAxis:{data:string_keys,splitLine:{lineStyle:{type:"dashed"}},axisLabel:{interval:labelInterval,rotate:labelRotate}},yAxis:{axisLabel:{formatter:function(e){return numbro(e).format("0a.[0000]")}},splitLine:{lineStyle:{type:"dashed"}},scale:!0},visualMap:[{dimension:2,show:!1,min:.8*sizeMin,max:1.5*sizeMax,calculable:!0,precision:.1,textStyle:{color:"white"},inRange:{symbolSize:[5,70]}},{dimension:3,show:!1,min:colorMin,max:colorMax,inRange:{opacity:[.2,1]}}],targetData:chartConfig.values,series:_.map(series,function(e){return{name:e.name,data:e.data,type:"scatter",label:e.label}})};return updateEchartOptions(chartConfig.option,echartOption),echartOption}}]),discovery.service("chartScatter2Service",["dataService","BoardParamService","EventService",function(dataService,BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var scatterData=data,markLineCode=data.chartConfig.markLineCode,tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys;for(var _i63 in keys)Levi[keys[_i63].col]?(tooltip[keys[_i63].col]=Levi[keys[_i63].col],Levi[keys[_i63].col].col||(tooltip[keys[_i63].col].col=keys[_i63].col)):tooltip[keys[_i63].col]={col:keys[_i63].col,isShow:!0,formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget,targetValue={},_j21=0;_j21<data.chartConfig.values.length;_j21++)for(var k=0;k<data.chartConfig.values[_j21].cols.length;k++)targetValue[data.chartConfig.values[_j21].cols[k].alias]={col:data.chartConfig.values[_j21].cols[k].alias};for(var _i64 in targetValue)tooltipTarget[_i64]=Target[_i64],Target[_i64]&&Target[_i64].col||(tooltipTarget[_i64]={col:_i64,isShow:!Target[_i64]||Target[_i64].isShow,formatter:Target[_i64]&&Target[_i64].formatter?Target[_i64].formatter:""});for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i65=0;_i65<targetGroups.length;_i65++)Groups[targetGroups[_i65].col]?(tooltipGroups[targetGroups[_i65].col]=Groups[targetGroups[_i65].col],Groups[targetGroups[_i65].col].col||(tooltipGroups[targetGroups[_i65].col].col=targetGroups[_i65].col)):tooltipGroups[targetGroups[_i65].col]={col:targetGroups[_i65].col,isShow:!0,formatter:targetGroups[_i65]&&targetGroups[_i65].formatter?targetGroups[_i65].formatter:""};var chartConfig=data.chartConfig,casted_keys=data.keys,casted_values=data.series,aggregate_data=data.data,newValuesConfig=data.seriesConfig,tunningOpt=chartConfig.option,data_copy=data,string_keys=_.map(casted_keys,function(e){return e.join("-")}),cityMaxRadius=20;data.chartConfig.option.cityMaxRadius&&(cityMaxRadius=data.chartConfig.option.cityMaxRadius);var cityMinRadus=10;data.chartConfig.option.cityMinRadus&&(cityMinRadus=data.chartConfig.option.cityMinRadus);for(var series=[],valueName=[],i=0;i<casted_values.length;i++){var joined_values=casted_values[i].join("-"),valueAxisIndex=newValuesConfig[joined_values].valueAxisIndex,name=casted_values[i].slice(0,-1).join("-"),s=_.find(series,function(e){return e.name==name});s||(s={name:name},series.push(s)),0==valueAxisIndex&&(s.xIdx=i),1==valueAxisIndex&&(s.yIdx=i),2==valueAxisIndex&&(s.sizeIdx=valueAxisIndex),3==valueAxisIndex&&(s.colorIdx=i),s.type="scatter",valueName[valueAxisIndex]=casted_values[i][casted_values[i].length-1]}var data=_.unzip(aggregate_data);if(_.each(series,function(e,t){if(e.data=_.map(data,function(e,t){var a=CBoardEChartRenderEventInfo(data_copy,n,t),r=[];for(var n in e)r.push(e[n]);return r.push(string_keys),r.push(a),{value:r,eventInfo:a}}),e.data&&e.data.length>0&&e.data[0].value&&!$.isNumeric(e.data[0].value[2]))for(var a=0;a<e.data.length;a++)e.data[a].value.splice(2,0,50);var r=_.max(e.data,function(e){return Number(e.value[2])});r.length<3&&ModalUtils.alert("请拖入大小的指标","modal-warning","sm");var n=_.max(e.data,function(e){return"string"==typeof e.value[2]?parseFloat(e.value[2]):e.value[2]});e.symbolSize=function(e,t){var a=0;return _.isUndefined(n.value)||_.isNaN(n.value[2])||_.isUndefined(n.value[2])||n.value[2]===1/0||(a=parseFloat(e[2])/parseFloat(n.value[2])*cityMaxRadius),a<cityMinRadus||_.isNaN(a)?cityMinRadus:a},e.label={show:!1,color:"black",formatter:function(e){return e.data.eventInfo&&e.data.eventInfo.length>0?e.data.eventInfo[0].value:void 0}}}),tunningOpt){var labelInterval,labelRotate;tunningOpt.ctgLabelInterval?labelInterval=tunningOpt.ctgLabelInterval:"auto",tunningOpt.ctgLabelRotate?labelRotate=tunningOpt.ctgLabelRotate:0}var params=angular.copy(window.$$dlut_param);if(markLineCode)for(var _i66 in series)try{series[_i66]=new Function("serie,params,seriesIndex","return ("+markLineCode+")(serie,params,seriesIndex)")(series[_i66],params,_i66)}catch(e){console.error("series自定义计算错误",markLineCode,series[_i66],params,_i66,e)}var echartOption={legend:{data:_.map(series,function(e){return e.name})},tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",value="",param=BoardParamService.getAll(),_loop19=function _loop19(_i67){if(void 0===_typeof(tooltip[_i67])||tooltip[_i67].isShow!==!1){var index=_.findIndex(params.data.value[params.data.value.length-1],function(e){return e.col===_i67});if(index<0)return{v:void 0};value=params.data.value[params.data.value.length-1][index].value;var _result5=value;tooltip[_i67].formatter&&(_result5=eval(tooltip[_i67].formatter)),finalResult=finalResult+tooltip[_i67].col+": "+_result5+"<br/>"}};for(var _i67 in tooltip){var _ret19=_loop19(_i67);if("object"===("undefined"==typeof _ret19?"undefined":_typeof(_ret19)))return _ret19.v}for(var _i68 in tooltipGroups)if(void 0===_typeof(tooltipGroups[_i68])||tooltipGroups[_i68].isShow!==!1){var obj=_.where(params.value[params.value.length-1],{col:_i68});if(0===obj.length)return;value=params.seriesName;var result=value;tooltipGroups[_i68].formatter&&(result=eval(tooltipGroups[_i68].formatter)),finalResult=finalResult+tooltipGroups[_i68].col+": "+result+"<br/>"}for(var _i69 in tooltipTarget)if(void 0===_typeof(tooltipTarget[_i69])||tooltipTarget[_i69].isShow!==!1){var targetArray=_.keys(tooltipTarget);value=params.data.value[_.indexOf(targetArray,_i69)];var _result4=value;tooltipTarget[_i69].formatter&&(_result4=eval(tooltipTarget[_i69].formatter)),finalResult=finalResult+tooltipTarget[_i69].col+": "+_result4+"<br/>"}return finalResult}},xAxis:{splitLine:{lineStyle:{type:"dashed"}},axisLabel:{interval:labelInterval,rotate:labelRotate}},yAxis:{axisLabel:{formatter:function(e){return numbro(e).format("0a.[0000]")}},splitLine:{lineStyle:{type:"dashed"}},scale:!0},targetData:chartConfig.values,series:series};if(chartConfig.optionCode){var optionCode=chartConfig.optionCode;try{var param=angular.copy(window.$$dlut_param);echartOption=new Function("option,param,config","return ("+optionCode+")(option,param,config)")(echartOption,param,chartConfig)}catch(e){console.error("option自定义计算错误",echartOption,e)}}return updateEchartOptions(chartConfig.option,echartOption),echartOption.wName=scatterData.wName,echartOption}}]),discovery.service("chartCrossTableService",["$filter","EventService","uuid4",function(e,t,a){"ngInject";e("translate");this.render=function(e,r,n,i){var o=new CBoardDataTableRender(e,r);this.instance={render:o};var s=a.generate(),l="example_"+s,c=o.html(l);return e.html(c),o.initialize(r,n,l,t)},this.parseOption=function(e){function t(e,t){if(_.isUndefined(e[0])||!e.length)return!1;if(_.isUndefined(e[0].drillDown))return _.find(t,function(t){return e[0].col===t.name});for(var a=0;a<e[0].drillDown.length;a++){var r=_.find(t,function(t){return e[0].drillDown[a].col===t.name});if(r)return r}}var a=e.chartConfig.values[0].cols,r=e.chartConfig.keys,n=e.chartConfig.groups,i=e.originalData.columnList,o=e.originalData.data,s=t(r,i),l=t(n,i),c=[],d=[],u=[];_.each(o,function(e){var t={};_.each(i,function(a){t[a.name]=e[a.index]}),u.push(t)});for(var f=[],p=0;p<o.length;p++)f.push(o[p][s.index]);for(var g=_.uniq(f),m=l.name,h=s.name,v=[],p=0;p<o.length;p++){var y={};y[m]=o[p][l.index],y.values=a;var w=_.find(v,function(e){return e[m]==o[p][l.index]});_.isUndefined(w)&&v.push(y)}return _.each(g,function(e){var t=[e];_.each(v,function(a){var r=_.find(u,function(t){return t[m]==a[m]&&e==t[h]});_.each(a.values,function(e){_.isUndefined(r)?t.push("-"):(t.push(r[e.col]),d.push({data:e.col+"-"+r[m]}))})}),c.push(t)}),e.dataList=c,e}}]),discovery.service("chartCrossTableGreatService",["$filter","EventService","uuid4",function(e,t,a){"ngInject";e("translate");this.render=function(e,r,n,i){var o=new CBoardCrossGreatRender(e,r);this.instance={render:o};var s=a.generate(),l="cross_great_"+s,c=o.html(l,r);return e.html(c),o.initialize(r,n,l,t)},this.parseOption=function(e){var t=e.chartConfig.drillTier,a=e.originalData.columnList,r=e.originalData.data,n=[];return t.isGreat=!0,_.each(r,function(e){var t={};_.each(a,function(a){t[a.name]=e[a.index]}),n.push(t)}),e.tableData=n,e}}]),discovery.service("chartSelectorService",["dataService","$compile","$filter","EventService",function(e,t,a,r){"ngInject";a("translate");this.render=function(e,a,n,i){var o=new CBoardSelectorRender(e,a),s=o.html(a);return n?e.append(t(s)(n)):e.html(s),o.initialize(a,n,r)},this.parseOption=function(e){var t=e.chartConfig.customCode,a=e.chartConfig.option.advancedOption,r=e.originalData.columnList,n=e.originalData.data,i={},o=[];if(_.each(n,function(e,t){o.indexOf(e[0])==-1&&o.push(e[0]),_.each(e,function(e,t){!i[e]&&t<=r.length-1&&(i[e]={},i[e].index=t,i[e].key=r[t].name,i[e].children=[],i[e].isMultiple=!1)});for(var a=0;a<e.length;a++)i[e[a]]&&i[e[a]].children.indexOf(e[a+1])==-1&&i[e[a]].children.push(e[a+1])}),!a){o=o.sort();var s=[],l=[];if(_.each(o,function(e,t){(_.isUndefined(e)||_.isNull(e)||"null"===e||""===e||"缺省"===e||"-"===e||"未定义"===e||"Null"===e)&&(l.push(t),s.push(e))}),l.length){var c=0;_.each(l,function(e){o.splice(e-c,1),c++}),o=o.concat(s)}}if(e.groupSelects=i,e.firstSelects=o,t){var d=[];try{d=new Function("firstSelects","return ("+t+")(firstSelects)")(e.firstSelects),e.firstSelects=d}catch(u){d="ERROR",console.error("crossTable自定义计算错误",t,e.firstSelects,u)}finally{e.firstSelects=d}}return e}}]),discovery.service("chartGaugeService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var s;return r?s=r.myheight-20:null,this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(s,n,e)},this.parseOption=function(e){var t={tooltip:{formatter:"{a} <br/>{b} : {c}"},toolbox:{show:!1,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!0},restore:{show:!1},saveAsImage:{show:!0}}},series:[{type:"gauge",min:0,max:100,splitNumber:10,axisLine:{lineStyle:{color:[[.2,"#228b22"],[.8,"#48b"],[1,"#ff4500"]],width:8}},axisTick:{splitNumber:10,length:12,lineStyle:{color:"auto"}},axisLabel:{textStyle:{color:"auto"}},splitLine:{show:!0,length:20,lineStyle:{color:"auto"}},pointer:{width:5},title:{show:!0,offsetCenter:[0,"-40%"],textStyle:{fontWeight:"bolder"}},detail:{formatter:"{value}",textStyle:{color:"auto",fontWeight:"bolder",fontSize:20}},data:[]}]},a=e.chartConfig,r=e.data,n=a.values[0].name?a.values[0].name:"",i=a.values[0].minValue?a.values[0].minValue:0,o=a.values[0].maxValue?a.values[0].maxValue:100;(isNaN(i)||isNaN(o)||parseFloat(i)>=parseFloat(o))&&(i=0,o=100),t.series[0].min=i,t.series[0].max=o;var s=[];for(var l in a.styles){var c=a.styles[l].proportion,d=a.styles[l].color;void 0!=c&&""!=c&&s.push([c,d])}s.length>0&&(t.series[0].axisLine.lineStyle.color=s);var u=r.length>0?r[0][0]:"N/A";a.values[0].format&&(u=numbro(u).format(a.values[0].format));var f=u.lastIndexOf("%");return f!=-1&&(u=u.substring(0,f),t.tooltip.formatter="{a} <br/>{b} : {c}%",t.series[0].detail.formatter="{value}%"),t.series[0].data=[{name:n,value:u}],t}}]),discovery.service("chartWordCloudService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var s;return r?s=r.myheight-20:null,this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(s,n,e)},this.parseOption=function(e){var t=e.keys,a=e.data,r=(e.chartConfig,e.keys,[]);for(var n in t){var i=CBoardEChartRenderEventInfo(e,void 0,n);r.push({eventInfo:i,name:t[n].join("-"),value:a[0][n]})}var o={tooltip:{formatter:"{b} : {c}"},toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!0},restore:{show:!1},saveAsImage:{show:!0}}},series:[{type:"wordCloud",gridSize:5,sizeRange:[12,50],rotationRange:[-90,90],rotationStep:45,shape:"circle",textStyle:{normal:{color:function(){return"rgb("+[Math.round(255*Math.random()),Math.round(255*Math.random()),Math.round(255*Math.random())].join(",")+")"}},emphasis:{shadowBlur:10,shadowColor:"#333"}},data:r}]};return o}}]),discovery.service("chartTreeMapService",["EventService",function(e){"ngInject";function t(e,r,n,i,o,s){var l=a(e,r,n,i,o),c=[];if(e==r)for(var d in l){var u={name:l[d].arr[e-1],value:l[d].val,children:t(e-1,r,l[d].key,i,o)};"random"==s&&(u.itemStyle={normal:{}}),c.push(u)}else if(e>1)for(var d in l)c.push({name:l[d].arr[e-1],value:l[d].val,children:t(e-1,r,l[d].key,i,o)});else if(1==e)for(var d in l)c.push({name:l[d].arr[e-1],value:l[d].val});return c}function a(e,t,a,r,n){var i={};for(var o in r){var s=r[o][e-1];if(t>e){for(var l="",c=t;c>e;c--)l=c==t?r[o][c-1]:l+"-"+r[o][c-1];if(a!=l)continue;s=a+"-"+s}var d=isNaN(n[0][o])?0:parseFloat(n[0][o]);void 0==i[s]?i[s]={key:s,val:d,arr:r[o]}:i[s]={key:s,val:i[s].val+d,arr:r[o]}}return i}this.instance=null,this.render=function(t,a,r,n,i,o){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var s;return r?s=r.myheight-20:null,this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(s,n,e)},this.parseOption=function(e){var a={tooltip:{trigger:"item",formatter:function(e){return e.name+(e.value?":"+e.value:"")}},series:[{type:"treemap",visibleMin:1,label:{normal:{show:!0,position:"inside",textStyle:{fontSize:"18",fontWeight:"bold"},formatter:function(e){return e.name}}}}]},r=e.chartConfig,n=r.values[0].name?r.values[0].name:"Main";a.series[0].name=n;var i=r.values[0].leafDepth?r.values[0].leafDepth:1;a.series[0].leafDepth=i;var o=r.values[0].style?r.values[0].style:"random";"random"!=o&&"multi"!=o&&(a.color=[o]);var s=e.chartConfig.keys.length,l=e.keys,c=e.data;for(var d in l)l[d].reverse();var u=t(s,s,"",l,c,o);"random"!=o&&"multi"!=o?a.series[0].data=[{value:1e3,children:u}]:a.series[0].data=u;for(var f=[],d=s;d>0;d--)f.push({colorSaturation:[.2,.6],itemStyle:{normal:{borderColorSaturation:.7,gapWidth:d
}}});return a.series[0].levels=f,a}}]),discovery.service("chartAreaMapService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i="china";t.city&&t.city.code?i=t.city.code:t.province&&t.province.code&&(i=t.province.code);var o;o="china"==i?"plugins/FineMap/mapdata/china.json":i.length>2?"plugins/FineMap/mapdata/geometryCouties/"+i+".json":"plugins/FineMap/mapdata/geometryProvince/"+i+".json";for(var s=null,l=_.map(r,function(e){return e.join("-")}),c=[],d=0;d<l.length;d++){for(var e=[],u=0;u<n[d].length;u++){for(var f=[],p=0;p<t.keys.length;p++)f.push({col:t.keys[p].col,alias:t.keys[p].alias,value:a[u][p]});var g={eventInfo:f,name:a[u][t.keys.length-1],value:n[d][u]?n[d][u]:0};e.push(g)}var g={name:l[d],type:"map",map:i,roam:!0,tooltip:{trigger:"item"},label:{normal:{show:!1},emphasis:{show:!0}},itemStyle:{normal:{areaColor:"#EFF0F0",borderColor:"#B5B5B5",borderWidth:1}},data:e};c.push(g)}for(var m=[],d=0;d<r.length;d++){for(var h=0,u=0;u<n.length;u++)h+=parseFloat(isNaN(n[u][d])?0:n[u][d]);m.push(h)}m.sort(function(e,t){return e-t});var v=m[m.length-1];return $.ajax({type:"get",url:o,async:!1,success:function(e){echarts.registerMap(i,e),s={legend:{orient:"vertical",left:"left",data:l},visualMap:{min:0,max:v,left:"right",top:"bottom",text:["High","Low"],inRange:{color:["#e0ffff","#006edd"]},calculable:!0},series:c}}}),s}}]),discovery.service("chartHeatMapCalendarService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var s;return r?s=r.myheight-20:null,this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(s,n,e)},this.parseOption=function(e){var t=settings.preferredLanguage,a=e.chartConfig,r=a.values[0].dateFormat?a.values[0].dateFormat:"yyyy-MM-dd",n=a.values[0].style?a.values[0].style:"blue",i=e.keys.map(function(e){var t=e[0];return"yyyyMMdd"==r?t.substr(0,4)+"-"+t.substr(4,2)+"-"+t.substr(6,2):"yyyy/MM/dd"==r?t.replace(/\//g,"-"):t}),o={};i.map(function(e){var t=+echarts.number.parseDate(e);if(t){var a=echarts.format.formatTime("yyyy",t);o[a]=1}});var s=[];for(var l in o)s.push(l);s.sort(function(e,t){return t-e});var c=0,d=s.map(function(e){return{top:50+140*c++,cellSize:["auto",15],range:e,itemStyle:{normal:{borderWidth:.5}},monthLabel:{nameMap:t},dayLabel:{firstDay:1,nameMap:t},yearLabel:{show:!0}}}),u=0,f=0,p={},g=[];for(var m in e.keys){var h=+echarts.number.parseDate(i[m]);if(h){var l=echarts.format.formatTime("yyyy",h),v=echarts.format.formatTime("yyyy-MM-dd",h);g=p[l]?p[l]:[];var y=e.data[0][m];u=y<u?y:u,f=y>f?y:f,g.push([v,y]),p[l]=g}}c=0;var _=s.map(function(e){return{type:"heatmap",coordinateSystem:"calendar",calendarIndex:c++,data:p[e]}}),w={tooltip:{position:"top",trigger:"item",axisPointer:{show:!1,type:"shadow"},formatter:function(e){return cboardTranslate("COMMON.DATE")+": "+e.value[0]+"<br>"+cboardTranslate("COMMON.VALUE")+": "+e.value[1]}},toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!0},restore:{show:!1},saveAsImage:{show:!0}}},visualMap:{min:u,max:f,calculable:!0,orient:"horizontal",left:"left",bottom:"90%",inRange:{color:["#eee",n]}},calendar:d,series:_};return w}}]),discovery.service("chartHeatMapTableService",["EventService",function(EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){if(null==t)return void e.html('<div class="alert alert-danger" role="alert">No Data!</div>');var o;return a?o=a.myheight-20:null,this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(o,r,EventService)},this.parseOption=function(data){var chartConfig=data.chartConfig,aggregate_data=data.data,tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys;for(var _i70 in keys)Levi[keys[_i70].col]?(tooltip[keys[_i70].col]=Levi[keys[_i70].col],Levi[keys[_i70].col].col||(tooltip[keys[_i70].col].col=keys[_i70].col)):tooltip[keys[_i70].col]={col:keys[_i70].col,isShow:!0,formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget?data.chartConfig.option.tooltipTarget:{},targetValue={},_j22=0;_j22<data.chartConfig.values.length;_j22++)for(var k=0;k<data.chartConfig.values[_j22].cols.length;k++)targetValue[data.chartConfig.values[_j22].cols[k].alias]={col:data.chartConfig.values[_j22].cols[k].alias};if(!_.isUndefined(Target))for(var _i71 in targetValue)tooltipTarget[_i71]=Target[_i71],Target[_i71]?tooltipTarget[_i71]={col:Target[_i71].col?Target[_i71].col:_i71,isShow:!Target[_i71]||Target[_i71].isShow,formatter:Target[_i71].formatter?Target[_i71].formatter:""}:tooltipTarget[_i71]={col:_i71,isShow:!Target[_i71]||Target[_i71].isShow,formatter:""};for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i72=0;_i72<targetGroups.length;_i72++)Groups[targetGroups[_i72].col]?(tooltipGroups[targetGroups[_i72].col]=Groups[targetGroups[_i72].col],Groups[targetGroups[_i72].col].col||(tooltipGroups[targetGroups[_i72].col].col=targetGroups[_i72].col)):tooltipGroups[targetGroups[_i72].col]={col:targetGroups[_i72].col,isShow:!0,formatter:""};var grid=data.chartConfig.option,preferredLanguage=settings.preferredLanguage,config=data.chartConfig,xAxisName="";for(var i in config.keys)xAxisName+=0==i?config.keys[i].col:"-"+config.keys[i].col;var yAxisName="";for(var i in config.groups)yAxisName+=0==i?config.groups[i].col:"-"+config.groups[i].col;var xAxisData=data.keys.map(function(e){return e.join("-")}),yAxisData=data.series.map(function(e){var t=[];for(var a in e)a!=e.length-1&&t.push(e[a]);return t.join("-")}),min=0,max=0,datas=[];for(var i in data.data)for(var j in data.data[i]){var value=isNaN(data.data[i][j])?0:parseFloat(data.data[i][j]);min=value<min?value:min,max=value>max?value:max;var eventInfo=CBoardEChartRenderEventInfo(data,i,j);datas.push({eventInfo:eventInfo,value:[parseInt(j),parseInt(i),value]})}var style=config.values[0].styles?config.values[0].styles:["#eee","blue"],option={tooltip:{trigger:"item",axisPointer:{show:!1,type:"shadow"},formatter:function formatter(params){var finalResult="",_loop20=function _loop20(_i73){if(tooltip[_i73].isShow!==!1){var index=_.findIndex(data.chartConfig.keys,function(e){return e.col===_i73});if(index<0)return{v:void 0};var _value3="";if(tooltip[_i73].formatter&&tooltip[_i73].formatter.indexOf("{v}")!=-1){var repResult="";"string"==typeof data.keys[params.value[0]][index]&&(repResult=tooltip[_i73].formatter.replace("{v}","'{v}'")),repResult=repResult.replace("{v}",data.keys[params.value[0]][index]),_value3=eval(repResult)}else _value3=data.keys[params.value[0]][index];finalResult=finalResult+tooltip[_i73].col+": "+_value3+"<br/>"}};for(var _i73 in tooltip){var _ret20=_loop20(_i73);if("object"===("undefined"==typeof _ret20?"undefined":_typeof(_ret20)))return _ret20.v}var _loop21=function _loop21(_i74){if(tooltipGroups[_i74].isShow!==!1){var index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i74});if(index<0)return{v:void 0};var _value4="";if(tooltipGroups[_i74].formatter&&tooltipGroups[_i74].formatter.indexOf("{v}")!=-1){var repResult="";"string"==typeof params.data.eventInfo[index].value&&(repResult=tooltipGroups[_i74].formatter.replace("{v}","'{v}'")),repResult=repResult.replace("{v}",params.data.eventInfo[index].value),_value4=eval(repResult)}else _value4=params.data.eventInfo[index].value;finalResult=finalResult+tooltipGroups[_i74].col+": "+_value4+"<br/>"}};for(var _i74 in tooltipGroups){var _ret21=_loop21(_i74);if("object"===("undefined"==typeof _ret21?"undefined":_typeof(_ret21)))return _ret21.v}var _loop22=function _loop22(_i75){if(tooltipTarget[_i75].isShow!==!1){var index=_.findIndex(data.chartConfig.values[0].cols,function(e){return e.alias===_i75});if(index<0)return{v:void 0};var _value5="";if(tooltipTarget[_i75].formatter&&tooltipTarget[_i75].formatter.indexOf("{v}")!=-1){var repResult="";repResult="string"==typeof data.keys[params.value[0]][index]?tooltipTarget[_i75].formatter.replace("{v}","'{v}'"):tooltipTarget[_i75].formatter,repResult=repResult.replace("{v}",params.value[params.value.length-1]),_value5=eval(repResult)}else _value5=params.value[params.value.length-1];finalResult=finalResult+tooltipTarget[_i75].col+": "+_value5+"<br/>"}};for(var _i75 in tooltipTarget){var _ret22=_loop22(_i75);if("object"===("undefined"==typeof _ret22?"undefined":_typeof(_ret22)))return _ret22.v}return finalResult}},grid:angular.copy(echartsBasicOption.grid),animation:!1,toolbox:{show:!1,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!0},restore:{show:!1},saveAsImage:{show:!0}}},xAxis:{name:xAxisName,type:"category",data:xAxisData,splitArea:{show:!0}},yAxis:{name:yAxisName,type:"category",data:yAxisData,splitArea:{show:!0}},visualMap:{min:min,max:max,calculable:!0,orient:"horizontal",left:"center",bottom:"0%",inRange:{color:style}},targetData:chartConfig.values,series:[{type:"heatmap",data:datas}]};return grid.gridCustom&&(grid.gridBottom&&(option.grid.bottom=grid.gridBottom),grid.gridTop&&(option.grid.top=grid.gridTop),grid.gridLeft&&(option.grid.left=grid.gridLeft),grid.gridRight&&(option.grid.right=grid.gridRight)),option}}]),discovery.service("chartMarkLineMapService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){return this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(null,n,e)},this.parseOption=function(e){var t,a=e.keys,r=e.series,n={},i=[],o=[],s=e.chartConfig,l="china";s.city&&s.city.code?l=s.city.code:s.province&&s.province.code&&(l=s.province.code);var c;c="china"==l?"plugins/FineMap/mapdata/china.json":l.length>2?"plugins/FineMap/mapdata/geometryCouties/"+l+".json":"plugins/FineMap/mapdata/geometryProvince/"+l+".json";for(var d=0,u=0;a[0]&&u<a.length;u++)t=a[u][2],n[t]=[a[u][0],a[u][1]];for(var u=0;r[0]&&u<r.length;u++){t=r[u][2],n[t]=[r[u][0],r[u][1]],o[u]=r[u][2];for(var f=[],p=0,g=0;a[0]&&p<a.length;p++)e.data[u][p]&&0!=e.data[u][p]&&(f[g]=[{name:t},{name:a[p][2],value:e.data[u][p]}],g++,d<e.data[u][p]&&(d=e.data[u][p]));i[u]=[t,f]}var m=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a],i=n[r[0].name],o=n[r[1].name];i&&o&&t.push({fromName:r[0].name,toName:r[1].name,coords:[i,o]})}return t},h=["#a6c84c","#ffa022","#46bee9"],v=[];i.forEach(function(e,t){v.push({name:e[0],type:"lines",zlevel:2,symbol:["none","arrow"],symbolSize:10,effect:{show:!0,constantSpeed:30,period:6,trailLength:.1,symbol:"arrow",symbolSize:4},lineStyle:{normal:{width:1,opacity:.6,curveness:.2}},data:m(e[1])},{name:e[0],type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{brushType:"stroke"},label:{normal:{show:!0,position:"right",formatter:"{b}"}},symbolSize:function(e){return 0==d?0:10*e[2]/d},itemStyle:{normal:{color:h[t]}},data:e[1].map(function(e){return{name:e[1].name,value:n[e[1].name].concat([e[1].value])}})})});var y;return $.ajax({type:"get",url:c,async:!1,success:function(e){echarts.registerMap(l,e),y={legend:{orient:"vertical",top:"top",left:"left",selectedMode:"multiple",data:o},geo:{map:l,roam:!0,itemStyle:{normal:{areaColor:"#EFF0F0",borderColor:"#B5B5B5",borderWidth:1}}},tooltip:{trigger:"item"},series:v}}}),y}}]),discovery.service("chartLiquidFillService",["EventService",function(e){"ngInject";this.instance=null,this.render=function(t,a,r,n,i,o){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var s;return r?s=r.myheight-20:null,this.instance=new CBoardEChartRender(t,a,(void 0),o),this.instance.chart(s,n,e)},this.parseOption=function(e){var t=e.chartConfig,a=!0;"static"==t.animation&&(a=!1);var r=t.values[0].style?t.values[0].style:"circle",n=[],i=e.data.length>0?e.data[0][0]:"N/A";if("N/A"!=i)for(var o=1;o<5;o++){for(var s=1,l=1;l<o;l++)s=.95*s;n.push(i*s)}var c={series:[{type:"liquidFill",shape:r,data:n,waveAnimation:a,radius:"70%",backgroundStyle:{borderWidth:2,borderColor:"#156ACF"},outline:{show:!1}}]};return c}}]),discovery.service("chartD3DemoService",["uuid4",function(e){"ngInject";function t(e,n,i,o,s,l){var c=a(e,n,i,o,s),d=[];if(e==n)for(var u in c){var f={name:c[u].arr[e-1],size:c[u].val,children:t(e-1,n,c[u].key,o,s)};"random"==l&&(f.itemStyle=r()),d.push(f)}else if(e>1)for(var u in c)d.push({name:c[u].arr[e-1],size:c[u].val,children:t(e-1,n,c[u].key,o,s)});else if(1==e)for(var u in c)d.push({name:c[u].arr[e-1],size:c[u].val});return d}function a(e,t,a,r,n){var i={};for(var o in r){var s=r[o][e-1];if(t>e){for(var l="",c=t;c>e;c--)l=c==t?r[o][c-1]:l+"-"+r[o][c-1];if(a!=l)continue;s=a+"-"+s}var d=isNaN(n[0][o])?0:parseFloat(n[0][o]);void 0==i[s]?i[s]={key:s,val:d,arr:r[o]}:i[s]={key:s,val:i[s].val+d,arr:r[o]}}return i}function r(){return{normal:{color:"rgb("+[Math.round(160*Math.random()),Math.round(160*Math.random()),Math.round(160*Math.random())].join(",")+")"}}}this.render=function(t,a,r,n,i){if(null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var o;r?o=r.myheight:null;var s=e.generate();return t.addClass("d3_"+s),new CBoardD3Render(t,a,this,s).chart(null,n)},this.parseOption=function(e){return e},this.initCanvas=function(e,t,a){html="<div>hello world</div>",html='<div id="wrapper">\n\t\t<div id="info" style="opacity: 1;">\n\t\t\t\t<div><span id="name"></span><span id="segment">&nbsp;</span></div>\n\t\t\t\t<div><span id="emissions"></span><span id="percent"></span></div>\n\t\t<div id="tweet-box">\n\t\t\t<i id="close" class="icon-remove"></i>\n\t\t\t<div id="tweet-text"></div>\n\t\t</div>\t\t\n',e.html(html);var r=e.height(),n=e.width(),i=d3.select(".d3_"+a.uuid).append("svg").attr("width",n).attr("height",r).attr("left",200);return i},this.draw=function(e,a,r){function n(e){if(G.transition().duration(M).attrTween("d",f(e)).each("end",function(e,t){d3.select($[0][t]).style("fill",function(e){return E(e)?"white":"none"})}),$.style("visibility",function(t){return u(e,t)?null:d3.select(this).style("visibility")}).transition().duration(M).attrTween("text-anchor",function(e){return function(){return T(e.x+e.dx/2)>Math.PI?"end":"start"}}).attrTween("transform",function(e){var t=(e.name||"").split(" ").length>1;return function(){var a=180*T(e.x+e.dx/2)/Math.PI-90,r=a+(t?-.5:0);return"rotate("+r+")translate("+(D(e.y)+S)+")rotate("+(a>90?-180:0)+")"}}).style("fill-opacity",function(t){return u(e,t)?1:1e-6}).each("end",function(t){d3.select(this).style("visibility",u(e,t)?null:"hidden")}),0==e.depth)d3.select("#splash").style("display","block").transition().duration(750).delay(500).style("opacity",1),d3.select("#centre-label").text("All emissions").style("font-family","Guardian-Text-Egyp-Web-Reg-Latin").style("font-size","12px");else if(d3.select("#splash").transition().duration(750).style("opacity",0).each("end",function(){d3.select(this).style("display","none")}),d3.select("#centre-label").text("").style("font-family","FontAwesome").style("font-size","18px"),d3.select("#centre-label-background").transition().delay(750).style("fill",g(e.parent)),3==e.depth){var t=Math.round(100*e.value)/100,a=e.parent?Math.round(1e4*t/e.parent.value)/100:"";tweetText=e.name+" has caused "+a+"% of manmade carbon emissions",d3.select("#tweet-text").transition().delay(750).text("‘"+tweetText+"’"),o()}}function i(){d3.select("#tweet-box").transition().duration(500).style("opacity",0).each("end",function(){d3.select(this).style("display","none")}),tweetBoxShowing=!1}function o(){d3.select("#tweet-box").style("display","block").transition().duration(500).style("opacity",1),tweetBoxShowing=!0}function s(e){l(e),e.depth<4&&d3.select(this).style("cursor","pointer");var t=d(e);d3.selectAll("path").classed("highlighted-path",!1),d3.selectAll("path").filter(function(e){return t.indexOf(e)>=0}).classed("highlighted-path",!0),d3.select("#centre-label-background").classed("highlighted-path",!0)}function l(e){d3.select("#info").transition().duration(750).style("opacity",1),d3.select("#name").text(0==e.depth?"总计":e.name);var t=Math.round(100*e.value)/100,a=e.parent?Math.round(1e4*t/e.parent.value)/100:"";d3.select("#emissions").text(0!=e.value?"数值："+t+"  ":" "),d3.select("#percent").text(0!=e.value?"对"+e.parent.name+"占比："+a+"%":"")}function c(e){d3.selectAll(".highlighted-path").classed("highlighted-path",!1)}function d(e){for(var t=[],a=e;a.parent;)t.unshift(a),a=a.parent;return t.unshift(a),t}function u(e,t){return e===t||!!e.children&&e.children.some(function(e){return u(e,t)})}function f(e){var t=p(e),a=d3.interpolate(T.domain(),[e.x,e.x+e.dx]),r=d3.interpolate(D.domain(),[e.y,t]),n=d3.interpolate(D.range(),[e.y?20:0,N]);return function(e){return function(t){return T.domain(a(t)),D.domain(r(t)).range(n(t)),W(e)}}}function p(e){return e.children?Math.max.apply(Math,e.children.map(p)):e.y+e.dy}function g(e){return colorList=[{depth:0,color:["#aaa"]},{depth:1,color:["#D81B1F","#0064A2","#49AB57"]},{depth:2,color:["#E95B2E","#488FC2","#76B847"]},{depth:3,color:["#FFCC4B","#69C3EA","#ADC946"]}],0==e.depth?"#aaa":1==e.depth?"#ADC946":2==e.depth?"#49AB57":3==e.depth?"#E95B2E":"Investor owned"==e.name?"#D81B1F":"Nation states"==e.name?"#0064A2":"State owned"==e.name?"#49AB57":e.parent&&"Investor owned"==e.parent.name?"#E95B2E":e.parent&&"Nation states"==e.parent.name?"#488FC2":e.parent&&"State owned"==e.parent.name?"#76B847":"Fuel & cement"==e.name?{"Investor owned":"#FFCC4B","Nation states":"#69C3EA","State owned":"#ADC946"}[e.parent.parent.name]:"Methane leaks"==e.name?{"Investor owned":"#FBBC73","Nation states":"#88B6D7","State owned":"#CBEC8E"}[e.parent.parent.name]:"Own footprint"==e.name?{"Investor owned":"#E9B251","Nation states":"#88B6D7","State owned":"#87DC8C"}[e.parent.parent.name]:"#333"}r.option=a;var m=this.initCanvas(e,a,r),h=(a.data[1],a.chartConfig),v=h.values[0].style?h.values[0].style:"random";"random"!=v&&"multi"!=v&&(a.color=[v]);var y=a.chartConfig.keys.length,_=a.keys,w=a.data;for(var b in _)_[b].reverse();var C=t(y,y,"",_,w,v),I=e.height(),x=e.width(),N=.85*I/2,T=d3.scale.linear().range([0,2*Math.PI]),D=d3.scale.pow().exponent(1.3).domain([0,1]).range([0,N]),S=5,M=1e3,k=m.attr("width",x+2*S).attr("height",I+2*S).append("g").attr("transform","translate("+[N+S,N+S]+")"),O=d3.layout.partition().value(function(e){return e.size}),W=d3.svg.arc().startAngle(function(e){return Math.max(0,Math.min(2*Math.PI,T(e.x)))}).endAngle(function(e){return Math.max(0,Math.min(2*Math.PI,T(e.x+e.dx)))}).innerRadius(function(e){return Math.max(0,e.y?D(e.y):e.y)}).outerRadius(function(e){return Math.max(0,D(e.y+e.dy))}),E=function(e){return T(e.x+e.dx)-T(e.x)>.05},L=O.nodes({name:"",children:C}),G=k.selectAll("path").data(L);G.enter().append("path").attr("id",function(e,t){return"path-"+t}).attr("d",W).attr("fill-rule","evenodd").style("fill",function(e){return g(e)}).on("click",function(e){return n(e.depth<4?e:e.parent)}).on("mouseover",s).on("mouseout",c);var $=k.selectAll("text").data(L),A=$.enter().append("text").style("fill-opacity",.1).style("stroke",function(e){return E(e)?"white":"none"}).attr("text-anchor",function(e){return T(e.x+e.dx/2)>Math.PI?"end":"start"}).attr("dy",".35em").attr("transform",function(e){var t=(e.name||"").split(" ").length>1,a=180*T(e.x+e.dx/2)/Math.PI-90,r=a+(t?-.5:0);return"rotate("+r+")translate("+(D(e.y)+S)+")rotate("+(a>90?-180:0)+")"});A.append("tspan").attr("x",0).text(function(e){return e.name}),A.append("tspan").attr("x",0).attr("dy","1.1em").text(function(e){return e.depth?e.name.split(" ")[1]||"":""}),d3.select("#close").on("click",function(){i()})},this.redraw=function(e,t){this.draw(e,t.option,t)}}]),discovery.service("chartCodeFlowerService",["uuid4",function(e){"ngInject";function t(e,n,i,o,s,l){var c=a(e,n,i,o,s),d=[];if(e==n)for(var u in c){var f={name:c[u].arr[e-1],size:c[u].val,children:t(e-1,n,c[u].key,o,s)};"random"==l&&(f.itemStyle=r()),d.push(f)}else if(e>1)for(var u in c)d.push({name:c[u].arr[e-1],size:c[u].val,children:t(e-1,n,c[u].key,o,s)});else if(1==e)for(var u in c)d.push({name:c[u].arr[e-1],size:c[u].val});return d}function a(e,t,a,r,n){var i={};for(var o in r){var s=r[o][e-1];if(t>e){for(var l="",c=t;c>e;c--)l=c==t?r[o][c-1]:l+"-"+r[o][c-1];if(a!=l)continue;s=a+"-"+s}var d=isNaN(n[0][o])?0:parseFloat(n[0][o]);void 0==i[s]?i[s]={key:s,val:d,arr:r[o]}:i[s]={key:s,val:i[s].val+d,arr:r[o]}}return i}function r(){return{normal:{color:"rgb("+[Math.round(160*Math.random()),Math.round(160*Math.random()),Math.round(160*Math.random())].join(",")+")"}}}this.render=function(t,a,r,n,i){if(t.empty(),null==a)return void t.html('<div class="alert alert-danger" role="alert">No Data!</div>');var o;r?o=r.myheight:null;var s=e.generate();return t.addClass("d3_"+s),new CBoardD3Render(t,a,this,s).chart(null,n)},this.parseOption=function(e){return e},this.initCanvas=function(e,t,a){html='<div id="wrapper" style="position:relative"><div id="info" style="opacity: 1;position:absolute;top:0;left:0;right:0"><div><span id="name"></span><span id="segment">&nbsp;</span></div><div><span id="emissions"></span><span id="percent"></span></div><div id="tweet-box"><i id="close" class="icon-remove"></i><div id="tweet-text"></div></div>',e.html(html);var r=e.height(),n=e.width(),i=d3.select(".d3_"+a.uuid).append("svg").attr("width",n).attr("height",r);return i},this.draw=function(e,a,r){function n(e){return N[e%N.length]}function i(e){if(F.transition().duration(W).attrTween("d",p(e)).each("end",function(e,t){d3.select(R[0][t]).style("fill",function(e){return $(e)?"white":"none"})}),R.style("visibility",function(t){return f(e,t)?null:d3.select(this).style("visibility")}).transition().duration(W).attrTween("text-anchor",function(e){return function(){return M(e.x+e.dx/2)>Math.PI?"end":"start"}}).attrTween("transform",function(e){var t=(e.name||"").split(" ").length>1;return function(){var a=180*M(e.x+e.dx/2)/Math.PI-90,r=a+(t?-.5:0);return"rotate("+r+")translate("+(k(e.y)+O)+")rotate("+(a>90?-180:0)+")"}}).style("fill-opacity",function(t){return f(e,t)?1:1e-6}).each("end",function(t){d3.select(this).style("visibility",f(e,t)?null:"hidden")}),0==e.depth)d3.select("#splash").style("display","block").transition().duration(750).delay(500).style("opacity",1),d3.select("#centre-label").text("All emissions").style("font-family","Guardian-Text-Egyp-Web-Reg-Latin").style("font-size","12px");else if(d3.select("#splash").transition().duration(750).style("opacity",0).each("end",function(){d3.select(this).style("display","none")}),d3.select("#centre-label").text("").style("font-family","FontAwesome").style("font-size","18px"),d3.select("#centre-label-background").transition().delay(750).style("fill",m(e.parent)),3==e.depth){var t=Math.round(100*e.value)/100,a=e.parent?Math.round(1e4*t/e.parent.value)/100:"";tweetText=e.name+" has caused "+a+"% of manmade carbon emissions",d3.select("#tweet-text").transition().delay(750).text("‘"+tweetText+"’"),s()}}function o(){d3.select("#tweet-box").transition().duration(500).style("opacity",0).each("end",function(){d3.select(this).style("display","none")}),tweetBoxShowing=!1}function s(){d3.select("#tweet-box").style("display","block").transition().duration(500).style("opacity",1),tweetBoxShowing=!0}function l(e){c(e),e.depth<4&&d3.select(this).style("cursor","pointer");var t=u(e);d3.selectAll("path").classed("highlighted-path",!1),d3.selectAll("path").filter(function(e){return t.indexOf(e)>=0}).classed("highlighted-path",!0),d3.select("#centre-label-background").classed("highlighted-path",!0)}function c(t){e.find("#info").show(),e.find("#name").text(0==t.depth?"总计":t.name);var a=Math.round(100*t.value)/100,r=t.parent?Math.round(1e4*a/t.parent.value)/100:"";e.find("#emissions").text(0!=t.value?"数值："+a+"  ":" "),e.find("#percent").text(0!=t.value?"对"+t.parent.name+"占比："+r+"%":"")}function d(t){e.find("#info").hide(),d3.selectAll(".highlighted-path").classed("highlighted-path",!1)}function u(e){for(var t=[],a=e;a.parent;)t.unshift(a),a=a.parent;return t.unshift(a),t}function f(e,t){return e===t||!!e.children&&e.children.some(function(e){return f(e,t)})}function p(e){var t=g(e),a=d3.interpolate(M.domain(),[e.x,e.x+e.dx]),r=d3.interpolate(k.domain(),[e.y,t]),n=d3.interpolate(k.range(),[e.y?20:0,S]);return function(e){return function(t){return M.domain(a(t)),k.domain(r(t)).range(n(t)),G(e)}}}function g(e){return e.children?Math.max.apply(Math,e.children.map(g)):e.y+e.dy}function m(e){for(var t=e,a=0;t;){if(t.color)return"hsl("+t.color+","+(30+10*a)+"%,"+(20+10*a)+"%)";a++,t=t.parent}return e.colors}r.option=a;var h=this.initCanvas(e,a,r),v=(a.data[1],a.chartConfig),y=v.values[0].style?v.values[0].style:"random";"random"!=y&&"multi"!=y&&(a.color=[y]);var w=a.chartConfig.keys.length,b=a.keys,C=a.data;for(var I in b)b[I].reverse();for(var x=t(w,w,"",b,C,y),N=[],I=10;I<20;I++)N.push(19*I);var T=e.height(),D=e.width(),S=.85*T/2,M=d3.scale.linear().range([0,2*Math.PI]),k=d3.scale.pow().exponent(1.3).domain([0,1]).range([0,S]),O=5,W=1e3,E=h.attr("width",D+2*O).attr("height",T+2*O).append("g").attr("transform","translate("+[D/2,T/2]+")"),L=d3.layout.partition().value(function(e){return e.size}),G=d3.svg.arc().startAngle(function(e){return Math.max(0,Math.min(2*Math.PI,M(e.x)))}).endAngle(function(e){return Math.max(0,Math.min(2*Math.PI,M(e.x+e.dx)))}).innerRadius(function(e){return Math.max(0,e.y?k(e.y):e.y)}).outerRadius(function(e){return Math.max(0,k(e.y+e.dy))}),$=function(e){return M(e.x+e.dx)-M(e.x)>.05};if(_.isArray(x))for(var I=0;I<x.length;I++)x[I].color=n(I);var A=L.nodes({name:"",children:x}),F=E.selectAll("path").data(A);F.enter().append("path").attr("id",function(e,t){return"path-"+t}).attr("d",G).attr("fill-rule","evenodd").style("fill",function(e){return m(e)}).on("click",function(e){return i(e.depth<4?e:e.parent)}).on("mouseover",l).on("mouseout",d);var R=E.selectAll("text").data(A),U=R.enter().append("text").style("fill-opacity",.1).style("stroke",function(e){return $(e)?"white":"none"}).attr("text-anchor",function(e){return M(e.x+e.dx/2)>Math.PI?"end":"start"}).attr("dy",".35em").attr("transform",function(e){var t=(e.name||"").split(" ").length>1,a=180*M(e.x+e.dx/2)/Math.PI-90,r=a+(t?-.5:0);return"rotate("+r+")translate("+(k(e.y)+O)+")rotate("+(a>90?-180:0)+")"});U.append("tspan").attr("x",0).text(function(e){return e.name}),U.append("tspan").attr("x",0).attr("dy","1.1em").text(function(e){return e.depth?e.name.split(" ")[1]||"":""}),d3.select("#close").on("click",function(){o()})},this.redraw=function(e,t){this.draw(e,t.option,t)}}]),discovery.service("chartFlexService",["$interpolate","$compile","$sce","uuid4","EventService",function(e,t,a,r,n){"ngInject";this.render=function(e,t,a,i,o){if(t){var s=r.generate(),l=new CBoardFlexRender(e,t);return l.initialize(t,n,a,s)}},this.parseOption=function(e){if(!_.isUndefined(e.chartConfig.option.flex)){for(var t=[],a=[],r=0;r<e.chartConfig.keys.length;r++)a.push(e.chartConfig.keys[r].col);for(var r=0;r<e.keys.length;r++){for(var n={},i=0;i<a.length;i++)n[a[i]]=e.keys[r][i];t.push(n)}for(var r=0;r<e.series.length;r++)for(var i=0;i<e.keys.length;i++){var o=e.series[r][0],s=e.data[r];t[i][o]=s[i]}return{data:t,template:e.chartConfig.option.flex}}return!1}}]),discovery.service("chartFlex2Service",["$interpolate","$rootScope","$compile","$sce","uuid4","EventService","BoardParamService",function(e,t,a,r,n,i,o){"ngInject";function s(){return o}this.render=function(e,r,o,l,c){if(r){var d=o;void 0==d&&(d=t);var u=n.generate(),f=new CBoardFlex2Render(e,r);return f.initialize(r,i,d,u,a,s())}},this.parseOption=function(e){if(!_.isUndefined(e.chartConfig.option.flex)){for(var t=[],a=[],r=0;r<e.chartConfig.keys.length;r++)a.push(e.chartConfig.keys[r].col);for(var r=0;r<e.keys.length;r++){for(var n={},i=0;i<a.length;i++)n[a[i]]=e.keys[r][i];t.push(n)}for(var r=0;r<e.series.length;r++)for(var i=0;i<e.keys.length;i++){var o=e.series[r][0],s=e.data[r];t[i][o]=s[i]}return{data:t,template:e.chartConfig.option.flex,code:e.chartConfig.option.code}}return!1}}]),discovery.service("chartGanttService",["$filter","EventService","uuid4","$rootScope",function(e,t,a,r){"ngInject";this.render=function(e,r,n,i){var n=e.data("$scope");if(n){var o=new CBoardGanttRender(e,r);this.instance={render:o};var s=a.generate(),l="example_"+s+"_gantt",c=o.html(i,s,l);return e.html(c),o.initialize(r,t,n,s,l)}},this.parseOption=function(e){for(var t=e.chartConfig,a=["id","parent","start_date","duration","text"],r=["state","progress"],n=t.keys,i=t.groups,o=t.values[0].cols,s=e.originalData.data,l=[],c=0;c<s.length;c++){for(var d={},u=s[c],f=0,p=0;p<i.length;p++)d[r[p]]=u[f],f++;for(var g=0;g<n.length;g++)d[a[g]]=u[f],f++;for(var m=0;m<o.length;m++)d[valueNameList[m]]=u[f],f++;l.push(d)}return e.newList=l,e}}]),discovery.service("chartBarLimitsService",["dataService","EventService",function(e,t){"ngInject";this.instance=null,this.render=function(e,a,r,n,i,o){return this.instance=new CBoardEChartRender(e,a,(void 0),o),this.instance.chart(null,n,t)},this.parseOption=function(e){for(var t=e.chartConfig,a=e.keys,r=e.series,n=e.data,i=e.seriesConfig,o=new Array,s=_.map(a,function(e){return e.join("-")}),l=t.option,c=[],d=0;n[0]&&d<n[0].length;d++){for(var u=0,f=0;f<n.length;f++)u+=n[f][d]?Number(n[f][d]):0,n[f][d]=n[f][d]?Number(n[f][d]):0;c[d]=u}for(var f=0;f<n.length;f++){var p=r[f].join("-"),g=angular.copy(i[p]);g.name=p,g.data=n[f],g.barMaxWidth=40,g.type="bar",g.stack="stack"+f%(n.length/2);for(var m=[],d=0;d<g.data.length;d++){var h=CBoardEChartRenderEventInfo(e,f,d);m.push({eventInfo:h,value:g.data[d]})}g.data=m,f<n.length/2&&(g.itemStyle={normal:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"},emphasis:{barBorderColor:"rgba(0,0,0,0)",color:"rgba(0,0,0,0)"}}),o.push(g)}for(var f=0;f<t.values.length;f++)_.isUndefined(t.values[f].series_label)||("true"==t.values[f].series_label?o[f].label={normal:{show:!0}}:"false"==t.values[f].series_label&&(o[f].label={normal:{show:!1}}));var v=angular.copy(t.values);_.each(v,function(e,t){e.axisLabel={formatter:function(e){return numbro(e).format("0a.[0000]")}},e.min=0,t>0&&(e.splitLine=!1),e.scale=!0});for(var f=0;f<v.length;f++)t.values[f].series_label&&("true"==t.values[f].series_logarithm?v[f]={type:"log"}:"false"==t.values[f].series_logarithm&&(v[f]={type:"value"}));var y=[],w=[],b=[];if(t.option.itemStyle&&t.option.itemStyle.color&&(y=t.option.itemStyle.color.split(",")),t.option.itemStyle&&t.option.itemStyle.dataName&&(w=t.option.itemStyle.dataName.split(",")),t.option.itemStyle&&t.option.itemStyle.seriesName&&(b=t.option.itemStyle.seriesName.split(",")),t.option.itemStyle&&t.option.itemStyle&&t.option.itemStyle.color&&""!=t.option.itemStyle.color)for(var C=0;C<y.length;C++)if(t.option.itemStyle.dataName&&(_.isUndefined(t.option.itemStyle.seriesName)||""==t.option.itemStyle.seriesName)){for(var f=0;f<o.length;f++)if(w[C]==o[f].name)for(var d=0;d<o[f].data.length;d++)o[f].data[d]=_.extend(o[f].data[d],{itemStyle:{normal:{color:y[C]}}})}else if(t.option.itemStyle.dataName&&t.option.itemStyle.seriesName)for(var f=0;f<o.length;f++)if(w[C]==o[f].name)for(var d=0;d<o[f].data.length;d++)for(var I=0;I<o[f].data[d].eventInfo.length;I++)b[C]==o[f].data[d].eventInfo[I].value&&(o[f].data[d]=_.extend(o[f].data[d],{itemStyle:{normal:{color:y[C]}}}));if(l){var x,N;l.ctgLabelInterval?x=l.ctgLabelInterval:"auto",l.ctgLabelRotate?N=l.ctgLabelRotate:0}var T={type:"category",data:s,axisLabel:{interval:x,rotate:N}},D={type:"bar",grid:angular.copy(echartsBasicOption.grid),legend:{data:_.map(r,function(e){return e.join("-")})},tooltip:{formatter:function(e){e[0].name;return"最小值:"+e[0].value+"<br>最大值:"+e[1].value}},xAxis:"horizontal"==t.valueAxis?v:T,yAxis:"horizontal"==t.valueAxis?T:v,series:o};return"horizontal"===t.valueAxis&&(D.grid.left="left",D.grid.containLabel=!0,D.grid.bottom="5%"),"vertical"===t.valueAxis&&t.values.length>1&&(D.grid.right=40),updateEchartOptions(l,D),D}}]),discovery.service("chartDataLineTableService",["$filter","EventService","uuid4",function(e,t,a){
"ngInject";e("translate");this.render=function(e,r,n,i){var o=new CBoardDataLineTableRender(e,r);this.instance={render:o};var s=a.generate(),l="example_"+s,c=o.html(i,s,l);return e.html(c),o.initialize(r,t,n,s,l)},this.parseOption=function(e){var t=[];t=e.keys;for(var a=0;a<e.data.length;a++)for(var r=e.data[a],n=0;n<t.length;n++)t[n]=t[n].concat(r[n]);return e.dataList=t,e}}]),discovery.service("chartEchartBmapService",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.type="bMap",this.instance.chart(null,r,EventService)},this.parseOption=function(data){var tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys,drill=data.chartConfig.drillTier,ops=data.chartConfig.option;for(var _i76 in keys)Levi[keys[_i76].col]?(tooltip[keys[_i76].col]=Levi[keys[_i76].col],Levi[keys[_i76].col].col||(tooltip[keys[_i76].col].col=keys[_i76].col)):tooltip[keys[_i76].col]={col:keys[_i76].col,isShow:!0,formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget,targetValue={},_j23=0;_j23<data.chartConfig.values.length;_j23++)for(var k=0;k<data.chartConfig.values[_j23].cols.length;k++)targetValue[data.chartConfig.values[_j23].cols[k].alias]={col:data.chartConfig.values[_j23].cols[k].alias};for(var _i77 in targetValue)tooltipTarget[_i77]=Target[_i77],Target[_i77]&&Target[_i77].col||(tooltipTarget[_i77]={col:_i77,isShow:!Target[_i77]||Target[_i77].isShow,formatter:Target[_i77]&&Target[_i77].formatter?Target[_i77].formatter:""});for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i78=0;_i78<targetGroups.length;_i78++)Groups[targetGroups[_i78].col]?(tooltipGroups[targetGroups[_i78].col]=Groups[targetGroups[_i78].col],Groups[targetGroups[_i78].col].col||(tooltipGroups[targetGroups[_i78].col].col=targetGroups[_i78].col)):tooltipGroups[targetGroups[_i78].col]={col:targetGroups[_i78].col,isShow:!0,formatter:""};var originalData=data.originalData.data,minColor="#006edd";data.chartConfig.option.maxColor&&(minColor=data.chartConfig.option.maxColor);var maxColor="#e0ffff";data.chartConfig.option.minColor&&(maxColor=data.chartConfig.option.minColor);var cityMaxRadius=20;data.chartConfig.option.cityMaxRadius&&(cityMaxRadius=data.chartConfig.option.cityMaxRadius);var cityMinRadus=10;data.chartConfig.option.cityMinRadus&&(cityMinRadus=data.chartConfig.option.cityMinRadus);var series_data=convertCityData(data),maxCity=_.max(series_data,function(e){return"string"==typeof e.value[2]?parseInt(e.value[2]):parseInt(e.value[2])}),thresholdCode=data.chartConfig.thresholdCode;if(thresholdCode){var params=angular.copy(window.$$dlut_param),seriesIndexObj={},dataIndexObj={};for(var _j24 in data.seriesConfig)seriesIndexObj[_j24]=data.seriesConfig[_j24].valueAxisIndex,dataIndexObj[_j24]=2;var evalColor=function(e){for(var t in e){e[t];try{e[t]=new Function("data,params,seriesIndex,dataIndex","return ("+thresholdCode+")(data,params,seriesIndex,dataIndex)")(e[t],params,t,0)}catch(a){console.error("data自定义计算公式错误",thresholdCode,params,e[t],t,0,a)}}};evalColor(series_data)}var seriesArr=[{type:"scatter",coordinateSystem:"geo",data:series_data,label:{show:!0,color:"auto",position:"top",formatter:function(e){return e.name}},symbolSize:function(e,t){var a=0;if(_.isUndefined(maxCity.value)||_.isNaN(maxCity.value[2])||_.isUndefined(maxCity.value[2])||maxCity.value[2]===1/0);else{var r=parseFloat(e[2]),n=parseFloat(maxCity.value[2]);a=_.isNaN(r)?cityMinRadus:_.isNaN(n)?cityMaxRadius:r/n*cityMaxRadius}return a<cityMinRadus||_.isNaN(a)?cityMinRadus:a>cityMaxRadius?cityMaxRadius:a}}];if(data.chartConfig.markLineCode){var markLineCode=data.chartConfig.markLineCode;for(var _i80 in seriesArr)try{seriesArr[_i80]=new Function("serie,params,seriesIndex","return ("+markLineCode+")(serie,params,seriesIndex)")(seriesArr[_i80],params,_i80)}catch(e){console.error("series自定义计算错误",markLineCode,seriesArr[_i80],params,_i80,e)}}var echartOption={};if(echartOption={backgroundColor:"#D1D1D1",tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",value="",param=BoardParamService.getAll(),_loop23=function _loop23(_i81){if(void 0===_typeof(tooltip[_i81])||tooltip[_i81].isShow!==!1)if(index=_.findIndex(params.data.eventInfo,function(e){return e.col===_i81}),index>-1){if(params.data.eventInfo[index].value){value=params.data.eventInfo[index].value;var _result6=params.data.eventInfo[index].value;tooltip[_i81].formatter&&(_result6=eval(tooltip[_i81].formatter)),finalResult=finalResult+tooltip[_i81].col+": "+_result6+"<br/>"}}else if(params.name){value=params.name;var _result7=params.name;tooltip[_i81].formatter&&(_result7=eval(tooltip[_i81].formatter)),finalResult=finalResult+tooltip[_i81].col+": "+_result7+"<br/>"}};for(var _i81 in tooltip){var index;_loop23(_i81)}for(var _i82 in tooltipTarget)if(void 0===_typeof(tooltipTarget[_i82])||tooltipTarget[_i82].isShow!==!1){var targetArray=_.keys(tooltipTarget);if(params.data&&params.data.value){value=params.data.value[_.indexOf(targetArray,_i82)+2];var result=params.data.value[_.indexOf(targetArray,_i82)+2];tooltipTarget[_i82].formatter&&(result=eval(tooltipTarget[_i82].formatter)),finalResult=finalResult+tooltipTarget[_i82].col+": "+result+"<br/>"}}return finalResult}},geo:{map:"china",label:{emphasis:{show:!1}},itemStyle:{normal:{areaColor:"#F4F4F4",borderColor:"white",borderWidth:1},emphasis:{areaColor:"#F4F4F4"}},zoom:(ops.isEnLarge&&1==drill.keyTier||2==drill.keyTier)&&ops.zoom?ops.zoom:1,center:ops.isEnLarge&&1==drill.keyTier||2==drill.keyTier?[city[drill.filters.key[0]][0],city[drill.filters.key[0]][1]]:[]},series:seriesArr},data.chartConfig.optionCode){var optionCode=data.chartConfig.optionCode;try{var param=angular.copy(window.$$dlut_param);echartOption=new Function("option,param,config","return ("+optionCode+")(option,param,config)")(echartOption,param,data.chartConfig)}catch(e){console.error("option自定义计算错误",echartOption,e)}}return echartOption}}]),discovery.service("chartEchartZoneMapService",["BoardParamService","EventService",function(BoardParamService,EventService){"ngInject";this.instance=null,this.render=function(e,t,a,r,n,i){return this.instance=new CBoardEChartRender(e,t,(void 0),i),this.instance.chart(null,r,EventService)},this.parseOption=function(data){var tooltip={},Levi=data.chartConfig.option.tooltip,keys=data.chartConfig.keys;for(var _i83 in keys)Levi[keys[_i83].col]?(tooltip[keys[_i83].col]=Levi[keys[_i83].col],Levi[keys[_i83].col].col||(tooltip[keys[_i83].col].col=keys[_i83].col)):tooltip[keys[_i83].col]={col:keys[_i83].col,isShow:!0,formatter:""};for(var tooltipTarget={},Target=data.chartConfig.option.tooltipTarget,targetValue={},_j25=0;_j25<data.chartConfig.values.length;_j25++)for(var k=0;k<data.chartConfig.values[_j25].cols.length;k++)targetValue[data.chartConfig.values[_j25].cols[k].alias]={col:data.chartConfig.values[_j25].cols[k].alias};for(var _i84 in targetValue)tooltipTarget[_i84]=Target[_i84],Target[_i84]&&Target[_i84].col||(tooltipTarget[_i84]={col:_i84,isShow:!Target[_i84]||Target[_i84].isShow,formatter:Target[_i84]&&Target[_i84].formatter?Target[_i84].formatter:""});for(var tooltipGroups={},Groups=data.chartConfig.option.tooltipGroups,targetGroups=data.chartConfig.groups,_i85=0;_i85<targetGroups.length;_i85++)Groups[targetGroups[_i85].col]?(tooltipGroups[targetGroups[_i85].col]=Groups[targetGroups[_i85].col],Groups[targetGroups[_i85].col].col||(tooltipGroups[targetGroups[_i85].col].col=targetGroups[_i85].col)):tooltipGroups[targetGroups[_i85].col]={col:targetGroups[_i85].col,isShow:!0,formatter:""};var minColor="#e0ffff";data.chartConfig.option.maxColor&&(minColor=data.chartConfig.option.maxColor);var maxColor="#006edd";data.chartConfig.option.minColor&&(maxColor=data.chartConfig.option.minColor);var series_data=convertZoneData(data),maxCity=_.max(series_data,function(e){return e.value[2]}),thresholdCode=data.chartConfig.thresholdCode;if(thresholdCode){var params=angular.copy(window.$$dlut_param),seriesIndexObj={},dataIndexObj={};for(var _j26 in data.seriesConfig)seriesIndexObj[_j26]=data.seriesConfig[_j26].valueAxisIndex,dataIndexObj[_j26]=2;var evalColor=function(e){for(var t in e){e[t];try{e[t]=new Function("data,params,seriesIndex,dataIndex","return ("+thresholdCode+")(data,params,seriesIndex,dataIndex)")(e[t],params,t,0)}catch(a){console.error("data自定义计算公式错误",thresholdCode,params,e[t],t,0,a)}}};evalColor(series_data)}var maxValue=_.max(series_data,function(e){return Number(e.value[0])});Math.abs(maxValue)!=1/0&&(maxValue=maxValue.value[0]);var minValue=_.min(series_data,function(e){return Number(e.value[0])});minValue&&(minValue=minValue.value[0]);var absoluteMaxValue=Math.abs(maxValue);Math.abs(minValue)>absoluteMaxValue&&(absoluteMaxValue=Math.abs(minValue));var chartOption=null;if(chartOption={backgroundColor:"#D1D1D1",tooltip:{trigger:"item",formatter:function formatter(params){var finalResult="",value="",param=BoardParamService.getAll();for(var _i87 in tooltip)if((void 0===_typeof(tooltip[_i87])||tooltip[_i87].isShow!==!1)&&params.name){value=params.name;var result=params.name;tooltip[_i87].formatter&&(result=eval(tooltip[_i87].formatter)),finalResult=finalResult+tooltip[_i87].col+": "+result+"<br/>"}for(var _i88 in tooltipTarget)if(void 0===_typeof(tooltipTarget[_i88])||tooltipTarget[_i88].isShow!==!1){var targetArray=_.keys(tooltipTarget);if(params.data&&params.data.value){value=params.data.value[_.indexOf(targetArray,_i88)];var _result8=params.data.value[_.indexOf(targetArray,_i88)];tooltipTarget[_i88].formatter&&(_result8=eval(tooltipTarget[_i88].formatter)),finalResult=finalResult+tooltipTarget[_i88].col+": "+_result8+"<br/>"}}return finalResult}},geo:{show:!0,label:{normal:{show:!1},emphasis:{show:!1}},roam:!0,itemStyle:{normal:{areaColor:"#031525",borderColor:"#3B5077"},emphasis:{areaColor:"#2B91B7"}}},visualMap:{type:"continuous",min:minValue,max:maxValue,text:["Low","High"],realtime:!1,calculable:!0,precision:3,dimension:0,range:[minValue,maxValue],inRange:{color:["green","red"]}},series:[{type:"map",mapType:data.chartConfig.option.provinceMap?"china":"chinaZone",coordinateSystem:"geo",itemStyle:{normal:{areaColor:"#F4F4F4",borderColor:"white",borderWidth:1,label:{show:!1}},emphasis:{label:{show:!0}}},data:series_data}]},data.chartConfig.optionCode){var optionCode=data.chartConfig.optionCode;try{chartOption=new Function("option, absoluteMaxValue","return ("+optionCode+")(option, absoluteMaxValue)")(chartOption,absoluteMaxValue)}catch(e){console.error("option自定义计算错误",chartOption,e)}}return chartOption}}]),discovery.service("chartTreeGridService",function(){"ngInject";this.render=function(e,t,a){var r=new CBoardTreeGridRender(e,t),n=Math.random().toString(36).substring(2),i="treegrid_"+n,o=r.html(t,i);return this.instance={render:r},e.html(o),r.initialize(t,i)},this.parseOption=function(t){var a=[],r=[],n=[],i=null,o=t.chartConfig.values[0].cols,s=angular.copy(t.originalData.data),l=angular.copy(t.originalData.columnList),c=t.chartConfig.drillTier.keyTier,d=t.chartConfig.keys,u=t.chartConfig.keys[0].drillDown,f=i=u[c].col;return _.each(l,function(e){e.name===f?e.name=d[0].col:null}),_.each(d,function(e){a.push({name:e.col}),r.push({dataField:e.col,text:e.col,width:e.width?e.width:"auto"})}),_.each(o,function(e){a.push({name:e.col,type:e.treeType});var t,n=e.alias?e.alias:e.col;e.dataStyle&&"custom"===e.dataStyle.type&&(t=new Function("rowKey, dataField, value, data","return ("+e.dataStyle.num+")(rowKey, dataField, value, data)")),r.push({dataField:e.col,text:n,width:e.width?e.width:"auto",cellsRenderer:t})}),_.each(s,function(t){var a={};_.each(l,function(r){a[r.name]=t[r.index],a.tree_item_id=e()}),n.push(a)}),t.treeGrid={fields:a,columns:r,data:n},t};var e=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}),discovery.controller("NvParamCtrl",["$scope","$uibModal","$http",function($scope,$uibModal,$http){"ngInject";var evalValue=function evalValue(value){if(isNaN(Number(value))){var now=function(e,t){return void 0==e?+moment():+moment().add(e,t)},interval=function(e,t){var a=0;switch(t){case"h":a=36e5;break;case"d":a=864e5;break;case"m":a=6e4;break;case"s":a=1e3}return e*a};return eval(value)}return value},formatter=function(e,t){return _.isUndefined(t)?e:moment(e).format(t)};$scope.init=function(){if($scope.param=$scope.$parent.param,$scope.param.selects=[],$scope.param.type="=","undefined"==typeof $scope.param.values&&($scope.param.values=[]),"slider"==$scope.param.paramType){var e=$scope.param.cfg,t=evalValue(_.result(e,"max",null)),a=evalValue(_.result(e,"min",null)),r=_.debounce($scope.$parent.applyParamFilter,800);$scope.slider={minValue:t-Number(evalValue(_.result(e,"range",0))),maxValue:t,options:{floor:a,ceil:t,draggableRange:!0,enforceStep:!1,maxRange:Number(evalValue(_.result(e,"maxRange",null))),step:evalValue(_.result(e,"step",6e4)),translate:function(t){return formatter(t,e.formatter)},onChange:function(t,a,n,i){$scope.param.type="[a,b]",$scope.param.values=[formatter(a,e.value_fmt),formatter(n,e.value_fmt)],r()}}},$scope.param.type="[a,b]",$scope.param.values=[formatter($scope.slider.minValue,e.value_fmt),formatter($scope.slider.maxValue,e.value_fmt)],$scope.param.refresh=function(){if($scope.slider.maxValue==$scope.slider.options.ceil){var e=$scope.slider.maxValue-$scope.slider.minValue,t=$scope.param.cfg,a=evalValue(_.result(t,"max",null)),r=evalValue(_.result(t,"min",null));$scope.slider.maxValue=a,$scope.slider.minValue=a-e,$scope.slider.options.floor=r,$scope.slider.options.ceil=a,$scope.param.type="[a,b]",$scope.param.values=[formatter($scope.slider.minValue,t.value_fmt),formatter($scope.slider.maxValue,t.value_fmt)]}}}else _.each($scope.param.col,function(e){var t;_.isUndefined(e.datasetId)?_.each($scope.datasetList,function(a){e.widgetId==a.id&&(t={datasourceId:a.data.datasource,query:angular.toJson(a.data.query),datasetId:null})}):t={datasourceId:null,query:null,datasetId:e.datasetId}});$scope.$emit("paramInitFinish",$scope.param)},$scope.clearParam=function(){$scope.param.values=[],$scope.applyParamFilter()},$scope.deleteParam=function(e,t){e.params.splice(t,1),$scope.applyParamFilter()},$scope.editParam=function(){$uibModal.open({templateUrl:"src/view/nv/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return $scope.param?angular.copy($scope.param):{type:"="}},filter:function(){return!1},getSelects:function(){return function(e,t,a){a($scope.param.selects)}},ok:function(){return function(e){$scope.param.values=e.values,$scope.param.type=e.type,$scope.applyParamFilter()}}},controller:"newParamSelector"})}}]),discovery.controller("newParamSelector",["$scope","$http","$timeout","$interval",function(e,t,a,r){"ngInject";e.param=e.$parent.param,e.param.selects=[],_.each(e.param.col,function(t){var a;_.isUndefined(t.datasetId)?_.each(e.datasetList,function(e){t.widgetId==e.id&&(a={datasourceId:e.data.datasource,query:angular.toJson(e.data.query),datasetId:null})}):a={datasourceId:null,query:null,datasetId:t.datasetId}});e.enterKeyUp=function(t){var a=window.event?t.keyCode:t.which;13==a&&e.clickSearch()},e.clickSearch=function(t){var a=e.inputParam;""!=$.trim(a)?(e.param.type="like",e.param.values=["%"+a+"%"]):(e.param.type="like",e.param.values=[])},e.clearParams=function(t){e.param.values=[]}}]),discovery.controller("nvShareCtrl",["$scope","$http","ModalUtils","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.activeId,e.curUser,e.userKeyword="",e.selectedRoleId=null;var i=function(){t.get("admin/getRoleListAll.do").success(function(t){e.roleList=t})};i(),e.resList=[{id:"Dashboard",text:n("ADMIN.BOARD"),parent:"#",state:{disabled:!0}},{id:"Dataset",text:n("ADMIN.DATASET"),parent:"#",state:{disabled:!0}},{id:"Widget",text:n("ADMIN.WIDGET"),parent:"#",state:{disabled:!0}},{id:"Mind",text:n("ADMIN.BRAIN_MAP"),parent:"#",state:{disabled:!0}}];var o=function(){return t.get("admin/getBoardListUser.do").success(function(t){_.each(d(t,"Dashboard","board","fa fa-puzzle-piece"),function(t){e.resList.push(t)})})},s=function(){return t.get("admin/getDatasetListUser.do").success(function(t){_.each(d(t,"Dataset","dataset","fa fa-table"),function(t){e.resList.push(t)})})},l=function(){return t.get("admin/getWidgetListUser.do").success(function(t){_.each(d(t,"Widget","widget","fa fa-line-chart"),function(t){e.resList.push(t)})})},c=function(){return t.get("mindmap/getMindmapList.do").success(function(t){_.each(d(t,"Mind","mind","fa fa-sitemap"),function(t){e.resList.push(t)})})},d=function(e,t,a,r){for(var n=1,i=[],o=0;o<e.length;o++){var s=[];e[o].categoryName?(s=e[o].categoryName.split("/"),s.push(e[o].name)):s.push(e[o].name);for(var l=t,c=0;c<s.length;c++){for(var d=!1,u=s[c],f=0;f<i.length;f++)if(i[f].text==u&&i[f].parent==l&&"parent"==i[f].id.substring(0,6)){d=!0;break}d?l=i[f].id:(c==s.length-1?i.push({id:a+"_"+e[o].id.toString(),parent:l,text:u,resId:e[o].id,type:a,icon:r,name:u}):i.push({id:"parent_"+a+"_"+n,parent:l,text:u,state:{disabled:!0}}),l="parent_"+a+"_"+n,n++)}}return i},u=(function(){o().then(function(){return s()}).then(function(){return l()}).then(function(){return c()}).then(function(){e.treeConfig={core:{multiple:!0,animation:!0,error:function(e){},check_callback:!0,worker:!0},checkbox:{three_state:!1},dnd:{check_while_dragging:!1},version:1,plugins:["types","unique","dnd"]},$(document).on("dnd_stop.vakata.jstree",function(e,t){$(".dropable").removeClass("active");var a=t.event.target;a=$(a).parents(".dropable");var r=$(a).attr("roleId");if(r){for(var n=t.data.nodes,i=[],o=0;o<n.length;o++){var s=n[o];i.push(t.data.origin._model.data[s].original)}u(r,n,i)}})})}(),function(r,i,o){var s=_.map(e.getResListByRoleId(r),function(e){return{resId:e.resId,resType:e.type}});_.each(o,function(e){s.push({resId:e.resId,resType:e.type})}),t.post("admin/insertRoleResShare.do",{roleId:r,resIdArr:angular.toJson(s)}).success(function(t){"1"==t?(e.getDataset(r,!0),a.alert(n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})});e.changed=function(t,a,r){var t=a.node.original,n=_.map(_.filter(e.roleResList,function(e){return e.resType==t.type&&e.resId==t.resId}),function(e){return e.roleId});e.selectRole=_.filter(e.roleList,function(e){return _.find(n,function(t){return e.roleId==t})})},e.getResListByRoleId=function(t,a){var r=_.filter(e.roleResList,function(e){return e.roleId==t&&("widget"==e.resType||"dataset"==e.resType||"board"==e.resType||"mind"==e.resType)}),n=_.filter(e.resList,function(e){return _.find(r,function(t){return e.resId==t.resId&&e.type==t.resType})});return _.isUndefined(a)||(n=_.filter(n,function(e){return e.type==a})),n},e.deleteResInRoleGroup=function(r,i,o){t.post("admin/deleteRoleResByExample.do",{roleId:r,resId:i,resType:o}).success(function(t){1==t?(e.getDataset(r,!0),a.alert("删除"+n("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})};var f=function(){t.get("admin/getUserRoleList.do").success(function(t){e.userRoleList=t})};f();var p=function(){t.get("admin/getUserList.do").success(function(t){e.userList=t})};p(),e.changeState=function(t){e.selectedRoleId=t,e.selectedUserList=_.filter(e.userList,function(a){return _.find(e.userRoleList,function(e){return e.roleId==t&&a.userId==e.userId})})},e.getDataset=function(a,r){_.isUndefined(e.activeId)||e.activeId!=a||r?t.get("/admin/getRoleResListByRoleId.do?roleId="+a).success(function(t){e.roleResList=t,e.activeId=a}):e.activeId=void 0}}]),discovery.controller("NvScreenMenuCtrl",["$scope","$stateParams","$http","$uibModal","$filter","ModalUtils","$timeout",function(e,t,a,r,n,i,o){"ngInject";var s="screenTreeID",l=[],c="dashboard/updateBoard.do";e.TYPE_LIST=[{name:"左",type:"left"}];var d=n("translate");e.screenList=[{id:"Screen",text:d("我的看板"),parent:"#",state:{disabled:!0}}];var u=function(){a.get("admin/getBoardListUser.do").success(function(t){for(var a=0;a<t.length;a++)t[a].resId=t[a].id;e.screenList=t,e.searchNode(),p()})};u();var f=function(t,a,r){if(!(_.isUndefined(t)||_.isUndefined(a)||_.isUndefined(r))){var n=_.find(e.screenList,function(e){return e.resId==r}),i=_.find(e.screens,function(e){return e.id==t});i.type[a]={dashboardId:r,menuId:t,name:n.name,type:a}}};e.emptyBoard=function(e){e.dashboardId="",e.name=""},e.saveScreen=function(e){var t=[];if(e.type)for(var a in e.type)t.push(e.type[a]);$.ajax({type:"POST",url:baseUrl+"screens/saveScreenList.do",dataType:"json",data:{menuItemList:JSON.stringify(t),id:e.id,title:e.title,status:e.status},success:function(e){e.falg>0?i.alert("保存成功","modal-warning","sm"):i.alert("保存失败","modal-warning","sm")}})},e.deleteScreen=function(e){i.confirm(d("COMMON.CONFIRM_DELETE"),"modal-info","sm",function(){a.post("screens/deleteScreenList.do",{id:e.id}).success(function(e){e.falg>0?(p(),i.alert("删除成功","modal-warning","sm")):i.alert("删除失败","modal-warning","sm")})})},e.updateScreenSort=function(e,t,r){"desc"==r&&(r="0"),_.isUndefined(r)&&(r="1"),a.post("screens/updateScreenSort.do",{id:e,orderId:t,sortId:r}).success(function(e){e>0&&p()})},1==e.screenStatus;var p=function(){e.screenItem=[],a.get("screens/getScreenList.do").success(function(t){t=t.result;for(var a=0;a<t.length;a++){var r=t[a];if(r.dashboardScreenMenuItems){for(var n={},i=0;i<r.dashboardScreenMenuItems.length;i++){var o=r.dashboardScreenMenuItems[i];n[o.type]=o;var s=_.find(e.screenList,function(e){return e.resId==o.dashboardId});s&&(o.name=s.name)}r.type=n}}e.screens=t}),$("#screens").sortable(),$("#screens").disableSelection(),$(document).on("sortdeactivate","#screens",function(e,t){var r=[],n=$(e.toElement).parents("ul");$(n).find("li").each(function(e,t){r.push({id:$(t).attr("id"),orderId:e})}),a({method:"POST",url:"screens/dragScreenSort.do",data:JSON.stringify(r),headers:{Accept:"application/json","Content-Type":"application/json"}}).success(function(e){})})};e.addScreeItem=function(){a.post("screens/addScreeItem.do").success(function(e){p()})},e.treeConfig=jsTreeConfig1,e.screenTreeConfig={core:{multiple:!0,animation:!0,error:function(e){},check_callback:!0,worker:!0},checkbox:{three_state:!1},version:1,plugins:["types","unique","dnd"]},e.screenTreeConfig=$.extend(!0,{},e.screenTreeConfig,e.treeConfig),e.searchNode=function(){var t={dsName:"",dsrName:""},a=e.screenList.map(function(t){var a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.dsName=e.keywords;else for(var r=e.keywords.split(" "),i=0;i<r.length;i++){var o=r[i].trim();"ds"==o.split(":")[0]&&(t.dsName=o.split(":")[1]),"dsr"==o.split(":")[0]&&(t.dsrName=o.split(":")[1])}l=jstree_CvtVPath2TreeData(n("filter")(a,{name:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(s,l),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100),$(document).on("dnd_stop.vakata.jstree",function(e,t){$(".dropable").removeClass("active");var a=t.event.target;a=$(a).parents(".dropable");var r=a.attr("menu_id"),n=a.attr("type");if(r)for(var i=t.data.nodes,o="",s=0;s<i.length;s++){var l=i[s];o=t.data.origin._model.data[l].original.id}a.attr("border_id",o),f(r,n,o)}),$(document).on("dnd_move.vakata.jstree",function(e,t){var a=$(t.event.target);a=$(a.parents(".dropable"));var r=a.attr("menu_id");void 0!=r&&($(".dropable").removeClass("active"),a.addClass("active"))})},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:o,treeID:s,listName:"screenList",updateUrl:c,ModalUtils:i,categoryList:"categoryList"});return t}()}]),discovery.controller("NvStatisticsCtrl",["$scope","$stateParams","$http","$uibModal","$filter","ModalUtils",function(e,t,a,r,n,i){"ngInject";var o={ajax:{getAll:function(){o.ajax.getCubeAllMess()},getCubeAllMess:function(){return a.get("statistics/getCubeAllMessList.do").success(function(t){e.cubeList=t})},getWidgetAllMess:function(){return a.get("statistics/getWidgetAllMessList.do").success(function(t){e.widgetList=t})}}};o.ajax.getAll()}]),discovery.controller("NvTypeControlCtrl",["$scope","$http","ModalUtils","$filter",function(e,t,a,r){"ngInject";var n=r("translate");e.optFlag="none",e.categoryList={},e.alerts=[],e.verify={categoryName:!0};var i=function(){t.get("dashboard/getCategoryList.do").success(function(t){e.categoryList=t})},o=function(){e.verify={categoryName:!0},e.$emit("categoryChange")};i(),e.newBordCategory=function(){e.optFlag="new",e.curCategory={}},e.editBordCategory=function(t){e.optFlag="edit",e.curCategory=angular.copy(t)},e.deleteBordCategory=function(r){a.confirm(n("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){t.post("dashboard/deleteCategory.do",{id:r.id}).success(function(){e.optFlag="none",i(),o()})})};var s=function(){return e.alerts=[],!!e.curCategory.name||(e.alerts=[{msg:n("CONFIG.CATEGORY.NAME")+n("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={categoryName:!1},$("#CategoryName").focus(),!1)};e.save=function(){s()&&("new"==e.optFlag?t.post("dashboard/saveNewCategory.do",{json:angular.toJson(e.curCategory)}).success(function(t){"1"==t.status?(e.optFlag="none",i(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm"),o()):e.alerts=[{msg:t.msg,type:"danger"}]}):t.post("dashboard/updateCategory.do",{json:angular.toJson(e.curCategory)}).success(function(t){"1"==t.status?(e.optFlag="none",i(),a.alert(n("COMMON.SUCCESS"),"modal-success","sm"),o()):e.alerts=[{msg:t.msg,type:"danger"}]}))}}]),discovery.controller("NvDataSourceCtrl",["$scope","$http","ModalUtils","$uibModal","$filter","$q",function(e,t,a,r,n,i){"ngInject";var o=n("translate");e.optFlag="none",e.dsView="",e.curDatasource={},e.alerts=[],e.verify={dsName:!0,provider:!0},e.params=[];var s=function(){t.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t})};s(),t.get("dashboard/getProviderList.do").success(function(t){e.providerList=t}),e.newDs=function(){e.optFlag="new",e.curDatasource={config:{}},e.dsView=""},e.editDs=function(t){e.optFlag="edit",e.curDatasource=angular.copy(t),e.changeDsView(),e.doDatasourceParams()},e.deleteDs=function(r){var n=[],l=[],c=t.get("dashboard/getAllDatasetList.do").then(function(e){if(!e)return!1;for(var t=0;t<e.data.length;t++)e.data[t].data&&e.data[t].data.datasource==r.id&&n.push(e.data[t].name)}),d=t.get("dashboard/getAllWidgetList.do").then(function(e){if(!e)return!1;for(var t=0;t<e.data.length;t++)e.data[t].data&&e.data[t].data.datasource==r.id&&l.push(e.data[t].name)}),u=i.all([c,d]);u.then(function(){if(n.length>0||l.length>0){var i="   ";return n.length>0&&(i+="   "+o("CONFIG.DATASET.DATASET")+": ["+n.toString()+"]"),l.length>0&&(i+="   "+o("CONFIG.WIDGET.WIDGET")+": ["+l.toString()+"]"),a.alert(o("COMMON.NOT_ALLOWED_TO_DELETE_BECAUSE_BE_DEPENDENT")+i,"modal-warning","lg"),!1}a.confirm(o("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){t.post("dashboard/deleteDatasource.do",{id:r.id}).success(function(t){"1"==t.status?s():a.alert(t.msg,"modal-warning","lg"),e.optFlag="none"})})})},e.copyDs=function(r){var n=angular.copy(r);n.name=n.name+"_copy",t.post("dashboard/saveNewDatasource.do",{json:angular.toJson(n)}).success(function(t){"1"==t.status?(e.optFlag="none",s(),a.alert(o("COMMON.SUCCESS"),"modal-success","sm")):a.alert(t.msg,"modal-warning","lg")})},e.changeDsView=function(){e.dsView="dashboard/getDatasourceView.do?type="+e.curDatasource.type},e.doDatasourceParams=function(){t.get("dashboard/getDatasourceParams.do?type="+e.curDatasource.type).then(function(t){e.params=t.data})},e.changeDs=function(){e.changeDsView(),e.curDatasource.config={},t.get("dashboard/getDatasourceParams.do?type="+e.curDatasource.type).then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curDatasource.config[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curDatasource.config[r]=n):e.curDatasource.config[r]=Number(n)}})};var l=function(){if(e.alerts=[],null==e.curDatasource.type)return e.alerts=[{msg:o("CONFIG.DATA_SOURCE.DATA_PROVIDER")+o("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={provider:!1},!1;if(!e.curDatasource.name)return e.alerts=[{msg:o("CONFIG.DATA_SOURCE.NAME")+o("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curDatasource.config[a];if(1==n&&0!=i&&(void 0==i||""==i)){var s=/([\w_\s\.]+)/,l=s.exec(r);return l=l&&l.length>0?o(l[0]):r,e.alerts=[{msg:"["+l+"]"+o("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0};e.saveNew=function(){l()&&t.post("dashboard/saveNewDatasource.do",{json:angular.toJson(e.curDatasource)}).success(function(t){"1"==t.status?(e.optFlag="none",s(),e.verify={dsName:!0,provider:!0},a.alert(o("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.saveEdit=function(){l()&&t.post("dashboard/updateDatasource.do",{json:angular.toJson(e.curDatasource)}).success(function(t){"1"==t.status?(e.optFlag="none",s(),e.verify={dsName:!0,provider:!0},a.alert(o("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})},e.test=function(){var a=e.curDatasource;r.open({templateUrl:"src/view/config/modal/test.html",windowTemplateUrl:"src/view/util/modal/window.html",size:"lg",backdrop:!1,controller:["$scope","$uibModalInstance",function(e,r){e.datasource=a,e.alerts=[],e.close=function(){r.close()},e.curWidget={query:{}},t.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=test.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}});var n=function(){for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var s=/([\w_\s\.]+)/,l=s.exec(r);return l=l&&l.length>0?o(l[0]):r,e.alerts=[{msg:"["+l+"]"+o("COMMON.NOT_EMPTY"),type:"danger"}],!1}}return!0};e["do"]=function(){n()&&t.post("dashboard/test.do",{datasource:angular.toJson(e.datasource),query:angular.toJson(e.curWidget.query)}).success(function(t){"1"!=t.status?e.alerts=[{msg:t.msg,type:"danger"}]:e.alerts=[{msg:o("COMMON.SUCCESS"),type:"success"}]})}}]})}}]),discovery.controller("NvDocsAnalyse",["$scope","$stateParams","$http","$filter","$timeout","EventService",function(e,t,a,r,n,i){"ngInject";var o="screen/analyse.json";e.inputMode=!0,e.sectionList=[],e.tooltipStyle={display:"none"};var s=function(t){a.post(o,{text:t}).success(function(t){e.infoList=t.info,e.title=t.title;for(var a=[],r=0;r<t.text.length;r++){for(var n=t.text[r],i=n.split(/{{|}}/),o=[],s=0;s<i.length;s++){var c=l(i[s]);o.push(c)}a.push({text:t.text[r],arr:o})}e.sectionList=a})};e.analyse=function(){e.inputMode=!1,s()},e.back=function(){e.inputMode=!0};e.resultIt=function(t,a,r){if(e.selectedSection=t,$("#tooltip").hide(),"M"==a.type){var n=$(r.currentTarget),i={left:n.position().left+n.width()-20,top:n.position().top+n.height()+20};e.tooltipInfo=e.infoList[a.id],e.tooltipStyle=i,$("#tooltip").show()}},e.mouseOver=function(){},e.click=function(e){i.send({title:"3TV_route:page_change",addressee:"all",center:"preview.html#/nv/docs/result/"+e.join(",")})};var l=function(e){var t=e.split("||");return"M"==t[0]?{type:"M",text:t[1],id:t[2]}:"D"==t[0]?{type:"D",text:t[1]}:{type:"text",text:e}};s(),$(".textareaMode").on("scroll",function(){$("#tooltip").hide()})}]),discovery.controller("NvDocsResult",["$scope","$stateParams","$http","$filter","$timeout",function(e,t,a,r,n){"ngInject";e.test="NvDocsResult",
console.log(t.id)}]),discovery.controller("NvDocsRelatedWidgetCtrl",["$scope","$stateParams","$http","$filter","$timeout",function(e,t,a,r,n){"ngInject";e.test="NvDocsRelatedWidgetCtrl",console.log(t.id)}]),discovery.controller("NvDocsWidgetCtrl",["$q","$state","$scope","$stateParams","chartService","$http","$filter","$timeout","EventService",function(e,t,a,r,n,i,o,s,l){"ngInject";a.datasetFilters=[],a.widgetFilters=[];var c=function(t){var r=e.defer();if(t.widgetList){a.isWidgetList=!0;var n=t.widgetList;$.get("docs/result.do",{widgetList:n}).success(function(e){r.resolve(e)})}else t.datasetId&&(a.isWidgetList=!1,$.get("dashboard/getWidgetListByDatasetId.do",{datasetId:t.datasetId}).success(function(e){r.resolve(e)}));return r.promise},d={filter:{injectFilter:function(e){return e.data.config.boardFiltersByInit?delete e.data.config.boardFiltersByInit:(e.data.config.boardFilters=[],_.isUndefined(e.data.datasetId)?e.data.config.boardFilters=a.widgetFilters[e.id]:e.data.config.boardFilters=a.datasetFilters[e.data.datasetId]),e}},widget:{rendWidget:function(e,t){d.widget.buildRender(e,t)},loadWidget:function(e){_.isUndefined(e)&&(e=!1),_.each(a.widgetList,function(t){(_.isUndefined(t.hasRole)||t.hasRole)&&d.widget.rendWidget(t,e)})},buildRender:function(e,t){e.render=function(a,r,i){n.render(a,d.filter.injectFilter(e.widget).data,r,i,t,void 0,e.theme).then(function(t){e.realTimeTicket=t,e.loading=!1}),e.realTimeOption={optionFilter:r,scope:i}},e.modalRender=function(a,r,i){e.modalRealTimeTicket=n.render(a,d.filter.injectFilter(e.widget).data,r,i,t,void 0,e.theme),e.modalRealTimeOption={optionFilter:r,scope:i}}}}};c(r).then(function(e){for(var t=[],r=!1,n=0;n<e.length;n++)r=e[n].data.datasetId,t.push({show:!1,name:e[n].name,widget:e[n]});a.widgetList=t,r&&a.isWidgetList&&l.send({title:"3TV_route:page_change",addressee:"all",right:"preview.html#/nv/docs/related/dataset/"+r}),d.widget.loadWidget()}),a.editDocsWidget=function(e){l.send&&l.send({title:"3TV_route:page_change",addressee:"all",right:"/#/nv/explore/"+e})}}]);var jsTreeConfig1={core:{multiple:!1,animation:!0,error:function(e){},check_callback:function(e,t,a,r,n){return"move_node"!==e||("parent"==a.id.substring(0,6)||"root"==a.id.substring(0,4))},worker:!0},types:{"default":{valid_children:["default","file"]},file:{icon:"glyphicon glyphicon-file"}},dnd:{check_while_dragging:!0},state:{key:"cboard"},version:1,plugins:["types","unique","state","sort","dnd"]},jstree_CopyNode=function(e){return function(){jstree_CheckTreeNode(e.actionType,e.treeID)&&e.copyFunction(e.oldNode)}};discovery.service("ModalUtils",["$uibModal","$filter",function(e,t){"ngInject";var a=t("translate");this.alert=function(t,r,n,i){e.open({templateUrl:"src/view/util/modal/alert.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,windowClass:r,size:n,controller:["$scope","$uibModalInstance",function(e,r){t?e.content=t:e.content=a("CONFIG.DASHBOARD.DASHBOARD_SOMETHING_WRONG"),e.ok=function(){r.close(),i&&i()}}]})},this.confirm=function(t,r,n,i,o){e.open({templateUrl:"src/view/util/modal/confirm.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,windowClass:r,size:n,controller:["$scope","$uibModalInstance",function(e,r){t?e.content=t:e.content=a("CONFIG.DASHBOARD.DASHBOARD_SOMETHING_WRONG"),e.ok=function(){r.close(),i&&i()},e.close=function(){r.close(),o&&o()}}]})}}]),discovery.directive("nvDashboardWidget",["$compile","$templateCache","dataService","chartService",function(e,t,a,r){"ngInject";var n=function(a,r,n){var i=t.get("nvEchartContent");a.myheight=a.height;var o=e(i);r.append(o(a));var s=$(r).find(".box-body");a.widget.render&&a.widget.render(s,null,a)},i=function(a,r,n){var i=t.get("nvD3Content");a.myheight=a.height;var o=e(i);r.append(o(a));var s=$(r).find(".box-body");a.widget.render&&a.widget.render(s,null,a)},o=function(a,r,n){var i=t.get("nvChartContent");a.myheight=a.height;var o=e(i);r.append(o(a));var s=$(r).find(".box-body");a.widget.render(s,null,a)},s=function(a,r,n){var i=t.get("nvKpiContent"),o=e(i)(a);r.append(o);var s=$(r).find(".kpi-body");a.widget.render(s,null,a)},l=function(a,r,n){var i=t.get("nvChartContent");a.myheight=a.height;var o=e(i)(a);r.append(o);var s=$(r).parents(".box");a.myheight=s.height()-s.children(".box-header").height();var l=$(r).find(".box-body");a.widget.render&&a.widget.render(l,null,a)};return{restrict:"EA",scope:!0,compile:function(e,t){return{pre:function(e,t,a){},post:function(e,t,a){switch(e.widget.widget.data.config.chart_type){case"cityMap":n(e,t,a);break;case"zoneMap":n(e,t,a);break;case"line":n(e,t,a);break;case"line2":n(e,t,a);break;case"line3":n(e,t,a);break;case"pie":n(e,t,a);break;case"flexChart":n(e,t,a);break;case"kpi":s(e,t,a);break;case"table":l(e,t,a);break;case"dataLineTable":l(e,t,a);break;case"funnel":n(e,t,a);break;case"sankey":n(e,t,a);break;case"chord":n(e,t,a);break;case"barPolarStack":n(e,t,a);break;case"pieProportion":n(e,t,a);break;case"radar":n(e,t,a);break;case"map":o(e,t,a);break;case"scatter":n(e,t,a);break;case"gauge":n(e,t,a);break;case"wordCloud":n(e,t,a);break;case"treeMap":n(e,t,a);break;case"areaMap":n(e,t,a);break;case"heatMapCalendar":n(e,t,a);break;case"heatMapTable":n(e,t,a);break;case"markLineMap":n(e,t,a);break;case"liquidFill":n(e,t,a);break;case"rose":n(e,t,a);break;case"flexD3Chart":i(e,t,a);break;default:i(e,t,a)}}}}}}]),discovery.controller("renderCtrl",["$scope","$state","$stateParams","$http","$uibModal","dataService","ModalUtils","updateService","$filter","chartService",function(e,t,a,r,n,i,o,s,l,c){"ngInject";var d=function(t){r.get("dashboard/getWidgetList.do").success(function(t){e.widgetList=t;var r=u(a.wid);r={widget:r},f.widget.rendWidget(r,!1),e.previewList[0]=r})};d();var u=function(t){return _.find(e.widgetList,function(e){return e.id==t})};e.previewList=[],e.datasetFilters={},e.widgetFilters={};var f={filter:{injectFilter:function(t){return t.data.config.boardFilters=[],_.isUndefined(t.data.datasetId)?t.data.config.boardFilters=e.widgetFilters[t.id]:t.data.config.boardFilters=e.datasetFilters[t.data.datasetId],t}},widget:{rendWidget:function(e,t){f.widget.buildRender(e,t),e.loading=!0,e.show=!0},buildRender:function(e,t){e.render=function(a,r,n){c.render(a,f.filter.injectFilter(e.widget).data,r,n,t).then(function(t){e.realTimeTicket=t,e.loading=!1,$("body").append('<div class="persistFinish"></div>')}),e.realTimeOption={optionFilter:r,scope:n}}}}}}]),discovery.controller("AddDashboardCtrl",["$scope","$rootScope","$location","$http","$filter","$uibModalInstance",function(e,t,a,r,n,i){"ngInject";var o=n("translate");e.dashboardType=null,e.categoryList=[];var s={ajax:{addDashboard:function(e,n){var o={json:angular.toJson({layout:{rows:[]},categoryId:n,name:e})};r.post("dashboard/saveNewBoard.do",o).success(function(e){var r=e.uuid;r&&a.url("/nv/dashboard/default/"+r),i.close(),t.$broadcast("boardChange")})},getCategoryList:function(){r.get("dashboard/getCategoryList.do").success(function(t){e.categoryList=[{id:null,name:o("CONFIG.DASHBOARD.MY_DASHBOARD")}],_.each(t,function(t){e.categoryList.push(t)})})}}};e.ok=function(){e.dashboardName&&s.ajax.addDashboard(e.dashboardName,e.dashboardType)},e.cancel=function(){i.dismiss("cancel")},s.ajax.getCategoryList()}]).controller("nvHomeCtrl",["$scope","$rootScope","$http","$uibModal","ModalUtils","$filter","$location",function(e,t,a,r,n,i,o){"ngInject";var s=i("translate");e.dashboardName="";var l={ajax:{getAll:function(){l.ajax.getBoardList(),l.ajax.getAllDemandList(),l.ajax.getDemandRight()},getBoardList:function(){return a.get("admin/getBoardListUser.do").success(function(t){e.boardList=t})},getDatasetList:function(){return a.get("admin/getDatasetListUser.do").success(function(t){e.datasetList=t})},getWidgetList:function(){return a.get("admin/getWidgetListUser.do").success(function(t){e.widgetList=t})},getAllDemandList:function(){return a.get("dashboard/getAllDemandList.do").success(function(t){e.demandList=t})},getDemandRight:function(){return a.get("admin/getDemandRight.do").success(function(t){e.demandRight=t})},deleteBoard:function(e,t){n.confirm(s("COMMON.CONFIRM_DELETE"),"modal-warning","sm",function(){a.post("dashboard/deleteBoard.do",{id:e}).success(t)})}}};l.ajax.getAll(),e.openDashboardModel=function(){r.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"addDashboardModel.html",size:"sm",controller:"AddDashboardCtrl"})},e.removeDashboard=function(e){l.ajax.deleteBoard(e,function(e){"1"==e.status?(l.ajax.getBoardList(),t.$broadcast("boardChange"),n.alert(e.msg,"modal-success","sm")):n.alert(e.msg,"modal-warning","lg")})},e.updateStatus=function(e,t){a.post("dashboard/updateStatus.do",{id:e,status:t}).success(function(e){"1"==e.status?(l.ajax.getAllDemandList(),n.alert(e.msg,"modal-success","sm")):n.alert(e.msg,"modal-warning","lg")})},e.goToUploadExcel=function(){o.url("/nv/excel/upload")}}]),discovery.controller("nvCubeCtrl",["$scope","$state","$http","$stateParams","dataService","$uibModal","ModalUtils","$filter","chartService","$timeout","uuid4",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";var u=s("translate");e.optFlag="none",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},e.alerts=[],e.verify={dsName:!0},e.loadFromCache=!0,e.queryAceOpt=cbAcebaseOption,e.hierarchy=u("CONFIG.DATASET.HIERARCHY"),e.uuid4=d,e.params=[],e.colSearch={row:[]},e.tableSql=null,e.userInfo=USER_INFO_MAP,e.filterCols=[];var f="dataSetTreeID",p=[],g="dashboard/updateDataset.do",m={};e.addFilter=function(){e.curDataset.data.backendFilters.push({sessionKey:"",cols:""})},e.deleteFilter=function(t){e.curDataset.data.backendFilters.splice(t,1)},e.addParam=function(){e.curDataset.data.schema.paramList.push({column:"",list:[],selectType:"single",selector:"single"}),e.showParamData.push("")},e.deleteParam=function(t){e.curDataset.data.schema.paramList.splice(t,1),e.showParamData.splice(t,1)},e.addComputed=function(){e.curDataset.data.schema.computedDimension.push({aggType:"",column:"",dependOn:[],formula:"",preCalc:""}),e.showDependOnDimension.push("")},e.addValueComputed=function(){e.curDataset.data.schema.computed.push({aggType:"",column:"",dependOn:[],formula:"",preCalc:""}),e.showDependOnValue.push("")},e.deleteComputed=function(t){e.curDataset.data.schema.computedDimension.splice(t,1),e.showDependOnDimension.splice(t,1)},e.deleteValueComputed=function(t){e.curDataset.data.schema.computed.splice(t,1),e.showDependOnValue.splice(t,1)},e.transToNum=function(e){e.style="number"},e.transToStr=function(e){e.style="string"},e.openSqlEditModal=function(){var t=e,r=i.open({animation:!0,templateUrl:"src/view/config/modal/editSqlModal.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,r){e.ftlSql=angular.copy(t.curDataset.data.query.sql),e.testResult="",e.ftlConfig={mode:"ftl",rendererOptions:{fontSize:"14px"}},e.sqlConfig={mode:"sql"},e.paramsList=t.curDataset.data.schema.paramList,e.params={},e.paramsList.forEach(function(t){e.params[t.column]=t.list[0]?t.list[0]:""}),e.close=function(){r.close({result:!1})},e.test=function(){var t={};e.paramsList.forEach(function(a){a.isSendParam&&("multiple"===a.selector?t[a.column]="'"+[e.params[a.column]].join("','")+"'":t[a.column]=e.params[a.column])}),a.post("dashboard/testTemplateSql.do",{param:angular.toJson(t),sql:e.ftlSql}).success(function(t){e.testResult=t.msg})},e.save=function(){r.close({result:!0,info:e.ftlSql})}}]});r.result.then(function(e){e.result&&(t.curDataset.data.query.sql=e.info)})},e.$watch("curDataset.data",function(t){var a={};a=e.curDataset.data.schema},!0),e.checkDimension=function(t){var r={columns:[],filters:[],events:[],rows:[],values:[{column:t,aggType:"sum"}]},n={};"undefined"==typeof n.param&&(n.param={}),n.param.cols="",r.rows.forEach(function(e){n.param.cols+="'"+e.columnName+"',"}),r.columns.forEach(function(e){n.param.cols+="'"+e.columnName+"',"}),n.param.pg_grpcols=n.param.cols=n.param.cols.slice(0,n.param.cols.length-1),a.post("/dashboard/getAggregateData.do",{query:angular.toJson(n),datasetId:e.curDataset.id,reload:!1,cfg:JSON.stringify(r)}).success(function(e){e.data&&o.alert("可用,总数:"+JSON.stringify(e.data),"modal-warning","sm")})},e.loadAggregateData=function(){for(var t={columns:[],filters:[],events:[],rows:[],values:[]},r=e.curDataset.data.schema,n=0;n<r.dimension.length;n++){var i=r.dimension[n];t.rows.push({columnName:i.column,filterType:"eq",values:[],id:i.id,style:i.style?i.style:"string"})}for(var n=0;n<r.measure.length;n++){var o=r.measure[n];t.rows.push({columnName:o.column,filterType:"eq",values:[],id:o.id,style:o.style?o.style:"string"})}var s={};"undefined"==typeof s.param&&(s.param={}),s.param.cols="",t.rows.forEach(function(e){s.param.cols+="'"+e.columnName+"',"}),t.columns.forEach(function(e){s.param.cols+="'"+e.columnName+"',"}),s.param.pg_grpcols=s.param.cols=s.param.cols.slice(0,s.param.cols.length-1),a.post("/dashboard/getAggregateData.do",{query:angular.toJson(s),datasetId:e.curDataset.id,reload:!1,cfg:JSON.stringify(t)}).success(function(t){e.aggregateData=t})},e.editDemand=function(){var t=i.open({animation:!0,templateUrl:"src/view/config/modal/demand.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.close=function(){t.close()},e.ok=function(){return e.name?void t.close({name:e.name,explaination:e.explaination}):void o.alert(u("CONFIG.DATASET.NAME")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]});t.result.then(function(t){a.post("dashboard/saveNewDemand.do",{name:t.name,explaination:t.explaination,datasetId:e.curDataset.id}).success(function(e){"1"==e.status?(o.alert(u("COMMON.SUCCESS"),"modal-success","sm"),x()):o.alert(e.msg,"modal-warning","lg")})})},e.onlyView=function(){return!_.isUndefined(r.onlyView)&&r.onlyView},e.goToCreateChart=function(){e.curDataset&&e.curDataset.id&&t.go("nv.explore_create_by",{cube_id:e.curDataset.id})},e.goToUploadExcel=function(){t.go("nv.excel.upload")},e.toTrash=function(e,t){var a=e[t];"column"==a.type&&(m[a.column]||(m[a.column]=[]),m[a.column].push(a)),e.splice(t,1)},e.dndTransfer={dimension:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})},measure:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})}},e.permissionSetting=function(){var e=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/permission/setting.html",size:"lg",controller:"permissionSettingCtrl",resolve:{config:function(){return{type:"dataset",id:T().id}}}});e.result.then(function(){})},a.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t,e.datasourceShowList=_.filter(t,function(e){return 0==e.isVersion})});var h=function(){a.get("dashboard/getDatasetNameList.do").success(function(t){e.datasetList=t,e.searchNode(),_.isUndefined(r.id)?e.insertId?(e.editDs(_.find(e.datasetList,function(t){return t.id==e.insertId})),e.insertId=null):e.datasetList.length>0&&_.isUndefined(e.curDataset.id)&&e.editDs(e.datasetList[0]):e.editDs(_.find(e.datasetList,function(e){return e.id==r.id}))})},v=function(){a.get("dashboard/getDatasetCategoryList.do").success(function(t){e.categoryList=t,$("#DatasetName").autocomplete({source:e.categoryList})})};e.dimMapList=[];var y=function(t){a.post("dataRelated/getDimMapList.do",{datasetId:t}).success(function(t){for(var a={},r=0;r<t.length;r++){var n=t[r];a[n.col]=n}e.dimMapList=a})};v(),h(),e.goEdit=function(){t.go("config.model",{dataSourceId:e.datasource.id,curDatasetId:e.curDataset.id})},e.replaceColsData={},e.replaceCols=function(){a({url:"db.csv",dataType:"text"}).success(function(t){for(var a=t.split("\n"),r=0;r<a.length;r++)if(r>0){var n=a[r].split(",");e.replaceColsData[n[0]+"."+n[2]]={cols:n[3],tableCols:n[1]+":"+n[3]}}for(var i in e.curDataset.data.schema.measure)e.replaceColsData[e.curDataset.data.schema.measure[i].column]&&(e.curDataset.data.schema.measure[i].alias||(e.curDataset.data.schema.measure[i].alias=e.replaceColsData[e.curDataset.data.schema.measure[i].column].cols));for(var o in e.curDataset.data.schema.dimension)e.replaceColsData[e.curDataset.data.schema.dimension[o].column]&&(e.curDataset.data.schema.dimension[o].alias||(e.curDataset.data.schema.dimension[o].alias=e.replaceColsData[e.curDataset.data.schema.dimension[o].column].cols))})},e.buildModel=function(){i.open({templateUrl:"src/view/config/modal/selectDataSource.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:["$scope","$uibModalInstance",function(e,r){e.datasourceList=null,e.currentDatasource=null,e.searchStr="";var n=function(){a.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t})};e.selectDataSource=function(t,a){e.currentDatasource=a;var r=t.target,n=window.$;n(".data-active").removeClass("data-active"),r.classList.add("data-active")},e.close=function(){r.close()},e.ok=function(){e.currentDatasource&&t.go("config.model",{dataSourceId:e.currentDatasource.id})},n()}]})},e.newDs=function(){e.optFlag="new",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},e.widgetList=[],e.selects=[],N()},e.openWidget=function(e){window.open("#/nv/explore/"+e,"widget")},e.editDs=function(t){a.get("dashboard/getDatasetById.do?id="+t.id).success(function(t){t=t[0],e.showParamData=[],t.data.schema.paramList&&_.each(t.data.schema.paramList,function(t,a){e.showParamData.push(t.list.join("\n"))}),e.showDependOnDimension=[],e.showDependOnValue=[],t.data.schema.computedDimension&&_.each(t.data.schema.computedDimension,function(t,a){e.showDependOnDimension.push(t.dependOn.join(","))}),t.data.schema.computed&&_.each(t.data.schema.computed,function(t,a){e.showDependOnValue.push(t.dependOn.join(","))}),a.post("dashboard/checkDatasource.do",{id:t.data.datasource}).success(function(r){a.get("dashboard/getWidgetListByDatasetId.do?datasetId="+t.id).success(function(t){e.widgetList=t}),"1"==r.status?(w(t),e.doConfigParams()):o.alert(u("ADMIN.CONTACT_ADMIN")+"：Datasource/"+r.msg,"modal-danger","lg")})})};var w=function(t){e.optFlag="edit",e.curDataset=angular.copy(t),e.curDataset.data.backendFilters||(e.curDataset.data.backendFilters=[]),e.curDataset.data.schema.paramList||(e.curDataset.data.schema.paramList=[]),e.curDataset.data.schema.computedDimension||(e.curDataset.data.schema.computedDimension=[]),e.curDataset.data.schema.computed||(e.curDataset.data.schema.computed=[]),e.showParamData||(e.showParamData=[]),e.showDependOnDimension||(e.showDependOnDimension=[]),e.showDependOnValue||(e.showDependOnValue=[]),e.filterCols=e.curDataset.data.schema.dimension.concat(e.curDataset.data.schema.measure),e.curDataset.name=e.curDataset.categoryName+"/"+e.curDataset.name,e.curDataset.data.expressions||(e.curDataset.data.expressions=[]),e.curDataset.data.filters||(e.curDataset.data.filters=[]),e.curDataset.data.schema||(e.curDataset.data.schema={dimension:[],measure:[]}),e.datasource=_.find(e.datasourceList,function(t){return t.id==e.curDataset.data.datasource}),e.curWidget.query=e.curDataset.data.query;for(var a in e.curDataset.data.schema){var r=e.curDataset.data.schema;for(var n in r){var i=r[n];for(var o in i)"undefined"===i[o].style&&(i[o].style="string")}}e.loadData()};e.checkExist=function(t){var a=_.find(e.curDataset.data.schema.measure,function(e){return e.column==t});return!_.isUndefined(a)||(a=_.find(e.curDataset.data.schema.dimension,function(e){if("level"==e.type){var a=_.find(e.columns,function(e){return e.column==t});return!_.isUndefined(a)}return e.column==t}),!_.isUndefined(a))},e.deleteDs=function(t){a.get("dashboard/getAllWidgetList.do").then(function(r){if(!r)return!1;for(var n=[],i=0;i<r.data.length;i++)r.data[i].data.datasetId==t.id&&n.push(r.data[i].name);if(n.length>0){var s=u("CONFIG.WIDGET.WIDGET")+":["+n.toString()+"]";return o.alert(u("COMMON.NOT_ALLOWED_TO_DELETE_BECAUSE_BE_DEPENDENT")+s,"modal-warning","lg"),!1}o.confirm(u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){a.post("dashboard/deleteDataset.do",{id:t.id}).success(function(t){"1"==t.status?h():o.alert(t.msg,"modal-warning","lg"),e.optFlag="none"})})})},e.copyDs=function(t){a.get("dashboard/getDatasetById.do?id="+t.id).success(function(t){var r=angular.copy(t[0]);r.name=r.name+"_copy",a.post("dashboard/saveNewDataset.do",{json:angular.toJson(r)}).success(function(t){"1"==t.status?(e.optFlag="none",h(),o.alert(u("COMMON.SUCCESS"),"modal-success","sm")):o.alert(t.msg,"modal-warning","lg")})})};var b=function(){if(e.alerts=[],!e.curDataset.name)return e.alerts=[{msg:u("CONFIG.DATASET.NAME")+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name;if("sql"!==a){var r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?u(s[0]):r,e.alerts=[{msg:"["+s+"]"+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}}return!0},C=function(e){e&&(window.location.href="/starter.html#/nv/cube/"+e)};e.save=function(){if(e.showParamData&&e.curDataset.data.schema.paramList)for(var t=0;t<e.showParamData.length;t++)e.showParamData[t].length>0&&e.curDataset.data.schema.paramList[t]&&(e.curDataset.data.schema.paramList[t].list=e.showParamData[t].split("\n"));if(e.showDependOnValue&&e.curDataset.data.schema.computed)for(var r=0;r<e.showDependOnValue.length;r++)e.curDataset.data.schema.computed[r].dependOn=e.showDependOnValue[r].split(",");if(e.showDependOnDimension&&e.curDataset.data.schema.computedDimension)for(var n=0;n<e.showDependOnDimension.length;n++)e.curDataset.data.schema.computedDimension[n].dependOn=e.showDependOnDimension[n].split(",");if(e.datasource?e.curDataset.data.datasource=e.datasource.id:null,e.curDataset.data.query=e.curWidget.query,b()){var i=angular.copy(e.curDataset),s=i.name.lastIndexOf("/");i.categoryName=e.curDataset.name.substring(0,s).trim(),i.name=e.curDataset.name.slice(s+1).trim(),""==i.categoryName&&(i.categoryName=u("COMMON.DEFAULT_CATEGORY")),i.loadFromCache=e.loadFromCache,"new"==e.optFlag?a.post("dashboard/saveNewDataset.do",{json:angular.toJson(i)}).success(function(t){"1"==t.status?(t.id&&(e.insertId=t.id),v(),h(),e.verify={dsName:!0},o.alert(u("COMMON.SUCCESS"),"modal-success","sm"),C(t.uuid)):e.alerts=[{msg:t.msg,type:"danger"}]}):a.post(g,{json:angular.toJson(i)}).success(function(t){"1"==t.status?(e.optFlag="edit",v(),h(),e.verify={dsName:!0},o.alert(u("COMMON.SUCCESS"),"modal-success","sm"),C(t.uuid)):e.alerts=[{msg:t.msg,type:"danger"}]})}},e.editFilterGroup=function(t){var a=I(e.curDataset.data.schema);i.open({templateUrl:"src/view/config/modal/filterGroup.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,scope:e,controller:["$scope","$uibModalInstance",function(e,r){t?e.data=angular.copy(t):e.data={group:"",filters:[],id:d.generate()},e.selects=a,e.close=function(){r.close()},e.addColumn=function(t){e.data.filters.push({col:t,type:"=",values:[]})},e.ok=function(){t?(t.group=e.data.group,t.filters=e.data.filters):(null==e.$parent.curDataset.data.filters&&(e.$parent.curDataset.data.filters=[]),e.$parent.curDataset.data.filters.push(e.data)),r.close()},e.editFilter=function(t){i.open({templateUrl:"src/view/nv/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return angular.copy(t)},filter:function(){return!1},getSelects:function(){return function(t,a,r){n.getDimensionValues(e.datasource.id,e.curWidget.query,void 0,a,void 0,function(e){r(e)})}},ok:function(){return function(e){t.type=e.type,t.values=e.values}}},controller:"paramSelector"})}}]})},e.deleteFilterGroup=function(t){o.confirm(u("COMMON.FILTER_GROUP")+": ["+e.curDataset.data.filters[t].group+"], "+u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.filters.splice(t,1)})};var I=function(e){if(e.selects)return angular.copy(e.selects);var t=[];return t=t.concat(e.measure),_.each(e.dimension,function(e){"level"==e.type?_.each(e.columns,function(e){t.push(e)}):t.push(e)}),angular.copy(t)};e.editExp=function(t){var a,r=I(e.curDataset.data.schema),n=[{name:"sum",value:"sum"},{name:"count",value:"count"},{name:"avg",value:"avg"},{name:"max",value:"max"},{name:"min",value:"min"}],s={expression:""};t?(s.expression=t.exp,s.alias=t.alias,a=function(e){t.exp=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.expressions.push({type:"exp",exp:s.expression,alias:s.alias,id:d.generate()})},i.open({templateUrl:"src/view/config/modal/exp.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=s,e.selects=r,e.aggregate=n,e.alerts=[],e.expAceOpt=expEditorOptions(r,n),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.verify=function(){e.alerts=[];var t=verifyAggExpRegx(e.data.expression);e.alerts=[{msg:t.isValid?u("COMMON.SUCCESS"):t.msg,type:t.isValid?"success":"danger"}]},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.deleteExp=function(t){o.confirm(u("CONFIG.COMMON.CUSTOM_EXPRESSION")+": ["+e.curDataset.data.expressions[t].alias+"], "+u("COMMON.CONFIRM_DELETE"),"modal-warning","lg",function(){e.curDataset.data.expressions.splice(t,1)})},e.editMea=function(t){var a,r=I(e.curDataset.data.schema),n=[{name:"+",value:"+"},{name:"-",value:"-"},{name:"*",value:"*"},{name:"/",value:"/"}],s={expression:""};t?(s.expression=t.column,s.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){e.curDataset.data.schema.measure.push({type:"column",column:s.expression,alias:s.alias,id:d.generate()})},i.open({templateUrl:"src/view/config/modal/measure.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=s,e.selects=r,e.aggregate=n,e.alerts=[],e.expAceOpt=expEditorOptions(r,n),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.deleteTree=function(){e.curDataset.data.schema.computed=[],e.curDataset.data.schema.computedDimension=[],e.curDataset.data.schema.dimension=[],e.curDataset.data.schema.measure=[],e.curDataset.data.schema.paramList=[]},e.editDim=function(t){var a,r=I(e.curDataset.data.schema),n={expression:""};t?(n.expression=t.column,n.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){var r={type:"column",column:n.expression,alias:n.alias,id:d.generate(),style:"string"};e.curDataset.data.schema.dimension.push(r)},i.open({templateUrl:"src/view/config/modal/dimension.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=n,e.selects=r,e.alerts=[],e.expAceOpt=expEditorOptions(r,""),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void o.alert(u("CONFIG.WIDGET.ALIAS")+u("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.createNode=function(e){if(m[e.column]){var t=m[e.column].pop();if(t)return t}return e.style="string",e.id=d.generate(),e},e.measureToDimension=function(t,a){e.curDataset.data.schema.measure.splice(t,1),e.curDataset.data.schema.dimension.push(a)},e.toDimension=function(t){e.curDataset.data.schema.dimension.push(e.createNode(t))},e.toAllDimension=function(){_.each($("#cubeSelects").val(),function(t){e.curDataset.data.schema.dimension.push(e.createNode({type:"column",column:t}))})},e.toAllValue=function(){_.each($("#cubeSelects").val(),function(t){e.curDataset.data.schema.measure.push(e.createNode({type:"column",column:t}))})},e.clearSelected=function(){$("#cubeSelects").val("")},e.custom=function(t){var a=e.selects,r=e.datasource;i.open({templateUrl:"src/view/config/modal/custom.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"sm",controller:["$scope","$uibModalInstance",function(e,n){e.c=t,e.ok=function(){n.close()},e.customAceOpt=schemaCustomOpt(a,r.type)}]})};var x=function(){if(e.curDataset.id)return a.get("dashboard/getDatesetDemandList.do?datasetId="+e.curDataset.id).success(function(t){y(e.curDataset.id),e.demandList=t})};e.getSql=function(){a.post("dashboard/getKylinSql.do",{datasetId:e.curDataset.id,query:angular.toJson(e.curWidget.query),datasourceId:e.datasource.id}).success(function(t){e.curWidget.query.sql=t.sql})},e.preview=function(){e.tableSql=e.curWidget.query.sql},e.loadData=function(){N(),e.loading=!0,n.getColumns({datasource:e.datasource.id,query:e.curWidget.query,datasetId:null,paramList:e.curDataset.data.schema,reload:!e.loadFromCache,callback:function(t){e.loading=!1,e.toChartDisabled=!1,"1"==t.msg?(e.alerts=[],e.selects=t.columns):e.alerts=[{msg:t.msg,type:"danger"}];var a={chart_type:"table",filters:[],groups:[],keys:[],selects:[],values:[{cols:[]}]};_.each(e.selects,function(e){a.keys.push({col:e,type:"eq",values:[]})})}}),x()},e.updateStatus=function(e,t){a.post("dashboard/updateStatus.do",{id:e,status:t}).success(function(e){"1"==e.status?(x(),o.alert(e.msg,"modal-success","sm")):o.alert(e.msg,"modal-warning","lg")})};var N=function(){$("#dataset_preview").html("")};e.treeConfig=jsTreeConfig1,$("#"+f).keyup(function(t){46==t.keyCode&&e.deleteNode()});var T=function(){var t=jstree_GetSelectedNodes(f)[0];return _.find(e.datasetList,function(e){return e.id==t.id})},D=function(e){return jstree_CheckTreeNode(e,f,o.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyNode=function(){D("copy")&&e.copyDs(T())},e.editNode=function(){D("edit")&&e.editDs(T())},e.deleteNode=function(){D("delete")&&e.deleteDs(T())},e.searchNode=function(){var t={dsName:"",dsrName:""},a=e.datasetList.map(function(t){var a=_.find(e.datasourceList,function(e){var a=t.data;if(a)return e.id==a.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.dsName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var i=r[n].trim();"ds"==i.split(":")[0]&&(t.dsName=i.split(":")[1]),"dsr"==i.split(":")[0]&&(t.dsrName=i.split(":")[1])}p=jstree_CvtVPath2TreeData(s("filter")(a,{name:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(f,p),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100)},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:c,
treeID:f,listName:"datasetList",updateUrl:g});return t}(),e.doConfigParams=function(){a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data})},e.changeDs=function(){e.curWidget.query={},a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}})},e.queryAceOpt=datasetEditorOptions(),e.setDataRelated=function(t,a,r){var n=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"setDataRelated.html",size:"md",controller:"SetDataRelatedCtrl",resolve:{column:function(){return t.column},id:function(){return t.id},datasetId:function(){return a},commonId:function(){return r?r.commonId:null}}});n.result.then(function(t){y(e.curDataset.id)},function(){})}}]).controller("SetDataRelatedCtrl",["commonId","datasetId","column","id","$scope","$rootScope","$http","$uibModalInstance","ModalUtils","$filter","$location",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";n.activeCommonId=e;var u=function(){o.get("dataRelated/getDataRelatedList.do").success(function(e){n.dataRelatedList=e})};u(),n.changeDataRelated=function(e){n.activeCommonId!=e?n.activeCommonId=e:n.activeCommonId=""},n.ok=function(){o.post("dataRelated/saveDataRelated.do",{datasetId:t,commonId:n.activeCommonId,col:a,colId:r}).success(function(e){s.close(n.activeCommonId)})},n.cancel=function(){s.dismiss("cancel")}}]);var isNumber=function(e){var t=/^\d+(\.\d+)?$/,a=/^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/;return!(!t.test(e)&&!a.test(e)&&"number"!=typeof e)};discovery.controller("nvJsMindCtrl",["$compile","$templateCache","$scope","$stateParams","ModalUtils","chartService","$uibModal","$http","$filter","$state",function(e,t,a,r,n,i,o,s,l,c){"ngInject";function d(){s.get("dashboard/getWidgetList.do").success(function(e){a.widgetList=e,s.get("mindmap/getMindmapData.do?id="+r.id).success(function(e){a.categoryName=e.categoryName,a.mind=JSON.parse(e.json),a.mind.jsMind.data.id=e.id;var t={container:"jsmind_container",editable:!0,theme:"warning",support_html:!0,view:{hmargin:100,vmargin:50,line_width:2,line_color:"#e3d9f2"}},r=jsMind.show(t,a.mind.jsMind);u(),a.jsMind=r})})}function u(){_.each(a.mind.widget,function(e){var t=_.find(a.widgetList,function(t){return t.id==e.widgetId});v(t,e.nodeId)})}function f(e){e.children.length?confirm("删除该节点将同时删除下属子节点，是否确认删除？")&&a.jsMind.remove_node(e):a.jsMind.remove_node(e)}var p=l("translate");a.widgetMindList=[],a.widgetList=[],a.mind=null,a.categoryName=null,d(),$.contextMenu({selector:"jmnode",build:function(e,t){return{callback:function(t,r){var n=a.jsMind.get_selected_node();switch(a.nodeId=e.attr("nodeid"),t){case"chart":m(n);break;case"text":g(n);break;case"delete":f(n);break;case"new":c.go("nv.explore_create")}},items:{chart:{name:"插入图表"},text:{name:"插入文字"},"new":{name:"新建图表"},sep1:"---------","delete":{name:"删除节点"}}}}});var g=function(e){var t=o.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addJsMindNodeModel.html",size:"sm",controller:"addJsMindNodeCtrl"});t.result.then(function(t){var r=jsMind.util.uuid.newid();a.jsMind.add_node(e,r,t)},function(){console.info("Modal dismissed at: "+new Date)})},m=function(e){var t=o.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addWidgetModel.html",size:"sm",controller:"AddWidgetModelCtrl"});t.result.then(function(t){var r=jsMind.util.uuid.newid(),n="图表-"+r.substr(0,5),i={width:"300",height:"328"};a.jsMind.add_node(e,r,n,i);v(t,r)},function(){console.info("Modal dismissed at: "+new Date)})},h=function(r,n){var i=$('jmnode[nodeid="'+n+'"]'),o=t.get("jsMindContent"),s=e(o);i.addClass("isChart"),i.empty(),i.append(s(r));var l=i.find(".chart-title"),c=window.location.pathname+"#/nv/explore/"+r.widget.widgetId;l.append('<a href="'+c+'" target="_blank" style="text-decoration: underline;">'+r.widget.name+"</a>");var d=i.find(".box-body");r.widget.render(d,null,r),a.widgetMindList.push({nodeId:n,widgetId:r.widget.widgetId})},v=function(e,t){var r={name:e.name,widgetId:e.id,widget:e};y(r,!1),h(a,t)},y=function(e,t){e.render=function(a,r,n){i.render(a,e.widget.data,r,n,t,void 0,e.theme).then(function(t){e.realTimeTicket=t,e.loading=!1}),e.realTimeOption={optionFilter:r,scope:n}},e.modalRender=function(a,r,n){e.modalRealTimeTicket=i.render(a,e.widget.data,r,n,t,void 0,e.theme),e.modalRealTimeOption={optionFilter:r,scope:n}},a.widget=e};a.save=function(){var e=a.jsMind.get_data();e.meta.name=e.data.topic;var t={jsMind:e,widget:a.widgetMindList};s.post("/mindmap/updateMindmap.do",{json:angular.toJson(t),name:e.data.topic,id:r.id,categoryName:a.categoryName}).success(function(e){"1"==e.status?n.alert(p("COMMON.SUCCESS"),"modal-success","sm"):n.alert(e.msg,"modal-warning","lg")})},a.permissionSetting=function(){var e=o.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/permission/setting.html",size:"lg",controller:"permissionSettingCtrl",resolve:{config:function(){return{type:"brain",id:r.id}}}});e.result.then(function(){})}}]),discovery.controller("nvJsMindListCtrl",["$scope","$state","$http","$stateParams","dataService","ModalUtils","$filter","chartService","$timeout","$uibModal","$location",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";var u=o("translate");e.optFlag="none",e.treePath="",e.categoryList=[];var f="mindTreeID",p=[],g="mindmap/updateMindmap.do",m=function(){a.get("mindmap/getMindmapList.do").success(function(t){e.mindList=t,e.searchNode()})};m(),e.onlyView=function(){return!_.isUndefined(r.onlyView)&&r.onlyView},e.treeConfig=jsTreeConfig1,$("#"+f).keyup(function(t){46==t.keyCode&&e.deleteNode()});var h=function(){var t=jstree_GetSelectedNodes(f)[0];return _.find(e.mindList,function(e){return e.id==t.id})},v=function(e){return jstree_CheckTreeNode(e,f,i.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyDs=function(t){var r=angular.copy(t);r.name=r.name+"_copy";var n={jsMind:{data:{topic:r.name,extended:!0,children:[]},format:"node_tree",meta:{name:r.name}},widget:[]};a.post("mindmap/saveNewMindmap.do",{json:angular.toJson(n),name:r.name,categoryName:t.categoryName}).success(function(t){"1"==t.status?(e.optFlag="none",i.alert(u("COMMON.SUCCESS"),"modal-success","sm"),m()):i.alert(t.msg,"modal-warning","lg")})},e.createNode=function(){c.open({templateUrl:"src/view/nv/mind/modal/createTreeNode.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{categoryName:function(){return""},nodeName:function(){return""}},controller:["$scope","$uibModalInstance",function(e,t){e.close=function(){t.close()},e.ok=function(){if(e.nodeName.length){var r={jsMind:{data:{topic:e.nodeName,extended:!0,children:[]},format:"node_tree",meta:{name:e.nodeName}},widget:[]};a.post("mindmap/saveNewMindmap.do",{json:angular.toJson(r),name:e.nodeName,categoryName:e.categoryName}).success(function(e){"1"==e.status?(i.alert(u("COMMON.SUCCESS"),"modal-success","sm"),t.close(),m()):i.alert(e.msg,"modal-warning","lg")})}}}]})},e.deleteDs=function(e){a.post("/mindmap/deleteMindmap.do",{id:e.id}).success(function(e){"1"==e.status?(i.alert(u("COMMON.SUCCESS"),"modal-success","sm"),m()):i.alert(e.msg,"modal-warning","lg")})},e.copyNode=function(){v("copy")&&e.copyDs(h())},e.deleteNode=function(){v("delete")&&e.deleteDs(h())},e.editNode=function(){var e=h();d.url("/nv/mind/"+e.id)},e.searchNode=function(){var t={mindName:"",dsrName:""},a=e.mindList.map(function(t){var a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.mindName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var i=r[n].trim();"mind"==i.split(":")[0]&&(t.mindName=i.split(":")[1]),"dsr"==i.split(":")[0]&&(t.dsrName=i.split(":")[1])}p=jstree_CvtVPath2TreeData(o("filter")(a,{name:t.mindName,datasourceName:t.dsrName})),jstree_ReloadTree(f,p),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100)},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:l,treeID:f,listName:"mindList",updateUrl:g,ModalUtils:i,categoryList:"categoryList"});return t}()}]),discovery.controller("nvDashboardPanelCtrl",["$scope","$state","$http","$stateParams","dataService","ModalUtils","$filter","chartService","$timeout","$uibModal","$location",function(e,t,a,r,n,i,o,s,l,c,d){"ngInject";var u=o("translate");e.optFlag="none",e.curDataset={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]}}},e.curWidget={},e.alerts=[],e.verify={dsName:!0},e.queryAceOpt=cbAcebaseOption,e.params=[],e.treePath="";var f="dataSetTreeID";window.originalData=[];var p="dashboard/updateBoard.do";e.$watch("curDataset.data",function(t){var a={};a=e.curDataset.data.schema},!0);var g=function(){a.get("admin/getBoardListUser.do").success(function(t){e.boardList=t,e.searchNode()})};g(),e.onlyView=function(){return!_.isUndefined(r.onlyView)&&r.onlyView},e.goToCreateChart=function(){e.curDataset&&e.curDataset.id&&t.go("nv.explore_create_by",{cube_id:e.curDataset.id})},e.goToUploadExcel=function(){t.go("nv.excel.upload")},e.dndTransfer={dimension:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})},measure:function(e,t,a,r){"column"==r&&(e[t]={type:"column",column:a})}},e.openWidget=function(e){window.open("#/nv/explore/"+e,"widget")};var m=function(){if(e.alerts=[],!e.curDataset.name)return e.alerts=[{msg:u("CONFIG.DATASET.NAME")+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={dsName:!1},$("#DatasetName").focus(),!1;for(var t in e.params){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?u(s[0]):r,e.alerts=[{msg:"["+s+"]"+u("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0};e.save=function(){if(e.datasource?e.curDataset.data.datasource=e.datasource.id:null,e.curDataset.data.query=e.curWidget.query,m()){var t=angular.copy(e.curDataset),r=t.name.lastIndexOf("/");t.categoryName=e.curDataset.name.substring(0,r).trim(),t.name=e.curDataset.name.slice(r+1).trim(),""==t.categoryName&&(t.categoryName=u("COMMON.DEFAULT_CATEGORY")),"new"==e.optFlag?a.post("dashboard/saveNewBoard.do",{json:angular.toJson(t)}).success(function(t){"1"==t.status?(t.id&&(e.insertId=t.id),g(),e.verify={dsName:!0},i.alert(u("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]}):a.post(p,{json:angular.toJson(t)}).success(function(t){"1"==t.status?(e.optFlag="edit",g(),e.verify={dsName:!0},i.alert(u("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})}},e.treeConfig=jsTreeConfig1,$("#"+f).keyup(function(t){46==t.keyCode&&e.deleteNode()});var h=function(){var t=jstree_GetSelectedNodes(f)[0];return _.find(e.boardList,function(e){return e.id==t.id})},v=function(e){return jstree_CheckTreeNode(e,f,i.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyDs=function(t){var r=angular.copy(t);r.name=r.name+"_copy",a.post("dashboard/saveNewBoard.do",{json:angular.toJson(r)}).success(function(t){"1"==t.status?(g(),e.optFlag="none",i.alert(u("COMMON.SUCCESS"),"modal-success","sm")):i.alert(t.msg,"modal-warning","lg")})},e.createNode=function(){var t=e.treePath;c.open({templateUrl:"src/view/nv/dashboard/modal/createTreeNode.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{nodeName:function(){return e.treePath}},controller:["$scope","$uibModalInstance",function(e,r){e.nodeName=t,e.close=function(){r.close()},e.ok=function(){if(e.nodeName.length){var t={name:e.nodeName};a.post("dashboard/saveNewCategory.do",{json:angular.toJson(t)}).success(function(e){"1"==e.status?(i.alert(u("COMMON.SUCCESS"),"modal-success","sm"),r.close()):i.alert(e.msg,"modal-warning","lg")})}}}]})},$("#"+f).on("select_node.jstree",function(t,a){if(e.treePath="",a.node.id.indexOf("parent")>=0){for(var r=1;r<a.node.parents.length;r++)e.treePath+=a.node.parents.reverse()[r]+"/";e.treePath+=a.node.text+"/"}}),e.copyNode=function(){v("copy")&&e.copyDs(h())},e.editNode=function(){var e=h();d.url("/nv/dashboard/Demo/"+e.id)},e.deleteNode=function(){v("delete")&&e.deleteDs(h())},e.searchNode=function(){var t={dsName:"",dsrName:""},a=e.boardList.map(function(t){var a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource});return{id:t.id,name:t.name,categoryName:t.categoryName,datasourceName:a?a.name:""}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.dsName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var i=r[n].trim();"ds"==i.split(":")[0]&&(t.dsName=i.split(":")[1]),"dsr"==i.split(":")[0]&&(t.dsrName=i.split(":")[1])}originalData=jstree_CvtVPath2TreeData(o("filter")(a,{name:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(f,originalData),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100)},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:a,ngTimeout:l,treeID:f,listName:"boardList",updateUrl:p,ModalUtils:i,categoryList:"categoryList"});return t}(),e.doConfigParams=function(){a.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=dataset.html").then(function(t){e.params=t.data})},e.queryAceOpt=datasetEditorOptions()}]),discovery.controller("personCtrl",["$scope",function(e){"ngInject";e.myChartOption=!0,e.openChartOption=function(){e.myChartOption=!e.myChartOption}}]).controller("saveWgtAsCtrl",["$scope","$http","$uibModalInstance","$filter","widgetName",function(e,t,a,r,n){"ngInject";e.widgetName=n,e.ok=function(){a.close(e.widgetName)},e.cancel=function(){a.dismiss("cancel")}}]).controller("nvExploreEditCtrl",["$scope","$window","$stateParams","$state","$http","$uibModal","dataService","ModalUtils","updateService","$filter","chartService","$timeout","EventService","BoardParamService","$q",function(e,t,a,r,n,i,o,s,l,c,d,u,f,p,g){"ngInject";$.colors={red:"#FF7872",green:"#7ACE4C",yellow:"#FFB85E",gray:"#EEEEEE",blue:"#11A0F8"},$.ibm={colors:{blue:"#11A0F8",green:"#26C8A4",purple:"#BF8FE1",blue2:"#337FFF",orange:"#FF8426",yellow:"#FFBB44",pink:"#FF7872",green2:"#7ACE4C",black:"#354052",gray:"#7F8FA4"}},CBoardEChartRender.prototype.theme="theme-fin1";var m=c("translate"),h="dashboard/updateWidget.do";e.expAceOpt=cbAcebaseOption,e.expAceOpt=datasetEditorOptions(),n.get("admin/isAdmin.do").success(function(t){e.isAdmin=t,e.isAdmin&&(e.chart_group[2].list.push({name:m("CONFIG.WIDGET.FLEX2"),value:"flex2","class":"cFlex2"}),e.chart_group[2].list.push({name:m("CONFIG.WIDGET.FLEXCHART"),value:"flexChart","class":"cFlex",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")}),e.chart_group[2].list.push({name:m("CONFIG.WIDGET.FLEXD3CHART"),value:"flexD3Chart","class":"cFlexD3Chart",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")}))}),e.goToCube=function(){e.curWidget&&e.curWidget.datasetId&&window.open("#/nv/cube/"+e.curWidget.datasetId,"cube")},e.newData=function(){var t=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/newData.html",size:"md",controller:"newData",resolve:{}});t.result.then(function(t){var a=_.findWhere(e.datasetList,{name:t.selectTable,categoryName:"自动建模/"+t.datasource.name});if(a)r.go("nv.explore_create_by",{cube_id:a.id});else{var i={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]},datasource:t.datasource.id,query:{sql:"select * from "+t.selectTable}},name:t.selectTable,categoryName:"自动建模/"+t.datasource.name,loadFromCache:!0};n.post("dashboard/saveNewDataset.do",{json:angular.toJson(i)}).success(function(t){"1"==t.status?r.go("nv.explore_create_by",{cube_id:t.uuid}):e.alerts=[{msg:t.msg,type:"danger"}]})}})},e.chart_group=[{name:"常用",list:[{name:m("CONFIG.WIDGET.TABLE"),value:"table","class":"cTable",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.DATALINETABLE"),value:"dataLineTable","class":"cDataLineTable",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.TREEGRID"),value:"treeGrid","class":"cTreeGrid",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.CROSSTABLE"),value:"crossTable","class":"cCrossTable",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.CROSSGREATTABLE"),value:"crossGreatTable","class":"cCrossGreatTable",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.SELECTOR"),value:"selector","class":"cSelector",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE")},{name:m("CONFIG.WIDGET.LINE_BAR"),value:"line","class":"cLine",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.LINE_BAR2"),value:"line2","class":"cLine2",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.LINE_BAR3"),value:"line3","class":"cLine3",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.SCATTER"),value:"scatter","class":"cScatter",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.SCATTER2"),value:"scatter2","class":"cScatter2",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.PIE"),value:"pie","class":"cPie",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.PIE2"),value:"pie2","class":"cPie2",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")}]},{name:"三维",list:[{name:m("CONFIG.WIDGET.3DMAP"),value:"echart3dMap","class":"cechart3dMap",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.3DBAR"),value:"echart3dBar","class":"cechart3dBar",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.3DAREA"),value:"echart3dArea","class":"cechart3dArea",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.3DMAPLINE"),value:"echart3dMapLine","class":"cechart3dMapLine",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")}]},{name:"其他",list:[{name:m("CONFIG.WIDGET.ZONEMAP"),value:"zoneMap","class":"cZoneMap",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.CITYMAP"),value:"cityMap","class":"cCityMap",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.KPI"),value:"kpi","class":"cKpi",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.FUNNEL"),value:"funnel","class":"cFunnel",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.SANKEY"),value:"sankey","class":"cSankey",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.BARPOLARSTACK"),value:"barPolarStack","class":"cBarPolarStack",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.PIEPROPORTION"),value:"pieProportion","class":"cPieProportion",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.RADAR"),value:"radar","class":"cRadar",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.GAUGE"),value:"gauge","class":"cGauge",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.WORD_CLOUD"),value:"wordCloud","class":"cWordCloud",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.TREE_MAP"),value:"treeMap","class":"cTreeMap",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.HEAT_MAP_TABLE"),value:"heatMapTable","class":"cHeatMapTable",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.CODEFLOWER"),value:"codeFlower","class":"cCodeFlower",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.BARLIMITS"),value:"barLimits","class":"cBarLimits",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.LINEMAP"),value:"lineMap","class":"cLineMap",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.GANTT"),value:"gantt","class":"cGantt",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE")},{name:m("CONFIG.WIDGET.ROSE"),value:"rose","class":"cRose",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")},{name:m("CONFIG.WIDGET.CHORD"),value:"chord","class":"cChord",row:m("CONFIG.WIDGET.TIPS_DIM_NUM_1_MORE"),column:m("CONFIG.WIDGET.TIPS_DIM_NUM_0_MORE"),measure:m("CONFIG.WIDGET.TIPS_DIM_NUM_1")}]}],e.clearEmptyValues=function(){e.curWidget&&e.curWidget.config.values&&(e.curWidget.config.values=_.filter(e.curWidget.config.values,function(e){return e.cols.length>0}))},e.chart_types_status={line:!0,line2:!0,line3:!0,pie:!0,kpi:!0,table:!0,crossTable:!0,treeGrid:!0,crossGreatTable:!0,selector:!0,dataLineTable:!0,chord:!0,cityMap:!0,circular:!0,echart3dMap:!0,funnel:!0,zoneMap:!0,sankey:!0,barPolarStack:!0,pieProportion:!0,radar:!0,map:!0,echart3dMapLine:!0,echart3dBar:!0,echart3dArea:!0,scatter:!0,scatter2:!0,gauge:!0,wordCloud:!0,treeMap:!0,areaMap:!0,heatMapCalendar:!0,heatMapTable:!0,markLineMap:!0,liquidFill:!0,d3Demo:!0,codeFlower:!0,flex:!0,flex2:!0,barLimits:!0,lineMap:!0,pie2:!0,gantt:!0,flexChart:!0,flexD3Chart:!0,rose:!0},e.value_series_types=[{name:m("CONFIG.WIDGET.LINE"),value:"line"},{name:m("CONFIG.WIDGET.BAR"),value:"bar"},{name:m("CONFIG.WIDGET.STACKED_BAR"),value:"stackbar"},{name:m("CONFIG.WIDGET.PERCENT_BAR"),value:"percentbar"},{name:m("CONFIG.WIDGET.SCATTER"),value:"scatter"},{name:m("CONFIG.WIDGET.STACK_LINE"),value:"stackline"},{name:m("CONFIG.WIDGET.ONE_LINE_BAR"),value:"oneLineBar"},{name:m("CONFIG.WIDGET.WATER_FALL"),value:"waterFall"}],e.value_series_color=[{name:"红色",value:"red"},{name:"蓝色",value:"blue"}],e.value_series_Mtypes=[{name:"柱图",value:"bar3D"},{name:"点图",value:"scatter3D"}],e.value_aggregate_types=[{name:"总计",value:"sum"},{name:"计数",value:"count"},{name:"取平均",value:"avg"},{name:"取最大",value:"max"},{name:"取最小",value:"min"},{name:"可用值数",value:"distinct"}],e.kpi_styles=[{name:m("CONFIG.WIDGET.AQUA"),value:"text-aqua"},{name:m("CONFIG.WIDGET.RED"),value:"text-red"},{name:m("CONFIG.WIDGET.GREEN"),value:"text-green"},{name:m("CONFIG.WIDGET.YELLOW"),value:"text-yellow"},{name:m("CONFIG.WIDGET.CYAN"),value:"text-cyan"}],e.iconList=[{value:""},{value:"fa fa-area-chart"},{value:"fa fa-bar-chart"},{value:"fa fa-line-chart"},{value:"fa fa-pie-chart"},{value:"glyphicon glyphicon-bell"},{value:"glyphicon glyphicon-bookmark"},{value:"glyphicon glyphicon-briefcase"},{value:"glyphicon glyphicon-bullhorn"},{value:"glyphicon glyphicon-calendar"},{value:"glyphicon glyphicon-circle-arrow-up"},{value:"glyphicon glyphicon-circle-arrow-down"},{value:"glyphicon glyphicon-comment"},{value:"glyphicon glyphicon-globe"},{value:"glyphicon glyphicon-home"},{value:"glyphicon glyphicon-list-alt"},{value:"glyphicon glyphicon-plane"},{value:"glyphicon glyphicon-random"},{value:"glyphicon glyphicon-refresh"},{value:"glyphicon glyphicon-repeat"},{value:"glyphicon glyphicon-send"},{value:"glyphicon glyphicon-sort"},{value:"glyphicon glyphicon-star"},{value:"glyphicon glyphicon-tag"},{value:"glyphicon glyphicon-th-large"},{value:"glyphicon glyphicon-time"},{value:"glyphicon glyphicon-tint"},{value:"glyphicon glyphicon-tower"},{value:"glyphicon glyphicon-trash"},{value:"glyphicon glyphicon-user"},{value:"glyphicon glyphicon-wrench"},{value:"fa fa-anchor"},{value:"fa fa-automobile"},{value:"fa fa-bank"},{value:"fa fa-bullseye"},{value:"fa fa-cab"},{value:"fa fa-comment"},{value:"fa fa-database"},{value:"fa fa-dashboard"},{value:"fa fa-diamond"},{value:"fa fa-cube"},{value:"fa fa-fighter-jet"},{value:"fa fa-flag"},{value:"fa fa-lightbulb-o"},{value:"fa fa-lock"},{value:"fa fa-location-arrow"},{value:"fa fa-plane"},{value:"fa fa-search"},{value:"fa fa-shield"},{value:"fa fa-sitemap"},{value:"fa fa-signal"},{value:"fa fa-ship"},{value:"fa fa-space-shuttle"},{value:"fa fa-rmb"},{value:"fa fa-list-alt"}],e.alignIcon=[{value:"fa fa-align-left",align:"textLeft"},{value:"fa fa-align-center",align:"textCenter"},{value:"fa fa-align-right",align:"textRight"}],e.iconActive=function(t){e.curWidget.config.values[0].icon=t},e.switchAlign=function(t){e.curWidget.config.values[0].align=t},$.getJSON("plugins/FineMap/mapdata/citycode.json",function(t){e.provinces=t.provinces}),e.treemap_styles=[{name:m("CONFIG.WIDGET.RANDOM"),value:"random"},{name:m("CONFIG.WIDGET.MULTI"),value:"multi"},{name:m("CONFIG.WIDGET.BLUE"),value:"blue"},{name:m("CONFIG.WIDGET.RED"),value:"red"},{name:m("CONFIG.WIDGET.GREEN"),value:"green"},{name:m("CONFIG.WIDGET.YELLOW"),value:"yellow"},{name:m("CONFIG.WIDGET.PURPLE"),value:"purple"}],e.heatmap_styles=[{name:m("CONFIG.WIDGET.BLUE"),value:["#eee","blue"]},{name:m("CONFIG.WIDGET.RED"),value:["#eee","red"]},{name:m("CONFIG.WIDGET.GREEN"),value:["#eee","green"]},{name:m("CONFIG.WIDGET.YELLOW"),value:["#eee","yellow"]},{name:m("CONFIG.WIDGET.PURPLE"),value:["#eee","purple"]},{name:"绿/黄/红",value:["Rgb(148,219,34)","#FFD73E","#F29400","#b72222"]}],e.heatmap_date_format=[{name:"yyyy-MM-dd",value:"yyyy-MM-dd"},{name:"yyyy/MM/dd",value:"yyyy/MM/dd"},{name:"yyyyMMdd",value:"yyyyMMdd"}],e.liquid_fill_style=[{name:m("CONFIG.WIDGET.CIRCLE"),value:"circle"},{name:m("CONFIG.WIDGET.PIN"),value:"pin"},{name:m("CONFIG.WIDGET.RECT"),value:"rect"},{name:m("CONFIG.WIDGET.ARROW"),value:"arrow"},{name:m("CONFIG.WIDGET.TRIANGLE"),value:"triangle"},{name:m("CONFIG.WIDGET.ROUND_RECT"),value:"roundRect"},{name:m("CONFIG.WIDGET.SQUARE"),value:"square"},{name:m("CONFIG.WIDGET.DIAMOND"),value:"diamond"}],e.configRule={cityMap:{keys:2,groups:0,filters:-1,values:2,events:-1},zoneMap:{keys:2,groups:0,filters:-1,values:1,events:-1},chord:{keys:2,groups:-1,filters:-1,values:2,events:-1},line:{keys:2,groups:-1,filters:-1,values:2,events:-1},line2:{keys:2,groups:-1,filters:-1,values:2,events:-1},line3:{keys:2,groups:-1,filters:-1,values:2,events:-1},pie:{keys:2,groups:0,filters:-1,values:2,events:-1},pie2:{keys:0,groups:0,filters:-1,values:2,events:-1},flexChart:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},flexD3Chart:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},kpi:{keys:0,groups:0,filters:-1,values:1,events:-1},table:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},treeGrid:{keys:-1,groups:0,filters:-1,values:-1,events:-1},crossTable:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},crossGreatTable:{keys:-1,groups:0,filters:-1,values:-1,events:-1},selector:{keys:-1,groups:0,filters:-1,values:0,events:-1},funnel:{keys:-1,groups:-1,filters:-1,values:2,events:-1},sankey:{keys:2,groups:2,filters:-1,values:1,events:-1},circular:{keys:2,groups:2,filters:-1,values:1,events:-1},echart3dMap:{keys:2,groups:0,filters:-1,values:1,events:-1},echart3dBar:{keys:2,groups:2,filters:-1,values:1,events:-1},echart3dArea:{keys:2,groups:2,filters:-1,values:1,events:-1},barPolarStack:{keys:2,groups:-1,filters:-1,values:2,events:-1},pieProportion:{keys:2,groups:0,filters:-1,values:-1,events:-1},radar:{keys:2,groups:-1,filters:-1,values:2,events:-1},map:{keys:2,groups:-1,filters:-1,values:2,events:-1},scatter:{keys:2,groups:-1,filters:-1,values:2,events:-1},scatter2:{keys:2,groups:-1,filters:-1,values:2,events:-1},gauge:{keys:0,groups:0,filters:-1,values:1,events:-1},wordCloud:{keys:2,groups:0,filters:-1,values:1,events:-1},treeMap:{keys:2,groups:0,filters:-1,values:1,events:-1},areaMap:{keys:2,groups:-1,filters:-1,values:1,events:-1},heatMapCalendar:{keys:1,groups:0,filters:-1,values:1,events:-1},heatMapTable:{keys:-1,groups:-1,filters:-1,values:1,events:-1},markLineMap:{keys:2,groups:2,filters:-1,values:1,events:-1},liquidFill:{keys:0,groups:0,filters:-1,values:1,events:-1},d3Demo:{keys:2,groups:0,filters:-1,values:2,events:-1},codeFlower:{keys:2,groups:0,filters:-1,values:2,events:-1},flex:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},flex2:{keys:-1,groups:-1,filters:-1,values:-1,events:-1},barLimits:{keys:2,groups:0,filters:-1,values:-1,events:-1},dataLineTable:{keys:-1,groups:0,filters:-1,values:-1,events:-1},lineMap:{keys:2,groups:-1,filters:-1,values:-1,events:-1},echart3dMapLine:{keys:2,groups:2,filters:-1,values:-1,events:-1},gantt:{keys:2,groups:2,filters:-1,values:0,events:-1},rose:{keys:2,groups:-1,filters:-1,values:2,events:-1}};var v={cityMap:!0,zoneMap:!0,chord:!0,codeFlower:!0,wordCloud:!0,barPolarStack:!0,sankey:!0,echart3dArea:!0,echart3dBar:!0,table:!0,crossTable:!0,treeGrid:!0,crossGreatTable:!0,selector:!0,dataLineTable:!0,line:!0,line2:!0,line3:!0,pie:!0,pie2:!0,flexChart:!0,flexD3Chart:!0,kpi:!0,funnel:!0,radar:!0,map:!0,scatter:!0,scatter2:!0,pieProportion:!0,gauge:!0,treeMap:!0,heatMapCalendar:!0,heatMapTable:!0,markLineMap:!0,echart3dMap:!0,echart3dMapLine:!0,flex:!0,flex2:!0,barLimits:!0,lineMap:!0,gantt:!0,rose:!0};e.hasOption=function(){return!!(e.curWidget&&e.curWidget.config&&e.curWidget.config.chart_type&&v[e.curWidget.config.chart_type]);
},e.refresh=function(){w(function(){e.curWidget.measureGroups=[],T(),e.curWidget.computedDimensionGroups=[],e.curWidget.computedGroups=[],D(),e.curWidget.expressions=[],N(),e.curWidget.filterGroups=[],x(),A()})},e.loading=!1,e.toChartDisabled=!0,e.optFlag="",e.alerts=[],e.treeData=[];e.datasource,e.widgetName,e.widgetCategory,e.widgetId,e.curWidget={},e.previewDivWidth=12,e.expressions=[],e.customDs=!1,e.loadFromCache=!0,e.filterSelect={},e.verify={widgetName:!0},e.params=[];var y=function(t){n.get("dashboard/dashboardWidget.do?id="+a.id).success(function(a){e.widgetInfo=a,t&&t()})},w=function(t){n.get("dashboard/getDatasetNameList.do").success(function(a){e.datasetList=a,t&&t()})};e.goBack=function(){t.history.back()},w();var b=function(t){n.get("dashboard/getDatasetById.do?id="+e.curWidget.datasetId).then(function(a){e.dataset=a.data[0],t&&t()})},C=function(){n.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t,I(),a.create?(e.newWgt(),a.cube_id&&(e.curWidget={datasetId:a.cube_id+"",query:{},measureGroups:[],dimensionGroups:[],computedDimensionGroups:[],computedGroups:[],expressions:[],filterGroups:[],config:{option:{},events:[]}},e.loadData())):a.id&&y(function(){e.editWgt(e.widgetInfo)})})};C(),e.datasetGroup=function(e){return e.categoryName};var I=function(){n.get("dashboard/getWidgetCategoryList.do").success(function(t){e.categoryList=t,$("#widgetName").autocomplete({source:e.categoryList})})};e.editExp=function(t){var a,r=F(e.schema),n=e.value_aggregate_types,o=e.curWidget,l={expression:""};t?(l.expression=t.exp,l.alias=t.alias,a=function(e){t.exp=e.expression,t.alias=e.alias}):a=function(t){e.curWidget.expressions.push({type:"exp",exp:t.expression,alias:t.alias})},i.open({templateUrl:"src/view/nv/explore/modal/exp.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=l,e.curWidget=o,e.selects=r,e.aggregate=n,e.alerts=[],e.close=function(){t.close()},e.expAceOpt=expEditorOptions(r,n),e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.verify=function(){e.alerts=[];var t=verifyAggExpRegx(e.data.expression);e.alerts=[{msg:t.isValid?m("COMMON.SUCCESS"):t.msg,type:t.isValid?"success":"danger"}]},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void s.alert(m("CONFIG.WIDGET.ALIAS")+m("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.editMea=function(t){var a,r=F(e.schema),n=[{name:"+",value:"+"},{name:"-",value:"-"},{name:"*",value:"*"},{name:"/",value:"/"}],o={expression:""};t?(o.expression=t.column,o.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){e.curWidget.measureGroups.push({type:"column",column:o.expression,alias:o.alias})},i.open({templateUrl:"src/view/nv/explore/modal/measure.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=o,e.selects=r,e.aggregate=n,e.alerts=[],e.expAceOpt=expEditorOptions(r,n),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void s.alert(m("CONFIG.WIDGET.ALIAS")+m("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.editDim=function(t){var a,r=F(e.schema),n={expression:""};t?(n.expression=t.column,n.alias=t.alias,a=function(e){t.column=e.expression,t.alias=e.alias}):a=function(t,a){e.curWidget.dimensionGroups.push({type:"column",column:n.expression,alias:n.alias})},i.open({templateUrl:"src/view/nv/explore/modal/dimension.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.data=n,e.selects=r,e.alerts=[],e.expAceOpt=expEditorOptions(r,""),e.close=function(){t.close()},e.addToken=function(t,a){var r=document.getElementById("expression_area"),n=e.data.expression.length;r.focus();var i=0;if("undefined"!=typeof document.selection)document.selection.createRange().text=t,i=t.length-1;else{var o=e.data.expression.substr(0,r.selectionStart),s=e.data.expression.substring(r.selectionStart,n);e.data.expression=o+t,i=e.data.expression.length-1,e.data.expression+=s}a||i++,r.selectionStart=i,r.selectionEnd=i},e.ok=function(){return e.data.alias?(a(e.data),void t.close()):void s.alert(m("CONFIG.WIDGET.ALIAS")+m("COMMON.NOT_EMPTY"),"modal-warning","lg")}}]})},e.loadData=function(){e.toChartDisabled=!1,e.filterSelect={},b(function(){e.curWidget.measureGroups=[],T(),e.curWidget.computedDimensionGroups=[],e.curWidget.computedGroups=[],D(),e.curWidget.expressions=[],N(),e.curWidget.filterGroups=[],x(),A()}),E()},e.newWgt=function(){e.curWidget={},e.curWidget.config={},e.curWidget.config.option={},e.curWidget.dimensionGroups=[],e.curWidget.measureGroups=[],e.curWidget.expressions=[],e.curWidget.filterGroups=[],e.curWidget.query={},e.datasource=null,e.widgetName=null,e.widgetCategory=null,e.widgetId=null,e.optFlag="new",e.customDs=!1,e.schema=null,M()},e.isDsDimensionGroups=function(t){if(e.customDs)return!1;var a=e.dataset.data.schema.dimension,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)},e.isDsMeasureGroups=function(t){if(e.customDs)return!1;var a=e.dataset.data.schema.measure,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)},e.isDsComputedGroups=function(t,a){if(e.customDs)return!1;var r=e.dataset.data.schema[a],n=_.find(r,function(e){return e.id&&t.id==e.id});return!_.isUndefined(n)},e.isDsExpression=function(t){if(e.customDs)return!1;var a=e.dataset.data.expressions,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)},e.isDsFilter=function(t){if(e.customDs)return!1;var a=e.dataset.data.filters,r=_.find(a,function(e){return e.id&&t.id==e.id});return!_.isUndefined(r)};var x=function(){if(!e.customDs){var t=e.dataset.data.filters;t&&_.each(t,function(t){e.curWidget.filterGroups.push(t)})}},N=function(){if(!e.customDs){var t=e.dataset.data.expressions;t&&_.each(t,function(t){e.curWidget.expressions.push(t)})}},T=function(){if(!e.customDs){var t=e.dataset.data.schema.measure;t&&_.each(t,function(t){e.curWidget.measureGroups.push(t)})}},D=function(){if(!e.customDs){var t=e.dataset.data.schema.computedDimension,a=e.dataset.data.schema.computed;t&&_.each(t,function(t){t.alias=t.column,t.type="computedDimension",e.curWidget.computedDimensionGroups.push(t)}),a&&_.each(a,function(t){t.alias=t.column,t.type="computed",e.curWidget.computedGroups.push(t)})}},S=function(){e.$watch("curWidget.config.keys",W,!0),e.$watch("curWidget.config.groups",W,!0),e.$watch("curWidget.config.values",W,!0),e.$watch("curWidget.config.filters",W,!0),e.$watch("curWidget.config.events",W,!0),M()},M=function(){e.$watch("widgetName",k,!0),e.$watch("curWidget.datasetId",k,!0)},k=function(){e.alerts=[],e.verify={widgetName:!0}},O=function(){if(e.alerts=[],e.verify={widgetName:!0},!e.widgetName)return e.alerts=[{msg:m("CONFIG.WIDGET.WIDGET_NAME")+m("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={widgetName:!1},$("#widgetName").focus(),!1;if(0==e.customDs&&void 0==e.curWidget.datasetId)return e.alerts=[{msg:m("CONFIG.WIDGET.DATASET")+m("COMMON.NOT_EMPTY"),type:"danger"}],!1;if(1==e.customDs)for(var t=0;t<e.params.length;t++){var a=e.params[t].name,r=e.params[t].label,n=e.params[t].required,i=e.curWidget.query[a];if(1==n&&0!=i&&(void 0==i||""==i)){var o=/([\w_\s\.]+)/,s=o.exec(r);return s=s&&s.length>0?m(s[0]):r,e.alerts=[{msg:"["+s+"]"+m("COMMON.NOT_EMPTY"),type:"danger"}],e.verify[a]=!1,!1}}return!0},W=function(){for(var t in e.chart_types_status){var a=e.configRule[t],r=e.curWidget.config,n=[];if(_.each(r.values,function(e){n=n.concat(e.cols)}),0==_.size(r.keys)&&0==_.size(r.groups)&&0==_.size(n))o=!1;else for(var i in a){var o=!0;if(2==a[i]?o="values"==i?_.size(n)>=1:_.size(r[i])>=1:a[i]!=-1&&(o="values"==i?_.size(n)==a[i]:_.size(r[i])==a[i]),!o){e.chart_types_status[t]=o;break}}e.chart_types_status[t]=o}};e.changeChart=function(t){if(e.chart_types_status[t]){var a=angular.copy(e.curWidget.config);switch(e.curWidget.config={},e.curWidget.config.option={},e.curWidget.config.chart_type=t,E(),e.curWidget.config.selects=a.selects?a.selects:[],e.curWidget.config.keys=a.keys?a.keys:[],e.curWidget.config.groups=a.groups?a.groups:[],e.curWidget.config.values=[],e.curWidget.config.events=[],e.curWidget.config.filters=a.filters,e.curWidget.config.option.tooltip={},e.curWidget.config.option.tooltipGroups={},e.curWidget.config.option.tooltipTarget={},e.curWidget.config.option.thresholds={},e.curWidget.config.chart_type){case"line":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"line2":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"line3":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})}),e.curWidget.config.valueAxis="vertical",_.each(e.curWidget.config.values,function(e){e.series_type="line",e.type="value"});break;case"kpi":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="text-aqua"});break;case"scatter":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<3;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"scatter2":_.each(a.values,function(t){e.curWidget.config.values.push({name:t.name,cols:t.cols})});break;case"pieProportion":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<2;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"lineMap":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<3;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"barLimits":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<2;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"d3Demo":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<2;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"codeFlower":var r=0;_.each(a.values,function(t){_.each(t.cols,function(t){return r>=3?void e.curWidget.config.selects.push(t.col):(e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]}),e.curWidget.config.values[r].cols.push(t),void r++)})});for(var r=0;r<2;r++)e.curWidget.config.values[r]||(e.curWidget.config.values[r]={name:"",cols:[]});break;case"gauge":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.styles=[{proportion:"0.2",color:"#228b22"},{proportion:"0.8",color:"#48b"},{proportion:"1",color:"#ff4500"}];break;case"areaMap":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="text-aqua"});break;case"heatMapCalendar":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.dateFormat="yyyy-MM-dd",e.style="blue"});break;case"heatMapTable":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="blue"});break;case"liquidFill":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.animation="static",_.each(e.curWidget.config.values,function(e){e.style="circle"});break;case"markLineMap":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),e.curWidget.config.selects=angular.copy(e.columns),_.each(e.curWidget.config.values,function(e){e.style="text-aqua"});break;case"flexChart":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),_.isUndefined(e.curWidget.config.option.flex)&&(e.curWidget.config.option.flex="draw = function(list, config){\n\tvar option={};\n\treturn option\n}");break;case"flexD3Chart":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),_.isUndefined(e.curWidget.config.option.flex)&&(e.curWidget.config.option.flex="draw = function(d3,$canvas,list,config){\n}");break;case"flex2":e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})}),_.isUndefined(e.curWidget.config.option.flex)&&(e.curWidget.config.option.flex='<div ng-init="init()">{{list}}</div>'),_.isUndefined(e.curWidget.config.option.code)&&(e.curWidget.config.option.code="fun = {\n\tinit:function(){\n\t\tconsole.log($scope.list)\n\t}\n}");break;default:e.curWidget.config.values.push({name:"",cols:[]}),_.each(a.values,function(t){_.each(t.cols,function(t){e.curWidget.config.values[0].cols.push(t)})})}_.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){delete e.formatter})}),e.preview()}},e.newConfig=function(){switch(console.log("newConfig"),e.curWidget.config={},e.curWidget.config.option={},e.curWidget.config.events=[],e.curWidget.config.chart_type="table",E(),e.curWidget.config.chart_type){case"cityMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"zoneMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"line":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"line2":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"line3":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=new Array,e.curWidget.config.filters=new Array,e.curWidget.config.valueAxis="vertical",e.add_value();break;case"pie":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"flexChart":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"flexD3Chart":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"pie2":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"kpi":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"text-aqua"}],e.curWidget.config.filters=new Array;break;case"table":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.option.isPagenation=!0,e.curWidget.config.option.groupSort=!0,e.curWidget.config.filters=new Array,console.log("$scope.curWidget.config",e.curWidget.config);break;case"crossTable":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"treeGrid":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.option.isPagenation=!0,e.curWidget.config.option.groupSort=!0,e.curWidget.config.filters=new Array;break;case"crossGreatTable":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"selector":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.filters=new Array;break;case"dataLineTable":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"gantt":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"flex":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"flex2":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"funnel":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"sankey":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"circular":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"echart3dMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"echart3dMapLine":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"echart3dBar":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"echart3dArea":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"barPolarStack":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"pieProportion":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"barLimits":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"lineMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"d3Demo":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"pie":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"codeFlower":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"radar":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"map":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"gauge":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array,e.curWidget.config.styles=[{proportion:"0.2",color:"#228b22"},{proportion:"0.8",color:"#48b"},{proportion:"1",color:"#ff4500"}];break;case"areaMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"heatMapCalendar":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],dateFormat:"yyyy-MM-dd",style:"blue"}];break;case"heatMapTable":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"blue"}],e.curWidget.config.filters=new Array;break;case"markLineMap":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array;break;case"liquidFill":e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.values=[{name:"",cols:[],style:"circle"}],e.curWidget.config.filters=new Array,e.curWidget.config.animation="static";break;default:e.curWidget.config.selects=angular.copy(e.columns),e.curWidget.config.keys=new Array,e.curWidget.config.groups=new Array,e.curWidget.config.values=[{name:"",cols:[]}],e.curWidget.config.filters=new Array}S()};var E=function(){$("#preview_widget").html(""),$("#viewQuery_widget").html(""),e.viewQueryMoal=!1};e.previewQuery=function(){$("#viewQuery_widget").html(""),u(function(){angular.element("#viewQuery_widget_tab").trigger("click")}),e.loadingPre=!0,o.viewQuery({config:e.curWidget.config,datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId},function(t){var a=t.trim().replace(/\n/g,"<br/>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");$("#viewQuery_widget").html("<div class='alert alert-info' role='alert' style='text-align: left;'><p style='color: black'>"+a+"</p></div>"),e.loadingPre=!1,e.viewQueryMoal=!0})},e.permissionSetting=function(){var e=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/permission/setting.html",size:"lg",controller:"permissionSettingCtrl",resolve:{config:function(){return{type:"explore",id:a.id}}}});e.result.then(function(){})},e.preview=function(){$("#preview_widget").html(""),u(function(){angular.element("#preview_widget_tab").trigger("click")}),e.loadingPre=!0,$("#preview_widget").html("<div id='preview' style='min-height: 300px;height:100%;user-select: text;'></div>"),e.curWidget.config.drillTier={},e.curWidget.config.drillTier.isGreat=!1,e.curWidget.config.drillTier.keyTier=0,e.curWidget.config.drillTier.groupTier=0,e.curWidget.config.drillTier.filters={},e.curWidget.config.drillTier.filters.key=[],e.curWidget.config.drillTier.filters.group=[],d.render($("#preview"),{config:e.curWidget.config,datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId,paramList:e.schema?e.schema.paramList:[]},function(t){switch(e.curWidget.config.chart_type){case"cityMap":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"zoneMap":e.previewDivWidth=12;break;case"line":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"line2":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"line3":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"pie":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"flexChart":e.expAceOpt.mode="javascript",e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"flexD3Chart":e.expAceOpt.mode="javascript",e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"pie2":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"kpi":e.previewDivWidth=6;break;case"table":e.previewDivWidth=12;break;case"crossTable":e.previewDivWidth=12;break;case"treeGrid":e.previewDivWidth=12;break;case"crossGreatTable":e.previewDivWidth=12;break;case"selector":e.previewDivWidth=12;break;case"dataLineTable":e.previewDivWidth=12;break;case"gantt":e.previewDivWidth=12;break;case"flex":e.previewDivWidth=12;break;case"flex2":e.previewDivWidth=12,e.expAceOptHTML=angular.copy(e.expAceOpt),e.expAceOptHTML.mode="html",e.expAceOptJS=angular.copy(e.expAceOpt),e.expAceOptJS.mode="javascript";break;case"funnel":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"sankey":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"circular":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"echart3dMap":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"barPolarStack":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"pieProportion":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"barLimits":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"lineMap":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"d3Demo":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"rose":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"codeFlower":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"echart3dMapLine":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"echart3dBar":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"echart3dArea":e.previewDivWidth=12,t.toolbox={feature:{dataView:{show:!0,readOnly:!0}}};break;case"map":e.previewDivWidth=12;break;case"areaMap":e.previewDivWidth=12;break;case"markLineMap":e.previewDivWidth=12}e.loadingPre=!1},null,!e.loadFromCache,void 0,void 0,!0).then(function(t){e.curWidget.realTimeTicket=t})},e.add_value=function(){e.curWidget.config.values.push({name:"",series_type:"line",type:"value",cols:[]})},e.add_style=function(){e.curWidget.config.styles.push({proportion:"",color:""})};e.saveWgtAs=function(){var t=i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/saveWgtAsModel.html",size:"sm",controller:"saveWgtAsCtrl",resolve:{widgetName:function(){return angular.copy(e.widgetName)}}});t.result.then(function(t){var a={};return a.name=t?t.slice(t.lastIndexOf("/")+1).trim():"",a.categoryName=t?t.substring(0,t.lastIndexOf("/")).trim():"",""==a.categoryName&&(a.categoryName=m("COMMON.DEFAULT_CATEGORY")),a.data={},a.data.config=e.curWidget.config,e.customDs?(a.data.query=e.curWidget.query,a.data.datasource=e.datasource.id):a.data.datasetId=e.curWidget.datasetId,a.data.measureGroups=_.filter(e.curWidget.measureGroups,function(t){return!e.isDsMeasureGroups(t)}),a.data.dimensionGroups=_.filter(e.curWidget.dimensionGroups,function(t){return!e.isDsDimensionGroups(t)}),a.data.expressions=_.filter(e.curWidget.expressions,function(t){return!e.isDsExpression(t)}),a.data.filterGroups=_.filter(e.curWidget.filterGroups,function(t){return!e.isDsFilter(t)}),e.alerts=[],e.verify={widgetName:!0},null==a.name||""==a.name?void e.alert("图表名不能为空"):void n.post("dashboard/saveNewWidget.do",{json:angular.toJson(a)}).success(function(t){"1"==t.status?(I(),s.alert(m("COMMON.SUCCESS"),"modal-success","sm"),window.location.href="/starter.html#/nv/explore/"+t.uuid):e.alerts=[{msg:t.msg,type:"danger"}]})},function(){})},e.saveWgt=function(){if(O()){var t={};return t.name=e.widgetName.slice(e.widgetName.lastIndexOf("/")+1).trim(),t.categoryName=e.widgetName.substring(0,e.widgetName.lastIndexOf("/")).trim(),
""==t.categoryName&&(t.categoryName=m("COMMON.DEFAULT_CATEGORY")),t.data={},t.data.config=e.curWidget.config,t.data.config.redis=e.redis,e.customDs?(t.data.query=e.curWidget.query,t.data.datasource=e.datasource.id):t.data.datasetId=e.curWidget.datasetId,t.data.measureGroups=_.filter(e.curWidget.measureGroups,function(t){return!e.isDsMeasureGroups(t)}),t.data.computedDimensionGroups=_.filter(e.curWidget.computedDimensionGroups,function(t){return!e.isDsComputedGroups(t,"computedDimensionGroups")}),t.data.computedGroups=_.filter(e.curWidget.computedGroups,function(t){return!e.isDsComputedGroups(t,"computedGroups")}),t.data.dimensionGroups=_.filter(e.curWidget.dimensionGroups,function(t){return!e.isDsDimensionGroups(t)}),t.data.expressions=_.filter(e.curWidget.expressions,function(t){return!e.isDsExpression(t)}),t.data.filterGroups=_.filter(e.curWidget.filterGroups,function(t){return!e.isDsFilter(t)}),e.alerts=[],e.verify={widgetName:!0},null==t.name||""==t.name?(e.alerts=[{msg:m("CONFIG.WIDGET.WIDGET_NAME")+m("COMMON.NOT_EMPTY"),type:"danger"}],e.verify={widgetName:!1},void $("#widgetName").focus()):void 0==t.data.datasetId&&0==e.customDs?void(e.alerts=[{msg:m("CONFIG.WIDGET.DATASET")+m("COMMON.NOT_EMPTY"),type:"danger"}]):void("new"==e.optFlag?n.post("dashboard/saveNewWidget.do",{json:angular.toJson(t)}).success(function(t){"1"==t.status?(I(),s.alert(m("COMMON.SUCCESS"),"modal-success","sm"),window.location.href="/starter.html#/nv/explore/"+t.uuid):e.alerts=[{msg:t.msg,type:"danger"}]}):"edit"==e.optFlag&&(t.id=e.widgetId,n.post(h,{json:angular.toJson(t)}).success(function(t){"1"==t.status?(I(),s.alert(m("COMMON.SUCCESS"),"modal-success","sm")):e.alerts=[{msg:t.msg,type:"danger"}]})))}},e.editWgt=function(t){n.post("dashboard/checkWidget.do",{id:t.id}).success(function(a){if("1"==a.status)L(t),1==e.customDs&&e.doConfigParams();else{var r=t.data.datasetId?"CONFIG.WIDGET.DATASET":"CONFIG.WIDGET.DATA_SOURCE";s.alert(m("ADMIN.CONTACT_ADMIN")+"："+m(r)+"/"+a.msg,"modal-danger","lg")}})},e.editCurWgt=function(){var t=e.widgetInfo;t&&e.editWgt(t)};var L=function(t){E(),u(function(){},500),$("#preview_widget").html(""),t.data.datasetId+="",e.curWidget=angular.copy(t.data),e.curWidget.measureGroups||(e.curWidget.measureGroups=[]),e.curWidget.computedDimensionGroups||(e.curWidget.computedDimensionGroups=[]),e.curWidget.computedGroups||(e.curWidget.computedGroups=[]),e.curWidget.dimensionGroups||(e.curWidget.dimensionGroups=[]),e.curWidget.expressions||(e.curWidget.expressions=[]),e.curWidget.filterGroups||(e.curWidget.filterGroups=[]),l.updateConfig(e.curWidget.config),e.datasource=_.find(e.datasourceList,function(e){return e.id==t.data.datasource}),e.widgetName=angular.copy(t.categoryName+"/"+t.name),e.redis=t.data.config.redis,e.widgetId=t.id,e.optFlag="edit",e.customDs=_.isUndefined(e.curWidget.datasetId),b(function(){T(),D(),N(),x(),A(),o.linkDataset(e.curWidget.datasetId,e.curWidget.config)}),S()};e.doCancel=function(){"new"==e.optFlag?(e.newConfig(),e.filterSelect={},E()):e.editCurWgt()},e.filterDimension=function(t){if("level"==t.type)return!0;var a=_.find(e.curWidget.config.keys,function(e){return e.col==t.column}),r=_.find(e.curWidget.config.groups,function(e){return e.col==t.column});return!(a||r)},e.filterMeasureGroups=function(t){var a=!1;return _.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){t.column==e.col&&(a=!0)})}),!a},e.filterComputedGroups=function(t){var a=!1;_.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){t.column==e.column&&(a=!0)})});var r=_.find(e.curWidget.config.keys,function(e){return e.col==t.column||e.column==t.column}),n=_.find(e.curWidget.config.groups,function(e){return e.col==t.column||e.column==t.column});return!a&&!(r||n)},e.filterExpressions=function(t){var a=!1;return _.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){"exp"==e.type&&t.id==e.id&&t.alias==e.alias&&(a=!0)})}),!a},e.selectParam=function(e,t){p.set(e,[t])},e.filterFilterGroup=function(t){var a=!1;return _.each(e.curWidget.config.filters,function(e){e.group&&t.id==e.id&&t.group==e.group&&(a=!0)}),!a};var G=function(e){for(var t in e)return!1;return!0},A=function(){var t=!1;if(e.customDs||e.dataset.data.schema&&(e.dataset.data.schema.measure.length>0||e.dataset.data.schema.dimension.length>0)&&(t=!0),t){if(e.schema=e.dataset.data.schema,e.paramForChange={},e.schema.paramList&&G(e.paramForChange))for(var r in e.schema.paramList)e.schema.paramList[r].list.length>0&&(p.set(e.schema.paramList[r].column,e.schema.paramList[r].list[0]),e.paramForChange[e.schema.paramList[r].column]=e.schema.paramList[r].list[0]);e.alerts=[]}else e.loading=!0,o.getColumns({datasource:e.datasource?e.datasource.id:null,query:e.curWidget.query,datasetId:e.customDs?void 0:e.curWidget.datasetId,reload:!e.loadFromCache,callback:function(t){e.loading=!1,e.alerts=[],"1"==t.msg?(e.schema={selects:[]},_.each(t.columns,function(t){e.schema.selects.push({column:t})})):e.alerts=[{msg:t.msg,type:"danger"}]}});a.create?a.create=!1:e.preview()};e.deleteWgt=function(t){s.confirm(m("COMMON.CONFIRM_DELETE"),"modal-info","lg",function(){n.post("dashboard/deleteWidget.do",{id:t.id}).success(function(t){"1"==t.status||s.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})})},e.copyWgt=function(t){var a=angular.copy(t);a.name=a.name+"_copy",n.post("dashboard/saveNewWidget.do",{json:angular.toJson(a)}).success(function(t){"1"==t.status?s.alert(m("COMMON.SUCCESS"),"modal-success","sm"):s.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})},e.getQueryView=function(){if(e.datasource&&e.datasource.name)return"dashboard/getConfigView.do?type="+e.datasource.type},e.getChartView=function(){if(e.curWidget.config&&e.curWidget.config.chart_type)return"src/view/nv/chart/"+e.curWidget.config.chart_type+".html"},e.getOptionsView=function(){var t="src/view/nv/chart/options/";if(e.curWidget.config&&e.curWidget.config.chart_type)return t+e.curWidget.config.chart_type+".html"},e.deleteValue=function(t){_.each(t,function(t){"exp"==t.type?e.expressions.push(t):e.curWidget.config.selects.push(t.col)})},e.dndTransfer={toCol:function(e,t,a,r){"key"==r||"group"==r||"filter"==r?e[t]={col:a.col,aggregate_type:"sum",alias:a.alias?a.alias:a.col}:"select"!=r&&"measure"!=r||(e[t]={col:a.column,aggregate_type:"sum",alias:a.alias?a.alias:a.column})},toSelect:function(e,t,a,r){"col"==r?e[t]=a.col:"key"!=r&&"group"!=r&&"filter"!=r||(e[t]=a.col)},toEvent:function(e,t,a,r,n){e[t]={alias:a.alias,col:a.column}},toKeysGroups:function(e,t,a,r){"col"==r?e[t]={col:a.col,type:"eq",values:[],sort:"asc"}:"dimension"!=r&&"select"!=r||(e[t]={alias:a.alias,col:a.column,level:a.level,type:"eq",values:[],sort:"asc",style:a.style?a.style:"string"},"dimension"==r&&(e[t].id=a.id))},attachLevel:function(e,t){return e.level=t.alias,e},attachLevel2:function(e){var t=angular.copy(e),a=e.columns,r=[];e={alias:t.alias,col:t.alias,level:t.alias,id:t.id,type:"eq",values:[],sort:"asc"};for(var n=0;n<a.length;n++){var i={alias:a[n].alias,col:a[n].column,level:t.alias,id:a[n].id,type:"eq",values:[],sort:"asc"};r.push(i)}return e.drillDown=r,e},limitDnd:function(e,t){return"crossTable"!=t||0==e.length}},e.selectsByFilter=[],e.selects=[],e.editFilter=function(t,a){i.open({templateUrl:"src/view/nv/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){var e=t[a];return e.col?("eq"==e.type?e.type="=":"ne"==e.type&&(e.type="≠"),angular.copy(e)):{col:e,type:"=",values:[]}},filter:function(){return!0},getSelects:function(){return function(r,n,i){var s=void 0;if(r){s=angular.copy(e.curWidget.config);var l=_.findKey(e.curWidget.config,function(e){return e==t});s[l].splice(a,1)}o.getDimensionValues(e.datasource?e.datasource.id:null,e.curWidget.query,e.customDs?void 0:e.curWidget.datasetId,n,s,function(e){i(e)})}},ok:function(){return function(e){t[a]=e}}},controller:"paramSelector"})},e.editStyle=function(t){i.open({templateUrl:"src/view/nv/dashboard/modal/tableDataStyle.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"sm",resolve:{curWidgetConfig:e.curWidget.config,widget:e.curWidget,o:t},controller:["$scope","$uibModalInstance",function(e,a){e.typeList={bar:"柱状显示",percent:"百分比显示",updown:"增减",custom:"自定义显示",hidden:"隐藏"},e.customCode=_.isUndefined(e.$resolve.o.dataStyle)?"":e.$resolve.o.dataStyle.num,e.percentNum=_.isUndefined(e.$resolve.o.dataStyle)?100:parseInt(e.$resolve.o.dataStyle.num),e.selected=_.isUndefined(e.$resolve.o.dataStyle)?"":e.$resolve.o.dataStyle.type,e.hidden=_.isUndefined(e.$resolve.o.dataStyle)?"":e.$resolve.o.dataStyle.type,e.selectItem=function(t){e.selected==t?e.selected="":e.selected=t},e.close=function(){a.close()},e.ok=function(){"percent"===e.selected?t.dataStyle={type:e.selected,num:parseInt(document.getElementById("percentNum").value)}:"custom"===e.selected?t.dataStyle={type:e.selected,num:document.getElementById("editCustomCode").value}:t.dataStyle={type:e.selected,num:100},a.close()}}]})},e.editVFilter=function(e){i.open({templateUrl:"src/view/nv/modal/vfilter.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(t,a){t.type=["=","≠",">","<","≥","≤","(a,b]","[a,b)","(a,b)","[a,b]"],t.f_type=e.f_type?e.f_type:">",t.f_values=e.f_values?e.f_values:[],t.f_top=e.f_top?e.f_top:"",t.close=function(){a.close()},t.ok=function(){e.f_type=t.f_type,e.f_values=t.f_values,e.f_top=t.f_top,a.close()}}]})},e.editThreshold=function(t){i.open({templateUrl:"src/view/nv/modal/threshold.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{curWidgetConfig:e.curWidget.config,widget:e.curWidget,o:t},controller:["$scope","$uibModalInstance",function(e,a){_.isUndefined(e.thresholds)&&(e.thresholds={}),e.thresholds[t.col]=t.thresholds?t.thresholds[t.col]:[],e.close=function(){a.close()},e.ok=function(){e.$resolve.curWidgetConfig.option.thresholds[t.col]=e.thresholds[t.col],_.isUndefined(t.thresholds)&&(t.thresholds={}),t.thresholds[t.col]=e.thresholds[t.col],a.close()},e.add=function(){var a={t_key:"",t_min_values:"",t_max_values:"",t_color:""};e.thresholds[t.col].push(a)},e["delete"]=function(a){e.thresholds[t.col].splice(a,1)}}]})};var F=function(e){if(e.selects)return angular.copy(e.selects);var t=[];return t=t.concat(e.measure),_.each(e.dimension,function(e){"level"==e.type?_.each(e.columns,function(e){t.push(e)}):t.push(e)}),angular.copy(t)};e.editFilterGroup=function(t){var a=F(e.schema);i.open({templateUrl:"src/view/nv/modal/filterGroup.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,scope:e,controller:["$scope","$uibModalInstance",function(e,r){t?e.data=angular.copy(t):e.data={group:"",filters:[]},e.selects=a,e.close=function(){r.close()},e.addColumn=function(t){e.data.filters.push({col:t,type:"=",values:[]})},e.ok=function(){t?(t.group=e.data.group,t.filters=e.data.filters):e.curWidget.filterGroups.push(e.data),r.close()},e.editFilter=function(t){i.open({templateUrl:"src/view/nv/dashboard/modal/param.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",resolve:{param:function(){return angular.copy(t)},filter:function(){return!1},getSelects:function(){return function(t,a,r){o.getDimensionValues(e.datasource?e.datasource.id:null,e.curWidget.query,e.curWidget.datasetId,a,void 0,function(e){r(e)})}},ok:function(){return function(e){t.type=e.type,t.values=e.values,t.isExp=e.isExp,t.exp=e.exp}}},controller:"paramSelector"})}}]})},e.editSort=function(e){switch(e.sort){case"asc":e.sort="desc";break;case"desc":e.sort=void 0;break;default:e.sort="asc"}},e.cleanVSort=function(){_.each(e.curWidget.config.values,function(e){_.each(e.cols,function(e){e.sort=void 0})})},e.editAlign=function(e){switch(e.align){case void 0:e.align="left";break;case"left":e.align="right";break;default:e.align=void 0}},e.cleanRowSort=function(t){var a=t.sort;_.each(e.curWidget.config.keys,function(e){e.sort=void 0}),e.cleanVSort(),t.sort=a},e.showTooltip=function(e,t){if(!e.isDisabled){var a=$(t.currentTarget),r=a.find(".chart-tip");r.show()}},e.hideTooltip=function(e,t){if(!e.isDisabled){var a=$(t.currentTarget),r=a.find(".chart-tip");r.hide()}},e.queryAceOpt=datasetEditorOptions(),f.on("CE:drillDown",function(t){console.log("CE:drillDown-explore",t),t.widget={},t.widget.widget={},t.widget.widget.data=e.curWidget;var a=!1,r=t.widget.widget.data.config.keys,n=t.widget.widget.data.config.groups,i=t.widget.widget.data.config.drillTier,o=e.curWidget.realTimeTicket;i.isGreat=!!t.param.isGreat&&t.param.isGreat,_.each(r,function(e){_.isUndefined(e.drillDown)||(a=!0,i.keyTier<e.drillDown.length-1&&(_.isUndefined(t.param.drillType)||"key"==t.param.drillType)&&(i.filters.key.push(t.param.name),i.keyTier++))}),_.each(n,function(e){_.isUndefined(e.drillDown)||(a=!0,i.groupTier<e.drillDown.length-1&&(_.isUndefined(t.param.drillType)||"group"==t.param.drillType)&&(i.filters.group.push(t.param.name),i.groupTier++))}),"treeGrid"===t.type&&(a=!0,i.keyTier=t.tier.tier,i.filters.key=t.tier.list,i.treeGridFilters=t.filters),a&&d.realTimeRender(o,t.widget.widget.data)}),f.on("CE:drillUp",function(t){t.widget={},t.widget.widget={},t.widget.widget.data=e.curWidget;var a=!1,r=t.widget.widget.data.config.keys,n=t.widget.widget.data.config.groups,i=t.widget.widget.data.config.drillTier,o=e.curWidget.realTimeTicket;i.isGreat=!!t.param.isGreat&&t.param.isGreat,_.each(r,function(e){_.isUndefined(e.drillDown)||(a=!0,i.keyTier>0&&(_.isUndefined(t.param.drillType)||"key"==t.param.drillType)&&(i.filters.key.pop(),i.keyTier--))}),_.each(n,function(e){_.isUndefined(e.drillDown)||(a=!0,i.groupTier>0&&(_.isUndefined(t.param.drillType)||"group"==t.param.drillType)&&(i.filters.group.pop(),i.groupTier--))}),a&&d.realTimeRender(o,t.widget.widget.data)})}]),discovery.controller("nvExploreListCtrl",["$scope","$state","$stateParams","$http","$uibModal","dataService","ModalUtils","updateService","$filter","chartService","$timeout","$q",function(e,t,a,r,n,i,o,s,l,c,d,u){"ngInject";var f=l("translate"),p="dashboard/updateWidget.do",g="widgetTreeID",m=[];e.gotoDataset=function(e){window.open("#/nv/cube/"+e,"cube")},e.goToCreateChart=function(){t.go("nv.explore_create")},e.treeConfig=jsTreeConfig1;var h=function(t){r.get("dashboard/getWidgetList.do").success(function(a){e.widgetList=a,t&&t(),e.searchNode()})},v=function(){r.get("dashboard/getWidgetCategoryList.do").success(function(t){e.categoryList=t,$("#widgetName").autocomplete({source:e.categoryList})})};h(),v(),$("#"+g).keyup(function(t){46==t.keyCode&&e.deleteNode()});var y=function(){var t=jstree_GetSelectedNodes(g)[0];return _.find(e.widgetList,function(e){return e.id==t.id})},w=function(e){return jstree_CheckTreeNode(e,g,o.alert)};e.applyModelChanges=function(){return!e.ignoreChanges},e.copyNode=function(){w("copy")&&e.copyWgt(y())},e.copyWgt=function(t){var a=angular.copy(t);a.name=a.name+"_copy",r.post("dashboard/saveNewWidget.do",{json:angular.toJson(a)}).success(function(t){"1"==t.status?(h(),o.alert(f("COMMON.SUCCESS"),"modal-success","sm")):o.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})},e.previewList=[],e.datasetFilters={},e.widgetFilters={};var b={filter:{injectFilter:function(t){return t.data.config.boardFilters=[],_.isUndefined(t.data.datasetId)?t.data.config.boardFilters=e.widgetFilters[t.id]:t.data.config.boardFilters=e.datasetFilters[t.data.datasetId],t}},widget:{rendWidget:function(t,a){b.widget.buildRender(t,a),t.loading=!0,t.show=!0;var r=t.widget.data,n=_.find(e.datasetList,function(e){return e.id==r.datasetId});n&&n.data.interval&&n.data.interval>0&&(e.intervalGroup[r.datasetId]||(e.intervalGroup[r.datasetId]=[],e.intervals.push($interval(function(){_.each(e.intervalGroup[r.datasetId],function(e){e()})},1e3*n.data.interval))),e.intervalGroup[r.datasetId].push(function(){try{t.show&&(c.realTimeRender(t.realTimeTicket,b.filter.injectFilter(t.widget).data),t.modalRealTimeTicket&&c.realTimeRender(t.modalRealTimeTicket,b.filter.injectFilter(t.widget).data,t.modalRealTimeOption.optionFilter,null))}catch(e){console.error(e)}}))},loadWidget:function(t){_.each(e.board.layout.rows,function(e){_.each(e.widgets,function(e){(_.isUndefined(e.hasRole)||e.hasRole)&&b.widget.rendWidget(e,t)})})},buildRender:function(e,t){e.render=function(a,r,n){c.render(a,b.filter.injectFilter(e.widget).data,r,n,t).then(function(t){e.realTimeTicket=t,e.loading=!1}),e.realTimeOption={optionFilter:r,scope:n}},e.modalRender=function(t,a,r){e.modalRealTimeTicket=c.render(t,b.filter.injectFilter(e.widget).data,a,r),e.modalRealTimeOption={optionFilter:a,scope:r}}}}};e.editNode=function(){var e=y();t.go("nv.explore_item",{id:e.id})},e.clickNode=function(){var t=y();r.post("dashboard/checkWidget.do",{id:t.id}).success(function(a){if("1"==a.status)t={widget:t},b.widget.rendWidget(t,!1),e.previewList[0]=t,1==e.customDs&&e.doConfigParams();else{var r=t.data.datasetId?"CONFIG.WIDGET.DATASET":"CONFIG.WIDGET.DATA_SOURCE";o.alert(f("ADMIN.CONTACT_ADMIN")+"："+f(r)+"/"+a.msg,"modal-danger","lg")}})},e.deleteNode=function(){w("delete")&&e.deleteWgt(y())},e.deleteWgt=function(t){o.confirm(f("COMMON.CONFIRM_DELETE"),"modal-info","lg",function(){r.post("dashboard/deleteWidget.do",{id:t.id}).success(function(t){"1"==t.status?h():o.alert(t.msg,"modal-warning","lg"),"none"==e.optFlag})})},e.searchNode=function(){var t={wgtName:"",dsName:"",dsrName:""},a=e.widgetList.map(function(t){var a,r=_.find(e.datasetList,function(e){return e.id==t.data.datasetId}),n="";return r?a=_.find(e.datasourceList,function(e){return e.id==r.data.datasource}):t.data.datasource&&(a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource})),{id:t.id,name:t.name,categoryName:t.categoryName,datasetName:r?r.name:"",datasourceName:a?a.name:n}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.wgtName=e.keywords;else for(var r=e.keywords.split(" "),n=0;n<r.length;n++){var i=r[n].trim();"wg"==i.split(":")[0]&&(t.wgtName=i.split(":")[1]),"ds"==i.split(":")[0]&&(t.dsName=i.split(":")[1]),"dsr"==i.split(":")[0]&&(t.dsrName=i.split(":")[1])}m=jstree_CvtVPath2TreeData(l("filter")(a,{name:t.wgtName,datasetName:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(g,m),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100)},e.treeEventsObj=function(){var t=jstree_baseTreeEventsObj({ngScope:e,ngHttp:r,ngTimeout:d,treeID:g,listName:"widgetList",updateUrl:p});return t}(),e.doConfigParams=function(){r.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=widget.html").then(function(t){e.params=t.data})},e.changeDs=function(){e.curWidget.query={},r.get("dashboard/getConfigParams.do?type="+e.datasource.type+"&page=widget.html").then(function(t){e.params=t.data;for(var a in e.params){var r=e.params[a].name,n=e.params[a].value,i=e.params[a].checked,o=e.params[a].type;"checkbox"==o&&1==i&&(e.curWidget.query[r]=!0),"number"!=o||""==n||isNaN(n)?""!=n&&(e.curWidget.query[r]=n):e.curWidget.query[r]=Number(n)}})},e.setCities=function(){var t=_.find(e.provinces,function(t){return t.code==e.curWidget.config.province.code});t&&t.cities?e.cities=t.cities:e.curWidget.config.city&&e.curWidget.config.city.code&&(e.curWidget.config.city.code="")},e.autoBuildModel=function(){n.open({templateUrl:"src/view/config/modal/autoModel.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",scope:e,controller:["$scope","$uibModalInstance",function(e,a){e.datasourceList=null,e.tableList=[],e.currentDatasource=null,e.currentTable=null,e.name="",e.searchSourceStr="",e.searchTableStr="";var n=function(){r.get("dashboard/getDatasourceList.do").success(function(t){e.datasourceList=t})};e.close=function(){a.close()},e.ok=function(){if(e.currentDatasource&&e.currentTable&&e.name){var a={data:{expressions:[],filters:[],schema:{dimension:[],measure:[]},datasource:e.currentDatasource.id+"",query:{sql:"select * from "+e.currentTable}},name:e.name,categoryName:"默认分类",loadFromCache:!0};r.post("dashboard/saveNewDataset.do",{json:angular.toJson(a)}).success(function(a){"1"==a.status?(t.go("nv.explore_create_by",{cube_id:a.uuid}),o.alert(f("COMMON.SUCCESS"),"modal-success","sm")):a.uuid?t.go("nv.explore_create_by",{cube_id:a.uuid}):e.alerts=[{msg:a.msg,type:"danger"}]}),this.close()}},e.selectDataSource=function(t,a){e.currentDatasource=a;var n=t.target,i=window.$;i(".data-active").removeClass("data-active"),n.classList.add("data-active");var o=e;r.post("dashboard/getTableListByDatasourceId.do",{id:o.currentDatasource.id}).success(function(e){o.tableList=e})},e.selectTable=function(t,a){e.name=a,e.currentTable=a;var r=t.target,n=window.$;n(".table-active").removeClass("table-active"),r.classList.add("table-active")},n()}]})}}]),discovery.controller("CustomWidgetCtrl",["$scope",function(e,t,a){"ngInject";e.remove=function(e,t){e.widgets&&e.widgets.splice(t,1)},e.config=function(e){$state.go("config.widget",{id:e.widget.id})},e.widgetBoxStyleByType=function(e){switch(e.widget.data.config.chart_type){case"table":case"crossTable":case"crossGreatTable":case"dataLineTable":case"treeGrid":return!0;default:return!1}},e.selectorState=1,e.selectParam=function(t){e.selectorState=t},e.enterParam=function(t){e.selectorState=t}}]).controller("NvDashboardViewCtrl",["$timeout","$interpolate","$rootScope","$scope","EventService","$state","$stateParams","$http","ModalUtils","chartService","$interval","$uibModal","dataService","$filter","$q","BoardParamService","$sce",function($timeout,$interpolate,$rootScope,$scope,EventService,$state,$stateParams,$http,ModalUtils,chartService,$interval,$uibModal,dataService,$filter,$q,BoardParamService,$sce){"ngInject";function getOrangleParam(){var e=BoardParamService.getAll(),t=new Object;t=Object.freeze(angular.copy(e)),window.$$orangle_param=angular.copy(t)}function getParamByOrangle(){var e=$("select.selector_multiple_simple"),t=$(".moment-picker-sty"),a=$(".selector-input"),r=$(".capsule_btn"),n=angular.copy(window.$$orangle_param);e.length>0&&_.each(e,function(e,t){var a=$(e),r=(a.attr("id"),a.attr("data-eventname")),i=a.hasClass("isSingle"),o=a.multipleSelect("getSelects"),s=a.find("option").length,l=null;l=i?o[0]:o.length===s?"all":0===o.length?-1:o,l&&(n[r]=l)}),t.length>0&&_.each(t,function(e,t){var a=$(e),r=a.attr("data-eventname"),i=a.attr("data-selected");"undefined"!=typeof i&&(_typeof("string"===n[r])?n[r]=i.toString():n[r]=i)}),a.length>0&&_.each(a,function(e,t){var a=$(e),r=a.attr("data-eventName"),i=a.attr("data-value");"undefined"!=typeof i&&(_typeof("string"===n[r])?n[r]=i.toString():n[r]=i)}),r.length>0&&_.each(r,function(e,t){var a=$(e),r=a.attr("data-eventName"),i=(a.attr("data-value"),a.attr("data-active"));"undefined"!=typeof i&&(_typeof("string"===n[r])?n[r]=i.toString():n[r]=i)}),window.$$dlut_param=angular.copy(n)}function eventData(e){var t,a={},r=[],n={};return e.param.data&&(r=e.param.data.eventInfo),e.param.this_tr&&(t=e.param.this_tr),e.param.this_td&&(n[$.trim(e.param.this_td.data("column"))]=$.trim(e.param.this_td.data("value"))),_.each(r,function(e){a[e.col]=e.value}),{seriesName:e.param.seriesName,obj:a,_this:t,this_td:n}}function runEvent(e,t,a){!_.isUndefined(drillCallbackMap[a])&&_.isArray(drillCallbackMap[a][t])&&drillCallbackMap[a][t].length>0&&_.each(drillCallbackMap[a][t],function(t){t(e)})}BoardParamService.clear();var drillCallbackMap={},updateUrl="dashboard/updateBoard.do",translate=$filter("translate"),paramInitListener;$scope.started=!1,$scope.isPreview=isPreview,$scope.selectColumnHTML="",$scope.tabs=[],$scope.curTab=null,$stateParams.history?$scope.history=$stateParams.history:$scope.history=[],$stateParams.screenHistory?$scope.screenHistory=$stateParams.screenHistory:$scope.screenHistory=[],$stateParams.role&&($rootScope.role=$stateParams.role),$scope.stateParams=$stateParams,$scope.gridsterOptions={margins:[5,5],columns:36,draggable:{handle:".drag-handler"},rowHeight:35},isPreview?$scope.isAdmin=!0:($http.get("admin/isAdmin.do").success(function(e){$scope.isAdmin=e,$http.get("screens/getScreenIdTitleList.do").success(function(e){$scope.screenList=e})}),$http.get("dashboard/getBoardParam.do?boardId="+$stateParams.id).success(function(e){e?$scope.boardParams=JSON.parse(e.config):$scope.boardParams=[]}));var utils={filter:{injectFilter:function(e){return e.widget&&(e=e.widget),e.data.config.boardFiltersByInit?delete e.data.config.boardFiltersByInit:(e.data.config.boardFilters=[],_.isUndefined(e.data.datasetId)?e.data.config.boardFilters=$scope.widgetFilters[e.id]:e.data.config.boardFilters=$scope.datasetFilters[e.data.datasetId]),e}},widget:{addButton:function(e){var t={name:e.name,widgetId:e.id,sizeX:5,sizeY:5,widget:e,tab:$scope.curTab};utils.widget.rendWidget(t,!1),$scope.board.layout.rows.push({type:"widget",widgets:[t]})},addWidget:function(e){var t={name:e.name,widgetId:e.id,sizeX:5,sizeY:5,widget:e,tab:$scope.curTab};utils.widget.rendWidget(t,!1),$scope.board.layout.rows.push({type:"widget",widgets:[t]})},rendWidget:function(e,t){var a={},r=e.widget.data.config,n=decodeURI(window.location.search);if(n.indexOf("?")!==-1)for(var i=n.substring(n.indexOf("?")+1),o=i.split("&"),s=0;s<o.length;s++)a[o[s].split("=")[0]]=unescape(o[s].split("=")[1]);for(var l in a){var c,d=a[l];d.length>0&&(c=d.split(",")),"object"===("undefined"==typeof c?"undefined":_typeof(c))&&!_.isUndefined(c.length)&&c.length>1&&(a[l]=c)}"selector"===r.chart_type&&(r.temporaryParam=a[r.keys[0].eventName]),utils.widget.temporaryParam=a,utils.widget.buildRender(e,t),e.loading=!0,"timeline"==$scope.board.layout.type?row.show&&(e.show=!0):e.show=!0;var u=e.widget.data,f=_.find($scope.datasetList,function(e){return e.id==u.datasetId});f&&f.data.interval&&f.data.interval>0&&($scope.intervalGroup[u.datasetId]||($scope.intervalGroup[u.datasetId]=[],$scope.intervals.push($interval(function(){_.each($scope.intervalGroup[u.datasetId],function(e){e()})},1e3*f.data.interval))),$scope.intervalGroup[u.datasetId].push(function(){try{e.show&&(chartService.realTimeRender(e.realTimeTicket,utils.filter.injectFilter(e.widget).data),e.modalRealTimeTicket&&chartService.realTimeRender(e.modalRealTimeTicket,utils.filter.injectFilter(e.widget).data,e.modalRealTimeOption.optionFilter,null))}catch(t){console.error(t)}}))},clearRotateFilter:function(e){e.interval&&$interval.cancel(e.interval)},clearAllRouteFilter:function(){_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(e){try{utils.widget.clearRotateFilter(e)}catch(t){console.error(t)}})})},setBoardFilter:function(e){if(e.config){e.config;e.config.filters&&(_.isUndefined(e.filters_copy)&&(e.filters_copy=angular.copy(e.widget.data.config.filters)),e.widget.data.config.filters=angular.copy(e.filters_copy),e.config.rotateFilters&&e.config.rotateFilters.enable&&e.config.rotateFilters.interval>0?(utils.widget.clearRotateFilter(e),e.widget.data.config.filters=angular.copy(e.filters_copy),e.widget.data.config.filters.push(e.config.filters[0]),e.filterName=e.config.filters[0].group,e.config.rotateFilters.index=1,e.interval=$interval(function(){e.realTimeTicket&&(e.config.rotateFilters.index==e.config.filters.length&&(e.config.rotateFilters.index=0),e.widget.data.config.filters=angular.copy(e.filters_copy),e.widget.data.config.filters.push(e.config.filters[e.config.rotateFilters.index]),e.filterName=e.config.filters[e.config.rotateFilters.index].group,chartService.realTimeRender(e.realTimeTicket,utils.filter.injectFilter(e.widget).data),e.config.rotateFilters.index++)},e.config.rotateFilters.interval)):e.widget.data.config.filters=e.widget.data.config.filters.concat(e.config.filters))}},loadDelayWidget:function(e){_.isUndefined(e)&&(e=!1),_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(t){$('div[widget="'+t.name+"_"+t.widget.data.config.chart_type+'"]');(_.isUndefined(t.hasRole)||t.hasRole)&&"widget"===e.type&&t.config&&!t.realTimeTicket&&$scope.reloadWidget(t,!1,!0)})})},loadWidgetNum:0,widgetNum:0,widgetInitNum:0,boardParamKeyArr:[],temporaryParam:null,loadWidget:function loadWidget(reload){if($scope.board.config&&$scope.board.config.customStartCode)try{eval($scope.board.config.customStartCode)}catch(e){console.error("board eval页面最初始调用的代码出错",$scope.board.config.customStartCode,e)}if(_.isUndefined(reload)&&(reload=!1),_.each($scope.board.layout.rows,function(e){"widget"===e.type?_.each(e.widgets,function(e){e.widget.data.wName=e.name,e.config||(e.config={}),e.config.isInit===!0&&utils.widget.widgetInitNum++,utils.widget.widgetNum++}):"timePicker"===e.sign?utils.widget.boardParamKeyArr.push(e.config.eventName):"columns"===e.sign&&e.config.columns&&e.config.columns.length>0?(1==parseInt(e.config.chooseType)?BoardParamService.set(e.config.eventName,e.config.columns[0]):BoardParamService.set(e.config.eventName,[]),utils.widget.boardParamKeyArr.push(e.config.eventName)):"condition"===e.sign?e.params.forEach(function(e){utils.widget.boardParamKeyArr.push(e.name)}):"customTrigger"===e.sign||"input"===e.sign&&(BoardParamService.set(e.config.eventName,e.config.showValue),utils.widget.boardParamKeyArr.push(e.config.eventName))}),utils.widget.boardParamKeyArr=_.uniq(utils.widget.boardParamKeyArr),_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(t){(_.isUndefined(t.hasRole)||t.hasRole)&&("widget"===e.type&&t.config?(void 0===t.config.isInit&&(t.config.isInit=!0),t.config.isInit&&!t.hide&&(utils.widget.setBoardFilter(t),utils.widget.rendWidget(t,reload))):(utils.widget.setBoardFilter(t),utils.widget.rendWidget(t,reload)))})}),0===utils.widget.widgetInitNum&&$scope.board&&$scope.board.config&&$scope.board.config.customCode)try{eval($scope.board.config.customCode)}catch(e){console.error("board eval初始化出错",$scope.board.config.customCode,e)}},buildRender:function buildRender(w,reload){w.render=function(content,optionFilter,scope){chartService.render(content,utils.filter.injectFilter(w).data,optionFilter,scope,reload,void 0,w.theme).then(function(d){var $dom=$('div[widget="'+w.name+"_"+w.widget.data.config.chart_type+'"]');if(w.realTimeTicket=d,w.loading=!1,utils.widget.loadWidgetNum++,$dom.hasClass("rendered")||$dom.addClass("rendered"),utils.widget.loadWidgetNum===utils.widget.widgetInitNum){if($scope.board&&$scope.board.config&&$scope.board.config.customCode)try{eval($scope.board.config.customCode);var temporaryParam=utils.widget.temporaryParam;for(var tr in temporaryParam){var value=temporaryParam[tr],$target=$('[data-eventName="'+tr+'"]');$target.hasClass("selector_multiple_simple")||(isNaN(value)||isNaN(Date.parse(value)))&&$.params.set(tr,value)}}catch(e){console.error("board eval初始化出错",$scope.board.config.customCode,e)}$("body").removeClass(),$("#globalLoading").hide()}}),w.realTimeOption={optionFilter:optionFilter,scope:scope}},w.modalRender=function(e,t,a){w.modalRealTimeTicket=chartService.render(e,utils.filter.injectFilter(w.widget).data,t,a,reload,void 0,w.theme),w.modalRealTimeOption={optionFilter:t,scope:a}}}},params:{addFlex:function(){$scope.board.layout.rows.push({name:"FLEX",type:"board",sizeX:5,sizeY:5,params:[],tab:$scope.curTab,sign:"flex"})},addCustomButton:function(){$scope.board.layout.rows.push({name:"自定义按钮",type:"board",sizeX:5,sizeY:5,params:[],tab:$scope.curTab,sign:"customTrigger",customName:"自定义",customIcon:"fa fa-search"})},addButton:function(){$scope.board.layout.rows.push({name:"搜索",type:"board",sizeX:5,sizeY:5,params:[],tab:$scope.curTab,sign:"trigger"})},addWidget:function(){$scope.board.layout.rows.push({name:"条件组",type:"param",sizeX:5,sizeY:5,params:[],sign:"condition",tab:$scope.curTab})},clearAllSelectParams:function(){_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){e.title="",e.values=[]})}),$scope.applyParamFilter()},paramToFilter:function(){$scope.widgetFilters=[],$scope.datasetFilters=[],_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){e.values.length<=0?_.each(e.col,function(e){$scope.globalParamTitleMap[e.column]&&delete $scope.globalParamTitleMap[e.column];
}):_.each(e.col,function(t){var a={col:t.column,type:e.type,values:e.values};_.isUndefined(t.datasetId)?($scope.widgetFilters[t.widgetId]||($scope.widgetFilters[t.widgetId]=[]),$scope.widgetFilters[t.widgetId].push(a)):($scope.datasetFilters[t.datasetId]||($scope.datasetFilters[t.datasetId]=[]),$scope.datasetFilters[t.datasetId].push(a)),$scope.globalParamTitleMap[t.column]={col:t.column,type:e.type,values:e.values}})})}),utils.params.updateGlobalParamTitle()},updateGlobalParamTitle:function(){var e=[];for(var t in $scope.globalParamTitleMap){var a=$scope.globalParamTitleMap[t],r=a.type,n=a.values;"like"==r?(r="",n=a.values[0].slice(1,a.values[0].length-1)):n=a.values.join(",");var i=a.col+r+"("+n+")";e.push(i)}return void($scope.globalParamTitle=e.join(","));var e,t,a},updateParamTitle:function(){_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){if("slider"!=e.paramType){var t;switch(e.type){case"=":case"≠":t=e.name+" "+e.type+" ("+e.values+")";break;case">":case"<":case"≥":case"≤":t=e.name+" "+e.type+" "+e.values;break;case"(a,b]":case"[a,b)":case"(a,b)":case"[a,b]":var a=e.type.split("a")[0],r=e.type.split("b")[1];t=e.name+" between "+a+e.values[0]+","+e.values[1]+r}e.title=e.values.length>0?t:void 0}})}),utils.params.updateGlobalParamTitle()},loadBoardDataset:function(e){var t=[],a=[];_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(e){var a=null;e.widget&&e.widget.data&&(a=e.widget.data.datasetId);var r=_.find($scope.widgetList,function(e){return e.id==a});r?r.data.datasetId?t.push(r.data.datasetId):r.id&&t.push(r.id):t.push(a)})}),t=_.union(t),$scope.boardDataset=[],_.each(t,function(t){e.i++,dataService.getColumnsByDatasetConfig({datasource:null,query:null,datasetId:t,callback:function(t){$scope.alerts=[],$scope.boardDataset.push({name:t.name,columns:t.data.schema.dimension,datasetId:t.id}),e.i--}})}),_.each(a,function(t){e.i++,dataService.getColumnsByDatasetConfig({datasource:t.data.datasource,query:t.data.query,datasetId:null,callback:function(a){"1"==a.msg?($scope.boardDataset.push({name:t.name,columns:a.columns,widgetId:t.id}),e.i--):$scope.alerts=[{msg:a.msg,type:"danger"}]}})})},editParamRow:function(e,t){var a={i:0};utils.params.loadBoardDataset(a);var r,n,i=$scope;_.isUndefined(e)&&(e={type:"param",params:[]}),_.isUndefined(t)?(n={col:[]},r=function(t){e.params||(e.params=[]),e.params.push(t)}):(n=angular.copy(e.params[t]),r=function(a){e.params[t]=a}),$uibModal.open({templateUrl:"src/view/nv/dashboard/modal/cubeParam.html",windowTemplateUrl:"src/view/util/modal/window.html",backdrop:!1,size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.param_types=[{name:translate("CONFIG.DASHBOARD.PARAM_TYPE_SELECTOR"),value:"selector"},{name:translate("CONFIG.DASHBOARD.PARAM_TYPE_SLIDER"),value:"slider"}],e.status=a,e.param=n,e.param.paramType||(e.param.paramType="default"),e.boardDataset=i.boardDataset,e.add=function(t,a,r,n){if("level"===a.type)return!1;var i=angular.copy(t);_.isUndefined(i.datasetId)&&!_.isUndefined(i.widgetId)&&(i.datasetId=i.widgetId,delete i.widgetId),delete i.columns,"level"===n&&(i.alias=r+"-",i.type="level"),i.column=a.column;for(var o=e.param.col,s=null,l=0;l<o.length;l++)o[l].column===i.column&&o[l].name===i.name?s=!0:null;s&&e.param.col!=[]?null:e.param.col.push(i)},e.close=function(){t.close()},e.deleteSelected=function(t,a){for(var r=e.param.col[t].column,n=$(".cube>span"),i=0;i<n.length;i++)$(n[i])[0].innerText!=r&&$(n[i]).data("column")!=r||$(n[i]).removeClass("itemSelected");if("level"===a)for(var o=$(".cube span.alias"),i=0;i<o.length;i++)$(o[i]).data("dh")==r&&$(o[i]).removeClass("itemSelected");e.param.col.splice(t,1)},e.ok=function(){e.param.name?(r(e.param),t.close()):ModalUtils.alert(translate("CONFIG.DASHBOARD.ENTER_PARAMETER_NAME"),"modal-warning","lg")},e.foldCube=function(t,a){var r="img"==a.target.localName?a.target.parentNode.parentNode:a.target.parentNode,n=r.getElementsByTagName("img");if("cubeName ng-binding"==a.target.className||"img"==a.target.localName)"25px"==r.style.height||""==r.style.height?(r.style.height="unset",n[0].style.webkitTransform="rotate(90deg)"):(r.style.height="25px",n[0].style.webkitTransform="rotate(0deg)");else if("span"==$(a.target)[0].localName){if(""===$($(a.target)[0]).data("column"))return!1;$(a.target).addClass("itemSelected")}e.param.col.map(function(e){for(var t=e.column,a=e.name,r=$(".cube>span"),n=0;n<r.length;n++){var i=r[n].parentNode.firstElementChild.innerText;($(r[n])[0].innerText==t&&a==i||$(r[n]).data("column")==t)&&$(r[n]).addClass("itemSelected")}})}}]})}},getBoardRows:function(e){var t=(e.board.layout.rows,["widgetId","name","col","row","sizeX","sizeY","action","screenAction","tab","theme","config","maximizeOption"]),a=[];return _.each(e.board.layout.rows,function(e){if("widget"==e.type){var r=!1,n=[];_.each(e.widgets,function(a){if(_.isUndefined(a.hasRole)||a.hasRole){for(var i=0;i<e.widgets.length;i++){for(var a=e.widgets[i],o={},s=0;s<t.length;s++)void 0!=a[t[s]]&&(o[t[s]]=a[t[s]]);n.push(o)}tabAlive(a.tab.id)&&(r=!0)}}),n.length>0&&r&&a.push({type:"widget",widgets:n})}else"param"==e.type?tabAlive(e.tab.id)&&a.push(e):"board"==e.type?(tabAlive(e.tab.id)&&e.timePicker&&(e.timePicker=""),e.config&&e.config.selectColumn&&(e.config.selectColumn=""),a.push(e)):"tabs"==e.type&&tabAlive(e.tab.id)&&a.push(e)}),a}};$scope.clearAllSelectParams=utils.params.clearAllSelectParams,$scope.openConfigModel=utils.params.openConfigModel,$scope.editParamRow=utils.params.editParamRow,$scope.addParamWidget=utils.params.addWidget,$scope.addFlex=utils.params.addFlex,$scope.addButton=utils.params.addButton,$scope.addCustomButton=utils.params.addCustomButton,$scope.addSignLine=function(){$(".addSignLine").prepend("<div class='signLine'></div>");var e=$(".addSignLine").width()/2;$(".signLine").attr("style","top:"+e+"px")},$scope.loading=!0,$http.get("dashboard/getBoardData.do?id="+$stateParams.id+"&token="+getQueryString("yili-token")).success(function(response){var datasetList=[];_.each(response.layout.rows,function(e){"widget"==e.type&&datasetList.push(e.widgets[0].widget.data.datasetId)});var readyCallback=function readyCallback(){$scope.loading=!1,$scope.board=response,$scope.deadline=null,$scope.board.config&&$scope.board.config.type&&("day"===$scope.board.config.type?$scope.deadline=moment().subtract(1,"days").format("YYYY年MM月DD日"):"month"===$scope.board.config.type&&($scope.deadline=moment().subtract(1,"month").format("YYYY年MM月"))),_.each($scope.board.layout.rows,function(row){if("param"==row.type||"widget"!=row.type)initTabList(row);else if("widget"===row.type&&utils.widget.loadWidgetNum===utils.widget.widgetInitNum&&0!==utils.widget.widgetInitNum){if($scope.board&&$scope.board.config&&$scope.board.config.customCode)try{eval($scope.board.config.customCode)}catch(e){console.error("board eval初始化出错",config.customCode,e)}$("body").removeClass(),$("#globalLoading").hide()}"flex"===row.sign&&row.config&&(row.config.showHTML=""),_.each(row.widgets,function(e){(_.isUndefined(e.hasRole)||e.hasRole)&&(e.loading=!0,e.widget&&e.widget.data&&(e.widget.data.loadingCircle=!0),e.show=!0,initTabList(e))}),"columns"===row.sign&&(1===row.config.chooseType?BoardParamService.set(row.config.eventName,row.config.columns[0]):BoardParamService.set(row.config.eventName,[]))}),_.each($scope.board.layout.rows,function(e){"param"==e.type&&initTabList(e),_.each(e.widgets,function(e){(_.isUndefined(e.hasRole)||e.hasRole)&&(e.loading=!0,e.show=!0,initTabList(e))})}),0==$scope.tabs.length&&($scope.tabs[0]={id:0,name:"默认"}),$scope.tabs=_.sortBy($scope.tabs,"id"),null==$stateParams.tab?$scope.curTab=$scope.tabs[0]:void 0!=$scope.tabs[$stateParams.tab]?$scope.curTab=$scope.tabs[$stateParams.tab]:$scope.curTab={id:null,name:null};var hasInitParam=!1;utils.params.clearAllSelectParams(),utils.widget.loadWidget(!1),$stateParams.param.length>0&&(directApplyParamFilter2($stateParams.param,!0),hasInitParam=!0),hasInitParam&&($scope.applyParamFilter(),$stateParams.param=[])};datasetList.length?dataService.getDatasetList(datasetList).then(readyCallback):readyCallback()}),$scope.addTimePicker=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addTimePickerWidget.html",size:"sm",controller:"AddTimePickerWidgetCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)})},$scope.initTime=function(row){BoardParamService.get(row.config.eventName)||(row.config.showValue="");var configArr=[];if(row.config.initConfig&&(configArr=row.config.initConfig.split(";")),configArr.forEach(function(e){var t=e.split(",");3===t.length&&"now"===t[0]?(t[2]=parseInt(t[2]),"DD"===t[1]?row.showValue=moment().add(t[2],"days").format("YYYY年MM月DD日"):"YYYY"===t[1]?row.showValue=moment().add(t[2],"years").format("YYYY年"):"MM"===t[1]?row.showValue=moment().add(t[2],"months").format("YYYY年MM月"):alert("初始化公式拼写错误！")):alert("初始化公式拼写错误！"),row.defaultValue=row.showValue,row.defaultValue=findNum(row.config.defaultValue).join(""),BoardParamService.set(row.config.eventName,[row.defaultValue])}),row.config.initTime){var initValue,temporaryParam=utils.widget.temporaryParam;try{initValue=eval(row.config.initTime)}catch(e){console.log("初始化日期赋值出错！")}_.isUndefined(temporaryParam[row.config.eventName])||initValue===temporaryParam[row.config.eventName]||(initValue=temporaryParam[row.config.eventName]),row.defaultValue=initValue,BoardParamService.set(row.config.eventName,initValue),row.config.initValue=dlut.math.toDate(initValue)}},$scope.stepTime=function(e,t){if(e.config.showValue){var a=findNum(e.config.showValue);switch(a[0]=parseInt(a[0]),a[1]=parseInt(a[1])-1,a[2]=parseInt(a[2]),t){case"forWard":"year"==e.config.timeType?e.config.showValue=moment(a).add(1,"years").format("YYYY年"):"month"==e.config.timeType?e.config.showValue=moment(a).add(1,"months").format("YYYY年MM月"):e.config.showValue=moment(a).add(1,"days").format("YYYY年MM月DD日");break;case"back":"year"==e.config.timeType?e.config.showValue=moment(a).add(-1,"years").format("YYYY年"):"month"==e.config.timeType?e.config.showValue=moment(a).add(-1,"months").format("YYYY年MM月"):e.config.showValue=moment(a).add(-1,"days").format("YYYY年MM月DD日")}e.config.defaultValue=a.join(""),BoardParamService.set(e.config.eventName,[e.config.defaultValue])}},$scope.changeTime=function(e,t,a){t.config.defaultValue=findNum(t.config.showValue).join(""),BoardParamService.set(t.config.eventName,t.config.defaultValue),$timeout(function(){$scope.boardFunBtnClick(t.config)},300)},$scope.initCapsule=function(e){e.activeName?e.activeName:e.activeName=e.columns[0],BoardParamService.set(e.eventName,e.activeName)},$scope.addCapsule=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addCapsuleModal.html",size:"sm",controller:"addCapsuleCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)})},$scope.switchCapsule=function(config,item){if(config.activeName=item,BoardParamService.set(config.eventName,item),config.functions.length)try{eval(config.functions)}catch(e){console.log("胶囊执行方法出错",e)}},$scope.boardFunBtnClick=function(config){if(_.isUndefined(window.$$orangle_param)&&getOrangleParam(),getParamByOrangle(),config.customCode)try{eval(config.customCode)}catch(e){console.error("board eval语句出错",config.customCode,e)}},$scope.triggerTime=function(e){return $.filters.autoCalc(),$.iframes.calcUrl(),$.widgets.initAll(),void $.widgets.reloadAll();var t,a,r,n,i,o},$scope.addInput=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addInputWidget.html",size:"sm",controller:"AddInputWidgetCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)},function(){})},$scope.changeColsDefault=function(e){if(e&&e.config){var t=angular.copy(e.config.showValue).toString();t.indexOf("%")>-1&&(t=t.replace("%","")),$("#"+e.name+"_input").attr("data-value",t),BoardParamService.set(e.config.eventName,t),$timeout(function(){$scope.boardFunBtnClick(e.config)},300)}},$scope.focusChangeColsDefault=function(row){if(row&&row.config&&(BoardParamService.set(row.config.eventName,row.config.showValue),$scope.boardFocusFunBtnClick(row.config),row.config.customFocusCode))try{eval(row.config.customFocusCode)}catch(e){console.error("board eval语句出错",config.customFocusCode,e)}},$scope.addIframeWidget=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addIframeWidget.html",size:"sm",controller:"AddIframeWidgetCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)},function(){})},$scope.initMultipleSelect=function(e,t){$scope.$applyAsync(function(){var t="select_"+(e.config.eventName?e.config.eventName:e.name),a=$("#"+t),r=1==parseInt(e.config.chooseType);a.multipleSelect({single:r,onClick:function(t){if(r)BoardParamService.set(e.config.eventName,t.value),a.attr("data-selected",t.value);else{var n=t.instance.getSelects();0===n.length&&(n="-1"),BoardParamService.set(e.config.eventName,n),a.attr("data-selected",n)}},onCheckAll:function(){BoardParamService.set(e.config.eventName,[]),a.attr("data-selected","all")},onUncheckAll:function(){BoardParamService.set(e.config.eventName,"-1"),a.attr("data-selected",-1)},onClose:function(){$timeout(function(){$scope.boardFunBtnClick(e.config)},300)}}),r?(a.multipleSelect("setSelects",[e.config.columns[0]]),BoardParamService.set(e.config.eventName,e.config.columns[0]),a.attr("data-selected",e.config.columns[0])):(a.multipleSelect("checkAll"),BoardParamService.set(e.config.eventName,[]),a.attr("data-selected","all"))})},$scope.addCols=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addColsWidget.html",size:"sm",controller:"AddColsWidgetCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)},function(){})},$scope.addStaticText=function(e){var t=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addStaticText.html",size:"lg",controller:"addStaticTextCtrl",resolve:{row:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return e?angular.copy(e):""}),tab:function(){return angular.copy($scope.curTab)}}});t.result.then(function(e){$scope.board.layout.rows.push(e)})},$scope.getAlertInfo=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/alertInfo.html",size:"lg",controller:"alertInfoCtrl",resolve:{config:function(){return angular.copy($scope.board.config)}}});e.result.then(function(e){$scope.board.config.alertInfo=e.alertInfo})},$scope.addDynamicTitle=function(e){var t=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addDynamicTitleModel.html",size:"sm",controller:"addDynamicTitleCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)},globalParamTitleMap:function(){return angular.copy($scope.globalParamTitleMap)},row:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return e?angular.copy(e):""})}});t.result.then(function(t){if(e){var a=t.config.dynamicTitle;for(var r in $scope.globalParamTitleMap){var n=$scope.globalParamTitleMap[r];a=a.replace("{{"+r+"}}",n.values[0])}a.indexOf("{{")>-1?(e.showTitle=t.config.dynamicDefault,e.config.dynamicDefault=t.config.dynamicDefault,e.config.dynamicTitle=t.config.dynamicTitle):e.showTitle=a}else $scope.board.layout.rows.push(t)})},$scope.$watch("globalParamTitleMap",function(){$scope.dynamicTitleFun()},!0),$scope.dynamicTitleFun=function(){$scope.board&&_.each($scope.board.layout.rows,function(e){if("title"==e.sign){var t=e.config.dynamicTitle;for(var a in $scope.globalParamTitleMap){var r=$scope.globalParamTitleMap[a];t=t.replace("{{"+a+"}}",r.values[0])}t.indexOf("{{")>-1?e.showTitle=e.config.dynamicDefault:e.showTitle=t}})},$scope.addImgWidget=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addImgWidget.html",size:"sm",controller:"AddImgWidgetCtrl",resolve:{tab:function(){return angular.copy($scope.curTab)}}});e.result.then(function(e){$scope.board.layout.rows.push(e)})},$scope.addTabGroupWidget=function(){$scope.board.layout.rows.push({name:"Tab group",type:"board",sign:"tabs",sizeX:5,sizeY:5,tab:$scope.curTab})},$scope.addTab=function(){$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/tabModel.html",size:"sm",controller:"tabCtrl",resolve:{tab:function(){},tabs:function(){return $scope.tabs}}})},$scope.changeTabName=function(e){$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/tabModel.html",size:"sm",controller:"tabCtrl",resolve:{tab:function(){return e},tabs:function(){return $scope.tabs}}})},$scope.deleteTab=function(e){e==$scope.curTab.id&&(e>0?$scope.curTab=$scope.tabs[e-1]:$scope.curTab=$scope.tabs[e+1]),$scope.tabs.splice(e,1)},$scope.goToTab=function(e){$scope.curTab=e};var initTabList=function(e){if(void 0==e.tab)e.tab={id:0,name:"默认"};else if(e.tab.id===!0)return;for(var t=!0,a=0;a<$scope.tabs.length;a++)$scope.tabs[a].id==e.tab.id&&(t=!1);t&&$scope.tabs.push(e.tab)},tabAlive=function(e){if(1==e)return!0;0==$scope.tabs.length&&($scope.tabs=[{id:0,name:"默认"}]);for(var t=!1,a=0;a<$scope.tabs.length;a++)$scope.tabs[a].id==e&&(t=!0);return t};$scope.paramToString=function(e){return _.filter(_.map(e.params,function(e){return e.title}),function(e){return e&&e.length>0}).join("; ")},$scope.paramsFun=function(){return $$dlut_param},$scope.goToEditPage=function(e){window.open("#/nv/explore/"+e)},$scope.openCopyWidgetModal=function(e,t){$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/copyWidgetModal.html",size:"lg",controller:["$scope","$uibModalInstance",function(a,r){"widget"===t?a.widget=JSON.stringify(e.widget):a.row=JSON.stringify(e),a.ok=function(){r.close()},a.cancel=function(){r.close()}}]})},$scope.pasteWidgetModelOpen=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/copyWidgetModal.html",size:"lg",controller:["$scope","$uibModalInstance",function(e,t){e.widget="",e.row="",e.cancel=function(){t.dismiss("cancel")},e.ok=function(){var a={type:"",data:null};e.widget?(a.type="widget",a.data=JSON.parse(e.widget)):e.row&&(a.type="row",a.data=JSON.parse(e.row)),t.close(a)}}]});e.result.then(function(e){"row"===e.type?(delete e.data.$$hashKey,$scope.board.layout.rows.push(e.data)):utils.widget.addWidget(e.data)},function(){})},$scope.goToDescribe=function(e){$scope.alert(e)},$scope.addWidgetModelOpen=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/addWidgetModel.html",size:"sm",controller:"AddWidgetModelCtrl"});e.result.then(function(e){utils.widget.addWidget(e)},function(){console.info("Modal dismissed at: "+new Date)})},$scope.save=function(){if($scope.board.name&&$scope.board.id){var e=utils.getBoardRows($scope),t={json:angular.toJson({layout:{rows:e},categoryId:$scope.board.categoryId,name:$scope.board.name,id:$scope.board.id,config:$scope.board.config})};$http.post(updateUrl,t).success(function(e){"1"==e.status?($scope.optFlag="edit",ModalUtils.alert(e.msg,"modal-success","sm")):ModalUtils.alert(e.msg,"modal-warning","sm")})}},$scope.clear=function(){$scope.board.layout.rows=[]},$scope.removeParam=function(e){$scope.board.layout.rows.splice(e,1)},$scope.clearParams=function(){$scope.applyParamFilter(!0)},$scope.newBoardParam=function(e){if(""!=e){$scope.newBoardParamName="";var t={};_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){"slider"!=e.paramType&&(t[e.name]={type:e.type,values:e.values})})}),$scope.boardParams.unshift({name:e,params:t}),$http.post("dashboard/saveBoardParam.do",{boardId:$stateParams.id,config:angular.toJson($scope.boardParams)})}},$scope.deleteBoardParam=function(e){$scope.boardParams.splice(e,1),$http.post("dashboard/saveBoardParam.do",{boardId:$stateParams.id,config:angular.toJson($scope.boardParams)})},$scope.applyBoardParam=function(e){for(var t in e)_.each($scope.board.layout.rows,function(a){_.each(a.params,function(a){a.name==t&&(a.type=e[t].type,a.values=e[t].values)})});$scope.applyParamFilter()},$scope.goBack=function(){if($scope.history.length>0){var e=$scope.history.pop();_.isUndefined(e.id)||$state.go("nv.dashboard.view",{id:e.id,param:e.param,history:$scope.history,screenHistory:$scope.screenHistory,role:$rootScope.role},{reload:!0})}},$scope.goBackAll=function(){EventService.trigger("WS:screenBack",{},"all")},$scope.widgetConfigModelOpen=function(e){var t=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/widgetConfigModal.html",size:"",controller:"widgetConfigModalControl",resolve:{widget:function(){return e},screenList:function(){return $scope.screenList?$scope.screenList:[]},isAdmin:function(){return $scope.isAdmin},widgetThemeConfigGroups:function(){if(!_.isUndefined($scope.themeConfigList)){var t=e.type,a="";return _.isUndefined(t)&&(t="widget"),"param"!=t&&"board"!=t&&(a=e.widget.data.config.chart_type),$scope.themeConfigList[t+":"+a]}},url:function a(){if("board"==e.type){var a="http://";_.isUndefined(e.config)||_.isUndefined(e.config.url)||(a=e.config.url)}return a},tab:function(){return angular.copy($scope.curTab)},tabs:function(){return angular.copy($scope.tabs)}}});t.result.then(function(){e.widget&&$scope.reloadWidget(e)})},$scope.boardConfigModelOption=function(){var e=$uibModal.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/dashboard/layout/modals/setPanelTheme.html",size:"lg",controller:"SetPanelCtrl",resolve:{config:function(){return void 0==$scope.board.config&&($scope.board.config={}),angular.copy($scope.board.config)},boardName:function(){return $scope.board.name},categoryId:function(){return $scope.board.categoryId}}});e.result.then(function(e){$scope.board.name=e.boardName,$scope.board.config=e.config,$scope.board.categoryId=e.categoryId},function(){})},$scope.minimizeWidget=function(){$scope.curTab=angular.copy($scope.lastTab)},$scope.maximizeWidget=function(e,t){var a=$(t.target).parents(".panelTheme"),r=e.maximizeOption;if(e.maximize)"filter"==r.type?$scope.lastFilter&&(e.widget.data.config.filters=$scope.lastFilter):"default"==r.type,e.maximizeOption2={style:$scope.lastSize};else{if("filter"===r.type){$scope.lastFilter=e.widget.data.config.filters;var n=r.filters;e.filters_copy&&(n=n.concat(e.filters_copy)),e.widget.data.config.filters=n}else"tab"==r.type?($scope.lastTab=angular.copy($scope.curTab),$scope.curTab={id:r.tabSelect}):"default"==r.type;$scope.lastSize={width:a.width(),height:a.height(),left:a.position().left,top:a.position().top},r.custumSize?e.maximizeOption2={style:{width:100/24*parseInt(r.sizeX)+"%",height:100/12*parseInt(r.sizeY)+"%",left:100/24*parseInt(r.col)+"%",top:100/12*parseInt(r.row)+"%",background:'url("theme/theme_Beili01/images/bk.jpg") no-repeat',"z-index":9999}}:e.maximizeOption2={style:{width:"100%",height:"100%",left:0,top:0,background:'url("theme/theme_Beili01/images/bk.jpg") no-repeat',"z-index":9999}}}"tab"!=r.type&&(e.maximize=!e.maximize,$scope.reloadWidget(e,!0))},$scope.applyParamFilter=function(e){e?($scope.widgetFilters=[],$scope.datasetFilters=[],$scope.globalParamTitle="",$scope.globalParamTitleMap={},_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){e.values=[]})})):utils.params.paramToFilter(),_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(e){if(!e.config||!e.config.ignoreEvent)try{chartService.realTimeRender(e.realTimeTicket,utils.filter.injectFilter(e.widget).data)}catch(t){console.error(t)}})}),utils.params.updateParamTitle()},$scope.globalParamTitleMap={};var directApplyParamFilter2=function(e,t,a){_.each($scope.board.layout.rows,function(t){_.each(t.params,function(t){for(var a=0;a<e.length;a++)e[a].column==t.name&&(t.type=e[a].type,t.values=e[a].values)})}),utils.params.updateGlobalParamTitle()};$scope.reloadWidget=function(e,t,a){_.isUndefined(e.render)||t?(t||utils.widget.setBoardFilter(e),e.show=!1,e.render=function(t,a,r){chartService.render(t,e.widget.data,a,r,!0,void 0,e.theme).then(function(t){e.realTimeTicket=t,utils.widget.loadWidgetNum++,utils.widget.loadWidgetNum===utils.widget.widgetNum&&(e.loading=!1,$.filters.autoCalc(),$.iframes.calcUrl(),$scope.started||($.widgets.initAll(),$.widgets.reloadAll()))}),e.realTimeOption={optionFilter:a,scope:r}},$timeout(function(){e.loading=!0,e.show=!0})):chartService.realTimeRender(e.realTimeTicket,utils.filter.injectFilter(e.widget).data)},$scope.reloadAllWidget=function(){_.each($scope.board.layout.rows,function(e){"widget"==e.type&&_.each(e.widgets,function(e){$scope.reloadWidget(e)})})};var getThemeConfigInfo=function(e){};$scope.$watch("board.config.theme",getThemeConfigInfo),CBoardEChartRender.prototype.theme="theme-fin1",EventService.on("WS:screenSkip",function(e){$http.get("screen/getScreenMenuItemByIdType.do?id="+e.target+"&type="+$rootScope.role).success(function(t){e.history&&($scope.screenHistory=e.history),""==t?$scope.screenHistory.push({}):(_.isUndefined($stateParams.param)&&($stateParams.param=[]),$scope.screenHistory.push({id:$stateParams.id,param:$stateParams.param}),$state.go("nv.dashboard.view",{id:t.dashboard_id,param:e.param,history:$scope.history,screenHistory:$scope.screenHistory,role:$rootScope.role},{reload:!0}))})}),EventService.on("WS:screenBack",function(e){if($scope.screenHistory.length>0){var t=$scope.screenHistory.pop();_.isUndefined(t.id)?$stateParams.screenHistory=$scope.screenHistory:$state.go("nv.dashboard.view",{id:t.id,param:t.param,history:$scope.history,screenHistory:$scope.screenHistory,role:$rootScope.role},{reload:!0})}}),EventService.on("CE:dblclick",function(e){console.log("CE:dblclick",e)}),EventService.on("CE:click",function(e){console.log("CE:click",e);var t=e.widget,a=(t.widgetId,e.param),r=[];if((a&&a.data&&a.data.eventInfo||"blank"===a.trigger)&&EventService.trigger("$click",e),a.region&&EventService.trigger("$click",e),_.isArray(a.data)){var n=a.data[a.data.length-1];n.length>0&&void 0!=n[0].value&&(r=n)}else{if(_.isUndefined(a.data))return;a.data.eventInfo&&(r=a.data.eventInfo)}var i=!_.isUndefined($rootScope.role)&&!_.isUndefined(t.screenAction)&&!_.isUndefined(t.screenAction.target),o=t.screenAction;if(i&&o){var s=t.widget.data.datasetId,l=angular.copy(o),c=o.param,d=[];for(var u in c)if(c[u].selected)for(var f=0;f<r.length;f++){var p=r[f].value;if(_.isArray(p)||(p=[p]),u==r[f].col){d.push({datasetId:s,column:u,type:"=",values:p});break}}l.param=d,EventService.trigger("WS:screenSkip",l,"all")}if(_.isUndefined(t.action)||_.isUndefined(t.action.type)&&_.isUndefined(t.action.regular));else if(_.isUndefined(t.action.regular))actionSkip(e,t.action,r,i);else if(t.action.regular){if(t.action.regular){var g=!1;_.each(t.action.list,function(t){var a=0;for(var n in t.param)t.param[n].selected&&a++;for(var o=0,s=0;s<r.length;s++)for(var n in t.param)if(r[s].col==n&&t.param[n].selected){var l=new RegExp(t.param[n].regular,"g");l.test(r[s].value)&&o++}a!=o||g||(g=!0,actionSkip(e,t,r,i))})}}else actionSkip(e,t.action.list[0],r,i)});var actionSkip=function(e,t,a,r){var n=e.widget,i=n.widgetId,o={};for(var s in t.param){var l=t.param[s],c=_.find(a,function(e){return e.col==l.col});void 0!=c&&void 0!=c.value&&(o[l.col]=c.value)}if("self"===t.type||"dashboard"===t.type){var d=n.widget.data.datasetId,u=[],f=[];t.ignoreSelf&&f.push(i),_.each(t.param,function(e){if(e.selected&&e.col&&!_.isUndefined(o[e.col])){var t=o[e.col];_.isArray(t)||(t=[t]),u.push({datasetId:d,column:e.col,type:"=",values:t})}}),"dashboard"!=t.type||r?"self"==t.type&&directApplyParamFilter2(u,void 0,f):(_.isUndefined($stateParams.param)&&($stateParams.param=[]),$scope.history.push({id:$stateParams.id,param:$stateParams.param}),$state.go("nv.dashboard.view",{id:t.target,param:u,history:$scope.history,screenHistory:$scope.screenHistory,role:$rootScope.role},{reload:!0}))}else if("url"==t.type){var p=t.target.toString();for(var g in o){var m=o[g];p=p.replace("{{"+g+"}}",m)}window.open(p,"noNewOpen","top=0,left=0,width=1920,height=1080,menubar=no,scrollbars=yes,resizable=yes,status=yes,titlebar=no,toolbar=no,location=no","_blank")}};EventService.on("CE:drillDown",function(e){console.log("CE:drillDown-dashboard",e),EventService.trigger("$drillDown",e);var t=e.widget.widget.data.config.keys,a=e.widget.widget.data.config.groups,r=e.widget.widget.data.config.drillTier,n=e.widget.realTimeTicket,i=!1,o=null;r.isGreat=!!e.param.isGreat&&e.param.isGreat,_.each(t,function(t){_.isUndefined(t.drillDown)||r.keyTier<t.drillDown.length-1&&(_.isUndefined(e.param.drillType)||"key"===e.param.drillType)&&(i=!0,o=t.drillDown[r.keyTier],r.filters.key.push(e.param.name),r.keyTier++)}),_.each(a,function(t){_.isUndefined(t.drillDown)||r.groupTier<t.drillDown.length-1&&(_.isUndefined(e.param.drillType)||"group"===e.param.drillType)&&(i=!0,o=key.drillDown[r.groupTier],r.filters.group.push(e.param.name),r.groupTier++)}),"treeGrid"===e.type&&(i=!0,r.keyTier=e.tier.tier,r.filters.key=e.tier.list,r.treeGridFilters=e.filters),i&&chartService.realTimeRender(n,e.widget.widget.data)}),EventService.on("CE:drillUp",function(e){EventService.trigger("$drillUp",e);var t=e.widget.widget.data.config.keys,a=e.widget.widget.data.config.groups,r=e.widget.widget.data.config.drillTier,n=e.widget.realTimeTicket,i=!1,o=null;r.isGreat=!!e.param.isGreat&&e.param.isGreat,_.each(t,function(t){_.isUndefined(t.drillDown)||r.keyTier>0&&(_.isUndefined(e.param.drillType)||"key"===e.param.drillType)&&(i=!0,o=t.drillDown[r.keyTier],r.filters.key.pop(),r.keyTier--)}),_.each(a,function(t){_.isUndefined(t.drillDown)||r.groupTier>0&&(_.isUndefined(e.param.drillType)||"group"===e.param.drillType)&&(i=!0,o=key.drillDown[r.groupTier],r.filters.group.pop(),r.groupTier--)}),i&&chartService.realTimeRender(n,e.widget.widget.data)}),EventService.on("$click",function(e){var t=eventData(e),a=BoardParamService.getAll();"chart"===e.type?runEvent({data:t.obj,param:a,seriesName:t.seriesName},e.widget.widget.data.wName,"$click"):"table"===e.type&&runEvent({data:t.obj,param:a,_this:t._this,this_td:t.this_td},e.wName,"$click")}),EventService.on("$drillDown",function(e){var t=eventData(e);"chart"===e.type?runEvent({data:t.obj,seriesName:t.seriesName},e.widget.widget.data.wName,"$drillDown"):"table"===e.type}),EventService.on("$drillUp",function(e){var t=eventData(e);"chart"===e.type?runEvent({data:t.obj,seriesName:t.seriesName},e.widget.widget.data.wName,"$drillUp"):"table"===e.type}),EventService.on("$ready",function(e){runEvent("",e.wName,"$ready")}),EventService.on("$blank",function(){try{if($scope.board)for(var e=0;e<$scope.board.layout.rows.length;e++){var t=$scope.board.layout.rows[e];"customTrigger"===t.sign&&t.config.customCode&&$scope.boardFunBtnClick(t.config);
}}catch(a){console.error("点击空白错误",a)}}),$("body").off("click").on("click",function(e){var t=$(e.target);(t.hasClass("gridster")||t.hasClass("contentTheme"))&&$timeout(function(){EventService.trigger("$blank")},500)}),$scope.$on("$destroy",function(){if(CBoardEChartRender.prototype.theme="theme-fin1",window.chartOptionList=void 0,window.$$orangle_param=void 0,window.$$EXCEL={},drillCallbackMap={},$scope.board.config&&$scope.board.config.customDesCode)try{eval($scope.board.config.customDesCode)}catch(e){console.error("board eval页面离开时调用的代码出错",$scope.board.config.customCode,e)}utils.widget.clearAllRouteFilter(),$(document).off("click")}),$.widgets={reload:function(e){return isArrayFn(e)?(utils.params.paramToFilter(),_.each($scope.board.layout.rows,function(t){_.each(t.widgets,function(t){if(_.indexOf(e,t.name)>-1)try{"treeGrid"===t.widget.data.config.chart_type&&$.widgets.resetChartDrill([t.name]),delete t.widget.data.config.temporaryParam,chartService.realTimeRender(t.realTimeTicket,utils.filter.injectFilter(t.widget).data,void 0,void 0,function(){})}catch(a){console.error(a)}})}),void utils.params.updateParamTitle()):void alert("reload参数应为数组")},reloadAll:function(){$scope.applyParamFilter()},resetChartDrill:function(e,t){_.isUndefined(t)&&(t=1),_.each(e,function(e){var a=_.find($scope.board.layout.rows,function(t){if("widget"===t.type)return t.widgets[0].name==e}).widgets[0],r=a.widget.data.config.drillTier;r.keyTier=t-1,r.groupTier=0,r.filters.key=[],r.filters.group=[]})},resetDrilldown:function(e,t){_.isUndefined(t)&&(t=1),_.each(e,function(e){var a=_.find($scope.board.layout.rows,function(t){if("widget"===t.type)return t.widgets[0].name==e}).widgets[0],r=a.widget.data.config.keys;r[t-1].values=[],r.splice(t,r.length-1)})},initAll:function(){utils.widget.widgetNum!==utils.widget.loadWidgetNum&&utils.widget.loadDelayWidget(!1)},sort:function(e,t,a){var r=_.find($scope.board.layout.rows,function(t){if("widget"===t.type)return t.widgets[0].name==e}).widgets[0];if(_.isUndefined(r))return void console.log("无对应的widget-",e);var n=r.widget.data.config;_.each(n.keys,function(e){$.trim(e.col)===t||$.trim(e.column)===t||$.trim(e.alias)===t?e.sort=a:e.sort=null}),_.each(n.groups,function(e){$.trim(e.col)===t||$.trim(e.column)===t||$.trim(e.alias)===t?e.sort=a:e.sort=null}),_.each(n.values,function(e){_.each(e.cols,function(e){$.trim(e.col)===t||$.trim(e.alias)===t?e.sort=a:e.sort=null})})},on:function(e,t,a){drillCallbackMap[e]||(drillCallbackMap[e]={}),_.each(t,function(t){drillCallbackMap[e][t]?drillCallbackMap[e][t].push(a):drillCallbackMap[e][t]=[a]})},hide:function(e){_.each($scope.board.layout.rows,function(t){_.each(t.widgets,function(t){t.name===e&&(t.hide=!0,t.config.isInit=!1)})})},show:function(e,t){"undefined"==typeof t&&(t={}),_.each($scope.board.layout.rows,function(a){_.each(a.widgets,function(a){if(a.name===e){for(var r in t)a[r]=t[r];a.hide=!1,a.config.isInit=!0,"undefined"==typeof a.realTimeTicket&&$scope.reloadWidget(a,!1,!0)}})})},tableDrilldown:function(e,t,a){var r=$scope.board.layout.rows;_.each(e,function(e){_.find(r,function(t){if("widget"===t.type)return t.widgets[0].name===e}).widgets[0]})},getPosition:function(e){_.each($scope.board.layout.rows,function(t){_.each(t.widgets,function(t){t.name===e&&console.log(e,"position:",{col:t.col,row:t.row,sizeX:t.sizeX,sizeY:t.sizeY})})})},setPagesize:function(e,t){var a=_.find($scope.board.layout.rows,function(t){if("widget"===t.type)return t.widgets[0].name===e}).widgets[0];a.widget.data.config.option.pageDataNum=t}},$.params={get:function(e){for(var t=0;t<$scope.board.layout.rows.length;t++){var a=$scope.board.layout.rows[t];if("widget"!==a.type&&a.config&&a.config.eventName===e){var r=a.config.eventName;return BoardParamService.get(r)}}return[]},set:function(e,t){for(var a=0;a<$scope.board.layout.rows.length;a++){var r=$scope.board.layout.rows[a];if("widget"!==r.type&&r.config&&r.config.eventName===e){var n=r.config.eventName;return BoardParamService.set(n,t),"capsule"===r.sign?(r.config.activeName=t,!1):(r.config.showValue!==t&&$scope.$applyAsync(function(){r.config.showValue=t}),!1)}}BoardParamService.set(e,t)},setSelect:function(e,t,a){var r=$("#select_"+e);if("undefined"==typeof a&&(a=t,t=e,r=$("[data-eventName="+t+"]")),r.size())if(a.length){var n=a;r.hasClass("isSingle")&&(n=a[0]),BoardParamService.set(t,n),r.multipleSelect("setSelects",a)}else BoardParamService.set(t,[]),r.multipleSelect("checkAll");else BoardParamService.set(t,a)}},$.filters={get:function(e){$scope.board.layout.rows.forEach(function(t){"param"===t.type&&t.params.forEach(function(t){if(t.name===e)return BoardParamService.get(e)})})},set:function(e,t){directApplyParamFilter2([{column:e,datasetId:"",type:"=",values:t}])},setSelect:function(e,t,a){$.params.setSelect(e,t,a)},autoCalc:function(){var e=[],t=[""];for(var a in utils.widget.boardParamKeyArr){var r={column:utils.widget.boardParamKeyArr[a],datasetId:"",type:"=",values:[]},n=BoardParamService.get(utils.widget.boardParamKeyArr[a]);r.values=n,"object"===("undefined"==typeof n?"undefined":_typeof(n))&&n.length>=0&&e.push(r)}directApplyParamFilter2(e,void 0,t),utils.widget.widgetNum!==utils.widget.loadWidgetNum&&utils.widget.loadDelayWidget(!1)},remove:function(e){BoardParamService.remove(e)}},$.iframes={calcUrl:function calcUrl(){var argReg=/\[&[^\]]+/g;_.each($scope.board.layout.rows,function(row){if(row.config&&row.config.url&&row.config.isExp&&row.config.exp){argList=row.config.exp.match(argReg);for(var allHave=!0,exp=row.config.exp,i=0;i<argList.length;i++){var argName=argList[i].substr(2),argValue=BoardParamService.get(argName);if("undefined"==typeof argValue){allHave=!1;break}exp=exp.replace("[&"+argName+"]",'"'+argValue+'"')}if(allHave)try{var value=eval(exp);$scope.$applyAsync(function(){row.config.showUrl=value})}catch(e){console.error(e)}}})}},$.events={on:function(e,t){EventService.on(e,t)},trigger:function(e,t){EventService.trigger(e,t)},off:function(e){EventService.off(e)}},$.highlight={setSeries:function(e,t){var a=window.$$dlut_renders[e];if(a){var r=a.ecc,n=a.options;if(r&&n){var i=n.series;if(i){r.showLoading();for(var o=0;o<i.length;o++)if("undefined"==typeof i[o].lineStyle&&(i[o].lineStyle={}),"undefined"==typeof i[o].itemStyle&&(i[o].itemStyle={}),i[o].lineStyle.opacity=.3,i[o].itemStyle.opacity=.3,t){var s=0===t.length||t.indexOf(i[o].name)>-1;s&&(i[o].lineStyle.opacity=1,i[o].itemStyle.opacity=1)}r.setOption(n),r.hideLoading()}}}},cancelSeries:function(e){var t=window.$$dlut_renders[e];if(t){var a=t.ecc,r=t.options;if(a&&r){var n=r.series;if(n)for(var i=0;i<n.length;i++)"undefined"==typeof n[i].lineStyle&&(n[i].lineStyle={}),"undefined"==typeof n[i].itemStyle&&(n[i].itemStyle={}),n[i].lineStyle.opacity=1,n[i].itemStyle.opacity=1;a.setOption(r)}}},set:function(e,t,a){var r=window.$$dlut_renders[e];if(r){var n=r.ecc,i=r.options;if(n&&i){n.showLoading();var o=i.series,s=void 0,l=!1;if(a){var c;i.xAxis&&"category"===i.xAxis.type&&i.xAxis.data?c=i.xAxis.data:i.yAxis&&"category"===i.yAxis.type&&i.yAxis.data&&(c=i.yAxis.data),"string"!=typeof a&&(l=!0),c&&(s=c.indexOf(a))}if(o){for(var d=0;d<o.length;d++)if("undefined"==typeof o[d].lineStyle&&(o[d].lineStyle={}),o[d].lineStyle.opacity=.3,t){var u=0===t.length||t.indexOf(o[d].name)>-1;u&&(o[d].lineStyle.opacity=1);for(var f=0;f<o[d].data.length;f++){var p=o[d].data[f];if("number"==typeof p)break;if(p.itemStyle||(p.itemStyle={}),"pie"===o[d].type?(o[d].labelLine={show:!1},p.itemStyle.opacity=.6):p.itemStyle.opacity=.3,u)if(l&&p.eventInfo){if("undefined"==typeof p.infoMap){p.infoMap={};for(var g in p.eventInfo){var m=p.eventInfo[g];m.col&&(p.infoMap[m.col]=m.value)}}var h=a(p.infoMap);h?(p.itemStyle.opacity=1,o[d].lineStyle.opacity=1):o[d].lineStyle.opacity=.3}else"undefined"!=typeof a&&p.name!==a&&f!==s||(p.itemStyle.opacity=1)}}n.setOption(i),n.hideLoading()}}}},cancel:function(e){var t=window.$$dlut_renders[e];if(t){var a=t.ecc,r=t.options;if(a&&r){for(var n=r.series,i=0;i<n.length;i++){"undefined"==typeof n[i].lineStyle&&(n[i].lineStyle={}),n[i].lineStyle.opacity=1;for(var o=0;o<n[i].data.length;o++)"undefined"==typeof n[i].data[o].itemStyle&&(n[i].data[o].itemStyle={}),n[i].data[o].itemStyle.opacity=1}a.setOption(r)}}},setTable:function(e,t){var a=$("table[widget='"+e+"']").find("tbody tr");_.each(a,function(e){$(e).removeClass()}),_.each(a,function(e){_.each($(e).find("td"),function(e){_.map(t,function(t,a){a===$.trim($(e).data("column"))&&t===$.trim($(e).data("value"))?($(e).parents("tr").removeClass(),$(e).parents("tr").addClass("highlight_tr")):$(e).parents("tr").hasClass("highlight_tr")||$(e).parents("tr").addClass("dim_tr")})})})},cancelTable:function(e){var t=$("table[widget='"+e+"']").find("tbody tr");_.each(t,function(e){$(e).removeClass()})}},$.alert=function(e,t,a){ModalUtils.alert(e,t,a)},$.ibm={colors:{blue:"#11A0F8",green:"#26C8A4",purple:"#BF8FE1",blue2:"#337FFF",orange:"#FF8426",yellow:"#FFBB44",pink:"#FF7872",green2:"#7ACE4C",black:"#354052",gray:"#7F8FA4"}},$.colors={red:"#FF7872",green:"#7ACE4C",yellow:"#FFB85E",gray:"#EEEEEE",blue:"#11A0F8",orange:"#f28e2b"},$.board={onClickBlank:function(e){},flex:{reload:function(e){for(var t=0;t<$scope.board.layout.rows.length;t++){var a=$scope.board.layout.rows[t];if("widget"!==a.type&&"flex"===a.sign&&a.config&&a.config.flexCode&&a.config.eventName===e)try{var r=BoardParamService.getAll(),n=new Function("params","return ("+a.config.flexCode+")(params)")(r);a.config.showHTML=$sce.trustAsHtml(n)}catch(i){console.error("board Flex eval语句出错",a.config.flexCode,i)}}}}},$.start=function(){_.isUndefined(window.$$orangle_param)&&getOrangleParam(),getParamByOrangle(),$("body").removeClass(),$("#globalLoading").hide(),$scope.started=!0,$.widgets.initAll(),$.iframes.calcUrl()},$scope.load=function(e){$scope.paramInit=0,$scope.loading=!0,_.each($scope.intervals,function(e){$interval.cancel(e)}),$scope.intervals=[],$scope.board&&_.each($scope.board.layout.rows,function(e){_.each(e.widgets,function(e){e.show=!1})}),$http.get("dashboard/getBoardData.do?id="+$stateParams.id+"&token="+getQueryString("yili-token")).success(function(t){var a=[];_.each(t.layout.rows,function(e){"widget"==e.type&&a.push(e.widgets[0].widget.data.datasetId)});var r=function(){$scope.intervalGroup={},$scope.loading=!1,$scope.board=t,_.each($scope.board.layout.rows,function(e){_.each(e.params,function(e){$scope.paramInit++,e.paramType||(e.paramType="default")})}),paramInitListener&&paramInitListener(e),"timeline"==$scope.board.layout.type&&groupTimeline(),0==$scope.paramInit&&utils.widget.loadWidget(e),paramInitListener=$scope.$on("paramInitFinish",function(t,a){$scope.paramInit--,0==$scope.paramInit&&utils.widget.loadWidget(e)}),utils.params.clearAllSelectParams()};a.length>0?dataService.getDatasetList(a).then(r):r()})},$scope.widgetTransposition=function(e){var t=angular.copy(e.widget.data.config.keys),a=angular.copy(e.widget.data.config.groups),r=angular.copy(e.widget.data.config.drillTier),n=e.realTimeTicket;e.widget.data.config.keys=a,e.widget.data.config.groups=t,e.widget.data.config.drillTier.keyTier=r.groupTier,e.widget.data.config.drillTier.groupTier=r.keyTier,e.widget.data.config.drillTier.filters.key=r.filters.group,e.widget.data.config.drillTier.filters.group=r.filters.key,chartService.realTimeRender(n,e.widget.data)},$scope.downloadExcel=function(e){function t(e){var t=[],a={};for(var r in e.columnList)a[r]=e.columnList[r].name;for(var r in e.data){var n={};for(var i in e.data[r])n[a[i]]=e.data[r][i];t.push(n)}return t}var a=t(window.$$EXCEL[e.widget.data.wName]),r=XLSX.utils.json_to_sheet(a),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,r,"sheet1"),XLSX.writeFile(n,e.widget.data.wName+".xlsx")}}]);var isArrayFn=function(e){return"[object Array]"===Object.prototype.toString.call(e)},findNum=function(e){return e.match(/\d+/g)};discovery.controller("widgetConfigModalControl",["$scope","isAdmin","screenList","url","tab","tabs","widget","widgetThemeConfigGroups","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o,s,l,c,d,u){"ngInject";if(o.config&&o.config.columns&&"object"===_typeof(o.config.columns)&&(e.columnsText=o.config.columns.join("\n")),console.log("打开widget设置modal",o),void 0==o.maximizeOption&&(o.maximizeOption={col:o.col,row:o.row,sizeX:o.sizeX,sizeY:o.sizeY}),e.maximizeOption=o.maximizeOption,e.maximizeOption.col=o.maximizeOption.col,e.maximizeOption.row=o.maximizeOption.row,e.maximizeOption.sizeX=o.maximizeOption.sizeX,e.maximizeOption.sizeY=o.maximizeOption.sizeY,e.maximizeSelectFilterList=o.maximizeOption.filterSelected,o.widget)if(_.isUndefined(o.maximizeOption.filters))e.maximizeSelectFilterList=angular.copy(o.widget.data.filterGroups);else{for(var f=angular.copy(o.widget.data.filterGroups),p=0;p<f.length;p++)for(var g=0;g<o.maximizeOption.filters.length;g++)f[p].group==o.maximizeOption.filters[g].group?f[p].selected=!0:f[p].selected=!1;e.maximizeSelectFilterList=f}e.maxFilterInit=function(){return},e.MAXIMIZE_TYPE=[{name:"单纯最大化",value:"default"},{name:"调整过滤器",value:"filter"},{name:"切换到tab",value:"tab"}],e.tabs=i,_.isUndefined(e.maximizeOption)&&(e.maximizeOption={tabSelect:{}}),e.changeTab=function(t){e.maximizeOption.tabSelect==t.id?delete e.maximizeOption.tabSelect:e.maximizeOption.tabSelect=t.id},e.isAdmin=t,e.screenList=a,e.checkScreen=function(t){e.screenAction.target!=t?e.screenAction.target=t:e.screenAction.target=""},e.checkRegular=function(e,t){t.target!=e?t.target=e:t.target=""};e.url=r;var m={chord:!0,line:!0,line2:!0,line3:!0,pie:!0,pie2:!0,kpi:!1,table:!1,dataLineTable:!0,funnel:!0,sankey:!0,echart3dMap:!0,circular:!0,radar:!0,map:!1,scatter:!0,scatter2:!0,gauge:!1,wordCloud:!0,treeMap:!1,areaMap:!1,heatMapCalendar:!1,heatMapTable:!0,markLineMap:!1,liquidFill:!1,flex:!1,echart3dBar:!1,echart3dArea:!1,echart3dMapLine:!1,barPolarStack:!1,pieProportion:!1,codeFlower:!1,barLimits:!1,flex2:!0,lineMap:!0,gantt:!0,rose:!0};if(void 0!=o.widget&&m[o.widget.data.config.chart_type]){if(e.showActionTab=!0,e.boardList=[],l.get("admin/getBoardListUser.do").success(function(t){e.boardList=t}),e.selectDushboard=null,e.TARGET_SELECT=[{name:"影响本页",value:"self"},{name:"跳转到其他面板",value:"dashboard"},{name:"跳转到站外链接",value:"url"}],void 0==o.action||void 0==o.action.type&&void 0==o.action.regular)o.action={regular:!1,list:[{type:"self",target:null,param:{}}]};else if(!_.isUndefined(o.action.type)&&_.isUndefined(o.action.regular)){var h=angular.copy(o.action);o.action={regular:!1,list:[h]}}if(o.actionChange=!0,e.action=o.action,!_.isUndefined(o.widget.data)){var v=o.widget.data.config.keys;o.widget.data.config.events&&(v=v.concat(o.widget.data.config.events)),_.each(v,function(e){_.each(o.action.list,function(t){_.isUndefined(t.param[e.col])&&(t.param[e.col]={name:e.alias?e.alias:e.col,col:e.col,regular:"",selected:!1})})})}if(e.isAdmin)if(void 0!=o.screenAction?e.screenAction=o.screenAction:e.screenAction={},_.isUndefined(e.screenAction.param))e.screenAction.param=angular.copy(e.action.list[0].param),_.each(e.screenAction.param,function(e){e.selected=!1});else for(var p in e.action.list[0].param){var y=angular.copy(e.action.list[0].param[p]),w=!1;for(var g in e.screenAction.param)if(p==g){w=!0;break}w||(y.selected=!1,e.screenAction.param[p]=y)}}if(e.pushActionList=function(){var t=angular.copy(e.action.list[0]);t.type="self",t.target=null;for(var a in t.param)t.param[a].regular="",t.param[a].selected=!1;e.action.list.push(t)},e.deleteActionList=function(t){1!=e.action.list.length&&e.action.list.splice(t,1)},e.widgetThemeConfigGroups=s,_.isUndefined(e.maximizeOption.type)&&(e.maximizeOption.type="default"),e.widget=o,_.isUndefined(o.theme)||(e.selectTheme=o.theme),_.isUndefined(e.selectTheme)&&(e.selectTheme={select:{},classes:[],options:[]}),e.changePzTheme=function(t,a){e.selectTheme.select[t]==a.id?delete e.selectTheme.select[t]:e.selectTheme.select[t]=a.id;var r=[],n=[];for(var t in e.selectTheme.select){var i=e.selectTheme.select[t];_.each(e.widgetThemeConfigGroups[t],function(e){if(e.id==i){e["class"]&&(r=r.concat(e["class"]));var t=e.option;t&&n.push(t)}})}e.selectTheme.options=n,e.selectTheme.classes=r},o.widget&&(e.canSelectFilterList=angular.copy(o.widget.data.filterGroups),o.config&&o.config.rotateFilters&&o.config.rotateFilters.enable?e.rotateFilters=o.config.rotateFilters:e.rotateFilters={},o.config&&o.config.filters))for(var p=0;p<o.config.filters.length;p++)for(var g=0;g<e.canSelectFilterList.length;g++)o.config.filters[p].group==e.canSelectFilterList[g].group&&(e.canSelectFilterList[g].selected=!0);e.ok=function(){if(e.columnsText&&(e.widget.config.columns=e.columnsText.split("\n")),_.isUndefined(o.config)&&(o.config={}),o.widget){var t=[];if(e.canSelectFilterList)for(var a=0;a<e.canSelectFilterList.length;a++){var r=e.canSelectFilterList[a];r.selected&&t.push(r)}if(e.rotateFilters.enable&&(o.config.rotateFilters=e.rotateFilters),o.config.filters=t,t=[],e.maximizeSelectFilterList)for(var a=0;a<e.maximizeSelectFilterList.length;a++)r=e.maximizeSelectFilterList[a],r.selected&&t.push(r);o.maximizeOption.filters=t}o.theme=e.selectTheme,"board"!=o.type||_.isUndefined(o.config.url)||(o.config.url=e.url),o.screenAction=e.screenAction,u.close()},e.cancel=function(){u.dismiss("cancel")}}]).controller("AddImgWidgetCtrl",["$scope","tab","Upload","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o,s){"ngInject";e.$watch("files",function(){e.upload(e.files)}),e.$watch("file",function(){null!=e.file&&(e.files=[e.file])}),e.imgUrl="",e.log="",e.upload=function(t){if(t&&t.length)for(var r=0;r<t.length;r++){var n=t[r];n.$error||a.upload({url:"/images/upload.do",data:{file:n}}).then(function(t){e.imgUrl=t.data.imgUrl},null,function(e){})}};var l={name:"图片",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:t,sign:"img"};e.ok=function(){l.config.imgUrl=e.imgUrl,s.close(l)},e.cancel=function(){s.dismiss("cancel")}}]).controller("AddIframeWidgetCtrl",["$scope","tab","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o){"ngInject";var s={name:"iframe",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:t,sign:"iframe"};e.url="http://",e.ok=function(){s.config.url=e.url,o.close(s)},e.cancel=function(){o.dismiss("cancel")}}]).controller("AddTimePickerWidgetCtrl",["$scope","tab","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o){"ngInject";var s={name:"时间选择器",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:t,sign:"timePicker",timeOptions:{year:"年",month:"月",day:"日"},showValue:""};e.name="时间选择器",e.eventName="",e.timeType="year",e.ok=function(){s.changeTime=e.changeTime,s.name=e.name,s.config.eventName=e.eventName,s.config.timeType=e.timeType,o.close(s)},e.cancel=function(){o.dismiss("cancel")}}]).controller("AddColsWidgetCtrl",["$scope","tab","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o){"ngInject";var s={name:"字段",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:t,sign:"columns"};e.name="字段",e.eventName="",e.columns="",e.chooseType=1,e.ok=function(){s.name=e.name,s.config.eventName=e.eventName,e.columns?s.config.columns=e.columns.split("\n"):s.config.columns=[],s.config.chooseType=e.chooseType,o.close(s)},e.cancel=function(){o.dismiss("cancel")}}]).controller("AddInputWidgetCtrl",["$scope","tab","$sce","$http","$timeout","$filter","$uibModalInstance",function($scope,tab,$sce,$http,$timeout,$filter,$uibModalInstance){"ngInject";var iframeWidget={name:"自定义输入框",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:tab,sign:"input"};$scope.name="自定义输入框",$scope.defaultValue="",$scope.calcFormula="",$scope.eventName="",$scope.ok=function(){if(iframeWidget.name=$scope.name,iframeWidget.config.calcFormula=$scope.calcFormula,iframeWidget.config.eventName=$scope.eventName,$scope.calcFormula){var formula=$scope.calcFormula.replace("{v}",$scope.defaultValue);try{$scope.defaultValue=eval(formula)}catch(e){alert(e)}}iframeWidget.config.defaultValue=$scope.defaultValue,$uibModalInstance.close(iframeWidget)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]).controller("addDynamicTitleCtrl",["$scope","row","globalParamTitleMap","tab","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i,o,s,l){"ngInject";t&&(e.dynamicTitle=t.config.dynamicTitle,e.dynamicDefault=t.config.dynamicDefault);var c={name:"动态标题",type:"board",sizeX:10,sizeY:10,tab:r,params:[],config:{},sign:"title"};e.ok=function(){c.config.dynamicTitle=e.dynamicTitle,c.config.dynamicDefault=e.dynamicDefault,l.close(c)},e.cancel=function(){l.dismiss("cancel")}}]).controller("SetPanelCtrl",["$scope","config","boardName","categoryId","$http","$uibModalInstance","$filter","$uibModal","$stateParams","$timeout",function(e,t,a,r,n,i,o,s,l,c){"ngInject";var d=o("translate");e.expAceOptJS=cbAcebaseOption,e.expAceOptJS.mode="javascript",e.categoryList={},e.permissionSetting=function(){var e=s.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"src/view/nv/permission/setting.html",size:"lg",controller:"permissionSettingCtrl",resolve:{config:function(){return{type:"board",id:l.id}}}});e.result.then(function(){})};var u=function(){n.get("dashboard/getCategoryList.do").success(function(t){e.categoryList=[{id:null,name:d("CONFIG.DASHBOARD.MY_DASHBOARD")}],_.each(t,function(t){e.categoryList.push(t)})})};u();var f=function(t){var a=window.wangEditor,r=new a("#alertEditor");r.customConfig.menus=["head","bold","fontSize","fontName","italic","underline","strikeThrough","foreColor","backColor","link","list","justify","quote","emoticon","table","code"],r.create(),r.txt.html(t),e.editor=r};t.hasAlert&&c(function(){f(t.alertInfo?t.alertInfo:"")},300),e.$watch("config.hasAlert",function(){t.hasAlert&&c(function(){f(t.alertInfo?t.alertInfo:"")},300)}),e.boardNname=a,e.config=t,e.dashboardType=r,n({method:"GET",url:"theme/themeList.json"}).then(function(t){e.themeList=t.data.theme},function(e){}),e.changeTheme=function(t){e.config.theme!=t.name?e.config.theme=t.name:e.config.theme=""},e.ok=function(){e.config.alertInfo=t.hasAlert?e.editor.txt.html():null,i.close({config:e.config,boardName:e.boardNname,categoryId:e.dashboardType})},e.cancel=function(){i.dismiss("cancel")}}]).controller("AddWidgetModelCtrl",["$scope","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n){"ngInject";var i="widgetTreeID";e.treeConfig=jsTreeConfig1;var o=function(a){t.get("dashboard/getWidgetList.do").success(function(t){e.widgetList=t,a&&a(),e.searchNode()})},s=function(){var t=jstree_GetSelectedNodes(i)[0];return _.find(e.widgetList,function(e){return e.id==t.id})};e.editNode=e.ok=function(){n.close(s())},e.cancel=function(){n.dismiss("cancel")},e.searchNode=function(){var t={wgtName:"",dsName:"",dsrName:""},a=e.widgetList.map(function(t){var a,r=_.find(e.datasetList,function(e){return e.id==t.data.datasetId}),n="";return r?a=_.find(e.datasourceList,function(e){return e.id==r.data.datasource}):t.data.datasource&&(a=_.find(e.datasourceList,function(e){return e.id==t.data.datasource})),{id:t.id,name:t.name,categoryName:t.categoryName,datasetName:r?r.name:"",datasourceName:a?a.name:n}});if(e.keywords)if(e.keywords.indexOf(" ")==-1&&e.keywords.indexOf(":")==-1)t.wgtName=e.keywords;else for(var n=e.keywords.split(" "),o=0;o<n.length;o++){var s=n[o].trim();"wg"==s.split(":")[0]&&(t.wgtName=s.split(":")[1]),"ds"==s.split(":")[0]&&(t.dsName=s.split(":")[1]),"dsr"==s.split(":")[0]&&(t.dsrName=s.split(":")[1])}originalData=jstree_CvtVPath2TreeData(r("filter")(a,{name:t.wgtName,datasetName:t.dsName,datasourceName:t.dsrName})),jstree_ReloadTree(i,originalData),e.keywords&&_.delay(function(){e.treeInstance.jstree(!0).open_all()},100)},e.treeEventsObj=function(){var r=jstree_baseTreeEventsObj({ngScope:e,ngHttp:t,ngTimeout:a,treeID:i,listName:"widgetList"});return r}(),o()}]).controller("tabCtrl",["$scope","tab","tabs","$uibModalInstance",function(e,t,a,r){"ngInject";e.ok=function(){e.tabName.length>0&&(void 0!=t?t.name=e.tabName:a.push({id:a.length,name:e.tabName}),r.close())},e.cancel=function(){r.dismiss("cancel")}}]).controller("newData",["$scope","$uibModalInstance","$http",function(e,t,a){"ngInject";e.datasourceList=[],e.datasource=null,e.dataTables=[],e.selectTable=null,e.columns=[];var r=e;e.changeTable=function(){var t={sql:"select * from "+r.selectTable};a.post("dashboard/getColumns.do",{datasourceId:r.datasource.id,query:JSON.stringify(t),reload:!1}).success(function(t){e.columns=t.columns})},a.get("dashboard/getDatasourceList.do").success(function(t){r.datasourceList=t,r.datasourceList.length>0&&(r.datasource=r.datasourceList[0],a.get("flow/datasources/"+r.datasource.id+"/tables.do").success(function(t){r.dataTables=t.data,r.dataTables.length>0&&(r.selectTable=r.dataTables[0],e.changeTable())}))}),e.changeSource=function(){a.get("flow/datasources/"+r.datasource.id+"/tables.do").success(function(t){r.dataTables=t.data,r.dataTables.length>0&&(r.selectTable=r.dataTables[0],e.changeTable())})},e.ok=function(){var a={datasource:e.datasource,selectTable:e.selectTable};t.close(a)},e.cancel=function(){t.dismiss("cancel")}}]).controller("addStaticTextCtrl",["$scope","$sce","$http","$timeout","$filter","$uibModalInstance","row","tab",function(e,t,a,r,n,i,o,s){"ngInject";o&&(e.text=o.config.editor),r(function(){var t=window.wangEditor,a=new t("#editor");a.customConfig.menus=["head","bold","fontSize","fontName","italic","underline","strikeThrough","foreColor","backColor","link","list","justify","quote","emoticon","table","code","undo","redo"],a.create(),a.txt.html(e.text),e.editor=a},300);var l={name:"静态文本",type:"board",sizeX:10,sizeY:10,tab:s,params:[],config:{},sign:"static"};e.ok=function(){l.config.editor=e.editor.txt.html(),i.close(l)},e.cancel=function(){i.dismiss("cancel")}}]).controller("addJsMindNodeCtrl",["$scope","$sce","$http","$timeout","$filter","$uibModalInstance",function(e,t,a,r,n,i){"ngInject";e.jsmindNodeText=null,e.ok=function(){i.close(e.jsmindNodeText)},e.cancel=function(){i.dismiss("cancel")}}]).controller("alertInfoCtrl",["$scope","$sce","$http","$timeout","$filter","$uibModalInstance","config",function(e,t,a,r,n,i,o){"ngInject";o&&(e.alertInfo=o.alertInfo),e.cancel=function(){i.dismiss("cancel")}}]).controller("addCapsuleCtrl",["$scope","$sce","$http","$timeout","$filter","$uibModalInstance","tab",function(e,t,a,r,n,i,o){"ngInject";var s={name:"胶囊",type:"board",sizeX:10,sizeY:10,params:[],config:{},tab:o,sign:"capsule"};e.name="按钮组",e.eventName="",e.columns="",e.functions="",e.activeName=null,e.ok=function(){s.name=e.name,s.config.activeName=e.activeName,s.config.eventName=e.eventName,s.config.functions=e.functions,e.columns?s.config.columns=e.columns.split("\n"):s.config.columns=[],i.close(s)},e.cancel=function(){i.dismiss("cancel")}}]),angular.module("discovery").factory("EventService",function(){"ngInject";var e={};return{on:function(t,a){e[t]=a},trigger:function(t,a){for(var r in e)r==t&&e[r](a)},off:function(t){delete e[t]}}}),discovery.controller("chartCtrl",["$compile","$templateCache","$scope","$stateParams","ModalUtils","chartService","$uibModal","$http","$filter",function(e,t,a,r,n,i,o,s,l){"ngInject";function c(){s.get("dashboard/getWidgetList.do").success(function(e){a.widgetList=e,d()})}function d(){var e=_.find(a.widgetList,function(e){return e.id==r.wid});f(e)}a.widgetList=[],c();var u=function(a){var r=$(document).outerHeight()+" !important",n=$(document).outerWidth(),i=$("#inner-container"),o=t.get("nvEchartContent"),s=e(o);i.append(s(a)),i.find(".box-body").width(n-90),i.find(".box-body").height(r);var l=i.find(".box-body");a.widget.render(l,null,a)},f=function(e){var t={name:e.name,widgetId:e.id,widget:e};p(t,!1),u(a)},p=function(e,t){e.render=function(a,r,n){i.render(a,e.widget.data,r,n,t,void 0,e.theme).then(function(t){e.realTimeTicket=t,e.loading=!1}),e.realTimeOption={optionFilter:r,scope:n}},e.modalRender=function(a,r,n){e.modalRealTimeTicket=i.render(a,e.widget.data,r,n,t,void 0,e.theme),e.modalRealTimeOption={optionFilter:r,scope:n}},a.widget=e}}]);